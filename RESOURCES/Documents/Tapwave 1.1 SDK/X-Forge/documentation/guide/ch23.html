<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>Chapter 23. Multiplayer Example</title><link rel="stylesheet" href="x-forge.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.54.1"><link rel="home" href="index.html" title="X-Forge Core 1.4.0 Guide"><link rel="up" href="pt07.html" title="Part VII. Core Examples"><link rel="previous" href="ch22.html" title="Chapter 22. XFF Player"><link rel="next" href="pt08.html" title="Part VIII. Appendices"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#0000FF" alink="#FF0000"><div class="navbar"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter 23. Multiplayer Example</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ch22.html">Prev</a> </td><th width="60%" align="center">Part VII. Core Examples</th><td width="20%" align="right"> <a accesskey="n" href="pt08.html">Next</a></td></tr></table></div><div class="chapter"><div class="titlepage"><div><h2 class="title"><a name="id435761"></a>Chapter 23. Multiplayer Example</h2></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><a href="ch23.html#id435771">Introduction</a></dt><dt><a href="ch23.html#id435300">About XFuBluetoothMultiNetwork</a></dt><dt><a href="ch23.html#id435872">Game Flow</a></dt><dd><dl><dt><a href="ch23.html#id435882">Session Initialization</a></dt><dt><a href="ch23.html#id435950">The Gameplay</a></dt><dt><a href="ch23.html#id435972">Ending a Game</a></dt></dl></dd><dt><a href="ch23.html#id436003">Class Overview</a></dt></dl></div><div class="sect1"><div class="titlepage"><div><h2 class="title" style="clear: both"><a name="id435771"></a>Introduction</h2></div></div><p>
Multiplayer Example is the simplest possible example for demonstrating how to initiate a multiplayer game with the new framework provided by <tt>XFuBluetoothMultiNetwork</tt>. The example has two to four 'players' who ignite light bulbs that are seen on  other devices in the game. The purpose of the example is to show how to initiate a multiplayer game and how to send the state over the air to other game participants.  
</p><p>
The Multiplayer Example uses the standard X-Forge network architecture with the network communication classes, data receivers, serializable packets etc. All the packets that are used to implement the game are defined in <tt>Packets.h</tt>. Each packet type is implemented as a class that inherits from a base packet class called <tt>Packet</tt>.
</p><p>
Most of the multiplayer functionality is implemented in the multiplayer handler class (<tt>MultiPlayerHandler</tt>). The multiplayer handler handles the participant discovery, session initialization and handshaking, game state updates and disconnection.
</p><p>
Multiplayer Example shows also how to build the communication so that it works in both Bluetooth and Inet networking environments. A majority of the multiplayer code doesn't care if the network type is Bluetooth or Internet. Only one type at a time is supported, and this is selected using a preprocessor definition. Currently, only two X-Forge platforms are supported: desktop Windows and Symbian. If the application is for desktop Windows, Internet is used and <tt>NETWORK_TYPE_INET</tt> is defined, otherwise <tt>NETWORK_TYPE_BT</tt> is defined.
</p><p>
The number of players in the example has been limited to four, but in theory, it is possible to create eight-player multiplayer games with the <tt>XFuBluetoothMultiNetwork</tt>. However, in normal fast paced 3D game, having eight players in the game will more than double the amount of sent traffic compared to four players. That may be too much for Bluetooth's bandwidth. 
</p><p>
The Multiplayer Example uses the following terms in classnames and comments:
</p><div class="itemizedlist"><ul type="disc"><li>Initiator - Game server or host which sends the connection initiation packet to all the other participants. Game server here isn't necessarily listening for connections, it just works as a logical hub of the game data among all participants</li><li>Participant - Game client which waits for the initiator to send the handshake packet.</li></ul></div><p>
</p></div><div class="sect1"><div class="titlepage"><div><h2 class="title" style="clear: both"><a name="id435300"></a>About XFuBluetoothMultiNetwork</h2></div></div><p>
The new multiplayer framework in the <tt>XFuBluetoothMultiNetwork</tt> works in reversed client-server relation to the <tt>XFuBluetoothNetwork</tt>. This is due to the Bluetooth networking architecture which allows only one incoming connection to the terminal. In the <tt>XFuBluetoothNetwork</tt> the game host works as a Bluetooth slave, listening for incoming connections like in the traditional networking architecture. The game client i.e. the Bluetooth master terminal connects to the game server and the multiplayer game is initiated. Using the same approach with more than 2 players in the game would be impossible, because Bluetooth slaves accept only one incoming connection and that is from the particular Bluetooth master terminal, whose Bluetooth band they are in. In the new framework the game server connects to client, i.e. game server sends the connection initiator packet to the clients.
</p><p>
The new multiplayer network is star-shaped system, where the game server (the Bluetooth master terminal) connects to all the game participants (the Bluetooth slave terminals). The next problem is how the game server should know which clients to connect. In the <tt>XFuBluetoothMultiNetwork</tt> the game clients advertise themselves to the game server with SDP protocol. The game clients have to be started before the game server. This is to get the SDP advertising set up before the game server starts its service discovery. After a successful discovery the game server has a list of available game clients. It shows the list to the user who can select which participants will be accepted to the game. When the names have been selected, the game server connects to the clients and the game may begin.
</p><p>
Good and compulsory reading for all X-Forge networking programmers is the Multiplayer Games chapter in Game Engine part.
</p></div><div class="sect1"><div class="titlepage"><div><h2 class="title" style="clear: both"><a name="id435872"></a>Game Flow</h2></div></div><div class="sect2"><div class="titlepage"><div><h3 class="title"><a name="id435882"></a>Session Initialization</h3></div></div><p>
Using Bluetooth, the game initiator uses the Bluetooth native service discovery protocol to search for available game participants. This is presented to the multiplayer handler in the same way as when using Internet. Using Internet as the network type, participant discovery works so that all the participants turns on the advertiser and the game initiator detects all advertisers and maintains a list of these, which is then displayed in the user interface. 
</p><p>
Once the game initiator selects all participants from the user interface, it starts sending game connect packets to them. The game connect packets include a game connect token, which is a magic token that must match the game connect token on the participant. If the token is invalid, the participant will quietly reject the connection request from the initiator.
</p><p>
When the participant receives a valid game connect token, it accepts the initiator and sends a handshake packet to the initiator and stops the advertiser.
When the initiator receives the handshake packet it sends a game init packet back to the participant telling his playerID and the number of 'players' in the game. Every participant has a connection state which will be updated to CONNECTED state when the game initialization packet has been sent.
</p></div><div class="sect2"><div class="titlepage"><div><h3 class="title"><a name="id435950"></a>The Gameplay</h3></div></div><p>
During the gameplay, the game clients send their state to the game server every 250 milliseconds. The server propagates these and its own state among all clients.
</p></div><div class="sect2"><div class="titlepage"><div><h3 class="title"><a name="id435972"></a>Ending a Game</h3></div></div><p>
A game client can exit the game at any time. When this happens, the client
sends a disconnect packet to the game server to inform it that it has left the game. This is handled in exactly the same was as if the connection was lost for some technical reason. When game client disconnects, and there are still left players in the game, the game continues until there are no other participants left.
</p><p>
Currently, disconnect packet's aren't propagated from server to other participants. The disconnected state of a participant is shown in ledState variable that is propagated among all participants by the server.
</p></div></div><div class="sect1"><div class="titlepage"><div><h2 class="title" style="clear: both"><a name="id436003"></a>Class Overview</h2></div></div><p>
The following briefly describes the roles of the classes in the example:
</p><div class="itemizedlist"><ul type="disc"><li><tt>MultiPlayerExample</tt> defines the main application  and its state changes</li><li><tt>MainMenuScreen</tt> implements the main menu of the game</li><li><tt>ConnectingScreen</tt> implements the participant list in the host</li><li><tt>GameScreen</tt> implements actual 'game' output</li><li><tt>Packet</tt> defines the types of packets that are sent over network</li><li><tt>MultiPlayerHandler</tt> the main multiplayer functionality class</li><li><tt>ClientListEntry</tt> defines an entry in the client list in the <tt>ConnectingScreen</tt></li><li><tt>ClientStateEntry</tt> represents the state of one client that there is a connection to</li><li><tt>GameState</tt> represents the state of the light bulbs</li><li><tt>UIImageFactory</tt> defines methods for drawing buttons and checkboxes for the example</li><li><tt>Screen</tt>Basic screen and user interface functionality</li></ul></div><p>
</p></div></div><div class="navbar"><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch22.html">Prev</a> </td><td width="20%" align="center"><a accesskey="u" href="pt07.html">Up</a></td><td width="40%" align="right"> <a accesskey="n" href="pt08.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter 22. XFF Player </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> Part VIII. Appendices</td></tr></table></div><div align="center" style="padding-top: 5px;"><table><tr><td align="left"><a href="http://www.fathammer.com/"><img src="images/fathammer_logo.gif" border="0"></a></td><td>&nbsp; &nbsp; &nbsp; &nbsp;</td><td align="center" class="copyright">
                X-Forge Documentation<br>
                Confidential<br>
                Copyright &copy; 2003 Fathammer<br></td></tr></table></div></body></html>
