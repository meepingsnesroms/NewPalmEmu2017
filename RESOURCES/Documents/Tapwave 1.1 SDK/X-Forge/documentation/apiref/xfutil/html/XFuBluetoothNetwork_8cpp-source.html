<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>XFuBluetoothNetwork.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>XFuBluetoothNetwork.cpp</h1><a href="XFuBluetoothNetwork_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*!</span>
00002 <span class="comment"> * \file</span>
00003 <span class="comment"> * X-Forge Engine &lt;br&gt;</span>
00004 <span class="comment"> * Copyright 2000-2002 Fathammer Ltd</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> * \brief Default implementation for a Bluetooth communication manager.</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * $Id: XFuBluetoothNetwork.cpp,v 1.14 2003/10/15 07:56:53 slehti Exp $</span>
00009 <span class="comment"> * $Date: 2003/10/15 07:56:53 $</span>
00010 <span class="comment"> * $Revision: 1.14 $</span>
00011 <span class="comment"> */</span>
00012 
00013 <span class="preprocessor">#include &lt;xforge.h&gt;</span>
00014 
00015 <span class="preprocessor">#include &lt;xfcore/net/XFcBtHandler.h&gt;</span>
00016 <span class="preprocessor">#include &lt;xfcore/net/XFcBtClientWin.h&gt;</span>
00017 <span class="preprocessor">#include &lt;xfcore/net/XFcObjectDataFrame.h&gt;</span>
00018 <span class="preprocessor">#include &lt;xfcore/net/XFcCommunicationScheduler.h&gt;</span>
00019 <span class="preprocessor">#include &lt;xfcore/net/XFcCommunicationConstants.h&gt;</span>
00020 <span class="preprocessor">#include &lt;xfcore/net/socket/XFcSocketConstants.h&gt;</span>
00021 <span class="preprocessor">#include &lt;xfcore/net/socket/XFcBtAddress.h&gt;</span>
00022 <span class="preprocessor">#include &lt;xfcore/net/XFcUnknownSender.h&gt;</span>
00023 <span class="preprocessor">#include &lt;xfcore/net/XFcClientLost.h&gt;</span>
00024 <span class="preprocessor">#include &lt;xfcore/net/XFcDataReceiver.h&gt;</span>
00025 <span class="preprocessor">#include &lt;xfcore/net/XFcObjectDataFrame.h&gt;</span>
00026 <span class="preprocessor">#include &lt;xfcore/net/socket/XFcHostEntry.h&gt;</span>
00027 <span class="preprocessor">#include &lt;xfcore/net/socket/XFcBtHostResolver.h&gt;</span>
00028 <span class="preprocessor">#include &lt;xfcore/net/socket/XFcBtAdvertiser.h&gt;</span>
00029 <span class="preprocessor">#include &lt;xfcore/net/XFcUdpEngine.h&gt;</span>
00030 <span class="preprocessor">#include &lt;xfcore/net/socket/XFcBtCommService.h&gt;</span>
00031 <span class="preprocessor">#include &lt;xfcore/net/socket/XFcBtServerSearch.h&gt;</span>
00032 <span class="preprocessor">#include &lt;xfcore/net/socket/XFcName.h&gt;</span>
00033 <span class="preprocessor">#include &lt;<a class="code" href="XFuSerializable_8h.html">xfutil/XFuSerializable.h</a>&gt;</span>
00034 <span class="preprocessor">#include &lt;<a class="code" href="XFuNetwork_8h.html">xfutil/XFuNetwork.h</a>&gt;</span>
00035 <span class="preprocessor">#include &lt;<a class="code" href="XFuNetworkEventHandler_8h.html">xfutil/XFuNetworkEventHandler.h</a>&gt;</span>
00036 <span class="preprocessor">#include &lt;<a class="code" href="XFuBluetoothNetwork_8h.html">xfutil/XFuBluetoothNetwork.h</a>&gt;</span>
00037 
00038 
<a name="l00039"></a><a class="code" href="classXFuBluetoothNetwork.html#d0">00039</a> <a class="code" href="classXFuBluetoothNetwork.html">XFuBluetoothNetwork</a> * <a class="code" href="classXFuBluetoothNetwork.html#d0">XFuBluetoothNetwork::create</a>()
00040 {
00041     <a class="code" href="classXFuBluetoothNetwork.html">XFuBluetoothNetwork</a> * manager = <span class="keyword">new</span> <a class="code" href="classXFuBluetoothNetwork.html">XFuBluetoothNetwork</a>;
00042     <span class="keywordflow">if</span> (manager != NULL &amp;&amp; !manager-&gt;<a class="code" href="classXFuBluetoothNetwork.html#b2">init</a>())
00043     {
00044         <span class="keyword">delete</span> manager;
00045         <span class="keywordflow">return</span> NULL;
00046     }
00047     <span class="keywordflow">return</span> manager;
00048 }
00049 
00050 
<a name="l00051"></a><a class="code" href="classXFuBluetoothNetwork.html#b1">00051</a> <a class="code" href="classXFuBluetoothNetwork.html#b1">XFuBluetoothNetwork::XFuBluetoothNetwork</a>()
00052 {
00053     <a class="code" href="classXFuBluetoothNetwork.html#o0">mNetworkEventHandlers</a> = NULL;
00054     <a class="code" href="classXFuBluetoothNetwork.html#o1">mCommunicationScheduler</a> = NULL;
00055     <a class="code" href="classXFuBluetoothNetwork.html#o2">mCommunicationHandler</a> = NULL;
00056     <a class="code" href="classXFuBluetoothNetwork.html#o4">mDefaultDataReceiver</a> = NULL;
00057     <a class="code" href="classXFuBluetoothNetwork.html#o7">mHostResolver</a> = NULL;
00058     <a class="code" href="classXFuBluetoothNetwork.html#o3">mCommunicationService</a> = NULL;
00059    
00060     <a class="code" href="classXFuBluetoothNetwork.html#o11">mAcceptGameToken</a> = 0;
00061     <a class="code" href="classXFuBluetoothNetwork.html#o8">mCommunicationHandlerId</a> = -1;
00062     <a class="code" href="classXFuBluetoothNetwork.html#o12">mGamePort</a> = 0;
00063     <a class="code" href="classXFuBluetoothNetwork.html#o10">mClientId</a> = -1;
00064     <a class="code" href="classXFuBluetoothNetwork.html#o9">mClient</a> = NULL;
00065     <a class="code" href="classXFuBluetoothNetwork.html#o6">mService</a> = NULL;
00066     <a class="code" href="classXFuBluetoothNetwork.html#o5">mBtServerSearch</a> = NULL;
00067 }
00068 
00069 
<a name="l00070"></a><a class="code" href="classXFuBluetoothNetwork.html#a37">00070</a> <a class="code" href="classXFuBluetoothNetwork.html#a37">XFuBluetoothNetwork::~XFuBluetoothNetwork</a>()
00071 {
00072     <a class="code" href="classXFuBluetoothNetwork.html#a2">closeService</a>();    
00073     <a class="code" href="classXFuBluetoothNetwork.html#b0">deleteAllClients</a>();
00074     <a class="code" href="classXFuBluetoothNetwork.html#a27">removeAllEventHandlers</a>();
00075 
00076     <span class="keyword">delete</span> <a class="code" href="classXFuBluetoothNetwork.html#o6">mService</a>;
00077     <span class="keyword">delete</span> <a class="code" href="classXFuBluetoothNetwork.html#o7">mHostResolver</a>;
00078     <span class="keyword">delete</span> <a class="code" href="classXFuBluetoothNetwork.html#o0">mNetworkEventHandlers</a>;
00079     <span class="keyword">delete</span> <a class="code" href="classXFuBluetoothNetwork.html#o2">mCommunicationHandler</a>;
00080     <span class="keyword">delete</span> <a class="code" href="classXFuBluetoothNetwork.html#o5">mBtServerSearch</a>;
00081 }
00082 
00083 
<a name="l00084"></a><a class="code" href="classXFuBluetoothNetwork.html#b2">00084</a> INT <a class="code" href="classXFuBluetoothNetwork.html#b2">XFuBluetoothNetwork::init</a>()
00085 {
00086     <a class="code" href="classXFuBluetoothNetwork.html#o1">mCommunicationScheduler</a> = (XFcCommunicationScheduler *)XFcCore::getCommunicationScheduler();
00087     <span class="keywordflow">if</span> (<a class="code" href="classXFuBluetoothNetwork.html#o0">mNetworkEventHandlers</a> == NULL)
00088         <a class="code" href="classXFuBluetoothNetwork.html#o0">mNetworkEventHandlers</a> = <a class="code" href="classXFuDynamicArray.html#d0">XFuDynamicArray&lt;XFuNetworkEventHandler*&gt;::create</a>(5);
00089 
00090     <span class="keywordflow">if</span> (<a class="code" href="classXFuBluetoothNetwork.html#o1">mCommunicationScheduler</a> == NULL ||
00091         <a class="code" href="classXFuBluetoothNetwork.html#o0">mNetworkEventHandlers</a> == NULL) <span class="keywordflow">return</span> 0;
00092 
00093     <span class="keywordflow">return</span> 1;
00094 
00095 }
00096 
00097 
<a name="l00098"></a><a class="code" href="classXFuBluetoothNetwork.html#a4">00098</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothNetwork.html#a4">XFuBluetoothNetwork::runCommunicationScheduler</a>()
00099 {
00100     <a class="code" href="classXFuBluetoothNetwork.html#o1">mCommunicationScheduler</a>-&gt;runScheduler();
00101 }
00102 
00103 
<a name="l00104"></a><a class="code" href="classXFuBluetoothNetwork.html#a3">00104</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothNetwork.html#a3">XFuBluetoothNetwork::reset</a>()
00105 {
00106     <a class="code" href="classXFuBluetoothNetwork.html#a2">closeService</a>();
00107     <a class="code" href="classXFuBluetoothNetwork.html#b0">deleteAllClients</a>();
00108     <a class="code" href="classXFuBluetoothNetwork.html#a27">removeAllEventHandlers</a>();   
00109     <a class="code" href="classXFuBluetoothNetwork.html#o11">mAcceptGameToken</a> = 0;
00110     <a class="code" href="classXFuBluetoothNetwork.html#b2">init</a>();
00111 
00112 }
00113 
00114 
<a name="l00115"></a><a class="code" href="classXFuBluetoothNetwork.html#b3">00115</a> INT <a class="code" href="classXFuBluetoothNetwork.html#b3">XFuBluetoothNetwork::initEnable</a>(UINT16 aPort, INT aIsServer)
00116 {
00117     <a class="code" href="classXFuBluetoothNetwork.html#a2">closeService</a>();
00118     <a class="code" href="classXFuBluetoothNetwork.html#b0">deleteAllClients</a>();
00119 
00120     <a class="code" href="classXFuBluetoothNetwork.html#o6">mService</a> = XFcBtCommService::create();
00121     <a class="code" href="classXFuBluetoothNetwork.html#o12">mGamePort</a> = aPort;
00122 
00123     <span class="comment">// Are we Bluetooth server, bt-slave.</span>
00124     <span class="keywordflow">if</span> (aIsServer)
00125     {
00126         <span class="keywordflow">if</span> (aPort == 0 &amp;&amp; <a class="code" href="classXFuBluetoothNetwork.html#o6">mService</a>)
00127             <a class="code" href="classXFuBluetoothNetwork.html#o12">mGamePort</a> = <a class="code" href="classXFuBluetoothNetwork.html#o6">mService</a>-&gt;getFirstFreeRFCOMMPort();
00128     }
00129     <span class="keywordflow">else</span>
00130     {
00131         <span class="comment">// Create piconet. Works only with master device.</span>
00132         <a class="code" href="classXFuBluetoothNetwork.html#o6">mService</a>-&gt;createPiconet();
00133         <a class="code" href="classXFuBluetoothNetwork.html#o6">mService</a>-&gt;lockPiconet();
00134     }
00135     
00136     <span class="keywordflow">if</span> (<a class="code" href="classXFuBluetoothNetwork.html#o12">mGamePort</a> == XFCNET_NOT_SUPPORTED)
00137         <a class="code" href="classXFuBluetoothNetwork.html#o12">mGamePort</a> = 0;
00138 
00139     <a class="code" href="classXFuBluetoothNetwork.html#o2">mCommunicationHandler</a> = XFcBtHandler::create(aIsServer);
00140     
00141     <span class="keywordflow">return</span> (<a class="code" href="classXFuBluetoothNetwork.html#o2">mCommunicationHandler</a> &amp;&amp; <a class="code" href="classXFuBluetoothNetwork.html#o6">mService</a>) ? 1 : 0;
00142 }
00143 
00144 
<a name="l00145"></a><a class="code" href="classXFuBluetoothNetwork.html#a0">00145</a> INT <a class="code" href="classXFuBluetoothNetwork.html#a0">XFuBluetoothNetwork::enableClientService</a>()
00146 {
00147     INT error = 0;
00148 
00149     <span class="keywordflow">if</span> (<a class="code" href="classXFuBluetoothNetwork.html#b3">initEnable</a>(0, 0))
00150     {
00151         <a class="code" href="classXFuBluetoothNetwork.html#o2">mCommunicationHandler</a>-&gt;setUnknownSenderHandler(<span class="keyword">this</span>);
00152         <a class="code" href="classXFuBluetoothNetwork.html#o2">mCommunicationHandler</a>-&gt;setClientLost(<span class="keyword">this</span>);
00153 
00154         <a class="code" href="classXFuBluetoothNetwork.html#o8">mCommunicationHandlerId</a> = <a class="code" href="classXFuBluetoothNetwork.html#o1">mCommunicationScheduler</a>-&gt;addCommunicationHandler(mCommunicationHandler);
00155         error = 1;
00156     }
00157     <span class="keywordflow">return</span> error;
00158 }
00159 
00160 
<a name="l00161"></a><a class="code" href="classXFuBluetoothNetwork.html#a1">00161</a> INT <a class="code" href="classXFuBluetoothNetwork.html#a1">XFuBluetoothNetwork::enableServerService</a>(UINT16 aPort)
00162 {    
00163     XFcBtAddress *address = XFcBtAddress::create();
00164     XFcBtClientWin *client = XFcBtClientWin::create(NULL);
00165 
00166     <span class="keywordflow">if</span> (address &amp;&amp; client &amp;&amp; <a class="code" href="classXFuBluetoothNetwork.html#b3">initEnable</a>(aPort, 1))
00167     {
00168 
00169         address-&gt;setPort(mGamePort);
00170 
00171         <span class="comment">// Max client count must be more than 1</span>
00172         INT32 maxClients = 2;
00173 
00174         <span class="comment">// Open server, will return 1 if success else 0</span>
00175         <span class="keywordflow">if</span> (<a class="code" href="classXFuBluetoothNetwork.html#o2">mCommunicationHandler</a>-&gt;openServer(*address, maxClients))
00176         {
00177             <a class="code" href="classXFuBluetoothNetwork.html#o2">mCommunicationHandler</a>-&gt;setUnknownSenderHandler(<span class="keyword">this</span>);
00178             <a class="code" href="classXFuBluetoothNetwork.html#o2">mCommunicationHandler</a>-&gt;setClientLost(<span class="keyword">this</span>);
00179             
00180 
00181             <a class="code" href="classXFuBluetoothNetwork.html#o8">mCommunicationHandlerId</a> = <a class="code" href="classXFuBluetoothNetwork.html#o1">mCommunicationScheduler</a>-&gt;addCommunicationHandler(mCommunicationHandler);
00182             <a class="code" href="classXFuBluetoothNetwork.html#o2">mCommunicationHandler</a>-&gt;listenConnection(*client);
00183 
00184             INT32 clientId = <a class="code" href="classXFuBluetoothNetwork.html#o1">mCommunicationScheduler</a>-&gt;addClient(client);
00185 
00186             <span class="keywordflow">if</span> (clientId != XFCNET_CLIENTADD_ERROR)
00187             {
00188 
00189                 <a class="code" href="classXFuBluetoothNetwork.html#o9">mClient</a> = client;
00190                 <a class="code" href="classXFuBluetoothNetwork.html#o10">mClientId</a> = clientId;
00191                 <span class="keyword">delete</span> address;
00192                 address = NULL;
00193 
00194                 <span class="keywordflow">return</span> 1;
00195             }
00196         }
00197     }
00198     <span class="keyword">delete</span> address;
00199     address = NULL;
00200     <span class="keyword">delete</span> client;
00201     client = NULL;
00202 
00203     <a class="code" href="classXFuBluetoothNetwork.html#o9">mClient</a> = NULL;
00204     <a class="code" href="classXFuBluetoothNetwork.html#o10">mClientId</a> = -1;
00205     <span class="keywordflow">return</span> 0;
00206 }
00207 
00208  
<a name="l00209"></a><a class="code" href="classXFuBluetoothNetwork.html#a2">00209</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothNetwork.html#a2">XFuBluetoothNetwork::closeService</a>()
00210 {   
00211     <span class="comment">// Unlock and destroy piconet if any.</span>
00212     <a class="code" href="classXFuBluetoothNetwork.html#o6">mService</a>-&gt;unlockPiconet();
00213     <a class="code" href="classXFuBluetoothNetwork.html#o6">mService</a>-&gt;destroyPiconet();
00214     
00215     <a class="code" href="classXFuBluetoothNetwork.html#a28">stopDeviceDiscovery</a>();
00216     <a class="code" href="classXFuBluetoothNetwork.html#a29">stopServerDiscovery</a>();
00217     <a class="code" href="classXFuBluetoothNetwork.html#a30">stopAdvertiser</a>();
00218 
00219     <span class="keywordflow">if</span> (<a class="code" href="classXFuBluetoothNetwork.html#o2">mCommunicationHandler</a> != NULL)
00220     {
00221         <a class="code" href="classXFuBluetoothNetwork.html#o2">mCommunicationHandler</a>-&gt;closeService();
00222         <a class="code" href="classXFuBluetoothNetwork.html#o1">mCommunicationScheduler</a>-&gt;removeCommunicationHandler(mCommunicationHandlerId);
00223         <span class="keyword">delete</span> <a class="code" href="classXFuBluetoothNetwork.html#o2">mCommunicationHandler</a>;
00224         <a class="code" href="classXFuBluetoothNetwork.html#o2">mCommunicationHandler</a> = NULL;
00225     }
00226     <span class="keyword">delete</span> <a class="code" href="classXFuBluetoothNetwork.html#o6">mService</a>;
00227     <a class="code" href="classXFuBluetoothNetwork.html#o6">mService</a> = NULL;
00228 }
00229 
00230 
<a name="l00231"></a><a class="code" href="classXFuBluetoothNetwork.html#a10">00231</a> UINT32 <a class="code" href="classXFuBluetoothNetwork.html#a10">XFuBluetoothNetwork::getAcceptGameToken</a>()
00232 {
00233     <span class="keywordflow">return</span> <a class="code" href="classXFuBluetoothNetwork.html#o11">mAcceptGameToken</a>;
00234 }
00235 
00236 
<a name="l00237"></a><a class="code" href="classXFuBluetoothNetwork.html#a11">00237</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothNetwork.html#a11">XFuBluetoothNetwork::setAcceptGameToken</a>(UINT32 aAcceptGameToken)
00238 {
00239     <a class="code" href="classXFuBluetoothNetwork.html#o11">mAcceptGameToken</a> = aAcceptGameToken;
00240 }
00241 
00242 
<a name="l00243"></a><a class="code" href="classXFuBluetoothNetwork.html#a12">00243</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothNetwork.html#a12">XFuBluetoothNetwork::sendGameConnectPacket</a>(INT32 aClientId, UINT32 aGameToken)
00244 {
00245     XFcObjectDataFrame *frame = <a class="code" href="classXFuBluetoothNetwork.html#a19">getPacketFrame</a>(aClientId, XFCNET_NONGUARANTEED);
00246     <span class="keywordflow">if</span> (frame)
00247     {
00248         frame-&gt;setReceiverId(0);
00249         <span class="keywordtype">void</span> *buffer = frame-&gt;lock();
00250         <span class="keywordflow">if</span> (buffer)
00251         {
00252             memcpy(buffer, &amp;aGameToken, 4);
00253             frame-&gt;setPacketSize(4);
00254         }
00255         frame-&gt;unlock();
00256     }
00257 }
00258 
00259 
<a name="l00260"></a><a class="code" href="classXFuBluetoothNetwork.html#b0">00260</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothNetwork.html#b0">XFuBluetoothNetwork::deleteAllClients</a>()
00261 {
00262     <span class="keywordflow">if</span> (!<a class="code" href="classXFuBluetoothNetwork.html#o9">mClient</a>)
00263         <span class="keywordflow">return</span>;
00264 
00265     <span class="keywordflow">if</span> (!<a class="code" href="classXFuBluetoothNetwork.html#o1">mCommunicationScheduler</a>)
00266         <span class="keywordflow">return</span>;
00267 
00268     <a class="code" href="classXFuBluetoothNetwork.html#o1">mCommunicationScheduler</a>-&gt;removeClient(mClientId);
00269     <a class="code" href="classXFuBluetoothNetwork.html#o9">mClient</a>-&gt;deinitializeClient();
00270     <span class="keyword">delete</span> <a class="code" href="classXFuBluetoothNetwork.html#o9">mClient</a>;
00271     <a class="code" href="classXFuBluetoothNetwork.html#o9">mClient</a> = NULL;
00272     <a class="code" href="classXFuBluetoothNetwork.html#o10">mClientId</a> = -1;
00273 }
00274 
00275 
<a name="l00276"></a><a class="code" href="classXFuBluetoothNetwork.html#a9">00276</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothNetwork.html#a9">XFuBluetoothNetwork::removeAllClients</a>()
00277 {
00278     <span class="keywordflow">if</span> (!<a class="code" href="classXFuBluetoothNetwork.html#o2">mCommunicationHandler</a>)
00279         <span class="keywordflow">return</span>;
00280 
00281     <a class="code" href="classXFuBluetoothNetwork.html#a8">removeClient</a>(mClientId);
00282 }
00283 
00284 
<a name="l00285"></a><a class="code" href="classXFuBluetoothNetwork.html#a13">00285</a> XFcDataReceiver * <a class="code" href="classXFuBluetoothNetwork.html#a13">XFuBluetoothNetwork::getDefaultDataReceiver</a>()
00286 {
00287     <span class="keywordflow">return</span> <a class="code" href="classXFuBluetoothNetwork.html#o4">mDefaultDataReceiver</a>;
00288 }
00289 
00290 
<a name="l00291"></a><a class="code" href="classXFuBluetoothNetwork.html#a16">00291</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothNetwork.html#a16">XFuBluetoothNetwork::setDefaultDataReceiver</a>(XFcDataReceiver *aReceiver)
00292 {
00293     <a class="code" href="classXFuBluetoothNetwork.html#o4">mDefaultDataReceiver</a> = aReceiver;
00294     <a class="code" href="classXFuBluetoothNetwork.html#o1">mCommunicationScheduler</a>-&gt;setDataReceiver(aReceiver);
00295 }
00296 
00297 
<a name="l00298"></a><a class="code" href="classXFuBluetoothNetwork.html#a14">00298</a> XFcDataReceiver * <a class="code" href="classXFuBluetoothNetwork.html#a14">XFuBluetoothNetwork::getDataReceiver</a>(UINT32 aId)
00299 {
00300     <span class="keywordflow">return</span> <a class="code" href="classXFuBluetoothNetwork.html#o1">mCommunicationScheduler</a>-&gt;getDataReceiver(aId);
00301 }
00302 
00303 
<a name="l00304"></a><a class="code" href="classXFuBluetoothNetwork.html#a15">00304</a> INT <a class="code" href="classXFuBluetoothNetwork.html#a15">XFuBluetoothNetwork::addDataReceiver</a>(UINT32 aId, XFcDataReceiver *aReceiver)
00305 {
00306     <span class="keywordflow">return</span> <a class="code" href="classXFuBluetoothNetwork.html#o1">mCommunicationScheduler</a>-&gt;addDataReceiver(aId, aReceiver);
00307 }
00308 
00309 
<a name="l00310"></a><a class="code" href="classXFuBluetoothNetwork.html#a17">00310</a> XFcDataReceiver * <a class="code" href="classXFuBluetoothNetwork.html#a17">XFuBluetoothNetwork::removeDataReceiver</a>(UINT32 aId)
00311 {
00312     <span class="keywordflow">return</span> <a class="code" href="classXFuBluetoothNetwork.html#o1">mCommunicationScheduler</a>-&gt;removeDataReceiver(aId);
00313 }
00314 
00315 
<a name="l00316"></a><a class="code" href="classXFuBluetoothNetwork.html#a25">00316</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothNetwork.html#a25">XFuBluetoothNetwork::addEventHandler</a>(<a class="code" href="classXFuNetworkEventHandler.html">XFuNetworkEventHandler</a> *aHandler)
00317 {
00318     <a class="code" href="classXFuBluetoothNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a7">put</a>(aHandler);
00319 }
00320 
00321 
<a name="l00322"></a><a class="code" href="classXFuBluetoothNetwork.html#a26">00322</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothNetwork.html#a26">XFuBluetoothNetwork::removeEventHandler</a>(<a class="code" href="classXFuNetworkEventHandler.html">XFuNetworkEventHandler</a> *aHandler)
00323 {
00324     <a class="code" href="classXFuBluetoothNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a10">remove</a>(aHandler);
00325 }
00326 
00327 
<a name="l00328"></a><a class="code" href="classXFuBluetoothNetwork.html#a27">00328</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothNetwork.html#a27">XFuBluetoothNetwork::removeAllEventHandlers</a>()
00329 {
00330     <span class="keywordflow">while</span> (!<a class="code" href="classXFuBluetoothNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a4">isEmpty</a>()) <a class="code" href="classXFuBluetoothNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a10">remove</a>();
00331 }
00332 
00333 
<a name="l00334"></a><a class="code" href="classXFuBluetoothNetwork.html#a7">00334</a> XFcClientCommWin * <a class="code" href="classXFuBluetoothNetwork.html#a7">XFuBluetoothNetwork::getClient</a>(INT32 <span class="comment">/*aClientId*/</span>)
00335 {
00336     <span class="keywordflow">return</span> <a class="code" href="classXFuBluetoothNetwork.html#o9">mClient</a>;
00337 }
00338 
00339 
<a name="l00340"></a><a class="code" href="classXFuBluetoothNetwork.html#a6">00340</a> INT32 <a class="code" href="classXFuBluetoothNetwork.html#a6">XFuBluetoothNetwork::addClient</a>(XFcAddress *aAddress, INT32 <span class="comment">/*aTimeoutTime*/</span>)
00341 {
00342     XFcBtClientWin *client = NULL;
00343     INT32 clientId = -1;
00344 
00345     <span class="keywordflow">if</span> (!aAddress)
00346         <span class="keywordflow">return</span> -1;
00347 
00348     <span class="keywordflow">if</span> ((client = XFcBtClientWin::create(aAddress)) == NULL)
00349         <span class="keywordflow">return</span> -1;
00350 
00351     <span class="keywordflow">switch</span> (aAddress-&gt;getType())
00352     {
00353         <span class="keywordflow">case</span> XFCNET_AFBT:
00354             <span class="keywordflow">if</span> (client-&gt;openClient() != -1)
00355             {
00356                 clientId = <a class="code" href="classXFuBluetoothNetwork.html#o1">mCommunicationScheduler</a>-&gt;addClient(client);
00357                 <span class="keywordflow">if</span> (clientId != XFCNET_CLIENTADD_ERROR &amp;&amp; clientId != XFCNET_ERROR)
00358                 {
00359                     <a class="code" href="classXFuBluetoothNetwork.html#o9">mClient</a> = client;
00360                 }
00361             }
00362 
00363             <span class="keywordflow">break</span>;
00364         <span class="keywordflow">default</span>:
00365             XFcCore::systemPanic(XFCSTR(<span class="stringliteral">"This address type is not supported"</span>));
00366             <span class="keywordflow">break</span>;
00367     }
00368 
00369     <span class="keywordflow">if</span> (clientId == -1)
00370         <span class="keyword">delete</span> client;
00371 
00372     <a class="code" href="classXFuBluetoothNetwork.html#o10">mClientId</a> = clientId;
00373     <span class="keywordflow">return</span> clientId;
00374 }
00375 
00376 
<a name="l00377"></a><a class="code" href="classXFuBluetoothNetwork.html#a8">00377</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothNetwork.html#a8">XFuBluetoothNetwork::removeClient</a>(INT32 aClientId)
00378 {
00379     INT32 cId = 0;
00380 
00381     <span class="comment">// If communication handler is not created we do not have anything to do.</span>
00382     <span class="keywordflow">if</span> (!<a class="code" href="classXFuBluetoothNetwork.html#o2">mCommunicationHandler</a>)
00383         <span class="keywordflow">return</span>;
00384 
00385     <span class="keywordflow">if</span> (<a class="code" href="classXFuBluetoothNetwork.html#o9">mClient</a> == NULL)
00386         <span class="keywordflow">return</span>;
00387 
00388     <span class="comment">// Remove client and deinitialize it</span>
00389     <a class="code" href="classXFuBluetoothNetwork.html#o1">mCommunicationScheduler</a>-&gt;removeClient(aClientId);
00390     <a class="code" href="classXFuBluetoothNetwork.html#o9">mClient</a>-&gt;deinitializeClient();
00391 
00392     <span class="keyword">delete</span> <a class="code" href="classXFuBluetoothNetwork.html#o9">mClient</a>;
00393     <a class="code" href="classXFuBluetoothNetwork.html#o9">mClient</a> = NULL;
00394     <a class="code" href="classXFuBluetoothNetwork.html#o10">mClientId</a> = -1;
00395 
00396     <span class="comment">// Listening client is created to backbuffer for incoming connections.</span>
00397     <span class="comment">// If client is removed we create new for new connection.</span>
00398     <span class="keywordflow">if</span> (<a class="code" href="classXFuBluetoothNetwork.html#o2">mCommunicationHandler</a>-&gt;isServer())
00399     {
00400         XFcBtClientWin *client = NULL;
00401         <span class="keywordflow">if</span> ((client = XFcBtClientWin::create(NULL)) != NULL)
00402         {
00403             <a class="code" href="classXFuBluetoothNetwork.html#o2">mCommunicationHandler</a>-&gt;listenConnection(*client);
00404             cId = <a class="code" href="classXFuBluetoothNetwork.html#o1">mCommunicationScheduler</a>-&gt;addClient(client);
00405 
00406             <span class="keywordflow">if</span> (cId != XFCNET_CLIENTADD_ERROR &amp;&amp; cId != XFCNET_ERROR)
00407             {
00408                 <a class="code" href="classXFuBluetoothNetwork.html#o10">mClientId</a> = cId;
00409                 <a class="code" href="classXFuBluetoothNetwork.html#o9">mClient</a> = client;
00410             }
00411             <span class="keywordflow">else</span>
00412                 XFcCore::systemPanic(XFCSTR(<span class="stringliteral">"removeClient(), add client"</span>));
00413         }
00414         <span class="keywordflow">else</span>
00415             XFcCore::systemPanic(XFCSTR(<span class="stringliteral">"removeClient(), new listener"</span>));
00416     }
00417 }
00418 
00419 
<a name="l00420"></a><a class="code" href="classXFuBluetoothNetwork.html#a22">00420</a> INT32 <a class="code" href="classXFuBluetoothNetwork.html#a22">XFuBluetoothNetwork::getRoundTripTime</a>(INT32 aClientId)
00421 {
00422     <span class="keywordflow">return</span> <a class="code" href="classXFuBluetoothNetwork.html#o1">mCommunicationScheduler</a>-&gt;getRoundTripTime(aClientId);
00423 }
00424 
00425 
<a name="l00426"></a><a class="code" href="classXFuBluetoothNetwork.html#a19">00426</a> XFcObjectDataFrame * <a class="code" href="classXFuBluetoothNetwork.html#a19">XFuBluetoothNetwork::getPacketFrame</a>(INT32 aClientId, XFCNET_MESSAGE_SLOT aSlot)
00427 {
00428     <span class="keywordflow">return</span> <a class="code" href="classXFuBluetoothNetwork.html#o1">mCommunicationScheduler</a>-&gt;getPacketFrame(aClientId, aSlot);
00429 }
00430 
00431 
<a name="l00432"></a><a class="code" href="classXFuBluetoothNetwork.html#a20">00432</a> XFcObjectDataFrame * <a class="code" href="classXFuBluetoothNetwork.html#a20">XFuBluetoothNetwork::getRecentStateFrame</a>(INT32 aClientId, INT32 aRecentId)
00433 {
00434     <span class="keywordflow">return</span> <a class="code" href="classXFuBluetoothNetwork.html#o1">mCommunicationScheduler</a>-&gt;getRecentStateFrame(aClientId, aRecentId);
00435 }
00436 
00437 
<a name="l00438"></a><a class="code" href="classXFuBluetoothNetwork.html#a21">00438</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothNetwork.html#a21">XFuBluetoothNetwork::removeRecentStateFrame</a>(INT32 aClientId, INT32 aRecentId)
00439 {
00440     <a class="code" href="classXFuBluetoothNetwork.html#o1">mCommunicationScheduler</a>-&gt;removeRecentStateFrame(aClientId, aRecentId);
00441 }
00442 
00443 
<a name="l00444"></a><a class="code" href="classXFuBluetoothNetwork.html#a23">00444</a> INT32 <a class="code" href="classXFuBluetoothNetwork.html#a23">XFuBluetoothNetwork::send</a>(INT32 aClientId, UINT32 aReceiverId, XFCNET_MESSAGE_SLOT aSlot, <a class="code" href="classXFuSerializable.html">XFuSerializable</a> *aSerializable)
00445 {
00446     XFcObjectDataFrame *frame = <a class="code" href="classXFuBluetoothNetwork.html#a19">getPacketFrame</a>(aClientId, aSlot);
00447     INT32 size = -1;
00448     <span class="keywordflow">if</span> (frame)
00449     {
00450 
00451         <span class="keywordtype">void</span> *buffer = frame-&gt;lock();
00452         <span class="keywordflow">if</span> (buffer)
00453         {
00454             size = aSerializable-&gt;<a class="code" href="classXFuSerializable.html#a1">serialize</a>((CHAR8*)buffer, frame-&gt;sizeofBuffer());
00455             <span class="comment">// If size is set to -1 XForge does not send the frame and frame is released.</span>
00456             frame-&gt;setPacketSize(size);
00457             frame-&gt;setReceiverId(aReceiverId);
00458 
00459         }
00460         frame-&gt;unlock();
00461     }
00462     <span class="keywordflow">return</span> size;
00463 }
00464 
00465 
<a name="l00466"></a><a class="code" href="classXFuBluetoothNetwork.html#a24">00466</a> INT32 <a class="code" href="classXFuBluetoothNetwork.html#a24">XFuBluetoothNetwork::sendRecentState</a>(INT32 aClientId, UINT32 aReceiverId, INT32 aRecentId, <a class="code" href="classXFuSerializable.html">XFuSerializable</a> *aSerializable)
00467 {
00468     XFcObjectDataFrame *frame = <a class="code" href="classXFuBluetoothNetwork.html#a20">getRecentStateFrame</a>(aClientId, aRecentId);
00469     INT32 size = -1;
00470 
00471     <span class="keywordflow">if</span> (frame)
00472     {
00473         <span class="keywordtype">void</span> *buffer = frame-&gt;lock();
00474         <span class="keywordflow">if</span> (buffer)
00475         {
00476             size = aSerializable-&gt;<a class="code" href="classXFuSerializable.html#a1">serialize</a>((CHAR8*)buffer, frame-&gt;sizeofBuffer());
00477             frame-&gt;setPacketSize(size);
00478             frame-&gt;setReceiverId(aReceiverId);
00479 
00480         }
00481         frame-&gt;unlock();
00482     }
00483     <span class="keywordflow">return</span> size;
00484 }
00485 
00486 
<a name="l00487"></a><a class="code" href="classXFuBluetoothNetwork.html#a5">00487</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothNetwork.html#a5">XFuBluetoothNetwork::clientLost</a>(INT32 aClientId)
00488 {
00489     <a class="code" href="classXFuBluetoothNetwork.html#a8">removeClient</a>(aClientId);
00490 
00491     INT32 handlersNum = <a class="code" href="classXFuBluetoothNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a2">size</a>();
00492     INT32 i;
00493 
00494     <span class="keywordflow">for</span> (i = 0; i &lt; handlersNum; i++)
00495     {
00496         <a class="code" href="classXFuBluetoothNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a5">get</a>(i)-&gt;<a class="code" href="classXFuNetworkEventHandler.html#a2">handleClientLost</a>(aClientId);
00497     }
00498 }
00499 
00500 
<a name="l00501"></a><a class="code" href="classXFuBluetoothNetwork.html#a18">00501</a> INT <a class="code" href="classXFuBluetoothNetwork.html#a18">XFuBluetoothNetwork::handleSender</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *aAddress, <span class="keyword">const</span> CHAR8 *aData, INT32 aLen)
00502 {
00503     <span class="comment">// Used magic number mAcceptGameToken here.</span>
00504     <span class="comment">// Make sure that gameToken is not addjusted with same value than mAcceptGameToken is.</span>
00505     UINT32 gameToken = ~<a class="code" href="classXFuBluetoothNetwork.html#o11">mAcceptGameToken</a>;
00506 
00507     <span class="keywordflow">if</span> (((XFcAddress *)aAddress)-&gt;getType() == (INT32)XFCNET_AFBT &amp;&amp; aLen == 4)
00508     {
00509         <span class="comment">// Get packet data</span>
00510         memcpy(&amp;gameToken, aData, 4);
00511 
00512         <span class="comment">// Test if packet data is game connect token packet</span>
00513         <span class="keywordflow">if</span> (gameToken == <a class="code" href="classXFuBluetoothNetwork.html#o11">mAcceptGameToken</a>)
00514         {
00515             <span class="keywordflow">if</span> (<a class="code" href="classXFuBluetoothNetwork.html#o9">mClient</a>-&gt;isClientActive() == XFCNET_BT_LINESTATUS_ONHOLD)
00516             {
00517                 <span class="comment">// Accept client connection</span>
00518                 <a class="code" href="classXFuBluetoothNetwork.html#o9">mClient</a>-&gt;acceptConnection(1);
00519 
00520                 INT32 i;
00521                 <span class="keywordflow">for</span> (i = 0; i &lt; (INT32)<a class="code" href="classXFuBluetoothNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a2">size</a>(); i++)
00522                 {
00523                     <span class="comment">// Notify event handler</span>
00524                     <a class="code" href="classXFuBluetoothNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a5">get</a>(i)-&gt;<a class="code" href="classXFuNetworkEventHandler.html#a1">handleClientAccepted</a>(i);
00525 
00526                 } 
00527             }
00528         }
00529     }
00530     <span class="keywordflow">if</span> (((XFcAddress *)aAddress)-&gt;getType() != (INT32)XFCNET_AFBT ||
00531         aLen != 4 ||
00532         gameToken != <a class="code" href="classXFuBluetoothNetwork.html#o11">mAcceptGameToken</a>)
00533     {
00534 
00535         <span class="keywordflow">if</span> (<a class="code" href="classXFuBluetoothNetwork.html#o9">mClient</a>-&gt;isClientActive() == XFCNET_BT_LINESTATUS_ONHOLD)
00536         {
00537             <span class="comment">// Disconnect client</span>
00538             <a class="code" href="classXFuBluetoothNetwork.html#o9">mClient</a>-&gt;acceptConnection(0);
00539 
00540             <span class="comment">// Remove client</span>
00541             <a class="code" href="classXFuBluetoothNetwork.html#a8">removeClient</a>(mClientId);
00542         }
00543     }
00544     <span class="keywordflow">return</span> 0;
00545 }
00546 
00547 
<a name="l00548"></a><a class="code" href="classXFuBluetoothNetwork.html#a31">00548</a> INT <a class="code" href="classXFuBluetoothNetwork.html#a31">XFuBluetoothNetwork::startDeviceDiscovery</a>()
00549 {
00550     <span class="comment">// Stop device discovery</span>
00551     <a class="code" href="classXFuBluetoothNetwork.html#a28">stopDeviceDiscovery</a>();
00552 
00553     <span class="comment">// Delete host resolver</span>
00554     <span class="keywordflow">if</span> (!<a class="code" href="classXFuBluetoothNetwork.html#o7">mHostResolver</a>)
00555         <a class="code" href="classXFuBluetoothNetwork.html#o7">mHostResolver</a> = XFcBtHostResolver::create();
00556 
00557     <span class="comment">// Do the device discovery, async found devices are returned througth deviceDiscovery callback.</span>
00558     <span class="keywordflow">if</span> (mHostResolver)
00559         <span class="keywordflow">return</span> (<a class="code" href="classXFuBluetoothNetwork.html#o7">mHostResolver</a>-&gt;inquiry(<span class="keyword">this</span>) == XFCNET_ERROR) ? 0 : 1;
00560 
00561     <span class="keywordflow">return</span> 0;
00562 }
00563 
00564 
<a name="l00565"></a><a class="code" href="classXFuBluetoothNetwork.html#a28">00565</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothNetwork.html#a28">XFuBluetoothNetwork::stopDeviceDiscovery</a>()
00566 {
00567     <span class="keywordflow">if</span> (mHostResolver)
00568         <a class="code" href="classXFuBluetoothNetwork.html#o7">mHostResolver</a>-&gt;cancelInquiry();
00569 }
00570 
00571 
<a name="l00572"></a><a class="code" href="classXFuBluetoothNetwork.html#a32">00572</a> INT <a class="code" href="classXFuBluetoothNetwork.html#a32">XFuBluetoothNetwork::startServerDiscovery</a>(<span class="keyword">const</span> XFcBtUUID &amp;aUuid, <span class="keyword">const</span> XFcBtAddress *aAddress)
00573 {    
00574     INT retval = 0;
00575     
00576     <span class="keywordflow">if</span> (!<a class="code" href="classXFuBluetoothNetwork.html#o6">mService</a>)
00577         <span class="keywordflow">return</span> 0;
00578 
00579     <a class="code" href="classXFuBluetoothNetwork.html#o13">mUUID</a> = aUuid;
00580     
00581     <span class="keywordflow">if</span> (aAddress)
00582     {
00583         <span class="comment">// Have to fix this.</span>
00584         XFcAdvertiser *advr = NULL;
00585         <span class="keywordflow">if</span> ((advr = XFcBtAdvertiser::create(*aAddress, NULL, 0)) != NULL)
00586             retval = <a class="code" href="classXFuBluetoothNetwork.html#o6">mService</a>-&gt;inquiry(*advr, <span class="keyword">this</span>, &amp;mUUID);
00587         <span class="keyword">delete</span> advr;
00588         <span class="keywordflow">return</span> retval;
00589     }
00590     <span class="keywordflow">else</span>
00591     {
00592         <span class="keyword">delete</span> <a class="code" href="classXFuBluetoothNetwork.html#o5">mBtServerSearch</a>;
00593         <span class="keywordflow">if</span> ((<a class="code" href="classXFuBluetoothNetwork.html#o5">mBtServerSearch</a> = XFcBtServerSearch::create()) != NULL)
00594             <span class="keywordflow">return</span> (<a class="code" href="classXFuBluetoothNetwork.html#o5">mBtServerSearch</a>-&gt;inquiry(<span class="keyword">this</span>, mUUID) == XFCNET_ERROR) ? 0 : 1;
00595     }
00596     <span class="keywordflow">return</span> retval;
00597 }
00598 
00599 
<a name="l00600"></a><a class="code" href="classXFuBluetoothNetwork.html#a29">00600</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothNetwork.html#a29">XFuBluetoothNetwork::stopServerDiscovery</a>()
00601 {   
00602     <span class="keywordflow">if</span> (mService)
00603         <a class="code" href="classXFuBluetoothNetwork.html#o6">mService</a>-&gt;cancelInquiry();
00604 
00605     <span class="keywordflow">if</span> (mBtServerSearch)
00606         <a class="code" href="classXFuBluetoothNetwork.html#o5">mBtServerSearch</a>-&gt;cancelInquiry();
00607 
00608     <span class="keyword">delete</span> <a class="code" href="classXFuBluetoothNetwork.html#o5">mBtServerSearch</a>;
00609     <a class="code" href="classXFuBluetoothNetwork.html#o5">mBtServerSearch</a> = NULL;   
00610 }
00611 
00612 
<a name="l00613"></a><a class="code" href="classXFuBluetoothNetwork.html#a34">00613</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothNetwork.html#a34">XFuBluetoothNetwork::deviceDiscovery</a>(<span class="keyword">const</span> XFcLinkedList&lt;XFcHostEntry *&gt; &amp;aHostEntry)
00614 {
00615     XFcLinkedList&lt;XFcHostEntry *&gt;::forwardIterator it;
00616     INT32 handlersNum = <a class="code" href="classXFuBluetoothNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a2">size</a>();
00617     INT32 i;
00618 
00619     <span class="keywordflow">if</span> (aHostEntry.size() != 0)
00620     {
00621         <span class="keywordflow">for</span> (it = aHostEntry.forwardBegin(); it != aHostEntry.forwardEnd(); it++)
00622         {
00623             <span class="keywordflow">for</span> (i = 0; i &lt; handlersNum; ++i)
00624                 <a class="code" href="classXFuBluetoothNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a5">get</a>(i)-&gt;<a class="code" href="classXFuNetworkEventHandler.html#a3">handleDeviceDiscovered</a>(it.getData());
00625         }
00626     }
00627     <span class="keywordflow">else</span>
00628     {
00629         <span class="keywordflow">for</span> (i = 0; i &lt; handlersNum; ++i)
00630             <a class="code" href="classXFuBluetoothNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a5">get</a>(i)-&gt;<a class="code" href="classXFuNetworkEventHandler.html#a3">handleDeviceDiscovered</a>(NULL);
00631     }
00632 }
00633 
00634 
<a name="l00635"></a><a class="code" href="classXFuBluetoothNetwork.html#a35">00635</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothNetwork.html#a34">XFuBluetoothNetwork::deviceDiscovery</a>(<span class="keyword">const</span> XFcLinkedList&lt;XFcAdvertiser *&gt; &amp;aAdvertiser)
00636 {
00637     XFcLinkedList&lt;XFcAdvertiser *&gt;::forwardIterator it;
00638     INT32 handlersNum = <a class="code" href="classXFuBluetoothNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a2">size</a>();
00639     INT32 i;
00640 
00641     <span class="keywordflow">if</span> (aAdvertiser.size() != 0)
00642     {
00643         <span class="keywordflow">for</span> (it = aAdvertiser.forwardBegin(); it != aAdvertiser.forwardEnd(); it++)
00644         {
00645             <span class="keywordflow">for</span> (i = 0; i &lt; handlersNum; i++)
00646                 <a class="code" href="classXFuBluetoothNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a5">get</a>(i)-&gt;<a class="code" href="classXFuNetworkEventHandler.html#a4">handleAdvertiseDiscovered</a>(it.getData());
00647         }
00648     }
00649     <span class="keywordflow">else</span>
00650     {
00651         <span class="keywordflow">for</span> (i = 0; i &lt; handlersNum; ++i)
00652             <a class="code" href="classXFuBluetoothNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a5">get</a>(i)-&gt;<a class="code" href="classXFuNetworkEventHandler.html#a4">handleAdvertiseDiscovered</a>(NULL);
00653     }
00654 
00655 }
00656 
00657 
<a name="l00658"></a><a class="code" href="classXFuBluetoothNetwork.html#a33">00658</a> INT <a class="code" href="classXFuBluetoothNetwork.html#a33">XFuBluetoothNetwork::startAdvertiser</a>(<span class="keyword">const</span> XFcBtUUID &amp;aUuid, <span class="keyword">const</span> CHAR8 *aMessage)
00659 {    
00660     XFcBtAdvertiser *advertise = NULL;
00661     
00662     <span class="keywordflow">if</span> (!<a class="code" href="classXFuBluetoothNetwork.html#o6">mService</a>)
00663         <span class="keywordflow">return</span> 0;
00664 
00665     <span class="keywordflow">if</span> ((advertise = XFcBtAdvertiser::create()) == NULL)
00666         <span class="keywordflow">return</span> 0;
00667 
00668     <a class="code" href="classXFuBluetoothNetwork.html#o13">mUUID</a> = aUuid;
00669     
00670     <span class="comment">// Create default message if not given any</span>
00671     <span class="keywordflow">if</span> (aMessage == NULL)
00672         advertise-&gt;setMessageHeader(<span class="stringliteral">"X-Forge server"</span>, 14);
00673     <span class="keywordflow">else</span>
00674         advertise-&gt;setMessageHeader(aMessage, strlen(aMessage));
00675 
00676     <span class="comment">// Set game port for advertiser</span>
00677     advertise-&gt;setGamePort(mGamePort);
00678 
00679     advertise-&gt;setAvailability(0xff); <span class="comment">// Fully available.</span>
00680 
00681     INT error = <a class="code" href="classXFuBluetoothNetwork.html#o6">mService</a>-&gt;advertise(*advertise, &amp;mUUID);
00682 
00683     <span class="keyword">delete</span> advertise;
00684 
00685     <span class="keywordflow">return</span> (error == XFCNET_ERROR) ? 0 : 1;
00686     
00687 }
00688 
00689 
<a name="l00690"></a><a class="code" href="classXFuBluetoothNetwork.html#a30">00690</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothNetwork.html#a30">XFuBluetoothNetwork::stopAdvertiser</a>()
00691 {   
00692     <span class="keywordflow">if</span> (!<a class="code" href="classXFuBluetoothNetwork.html#o6">mService</a>)
00693         <span class="keywordflow">return</span>;
00694 
00695     <a class="code" href="classXFuBluetoothNetwork.html#o6">mService</a>-&gt;cancelAdvertise();
00696 }
00697 
00698 
<a name="l00699"></a><a class="code" href="classXFuBluetoothNetwork.html#a36">00699</a> INT <a class="code" href="classXFuBluetoothNetwork.html#a36">XFuBluetoothNetwork::deviceLocalName</a>(XFcName &amp;aName)
00700 {
00701     <span class="comment">// Delete host resolver</span>
00702     <span class="keywordflow">if</span> (!<a class="code" href="classXFuBluetoothNetwork.html#o7">mHostResolver</a>)
00703         <a class="code" href="classXFuBluetoothNetwork.html#o7">mHostResolver</a> = XFcBtHostResolver::create();
00704 
00705     <span class="comment">// Do the device discovery, async found devices are returned througth deviceDiscovery callback.</span>
00706     <span class="keywordflow">if</span> (mHostResolver)
00707     {
00708         INT error = <a class="code" href="classXFuBluetoothNetwork.html#o7">mHostResolver</a>-&gt;localName(aName);
00709 
00710         <span class="keywordflow">if</span> (error != XFCNET_ERROR)
00711         {
00712             <span class="keywordflow">if</span> (aName.mLen &lt; 0x40)
00713                 aName.mName[aName.mLen] = <span class="charliteral">'\0'</span>;
00714 
00715             <span class="keywordflow">return</span> 1;
00716         }
00717     }
00718     <span class="keywordflow">return</span> 0;
00719 }
</pre></div><br clear=all>
<center><table border=0 cellpadding=0 cellspacing=0>
<tr><td colspan=5><img src="paleblue.gif" width=600 height=1></td></tr>
<tr><td>&nbsp;&nbsp;&nbsp;</td><td><a href="http://www.fathammer.com/"><img src="logo.gif" border=0></a></td>
<td valign=bottom><center><font face="arial, helvetica" size="-2" color="#003366">X-Forge Documentation<br>Confidential<br>Copyright &copy; 2002-2003 Fathammer</font></center></td><td>&nbsp;&nbsp;&nbsp;</td>
<td valign=bottom><center><font face="arial, helvetica" size="-2" color="#003366">Documentation generated<br>with <a href="http://www.doxygen.org/index.html">doxygen</a><br>by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a></font></center></td></tr></table>
</body></html>
