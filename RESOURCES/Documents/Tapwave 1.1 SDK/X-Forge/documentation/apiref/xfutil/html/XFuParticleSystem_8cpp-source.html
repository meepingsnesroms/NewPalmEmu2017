<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>XFuParticleSystem.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>XFuParticleSystem.cpp</h1><a href="XFuParticleSystem_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*! \file </span>
00002 <span class="comment"> * X-Forge Util &lt;br&gt;</span>
00003 <span class="comment"> * Copyright 2000-2003 Fathammer Ltd</span>
00004 <span class="comment"> * </span>
00005 <span class="comment"> * \brief Particle system utility</span>
00006 <span class="comment"> * </span>
00007 <span class="comment"> * $Id: XFuParticleSystem.cpp,v 1.15.2.1 2003/12/02 14:34:18 mikko Exp $</span>
00008 <span class="comment"> * $Date: 2003/12/02 14:34:18 $</span>
00009 <span class="comment"> * $Revision: 1.15.2.1 $</span>
00010 <span class="comment"> */</span>
00011 <span class="preprocessor">#include &lt;xfcore/XFcCore.h&gt;</span>
00012 <span class="preprocessor">#include &lt;xfcore/XFcGLTextureFromFile.h&gt;</span>
00013 <span class="preprocessor">#include &lt;<a class="code" href="XFuParticleSystem_8h.html">xfutil/XFuParticleSystem.h</a>&gt;</span>
00014 
00015 <span class="comment">// </span>
00016 <span class="comment">// somewhat long-term TODO:</span>
00017 <span class="comment">// - Get rid of fixed point dependency (compile time or otherwise)</span>
00018 <span class="comment">// - multiple particle system support</span>
00019 <span class="comment">// - lots of other fixes and additions</span>
00020 
00021 <span class="preprocessor">#ifndef PI</span>
<a name="l00022"></a><a class="code" href="XFuParticleSystem_8cpp.html#a0">00022</a> <span class="preprocessor"></span><span class="preprocessor">#define PI 3.1415926535897932384626433832795f</span>
00023 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00024"></a><a class="code" href="XFuParticleSystem_8cpp.html#a1">00024</a> <span class="preprocessor"></span><span class="preprocessor">#define PS_VERSIONTAG 0x03005350</span>
00025 <span class="preprocessor"></span>
<a name="l00026"></a><a class="code" href="classXFuParticleSystem.html#a12">00026</a> <span class="keywordtype">void</span> <a class="code" href="classXFuParticleSystem.html#a12">XFuParticleSystem::PSSeed</a>(INT32 v)
00027 {
00028     INT32 s = v &amp; 31;
00029     INT32 t = v ^ 0x14951C57;
00030     <a class="code" href="classXFuParticleSystem.html#m41">mRandSeed2</a> = (t &gt;&gt; s) + (t &lt;&lt; (32 - s));
00031     s = (v &gt;&gt; 5) &amp; 31;
00032     t = v ^ 0x6C691B25;
00033     <a class="code" href="classXFuParticleSystem.html#m40">mRandSeed1</a> = (t &gt;&gt; s) + (t &lt;&lt; (32 - s));
00034 }
00035 
00036 
00037 <span class="comment">// Sol's rol'n'xor noise function </span>
<a name="l00038"></a><a class="code" href="classXFuParticleSystem.html#a13">00038</a> INT32 <a class="code" href="classXFuParticleSystem.html#a13">XFuParticleSystem::PSRand</a>()
00039 {
00040     INT32 v = <a class="code" href="classXFuParticleSystem.html#m40">mRandSeed1</a>;
00041     mRandSeed1 = ((v &gt;&gt; 13) + (v &lt;&lt; (32 - 13)));  
00042     v = <a class="code" href="classXFuParticleSystem.html#m41">mRandSeed2</a> ^ 0x51549515;
00043     mRandSeed2 = mRandSeed1 ^ mRandSeed2;
00044     mRandSeed1 = v;
00045     <span class="keywordflow">return</span> mRandSeed1;
00046 }
00047 
00048 
<a name="l00049"></a><a class="code" href="classXFuParticleSystem.html#d0">00049</a> INT32 <a class="code" href="classXFuParticleSystem.html#d0">XFuParticleSystem::PSRandInPlace</a>(INT32 aSeed)
00050 {
00051     INT32 randseed1, randseed2;
00052     INT32 s = aSeed &amp; 31;
00053     INT32 t = aSeed ^ 0x14951C57;
00054     randseed2 = (t &gt;&gt; s) + (t &lt;&lt; (32 - s));
00055     s = (aSeed &gt;&gt; 5) &amp; 31;
00056     t = aSeed ^ 0x6C691B25;
00057     aSeed = (t &gt;&gt; s) + (t &lt;&lt; (32 - s));  
00058     randseed1 = ((aSeed &gt;&gt; 13) + (aSeed &lt;&lt; (32 - 13)));  
00059     aSeed = randseed2 ^ 0x51549515;
00060     randseed2 = randseed1 ^ randseed2;
00061     randseed1 = aSeed;
00062     <span class="keywordflow">return</span> randseed1 &amp; 0x7fff;
00063 }
00064 
00065 
<a name="l00066"></a><a class="code" href="classXFuParticleSystem.html#a0">00066</a> <a class="code" href="classXFuParticleSystem.html#a0">XFuParticleSystem::XFuParticleSystem</a>()
00067 {
00068     <a class="code" href="classXFuParticleSystem.html#m32">mFrames</a> = 0;
00069     <a class="code" href="classXFuParticleSystem.html#m33">mFrame</a> = NULL;
00070     <a class="code" href="classXFuParticleSystem.html#m30">mParticle</a> = NULL;
00071     <a class="code" href="classXFuParticleSystem.html#m29">mTexture</a> = NULL;
00072     <a class="code" href="classXFuParticleSystem.html#m36">mCurrentTick</a> = 0;
00073     <a class="code" href="classXFuParticleSystem.html#m12">mViewScale</a> = 1;
00074     <a class="code" href="classXFuParticleSystem.html#m42">mSharedTextures</a> = 0;
00075     <a class="code" href="classXFuParticleSystem.html#a12">PSSeed</a>(0xf00ba517);
00076 }
00077 
00078 
<a name="l00079"></a><a class="code" href="classXFuParticleSystem.html#a2">00079</a> <span class="keywordtype">void</span> <a class="code" href="classXFuParticleSystem.html#a2">XFuParticleSystem::restart</a>() 
00080 {
00081     <a class="code" href="classXFuParticleSystem.html#m34">mStartTick</a> = XFcCore::getTick(); <span class="comment">// TODO: this should be replaced with a parameter</span>
00082     <a class="code" href="classXFuParticleSystem.html#m35">mLastTick</a> = 0;
00083     <a class="code" href="classXFuParticleSystem.html#m31">mActive</a> = 0;
00084     <a class="code" href="classXFuParticleSystem.html#m37">mPeakActive</a> = 0;
00085     <a class="code" href="classXFuParticleSystem.html#m39">mEmitQueue</a> = 0;
00086     <a class="code" href="classXFuParticleSystem.html#m38">mEmitted</a> = 0;
00087     INT32 i;
00088     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="classXFuParticleSystem.html#m10">mMaxVisible</a>; i++)
00089         <a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m9">mAge</a> = -1;
00090     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="classXFuParticleSystem.html#m28">mPreTick</a>; i++)
00091         <a class="code" href="classXFuParticleSystem.html#a4">tickOnce</a>(REALi(1000) / mDesiredFPS);
00092 }
00093 
00094 
<a name="l00095"></a><a class="code" href="classXFuParticleSystem.html#a6">00095</a> <span class="keywordtype">void</span> <a class="code" href="classXFuParticleSystem.html#a6">XFuParticleSystem::setMaxVisible</a>(INT32 aValue) 
00096 {
00097     <span class="keywordflow">if</span> (<a class="code" href="classXFuParticleSystem.html#m30">mParticle</a> != NULL) 
00098         <span class="keyword">delete</span>[] <a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>;
00099     <a class="code" href="classXFuParticleSystem.html#m30">mParticle</a> = <span class="keyword">new</span> <span class="keyword">struct </span><a class="code" href="structXFuParticleSystem_1_1Particle.html">Particle</a>[aValue];
00100     <a class="code" href="classXFuParticleSystem.html#m10">mMaxVisible</a> = aValue;
00101     <a class="code" href="classXFuParticleSystem.html#a2">restart</a>();
00102 }
00103 
00104 
<a name="l00105"></a><a class="code" href="classXFuParticleSystem.html#a1">00105</a> <a class="code" href="classXFuParticleSystem.html#a1">XFuParticleSystem::~XFuParticleSystem</a>()
00106 {
00107     <span class="keywordflow">if</span> (<a class="code" href="classXFuParticleSystem.html#m32">mFrames</a> &gt; 0)
00108     {
00109         INT32 i;
00110         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="classXFuParticleSystem.html#m32">mFrames</a>; i++)
00111         {
00112             <span class="keywordflow">if</span> (!<a class="code" href="classXFuParticleSystem.html#m42">mSharedTextures</a>)
00113                 <span class="keyword">delete</span> <a class="code" href="classXFuParticleSystem.html#m33">mFrame</a>[i];
00114             <span class="keyword">delete</span>[] <a class="code" href="classXFuParticleSystem.html#m29">mTexture</a>[i]; 
00115         }
00116         <span class="keyword">delete</span>[] <a class="code" href="classXFuParticleSystem.html#m33">mFrame</a>;
00117         <span class="keyword">delete</span>[] <a class="code" href="classXFuParticleSystem.html#m29">mTexture</a>;
00118     }
00119     <span class="keywordflow">if</span> (<a class="code" href="classXFuParticleSystem.html#m30">mParticle</a> != NULL) 
00120         <span class="keyword">delete</span>[] <a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>;
00121 }
00122 
00123 
00124 <span class="comment">// TODO: get rid of fixed point dependency (at compile time, or always)</span>
<a name="l00125"></a><a class="code" href="classXFuNoiseController.html#a0">00125</a> XFcFixed <a class="code" href="classXFuNoiseController.html#a0">XFuNoiseController::noise</a>(INT32 aTick, <a class="code" href="classXFuParticleSystem.html">XFuParticleSystem</a> *ps)
00126 {    
00127     <span class="keywordflow">if</span> (<a class="code" href="classXFuNoiseController.html#m0">mType</a> == 0) <span class="keywordflow">return</span> 0; <span class="comment">// no noise</span>
00128     XFcFixed t;<span class="comment">// = REAL(tick);  </span>
00129     t.setValue(aTick &lt;&lt; (XFCFIXED_SHIFT - 10)); 
00130   
00131     <span class="comment">// If noise period is zero, consider it completely random:</span>
00132     <span class="keywordflow">if</span> (<a class="code" href="classXFuNoiseController.html#m2">mPeriod</a> == 0) 
00133     {
00134         XFcFixed r; 
00135         r.setValue(((ps-&gt;<a class="code" href="classXFuParticleSystem.html#a13">PSRand</a>() &amp; 8191) - 4096) &lt;&lt; (XFCFIXED_SHIFT - 12));
00136         <span class="keywordflow">return</span> r * <a class="code" href="classXFuNoiseController.html#m1">mValue</a>;
00137     }
00138 
00139     t = t / <a class="code" href="classXFuNoiseController.html#m2">mPeriod</a>;
00140     INT32 v;
00141 
00142     <span class="keywordflow">switch</span> (mType) 
00143     {
00144     <span class="keywordflow">case</span> 1: <span class="comment">// sin</span>
00145         <span class="keywordflow">return</span> XFcMath::sinFast((t * PI) * 2) * <a class="code" href="classXFuNoiseController.html#m1">mValue</a>;
00146     <span class="keywordflow">case</span> 2: <span class="comment">// cos</span>
00147         <span class="keywordflow">return</span> XFcMath::cosFast((t * PI) * 2) * <a class="code" href="classXFuNoiseController.html#m1">mValue</a>;
00148     <span class="keywordflow">case</span> 3: <span class="comment">// triangle1</span>
00149         v = ((((t.getValue() &gt;&gt; (XFCFIXED_SHIFT - 12)) &amp; 4095) - 2048) &lt;&lt; 2);
00150         <span class="keywordflow">if</span> (v &lt; 0) v = -v;
00151         v -= 4096;
00152         t.setValue(v);
00153         <span class="keywordflow">return</span> t * <a class="code" href="classXFuNoiseController.html#m1">mValue</a>;
00154     <span class="keywordflow">case</span> 4: <span class="comment">// triangle2</span>
00155         v = (((((t.getValue() &gt;&gt; (XFCFIXED_SHIFT - 12)) + 1024) &amp; 4095) - 2048) &lt;&lt; 2);
00156         <span class="keywordflow">if</span> (v &lt; 0) v = -v;
00157         v -= 4096;
00158         t.setValue(v);
00159         <span class="keywordflow">return</span> t * mValue;
00160     <span class="keywordflow">case</span> 5: <span class="comment">// random</span>
00161         {
00162             <span class="comment">// please note that the PSRand() noise function has been </span>
00163             <span class="comment">// tailored so that this would work: </span>
00164             <span class="keywordtype">int</span> d = t.getValue() &gt;&gt; (XFCFIXED_SHIFT - 12);
00165             <span class="keywordtype">int</span> s = d &gt;&gt; 12;
00166             d &amp;= 4095;
00167             <span class="keywordtype">int</span> id = 4096 - d;        
00168             <span class="keywordtype">int</span> r1 = ((ps-&gt;<a class="code" href="classXFuParticleSystem.html#d0">PSRandInPlace</a>(s)) * id) &gt;&gt; 14; <span class="comment">// 16384    </span>
00169             <span class="keywordtype">int</span> r2 = ((ps-&gt;<a class="code" href="classXFuParticleSystem.html#d0">PSRandInPlace</a>(s+1)) * d) &gt;&gt; 14;
00170             t.setValue((r1 + r2 - 4096) &lt;&lt; (XFCFIXED_SHIFT - 12));    
00171             <span class="keywordflow">return</span> t * mValue;
00172         }
00173     }
00174     <span class="keywordflow">return</span> 0;
00175 }
00176 
00177 
<a name="l00178"></a><a class="code" href="classXFuParticleSystem.html#a5">00178</a> <span class="keywordtype">void</span> <a class="code" href="classXFuParticleSystem.html#a5">XFuParticleSystem::render</a>(XFcGL * aGL)
00179 {
00180     INT32 cullmode, alphablend, srcblend, tgtblend, shademode, perspcorr;
00181     <span class="comment">// save current GL modes: (note: texture NOT saved)</span>
00182     aGL-&gt;getStateI(XFCGLRS_CULLING, cullmode);
00183     aGL-&gt;getStateI(XFCGLRS_ALPHABLEND, alphablend);
00184     aGL-&gt;getStateI(XFCGLRS_SRCBLEND, srcblend);
00185     aGL-&gt;getStateI(XFCGLRS_TGTBLEND, tgtblend);
00186     aGL-&gt;getStateI(XFCGLRS_SHADING, shademode);
00187     aGL-&gt;getStateI(XFCGLRS_PERSPECTIVECORRECTION, perspcorr);
00188     <span class="comment">// and then set some:</span>
00189     XFcMatrix4 rot;    
00190     aGL-&gt;setStateI(XFCGLRS_CULLING, XFCGLCULL_NONE);    
00191     aGL-&gt;setStateI(XFCGLRS_ALPHABLEND, 1);
00192     aGL-&gt;setStateI(XFCGLRS_SHADING, XFCGLSHADE_MATTE);
00193     aGL-&gt;setStateI(XFCGLRS_PERSPECTIVECORRECTION, 0);
00194 
00195     <span class="keywordflow">switch</span> (mAlphaMode)
00196     {
00197     <span class="keywordflow">case</span> 0: <span class="comment">//none:</span>
00198         aGL-&gt;setStateI(XFCGLRS_SRCBLEND, XFCBLEND_ONE);
00199         aGL-&gt;setStateI(XFCGLRS_TGTBLEND, XFCBLEND_ZERO);
00200         aGL-&gt;setStateI(XFCGLRS_ALPHABLEND, 0);
00201         <span class="keywordflow">break</span>;
00202     <span class="keywordflow">case</span> 1: <span class="comment">//add</span>
00203         aGL-&gt;setStateI(XFCGLRS_SRCBLEND, XFCBLEND_ONE);
00204         aGL-&gt;setStateI(XFCGLRS_TGTBLEND, XFCBLEND_ONE);
00205         <span class="keywordflow">break</span>;
00206     <span class="keywordflow">case</span> 2: <span class="comment">//alpha:</span>
00207         aGL-&gt;setStateI(XFCGLRS_SRCBLEND, XFCBLEND_SRCALPHA);
00208         aGL-&gt;setStateI(XFCGLRS_TGTBLEND, XFCBLEND_INVSRCALPHA);
00209         <span class="keywordflow">break</span>;
00210     <span class="keywordflow">case</span> 3: <span class="comment">//mul: Does not work (fillers not implemented)</span>
00211         aGL-&gt;setStateI(XFCGLRS_SRCBLEND, XFCBLEND_ZERO);
00212         aGL-&gt;setStateI(XFCGLRS_TGTBLEND, XFCBLEND_SRCCOLOR);
00213         <span class="keywordflow">break</span>;
00214     <span class="keywordflow">case</span> 4: <span class="comment">//invmul</span>
00215         aGL-&gt;setStateI(XFCGLRS_SRCBLEND, XFCBLEND_ZERO);
00216         aGL-&gt;setStateI(XFCGLRS_TGTBLEND, XFCBLEND_INVSRCCOLOR);
00217         <span class="keywordflow">break</span>;
00218     }
00219     
00220     <span class="keywordflow">if</span> (<a class="code" href="classXFuParticleSystem.html#m32">mFrames</a> == 0)
00221         aGL-&gt;setTexture(NULL);
00222 
00223     INT32 i;
00224     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="classXFuParticleSystem.html#m10">mMaxVisible</a>; i++) 
00225     {
00226         <span class="keywordflow">if</span> (<a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m9">mAge</a> !=  - 1) 
00227         {
00228             XFcFixed deltaAge = <a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m9">mAge</a> / mParticle[i].mMaxAge;
00229             
00230             <span class="keywordflow">if</span> (<a class="code" href="classXFuParticleSystem.html#m32">mFrames</a> != 0)
00231             {
00232                 <span class="comment">// find current animation frame and select the texture:</span>
00233                 INT32 texture = deltaAge * <a class="code" href="classXFuParticleSystem.html#m32">mFrames</a> + <a class="code" href="classXFuParticleSystem.html#m32">mFrames</a> * <a class="code" href="classXFuParticleSystem.html#m25">mFrameVariation</a>.<a class="code" href="classXFuNoiseController.html#a0">noise</a>(mCurrentTick, <span class="keyword">this</span>);
00234                 <span class="keywordflow">if</span> (texture &lt; 0) texture = 0;
00235                 <span class="keywordflow">if</span> (texture &gt;= <a class="code" href="classXFuParticleSystem.html#m32">mFrames</a>) texture = <a class="code" href="classXFuParticleSystem.html#m32">mFrames</a> - 1;
00236                 aGL-&gt;setTexture(mFrame[texture]);
00237             }            
00238             
00239             XFcFixed size = <a class="code" href="classXFuParticleSystem.html#m19">mParticleSizeStart</a> + deltaAge * (<a class="code" href="classXFuParticleSystem.html#m20">mParticleSizeEnd</a> - <a class="code" href="classXFuParticleSystem.html#m19">mParticleSizeStart</a>);
00240             size += <a class="code" href="classXFuParticleSystem.html#m21">mParticleSizeVariation</a>.<a class="code" href="classXFuNoiseController.html#a0">noise</a>(mCurrentTick, <span class="keyword">this</span>);
00241             size = size * <a class="code" href="classXFuParticleSystem.html#m11">mSizeScale</a> * <a class="code" href="classXFuParticleSystem.html#m12">mViewScale</a>;
00242 
00243             XFcFixed alpha = <a class="code" href="classXFuParticleSystem.html#m16">mAlphaStart</a> + deltaAge * (<a class="code" href="classXFuParticleSystem.html#m17">mAlphaEnd</a> - <a class="code" href="classXFuParticleSystem.html#m16">mAlphaStart</a>);
00244             alpha += <a class="code" href="classXFuParticleSystem.html#m18">mAlphaVariation</a>.<a class="code" href="classXFuNoiseController.html#a0">noise</a>(mCurrentTick, <span class="keyword">this</span>) * 255;
00245             INT32 finalAlpha = alpha;
00246             <span class="keywordflow">if</span> (finalAlpha &gt; 255) finalAlpha = 255;
00247             <span class="keywordflow">if</span> (finalAlpha &lt; 0) finalAlpha = 0;
00248             finalAlpha &lt;&lt;= 24;
00249 
00250             XFcMath::matrixIdentity(rot);
00251             <span class="keywordflow">if</span> (mParticle[i].mAngle != REALi(0))
00252             {
00253                 REAL cosVal = XFcMath::cosFast(mParticle[i].mAngle);
00254                 REAL sinVal = XFcMath::sinFast(mParticle[i].mAngle);
00255                 rot.m[0][0] = cosVal;
00256                 rot.m[0][1] = sinVal;
00257                 rot.m[1][0] = -sinVal;
00258                 rot.m[1][1] = cosVal;
00259             }
00260 
00261             <span class="comment">// draw sprite: </span>
00262             aGL-&gt;drawSprite3dBillboard(mParticle[i].mX * mSizeScale, mParticle[i].mY * mSizeScale, mParticle[i].mZ * mSizeScale, size, size, 0, 0, 1, 1, &amp;rot, 0xffffff | finalAlpha);
00263         }
00264     }
00265     <span class="comment">// restore changed GL states:</span>
00266     aGL-&gt;setStateI(XFCGLRS_CULLING,cullmode);
00267     aGL-&gt;setStateI(XFCGLRS_ALPHABLEND,alphablend);
00268     aGL-&gt;setStateI(XFCGLRS_SRCBLEND,srcblend);
00269     aGL-&gt;setStateI(XFCGLRS_TGTBLEND,tgtblend);
00270     aGL-&gt;setStateI(XFCGLRS_SHADING,shademode);
00271     aGL-&gt;setStateI(XFCGLRS_PERSPECTIVECORRECTION, perspcorr);
00272 }
00273 
00274 
<a name="l00275"></a><a class="code" href="classXFuParticleSystem.html#a11">00275</a> <span class="keywordtype">void</span> <a class="code" href="classXFuParticleSystem.html#a11">XFuParticleSystem::newParticle</a>(<span class="keyword">struct</span> <a class="code" href="structXFuParticleSystem_1_1Particle.html">Particle</a> &amp;aParticle)
00276 {
00277     aParticle.<a class="code" href="structXFuParticleSystem_1_1Particle.html#m9">mAge</a> = 0;
00278     aParticle.<a class="code" href="structXFuParticleSystem_1_1Particle.html#m10">mMaxAge</a> = <a class="code" href="classXFuParticleSystem.html#m7">mMaxAge</a> - ((int)((<a class="code" href="classXFuParticleSystem.html#m8">mAgeVariation</a>.<a class="code" href="classXFuNoiseController.html#a0">noise</a>(mCurrentTick, <span class="keyword">this</span>) + <a class="code" href="classXFuParticleSystem.html#m8">mAgeVariation</a>.<a class="code" href="classXFuNoiseController.html#m1">mValue</a>) * REALi(mMaxAge)));
00279     <span class="keywordflow">if</span> (aParticle.<a class="code" href="structXFuParticleSystem_1_1Particle.html#m10">mMaxAge</a> == 0)
00280         aParticle.<a class="code" href="structXFuParticleSystem_1_1Particle.html#m10">mMaxAge</a> = 1;
00281     aParticle.<a class="code" href="structXFuParticleSystem_1_1Particle.html#m0">mX</a> = aParticle.<a class="code" href="structXFuParticleSystem_1_1Particle.html#m1">mY</a> = aParticle.<a class="code" href="structXFuParticleSystem_1_1Particle.html#m2">mZ</a> = 0;
00282     <span class="keywordflow">if</span> (<a class="code" href="classXFuParticleSystem.html#m26">mEmitterSize</a>[0] != 0)
00283     {
00284         aParticle.<a class="code" href="structXFuParticleSystem_1_1Particle.html#m0">mX</a> = ((<a class="code" href="classXFuParticleSystem.html#a13">PSRand</a>() - 16384) * <a class="code" href="classXFuParticleSystem.html#m26">mEmitterSize</a>[0]) / REALi(16384);
00285     }
00286     <span class="keywordflow">if</span> (<a class="code" href="classXFuParticleSystem.html#m26">mEmitterSize</a>[1] != 0)
00287     {
00288         aParticle.<a class="code" href="structXFuParticleSystem_1_1Particle.html#m1">mY</a> = ((<a class="code" href="classXFuParticleSystem.html#a13">PSRand</a>() - 16384) * <a class="code" href="classXFuParticleSystem.html#m26">mEmitterSize</a>[1]) / REALi(16384);
00289     }
00290     <span class="keywordflow">if</span> (<a class="code" href="classXFuParticleSystem.html#m26">mEmitterSize</a>[2] != 0)
00291     {
00292         aParticle.<a class="code" href="structXFuParticleSystem_1_1Particle.html#m2">mZ</a>=((<a class="code" href="classXFuParticleSystem.html#a13">PSRand</a>() - 16384) * <a class="code" href="classXFuParticleSystem.html#m26">mEmitterSize</a>[2]) / REALi(16384);
00293     }
00294     aParticle.<a class="code" href="structXFuParticleSystem_1_1Particle.html#m11">mUniqueSeed</a> = (<a class="code" href="classXFuParticleSystem.html#a13">PSRand</a>() &amp; 0x7fff);
00295     aParticle.<a class="code" href="structXFuParticleSystem_1_1Particle.html#m3">mXi</a> = (<a class="code" href="classXFuParticleSystem.html#m1">mLaunchVelocity</a>[0] + <a class="code" href="classXFuParticleSystem.html#m2">mLaunchVelocityVar</a>[0].<a class="code" href="classXFuNoiseController.html#a0">noise</a>(mCurrentTick, <span class="keyword">this</span>));
00296     aParticle.<a class="code" href="structXFuParticleSystem_1_1Particle.html#m4">mYi</a> = (<a class="code" href="classXFuParticleSystem.html#m1">mLaunchVelocity</a>[1] + <a class="code" href="classXFuParticleSystem.html#m2">mLaunchVelocityVar</a>[1].<a class="code" href="classXFuNoiseController.html#a0">noise</a>(mCurrentTick, <span class="keyword">this</span>));
00297     aParticle.<a class="code" href="structXFuParticleSystem_1_1Particle.html#m5">mZi</a> = (<a class="code" href="classXFuParticleSystem.html#m1">mLaunchVelocity</a>[2] + <a class="code" href="classXFuParticleSystem.html#m2">mLaunchVelocityVar</a>[2].<a class="code" href="classXFuNoiseController.html#a0">noise</a>(mCurrentTick, <span class="keyword">this</span>));
00298 
00299     aParticle.<a class="code" href="structXFuParticleSystem_1_1Particle.html#m6">mAngle</a> = <a class="code" href="classXFuParticleSystem.html#m24">mRotationNoise</a>.<a class="code" href="classXFuNoiseController.html#a0">noise</a>(mCurrentTick, <span class="keyword">this</span>) * <a class="code" href="XFuParticleSystem_8cpp.html#a0">PI</a>;
00300     aParticle.<a class="code" href="structXFuParticleSystem_1_1Particle.html#m7">mBaseRotation</a> = <a class="code" href="classXFuParticleSystem.html#m22">mRotation</a>;
00301 }
00302 
<a name="l00303"></a><a class="code" href="classXFuParticleSystem.html#a4">00303</a> <span class="keywordtype">void</span> <a class="code" href="classXFuParticleSystem.html#a4">XFuParticleSystem::tickOnce</a>(XFcFixed aTimeSlice)
00304 {    
00305     XFcFixed time = aTimeSlice / 100;
00306     <a class="code" href="classXFuParticleSystem.html#m36">mCurrentTick</a> += aTimeSlice;
00307     <a class="code" href="classXFuParticleSystem.html#m39">mEmitQueue</a> += XFcFixed(aTimeSlice * mLaunchRate) / 1000;
00308     INT32 newones = (INT32)(<a class="code" href="classXFuParticleSystem.html#m39">mEmitQueue</a> - <a class="code" href="classXFuParticleSystem.html#m38">mEmitted</a>);
00309     <span class="keywordflow">if</span> (newones &gt; <a class="code" href="classXFuParticleSystem.html#m10">mMaxVisible</a> * 2) <a class="code" href="classXFuParticleSystem.html#m39">mEmitQueue</a> -= (newones - <a class="code" href="classXFuParticleSystem.html#m10">mMaxVisible</a> * 2);
00310 
00311     INT32 i;
00312     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="classXFuParticleSystem.html#m10">mMaxVisible</a>; i++) 
00313     {
00314         <span class="keywordflow">if</span> (<a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m9">mAge</a> != -1) 
00315         {
00316             <a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m9">mAge</a> += aTimeSlice;
00317             <span class="keywordflow">if</span> (<a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m9">mAge</a> &gt;= <a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m10">mMaxAge</a>) 
00318             {
00319                 <a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m9">mAge</a> = -1;
00320                 <a class="code" href="classXFuParticleSystem.html#m31">mActive</a>--;
00321             }
00322         }
00323         <span class="keywordflow">if</span> (<a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m9">mAge</a> == -1 &amp;&amp; newones &gt; 0 &amp;&amp; (<a class="code" href="classXFuParticleSystem.html#m9">mMaxTotal</a> == 0 || mMaxTotal &gt; <a class="code" href="classXFuParticleSystem.html#m38">mEmitted</a>)) 
00324         {
00325             <a class="code" href="classXFuParticleSystem.html#a11">newParticle</a>(mParticle[i]);
00326             <a class="code" href="classXFuParticleSystem.html#m38">mEmitted</a>++;
00327             newones--;
00328             <a class="code" href="classXFuParticleSystem.html#m31">mActive</a>++;
00329             <span class="keywordflow">if</span> (<a class="code" href="classXFuParticleSystem.html#m37">mPeakActive</a> &lt; <a class="code" href="classXFuParticleSystem.html#m31">mActive</a>) <a class="code" href="classXFuParticleSystem.html#m37">mPeakActive</a> = <a class="code" href="classXFuParticleSystem.html#m31">mActive</a>;
00330         }
00331         <span class="keywordflow">if</span> (<a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m9">mAge</a> !=  - 1) 
00332         {
00333             XFcFixed difx = <a class="code" href="classXFuParticleSystem.html#m4">mWeight</a>[0] + <a class="code" href="classXFuParticleSystem.html#m5">mNoise</a>[0].<a class="code" href="classXFuNoiseController.html#a0">noise</a>(mCurrentTick + mParticle[i].mUniqueSeed, <span class="keyword">this</span>) + -<a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m3">mXi</a> * (1 - <a class="code" href="classXFuParticleSystem.html#m3">mDamping</a>[0]);
00334             XFcFixed dify = mWeight[1] + <a class="code" href="classXFuParticleSystem.html#m5">mNoise</a>[1].<a class="code" href="classXFuNoiseController.html#a0">noise</a>(mCurrentTick + mParticle[i].mUniqueSeed, <span class="keyword">this</span>) + -<a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m4">mYi</a> * (1 - <a class="code" href="classXFuParticleSystem.html#m3">mDamping</a>[1]);
00335             XFcFixed difz = mWeight[2] + <a class="code" href="classXFuParticleSystem.html#m5">mNoise</a>[2].<a class="code" href="classXFuNoiseController.html#a0">noise</a>(mCurrentTick + mParticle[i].mUniqueSeed, <span class="keyword">this</span>) + -<a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m5">mZi</a> * (1 - <a class="code" href="classXFuParticleSystem.html#m3">mDamping</a>[2]);
00336 
00337             <a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m0">mX</a> += <a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m3">mXi</a> * time + (difx / 2) * time * time;
00338             <a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m1">mY</a> += <a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m4">mYi</a> * time + (dify / 2) * time * time;
00339             <a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m2">mZ</a> += <a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m5">mZi</a> * time + (difz / 2) * time * time;
00340         
00341             <a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m3">mXi</a> += difx * time;
00342             <a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m4">mYi</a> += dify * time;
00343             <a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m5">mZi</a> += difz * time;                            
00344 
00345             <span class="keywordflow">if</span> (<a class="code" href="classXFuParticleSystem.html#m27">mAABB</a>[0]!=0 &amp;&amp; XFcMath::abs(mParticle[i].mX) &gt; <a class="code" href="classXFuParticleSystem.html#m27">mAABB</a>[0]) 
00346             {
00347                 <span class="keywordflow">if</span> ((<a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m0">mX</a> &lt; 0 &amp;&amp; <a class="code" href="classXFuParticleSystem.html#m0">mFlags</a> &amp; <a class="code" href="XFuParticleSystem_8h.html#a9a0">XFUPSF_COLLIDER_XMIN</a>) || (<a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m0">mX</a> &gt; 0 &amp;&amp; <a class="code" href="classXFuParticleSystem.html#m0">mFlags</a> &amp; <a class="code" href="XFuParticleSystem_8h.html#a9a3">XFUPSF_COLLIDER_XMAX</a>))
00348                 {
00349                     <a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m3">mXi</a> = -<a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m3">mXi</a>;
00350                     <span class="keywordflow">if</span> (<a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m0">mX</a> &lt; 0)
00351                         <a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m0">mX</a> = -<a class="code" href="classXFuParticleSystem.html#m27">mAABB</a>[0];
00352                     <span class="keywordflow">else</span>
00353                         <a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m0">mX</a> = <a class="code" href="classXFuParticleSystem.html#m27">mAABB</a>[0];
00354                 
00355                 } 
00356                 <span class="keywordflow">else</span>
00357                 {
00358                     <a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m9">mAge</a> = -1;
00359                     <a class="code" href="classXFuParticleSystem.html#m31">mActive</a>--;
00360                 }
00361             }
00362             <span class="keywordflow">if</span> (<a class="code" href="classXFuParticleSystem.html#m27">mAABB</a>[1] != 0 &amp;&amp; XFcMath::abs(mParticle[i].mY) &gt; <a class="code" href="classXFuParticleSystem.html#m27">mAABB</a>[1]) 
00363             {
00364                 <span class="keywordflow">if</span> ((<a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m1">mY</a> &lt; 0 &amp;&amp; <a class="code" href="classXFuParticleSystem.html#m0">mFlags</a> &amp; <a class="code" href="XFuParticleSystem_8h.html#a9a1">XFUPSF_COLLIDER_YMIN</a>) || (<a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m1">mY</a> &gt; 0 &amp;&amp; <a class="code" href="classXFuParticleSystem.html#m0">mFlags</a> &amp; <a class="code" href="XFuParticleSystem_8h.html#a9a4">XFUPSF_COLLIDER_YMAX</a>))
00365                 {
00366                     <a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m4">mYi</a> = -<a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m4">mYi</a>;
00367                     <span class="keywordflow">if</span> (<a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m1">mY</a> &lt; 0)
00368                         <a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m1">mY</a> = -<a class="code" href="classXFuParticleSystem.html#m27">mAABB</a>[1];
00369                     <span class="keywordflow">else</span>
00370                         <a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m1">mY</a> = <a class="code" href="classXFuParticleSystem.html#m27">mAABB</a>[1];
00371                 
00372                 } 
00373                 <span class="keywordflow">else</span>
00374                 {
00375                     <a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m9">mAge</a> = -1;
00376                     <a class="code" href="classXFuParticleSystem.html#m31">mActive</a>--;
00377                 }
00378             }
00379             <span class="keywordflow">if</span> (<a class="code" href="classXFuParticleSystem.html#m27">mAABB</a>[2] != 0 &amp;&amp; XFcMath::abs(mParticle[i].mZ) &gt; <a class="code" href="classXFuParticleSystem.html#m27">mAABB</a>[2]) 
00380             {
00381                 <span class="keywordflow">if</span> ((<a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m2">mZ</a> &lt; 0 &amp;&amp; <a class="code" href="classXFuParticleSystem.html#m0">mFlags</a> &amp; <a class="code" href="XFuParticleSystem_8h.html#a9a2">XFUPSF_COLLIDER_ZMIN</a>) || (<a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m2">mZ</a> &gt; 0 &amp;&amp; <a class="code" href="classXFuParticleSystem.html#m0">mFlags</a> &amp; <a class="code" href="XFuParticleSystem_8h.html#a9a5">XFUPSF_COLLIDER_ZMAX</a>))
00382                 {
00383                     <a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m5">mZi</a> = -<a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m5">mZi</a>;
00384                     <span class="keywordflow">if</span> (<a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m2">mZ</a> &lt; 0)
00385                         <a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m2">mZ</a> = -<a class="code" href="classXFuParticleSystem.html#m27">mAABB</a>[2];
00386                     <span class="keywordflow">else</span>
00387                         <a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m2">mZ</a> = <a class="code" href="classXFuParticleSystem.html#m27">mAABB</a>[2];
00388                 
00389                 } 
00390                 <span class="keywordflow">else</span>
00391                 {
00392                     <a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m9">mAge</a> = -1;
00393                     <a class="code" href="classXFuParticleSystem.html#m31">mActive</a>--;
00394                 }
00395             }
00396             <a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m6">mAngle</a> += time * (<a class="code" href="classXFuParticleSystem.html#m30">mParticle</a>[i].<a class="code" href="structXFuParticleSystem_1_1Particle.html#m7">mBaseRotation</a> + <a class="code" href="classXFuParticleSystem.html#m23">mRotationVariation</a>.<a class="code" href="classXFuNoiseController.html#a0">noise</a>(mCurrentTick+mParticle[i].mUniqueSeed, <span class="keyword">this</span>));
00397         }
00398     }
00399 }
00400 
00401 
00402 
<a name="l00403"></a><a class="code" href="classXFuParticleSystem.html#a3">00403</a> <span class="keywordtype">void</span> <a class="code" href="classXFuParticleSystem.html#a3">XFuParticleSystem::tick</a>(XFcFixed aTime)
00404 {    
00405     XFcFixed currenttick = aTime;    
00406 
00407     XFcFixed deltatick = currenttick - <a class="code" href="classXFuParticleSystem.html#m35">mLastTick</a>;
00408 
00409     <span class="keywordflow">if</span> (deltatick &gt; 500 || deltatick &lt; 0) 
00410     {
00411         <span class="comment">// if over 500ms, (2 fps), assume we have slept for a while and don't even try to keep up</span>
00412         <span class="comment">// (these particle systems tend to blow up under 4fps in any case)</span>
00413         deltatick = 0;
00414         <a class="code" href="classXFuParticleSystem.html#m35">mLastTick</a> = currenttick;
00415     } 
00416 
00417     deltatick = <a class="code" href="classXFuParticleSystem.html#m13">mTimeScale</a> * deltatick;
00418 
00419     XFcFixed frametime = deltatick;
00420 
00421     <span class="keywordflow">if</span> (<a class="code" href="classXFuParticleSystem.html#m14">mDesiredFPS</a> != 0) 
00422         frametime = (REALi(1000) / <a class="code" href="classXFuParticleSystem.html#m14">mDesiredFPS</a>);
00423   
00424     <span class="keywordflow">if</span> (<a class="code" href="classXFuParticleSystem.html#m14">mDesiredFPS</a> != 0 &amp;&amp; deltatick &lt; frametime) <span class="keywordflow">return</span>;  
00425 
00426     <span class="comment">// accuracy problem here - round-offs of last tick are ignored</span>
00427     <a class="code" href="classXFuParticleSystem.html#m35">mLastTick</a> = currenttick;
00428 
00429     INT32 loops = 1;
00430 
00431     <span class="keywordflow">if</span> (<a class="code" href="classXFuParticleSystem.html#m0">mFlags</a> &amp; <a class="code" href="XFuParticleSystem_8h.html#a9a6">XFUPSF_FORCEITERATIONS</a>) 
00432     {
00433         loops = (INT32)(deltatick / frametime);
00434         deltatick = frametime;
00435         <span class="keywordflow">if</span> (loops &lt; 0) loops = 1;
00436     }
00437  
00438 
00439     <span class="keywordflow">for</span> (; loops; --loops) 
00440     {
00441         <a class="code" href="classXFuParticleSystem.html#a4">tickOnce</a>(deltatick);
00442     }
00443 }
00444 
00445 
<a name="l00446"></a><a class="code" href="classXFuNoiseController.html#a1">00446</a> <span class="keywordtype">void</span> <a class="code" href="classXFuNoiseController.html#a1">XFuNoiseController::write</a>(XFcFile * aFile)
00447 {
00448     aFile-&gt;writeINT32(mType);
00449     aFile-&gt;writeFLOAT32(mPeriod);
00450     aFile-&gt;writeFLOAT32(mValue);
00451 }
00452 
<a name="l00453"></a><a class="code" href="classXFuNoiseController.html#a2">00453</a> <span class="keywordtype">void</span> <a class="code" href="classXFuNoiseController.html#a2">XFuNoiseController::read</a>(XFcFile * aFile)
00454 {
00455     <a class="code" href="classXFuNoiseController.html#m0">mType</a> = aFile-&gt;readINT32();
00456     <a class="code" href="classXFuNoiseController.html#m2">mPeriod</a> = aFile-&gt;readFLOAT32();
00457     <a class="code" href="classXFuNoiseController.html#m1">mValue</a> = aFile-&gt;readFLOAT32();
00458 }
00459 
00460 
<a name="l00461"></a><a class="code" href="classXFuParticleSystem.html#a7">00461</a> <span class="keywordtype">void</span> <a class="code" href="classXFuParticleSystem.html#a7">XFuParticleSystem::save</a>(<span class="keyword">const</span> CHAR *fname)
00462 {
00463     XFcFile * f;
00464     f = XFcFile::open(fname,<span class="stringliteral">"wb"</span>);
00465     INT32 tag = <a class="code" href="XFuParticleSystem_8cpp.html#a1">PS_VERSIONTAG</a>; <span class="comment">// 'PR__' where __ is 00 03</span>
00466     f-&gt;writeINT32(tag);
00467     f-&gt;writeINT32(mFlags);
00468     f-&gt;writeFLOAT32(mLaunchVelocity[0]);
00469     f-&gt;writeFLOAT32(mLaunchVelocity[1]);
00470     f-&gt;writeFLOAT32(mLaunchVelocity[2]);
00471     <a class="code" href="classXFuParticleSystem.html#m2">mLaunchVelocityVar</a>[0].<a class="code" href="classXFuNoiseController.html#a1">write</a>(f);
00472     <a class="code" href="classXFuParticleSystem.html#m2">mLaunchVelocityVar</a>[1].<a class="code" href="classXFuNoiseController.html#a1">write</a>(f);
00473     <a class="code" href="classXFuParticleSystem.html#m2">mLaunchVelocityVar</a>[2].<a class="code" href="classXFuNoiseController.html#a1">write</a>(f);
00474     f-&gt;writeFLOAT32(mDamping[0]);
00475     f-&gt;writeFLOAT32(mDamping[1]);
00476     f-&gt;writeFLOAT32(mDamping[2]);
00477     f-&gt;writeFLOAT32(mWeight[0]);
00478     f-&gt;writeFLOAT32(mWeight[1]);
00479     f-&gt;writeFLOAT32(mWeight[2]);
00480     <a class="code" href="classXFuParticleSystem.html#m5">mNoise</a>[0].<a class="code" href="classXFuNoiseController.html#a1">write</a>(f);
00481     <a class="code" href="classXFuParticleSystem.html#m5">mNoise</a>[1].<a class="code" href="classXFuNoiseController.html#a1">write</a>(f);
00482     <a class="code" href="classXFuParticleSystem.html#m5">mNoise</a>[2].<a class="code" href="classXFuNoiseController.html#a1">write</a>(f);
00483     f-&gt;writeFLOAT32(mLaunchRate);
00484     f-&gt;writeINT32(mMaxAge);
00485     <a class="code" href="classXFuParticleSystem.html#m8">mAgeVariation</a>.<a class="code" href="classXFuNoiseController.html#a1">write</a>(f);
00486     f-&gt;writeINT32(mMaxTotal);
00487     f-&gt;writeINT32(mMaxVisible);
00488     f-&gt;writeFLOAT32(mSizeScale);
00489     f-&gt;writeFLOAT32(mTimeScale);
00490     f-&gt;writeFLOAT32(mDesiredFPS);
00491     f-&gt;writeINT32(mAlphaMode);
00492     f-&gt;writeFLOAT32(mAlphaStart);
00493     f-&gt;writeFLOAT32(mAlphaEnd);
00494     <a class="code" href="classXFuParticleSystem.html#m18">mAlphaVariation</a>.<a class="code" href="classXFuNoiseController.html#a1">write</a>(f);
00495     f-&gt;writeFLOAT32(mParticleSizeStart);
00496     f-&gt;writeFLOAT32(mParticleSizeEnd);
00497     <a class="code" href="classXFuParticleSystem.html#m21">mParticleSizeVariation</a>.<a class="code" href="classXFuNoiseController.html#a1">write</a>(f);
00498     f-&gt;writeFLOAT32(mRotation);
00499     <a class="code" href="classXFuParticleSystem.html#m23">mRotationVariation</a>.<a class="code" href="classXFuNoiseController.html#a1">write</a>(f);
00500     <a class="code" href="classXFuParticleSystem.html#m24">mRotationNoise</a>.<a class="code" href="classXFuNoiseController.html#a1">write</a>(f);
00501     <a class="code" href="classXFuParticleSystem.html#m25">mFrameVariation</a>.<a class="code" href="classXFuNoiseController.html#a1">write</a>(f);
00502     f-&gt;writeFLOAT32(mEmitterSize[0]);
00503     f-&gt;writeFLOAT32(mEmitterSize[1]);
00504     f-&gt;writeFLOAT32(mEmitterSize[2]);
00505     f-&gt;writeFLOAT32(mAABB[0]);
00506     f-&gt;writeFLOAT32(mAABB[1]);
00507     f-&gt;writeFLOAT32(mAABB[2]);
00508     f-&gt;writeINT32(mPreTick);
00509 
00510     <span class="comment">// filenames are encoded as thus: "filename1|filename2|filename3||" &lt;- two |:s end the string</span>
00511 
00512     INT32 i;
00513     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="classXFuParticleSystem.html#m32">mFrames</a>; i++)
00514     {
00515         CHAR * t = <a class="code" href="classXFuParticleSystem.html#m29">mTexture</a>[i];
00516         <span class="keywordflow">while</span> (*t != 0)
00517         {
00518             f-&gt;putChar(*t);
00519             t++;
00520         }
00521         f-&gt;putChar(<span class="charliteral">'|'</span>);
00522     }
00523     f-&gt;putChar(<span class="charliteral">'|'</span>);
00524     f-&gt;putChar(<span class="charliteral">'|'</span>);
00525 
00526     f-&gt;close();
00527 }
00528 
00529 
00530 
00531 <span class="keywordtype">void</span> <a class="code" href="classXFuParticleSystem.html#a8">XFuParticleSystem::load</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *fname)
00532 {
00533     XFcFile *f = XFcFile::open(fname, <span class="stringliteral">"rb"</span>);
00534     <a class="code" href="classXFuParticleSystem.html#a8">load</a>(f);
00535     f-&gt;close();
00536 }
00537 
<a name="l00538"></a><a class="code" href="classXFuParticleSystem.html#a8">00538</a> <span class="keywordtype">void</span> <a class="code" href="classXFuParticleSystem.html#a8">XFuParticleSystem::load</a>(XFcFile *f)
00539 {
00540     <span class="keywordflow">if</span> (f == NULL) <span class="keywordflow">return</span>;
00541     <span class="comment">// load ps3</span>
00542     <span class="keywordtype">int</span> tag = f-&gt;readINT32();
00543     <span class="keywordflow">if</span> (tag != <a class="code" href="XFuParticleSystem_8cpp.html#a1">PS_VERSIONTAG</a>)
00544     {
00545         <span class="comment">// different version</span>
00546     }
00547     <a class="code" href="classXFuParticleSystem.html#m0">mFlags</a> = f-&gt;readINT32();
00548     <a class="code" href="classXFuParticleSystem.html#m1">mLaunchVelocity</a>[0] = f-&gt;readFLOAT32();
00549     <a class="code" href="classXFuParticleSystem.html#m1">mLaunchVelocity</a>[1] = f-&gt;readFLOAT32();
00550     <a class="code" href="classXFuParticleSystem.html#m1">mLaunchVelocity</a>[2] = f-&gt;readFLOAT32();
00551     <a class="code" href="classXFuParticleSystem.html#m2">mLaunchVelocityVar</a>[0].<a class="code" href="classXFuNoiseController.html#a2">read</a>(f);
00552     <a class="code" href="classXFuParticleSystem.html#m2">mLaunchVelocityVar</a>[1].<a class="code" href="classXFuNoiseController.html#a2">read</a>(f);
00553     <a class="code" href="classXFuParticleSystem.html#m2">mLaunchVelocityVar</a>[2].<a class="code" href="classXFuNoiseController.html#a2">read</a>(f);
00554     <a class="code" href="classXFuParticleSystem.html#m3">mDamping</a>[0] = f-&gt;readFLOAT32();
00555     <a class="code" href="classXFuParticleSystem.html#m3">mDamping</a>[1] = f-&gt;readFLOAT32();
00556     <a class="code" href="classXFuParticleSystem.html#m3">mDamping</a>[2] = f-&gt;readFLOAT32();
00557     <a class="code" href="classXFuParticleSystem.html#m4">mWeight</a>[0] = f-&gt;readFLOAT32();
00558     <a class="code" href="classXFuParticleSystem.html#m4">mWeight</a>[1] = f-&gt;readFLOAT32();
00559     <a class="code" href="classXFuParticleSystem.html#m4">mWeight</a>[2] = f-&gt;readFLOAT32();
00560     <a class="code" href="classXFuParticleSystem.html#m5">mNoise</a>[0].<a class="code" href="classXFuNoiseController.html#a2">read</a>(f);
00561     <a class="code" href="classXFuParticleSystem.html#m5">mNoise</a>[1].<a class="code" href="classXFuNoiseController.html#a2">read</a>(f);
00562     <a class="code" href="classXFuParticleSystem.html#m5">mNoise</a>[2].<a class="code" href="classXFuNoiseController.html#a2">read</a>(f);
00563     <a class="code" href="classXFuParticleSystem.html#m6">mLaunchRate</a> = f-&gt;readFLOAT32();
00564     <a class="code" href="classXFuParticleSystem.html#m7">mMaxAge</a> = f-&gt;readINT32();
00565     <a class="code" href="classXFuParticleSystem.html#m8">mAgeVariation</a>.<a class="code" href="classXFuNoiseController.html#a2">read</a>(f);
00566     <a class="code" href="classXFuParticleSystem.html#m9">mMaxTotal</a> = f-&gt;readINT32();
00567     <a class="code" href="classXFuParticleSystem.html#m10">mMaxVisible</a> = f-&gt;readINT32();
00568     <a class="code" href="classXFuParticleSystem.html#m11">mSizeScale</a> = f-&gt;readFLOAT32();
00569     <a class="code" href="classXFuParticleSystem.html#m13">mTimeScale</a> = f-&gt;readFLOAT32();
00570     <a class="code" href="classXFuParticleSystem.html#m14">mDesiredFPS</a> = f-&gt;readFLOAT32();
00571     <a class="code" href="classXFuParticleSystem.html#m15">mAlphaMode</a> = f-&gt;readINT32();
00572     <a class="code" href="classXFuParticleSystem.html#m16">mAlphaStart</a> = f-&gt;readFLOAT32();
00573     <a class="code" href="classXFuParticleSystem.html#m17">mAlphaEnd</a> = f-&gt;readFLOAT32();
00574     <a class="code" href="classXFuParticleSystem.html#m18">mAlphaVariation</a>.<a class="code" href="classXFuNoiseController.html#a2">read</a>(f);
00575     <a class="code" href="classXFuParticleSystem.html#m19">mParticleSizeStart</a> = f-&gt;readFLOAT32();
00576     <a class="code" href="classXFuParticleSystem.html#m20">mParticleSizeEnd</a> = f-&gt;readFLOAT32();
00577     <a class="code" href="classXFuParticleSystem.html#m21">mParticleSizeVariation</a>.<a class="code" href="classXFuNoiseController.html#a2">read</a>(f);
00578     <a class="code" href="classXFuParticleSystem.html#m22">mRotation</a> = f-&gt;readFLOAT32();
00579     <a class="code" href="classXFuParticleSystem.html#m23">mRotationVariation</a>.<a class="code" href="classXFuNoiseController.html#a2">read</a>(f);
00580     <a class="code" href="classXFuParticleSystem.html#m24">mRotationNoise</a>.<a class="code" href="classXFuNoiseController.html#a2">read</a>(f);
00581     <a class="code" href="classXFuParticleSystem.html#m25">mFrameVariation</a>.<a class="code" href="classXFuNoiseController.html#a2">read</a>(f);
00582     <a class="code" href="classXFuParticleSystem.html#m26">mEmitterSize</a>[0] = f-&gt;readFLOAT32();
00583     <a class="code" href="classXFuParticleSystem.html#m26">mEmitterSize</a>[1] = f-&gt;readFLOAT32();
00584     <a class="code" href="classXFuParticleSystem.html#m26">mEmitterSize</a>[2] = f-&gt;readFLOAT32();
00585     <a class="code" href="classXFuParticleSystem.html#m27">mAABB</a>[0] = f-&gt;readFLOAT32();
00586     <a class="code" href="classXFuParticleSystem.html#m27">mAABB</a>[1] = f-&gt;readFLOAT32();
00587     <a class="code" href="classXFuParticleSystem.html#m27">mAABB</a>[2] = f-&gt;readFLOAT32();
00588     <a class="code" href="classXFuParticleSystem.html#m28">mPreTick</a> = f-&gt;readINT32();
00589 
00590     <span class="keywordflow">if</span> (<a class="code" href="classXFuParticleSystem.html#m33">mFrame</a> != NULL)
00591     {
00592         INT32 i;
00593         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="classXFuParticleSystem.html#m32">mFrames</a>; i++)
00594             <span class="keyword">delete</span> <a class="code" href="classXFuParticleSystem.html#m33">mFrame</a>[i];
00595         <span class="keyword">delete</span>[] <a class="code" href="classXFuParticleSystem.html#m33">mFrame</a>;
00596     }
00597     <a class="code" href="classXFuParticleSystem.html#m32">mFrames</a> = 0;  
00598     <a class="code" href="classXFuParticleSystem.html#m33">mFrame</a> = NULL;
00599     CHAR ** temp;
00600     CHAR * tempstr;
00601     temp = <span class="keyword">new</span> CHAR*[256];
00602     tempstr = <span class="keyword">new</span> CHAR[256];
00603     INT32 inchar = f-&gt;getChar();
00604     INT32 idx=0;
00605     <span class="keywordflow">while</span> (inchar != EOF)
00606     {
00607         <span class="keywordflow">if</span> (inchar == <span class="charliteral">'|'</span> &amp;&amp; idx == 0)
00608         {
00609             inchar = EOF;
00610         }
00611         <span class="keywordflow">else</span>
00612         {
00613             <span class="keywordflow">if</span> (inchar == <span class="charliteral">'|'</span>)
00614             {
00615                 tempstr[idx] = 0;
00616                 temp[<a class="code" href="classXFuParticleSystem.html#m32">mFrames</a>] = XFcStringToolkit::copy(tempstr);
00617                 idx = 0;
00618                 <a class="code" href="classXFuParticleSystem.html#m32">mFrames</a>++;
00619             }
00620             <span class="keywordflow">else</span>
00621             {
00622                 tempstr[idx] = (CHAR)inchar;
00623                 idx++;
00624             }
00625             inchar = f-&gt;getChar();
00626         }
00627     }
00628     <span class="keyword">delete</span>[] tempstr;   
00629 
00630     <span class="keywordflow">if</span> (<a class="code" href="classXFuParticleSystem.html#m32">mFrames</a> &gt; 0)
00631     {
00632         <a class="code" href="classXFuParticleSystem.html#m29">mTexture</a> = <span class="keyword">new</span> CHAR*[<a class="code" href="classXFuParticleSystem.html#m32">mFrames</a>];
00633         INT i;
00634         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="classXFuParticleSystem.html#m32">mFrames</a>; i++)
00635             <a class="code" href="classXFuParticleSystem.html#m29">mTexture</a>[i] = temp[i];
00636     }
00637     <span class="keywordflow">else</span>
00638     {
00639         <a class="code" href="classXFuParticleSystem.html#m29">mTexture</a> = NULL;
00640     }
00641     <span class="keyword">delete</span>[] temp;
00642 
00643     <span class="keywordflow">if</span> (<a class="code" href="classXFuParticleSystem.html#m11">mSizeScale</a> == 0) <a class="code" href="classXFuParticleSystem.html#m11">mSizeScale</a> = 1;
00644     <a class="code" href="classXFuParticleSystem.html#a6">setMaxVisible</a>(mMaxVisible); <span class="comment">// calls restart()</span>
00645 }
00646 
00647 
<a name="l00648"></a><a class="code" href="classXFuParticleSystem.html#a10">00648</a> <span class="keywordtype">void</span> <a class="code" href="classXFuParticleSystem.html#a10">XFuParticleSystem::loadTextures</a>(<span class="keyword">const</span> CHAR *aFilenamePrefix)
00649 {
00650     <a class="code" href="classXFuParticleSystem.html#m33">mFrame</a> = <span class="keyword">new</span> XFcGLTexture *[<a class="code" href="classXFuParticleSystem.html#m32">mFrames</a>];
00651     INT32 i;
00652     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="classXFuParticleSystem.html#m32">mFrames</a>; i++)
00653     {
00654         <a class="code" href="classXFuParticleSystem.html#m33">mFrame</a>[i] = NULL;
00655     }
00656 
00657     <span class="keywordflow">for</span> (i = 0; i &lt; mFrames; i++)
00658     {
00659         <span class="keywordflow">if</span> (aFilenamePrefix == NULL)
00660             <a class="code" href="classXFuParticleSystem.html#m33">mFrame</a>[i] = XFcGLTextureFromFile::create(mTexture[i]);
00661         <span class="keywordflow">else</span>
00662         {
00663             CHAR *filename = XFcStringToolkit::concat(aFilenamePrefix, mTexture[i]);
00664             <a class="code" href="classXFuParticleSystem.html#m33">mFrame</a>[i] = XFcGLTextureFromFile::create(filename);
00665             <span class="keyword">delete</span>[] filename;
00666         }
00667     }
00668 }
00669 
</pre></div><br clear=all>
<center><table border=0 cellpadding=0 cellspacing=0>
<tr><td colspan=5><img src="paleblue.gif" width=600 height=1></td></tr>
<tr><td>&nbsp;&nbsp;&nbsp;</td><td><a href="http://www.fathammer.com/"><img src="logo.gif" border=0></a></td>
<td valign=bottom><center><font face="arial, helvetica" size="-2" color="#003366">X-Forge Documentation<br>Confidential<br>Copyright &copy; 2002-2003 Fathammer</font></center></td><td>&nbsp;&nbsp;&nbsp;</td>
<td valign=bottom><center><font face="arial, helvetica" size="-2" color="#003366">Documentation generated<br>with <a href="http://www.doxygen.org/index.html">doxygen</a><br>by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a></font></center></td></tr></table>
</body></html>
