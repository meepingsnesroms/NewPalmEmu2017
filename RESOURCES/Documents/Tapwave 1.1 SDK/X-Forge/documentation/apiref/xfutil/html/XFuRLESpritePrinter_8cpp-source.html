<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>XFuRLESpritePrinter.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>XFuRLESpritePrinter.cpp</h1><a href="XFuRLESpritePrinter_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*! \file </span>
00002 <span class="comment"> * X-Forge Util &lt;br&gt;</span>
00003 <span class="comment"> * Copyright 2000-2003 Fathammer Ltd</span>
00004 <span class="comment"> * </span>
00005 <span class="comment"> * \brief Primitive RLESprite font printer class.</span>
00006 <span class="comment"> * Needs some work (create instead of init; gl sprites instead</span>
00007 <span class="comment"> * of the glsurface drawing currently in use.</span>
00008 <span class="comment"> * </span>
00009 <span class="comment"> * $Id: XFuRLESpritePrinter.cpp,v 1.11 2003/08/12 13:34:08 lars Exp $</span>
00010 <span class="comment"> * $Date: 2003/08/12 13:34:08 $</span>
00011 <span class="comment"> * $Revision: 1.11 $</span>
00012 <span class="comment"> */</span>
00013 
00014 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00015 <span class="preprocessor">#include &lt;xfcore/XFcCore.h&gt;</span>
00016 <span class="preprocessor">#include &lt;<a class="code" href="XFuPrinter_8h.html">xfutil/XFuPrinter.h</a>&gt;</span>
00017 <span class="preprocessor">#include &lt;<a class="code" href="XFuRLESpritePrinter_8h.html">xfutil/XFuRLESpritePrinter.h</a>&gt;</span>
00018 <span class="preprocessor">#include &lt;xfcore/XFcPixelConverter.h&gt;</span>
00019 
00020 
<a name="l00021"></a><a class="code" href="classXFuRLESpritePrinter.html#d0">00021</a> <a class="code" href="classXFuRLESpritePrinter.html">XFuRLESpritePrinter</a> * <a class="code" href="classXFuRLESpritePrinter.html#d0">XFuRLESpritePrinter::create</a>(<span class="keyword">const</span> CHAR *aFname) 
00022 {
00023     <span class="keywordflow">return</span> <a class="code" href="classXFuRLESpritePrinter.html#d0">create</a>(aFname,0xff000000,0x00000000,REALi(1),REALi(1));
00024 }
00025 
<a name="l00026"></a><a class="code" href="classXFuRLESpritePrinter.html#d1">00026</a> <a class="code" href="classXFuRLESpritePrinter.html">XFuRLESpritePrinter</a> * <a class="code" href="classXFuRLESpritePrinter.html#d0">XFuRLESpritePrinter::create</a>(<span class="keyword">const</span> CHAR *aFname, UINT32 aBaseMask, UINT32 aBaseColor)
00027 {
00028     <span class="keywordflow">return</span> <a class="code" href="classXFuRLESpritePrinter.html#d0">create</a>(aFname,aBaseMask,aBaseColor,REALi(1),REALi(1));
00029 }
00030 
<a name="l00031"></a><a class="code" href="classXFuRLESpritePrinter.html#d2">00031</a> <a class="code" href="classXFuRLESpritePrinter.html">XFuRLESpritePrinter</a> * <a class="code" href="classXFuRLESpritePrinter.html#d0">XFuRLESpritePrinter::create</a>(<span class="keyword">const</span> CHAR *aFname, UINT32 aBaseMask, UINT32 aBaseColor, REAL aXScale, REAL aYScale)
00032 {
00033     INT32 wid, ht;
00034     INT32 i;
00035 
00036     XFcGLSurface *img = XFcImageLoader::load(aFname,XFCGF_A8R8G8B8);
00037     <span class="keywordflow">if</span> (img == NULL) <span class="keywordflow">return</span> NULL;
00038 
00039     <a class="code" href="classXFuRLESpritePrinter.html">XFuRLESpritePrinter</a> *p = <span class="keyword">new</span> <a class="code" href="classXFuRLESpritePrinter.html#b0">XFuRLESpritePrinter</a>();
00040 
00041     <span class="keywordflow">if</span> (p == NULL)
00042     {
00043         <span class="keyword">delete</span> img;
00044         <span class="keywordflow">return</span> NULL;
00045     }
00046 
00047     p-&gt;<a class="code" href="classXFuPrinter.html#n2">mLetterSpacing</a> = 2; <span class="comment">// default letter spacing</span>
00048 
00049     wid = img-&gt;getWidth();
00050     ht = img-&gt;getHeight();
00051 
00052     p-&gt;<a class="code" href="classXFuPrinter.html#n3">mLineSpacing</a> = (INT32)(aXScale * (REAL)wid);
00053     p-&gt;<a class="code" href="classXFuPrinter.html#n4">mLineHeight</a> = (INT32)(aYScale * (REAL)wid);
00054 
00055     p-&gt;<a class="code" href="classXFuPrinter.html#n0">mMaxletter</a> = ht / wid;
00056     p-&gt;<a class="code" href="classXFuRLESpritePrinter.html#n0">mLetterSprite</a> = <span class="keyword">new</span> XFcRLESprite *[p-&gt;<a class="code" href="classXFuPrinter.html#n0">mMaxletter</a>];
00057 
00058     <span class="keywordflow">if</span> (p-&gt;<a class="code" href="classXFuRLESpritePrinter.html#n0">mLetterSprite</a> == NULL)
00059     {
00060         <span class="keyword">delete</span> img;
00061         <span class="keyword">delete</span> p;
00062         <span class="keywordflow">return</span> NULL;
00063     }
00064 
00065     XFcGLSurface *tImg = XFcGLSurface::create(wid,wid,XFCGF_A8R8G8B8);
00066 
00067     <span class="keywordflow">if</span> (tImg == NULL)
00068     {
00069         <span class="keyword">delete</span> img;
00070         <span class="keyword">delete</span> p;
00071         <span class="keywordflow">return</span> NULL;
00072     }
00073 
00074     <span class="comment">// init to NULL so that delete wouldn't fail if creation fails</span>
00075     <span class="keywordflow">for</span> (i = 0; i &lt; p-&gt;<a class="code" href="classXFuPrinter.html#n0">mMaxletter</a>; ++i)
00076         p-&gt;<a class="code" href="classXFuRLESpritePrinter.html#n0">mLetterSprite</a>[i] = NULL;
00077 
00078     UINT32 *pic;
00079     INT32 pitch = img-&gt;lock((<span class="keywordtype">void</span> **)(&amp;pic));
00080     <span class="keywordflow">if</span> (pitch == 0)
00081     {
00082         <span class="keyword">delete</span> tImg;
00083         <span class="keyword">delete</span> img;
00084         <span class="keyword">delete</span> p;
00085         <span class="keywordflow">return</span> NULL;
00086     }
00087 
00088     pitch /= 4;
00089     <span class="keywordflow">for</span> (i = 0; i &lt; p-&gt;<a class="code" href="classXFuPrinter.html#n0">mMaxletter</a>; ++i)
00090     {
00091         INT32 letterofs = i * wid * pitch;
00092 
00093         UINT32 *fb;
00094         INT32 tPitch = tImg-&gt;lock((<span class="keywordtype">void</span> **)&amp;fb);
00095         <span class="keywordflow">if</span> (tPitch == 0)
00096         {
00097             <span class="keyword">delete</span> tImg;
00098             img-&gt;unlock();
00099             <span class="keyword">delete</span> img;
00100             <span class="keyword">delete</span> p;
00101             <span class="keywordflow">return</span> NULL;
00102         }
00103         tPitch /= 4;
00104 
00105         INT32 j,k;
00106         <span class="keywordflow">for</span> (j = 0; j &lt; wid; j++)
00107         {
00108             <span class="keywordflow">for</span> (k = 0; k &lt; wid; k++) 
00109             {
00110                 fb[j*tPitch + k] = pic[letterofs + j*pitch + k];
00111             }
00112         }
00113 
00114         tImg-&gt;unlock();
00115 
00116         <span class="keywordflow">if</span> (aXScale != REALi(1) || aYScale != REALi(1))
00117         {
00118             XFcGLSurface *tImg2 = XFcGLSurfaceToolkit::resampleSurface(tImg,aXScale,aYScale);
00119             <span class="keywordflow">if</span> (tImg2)
00120                 p-&gt;<a class="code" href="classXFuRLESpritePrinter.html#n0">mLetterSprite</a>[i] = XFcRLESprite::create(tImg2, aBaseMask, aBaseColor);
00121             <span class="keyword">delete</span> tImg2;
00122         }
00123         <span class="keywordflow">else</span>
00124             p-&gt;<a class="code" href="classXFuRLESpritePrinter.html#n0">mLetterSprite</a>[i] = XFcRLESprite::create(tImg, aBaseMask, aBaseColor);
00125 
00126         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="classXFuRLESpritePrinter.html#n0">mLetterSprite</a>[i] == NULL)
00127         {
00128             <span class="keyword">delete</span> tImg;
00129             img-&gt;unlock();
00130             <span class="keyword">delete</span> img;
00131             <span class="keyword">delete</span> p;
00132             <span class="keywordflow">return</span> NULL;
00133         }
00134         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="classXFuRLESpritePrinter.html#n0">mLetterSprite</a>[i]-&gt;getWidth() == 0)
00135         {
00136             <span class="keyword">delete</span> p-&gt;<a class="code" href="classXFuRLESpritePrinter.html#n0">mLetterSprite</a>[i];
00137             p-&gt;<a class="code" href="classXFuRLESpritePrinter.html#n0">mLetterSprite</a>[i] = NULL;
00138         }
00139         <span class="keywordflow">else</span>
00140         {
00141             p-&gt;<a class="code" href="classXFuRLESpritePrinter.html#n0">mLetterSprite</a>[i]-&gt;setXOffset(0);
00142         }
00143     }
00144     img-&gt;unlock();
00145     <span class="keyword">delete</span> tImg;
00146     <span class="keyword">delete</span> img;
00147 
00148     <span class="keywordflow">if</span> (p-&gt;<a class="code" href="classXFuRLESpritePrinter.html#n0">mLetterSprite</a>[<span class="charliteral">'0'</span> - 33])
00149         p-&gt;<a class="code" href="classXFuPrinter.html#n5">mSpaceWidth</a> = p-&gt;<a class="code" href="classXFuRLESpritePrinter.html#n0">mLetterSprite</a>[<span class="charliteral">'0'</span> - 33]-&gt;getWidth() / 2;
00150     <span class="keywordflow">else</span>
00151         p-&gt;<a class="code" href="classXFuPrinter.html#n5">mSpaceWidth</a> = p-&gt;<a class="code" href="classXFuPrinter.html#n4">mLineHeight</a> / 2;
00152 
00153     <span class="keywordflow">return</span> p;
00154 
00155 }
00156 
00157 
<a name="l00158"></a><a class="code" href="classXFuRLESpritePrinter.html#a0">00158</a> <span class="keywordtype">void</span> <a class="code" href="classXFuRLESpritePrinter.html#a0">XFuRLESpritePrinter::print</a>(XFcGLSurface *aTarget, INT32 aX, INT32 aY, <span class="keyword">const</span> CHAR *aText,
00159                                 INT32 aBlendType, INT32 <span class="comment">/*aBlendValue*/</span>, XFcRectangle *aClipRect)
00160 {
00161     <span class="keywordflow">if</span> (<span class="keyword">this</span> == NULL) <span class="keywordflow">return</span>;
00162     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *p = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)aText;
00163     <span class="keywordtype">int</span> xo = 0;
00164     INT32 i;
00165 
00166     XFcRectangle tRect;
00167     <span class="keywordflow">if</span> (aClipRect == NULL)
00168     {
00169         tRect.mX = 0;
00170         tRect.mY = 0;
00171         tRect.mWidth = aTarget-&gt;getWidth();
00172         tRect.mHeight = aTarget-&gt;getHeight();
00173         aClipRect = &amp;tRect;
00174     }
00175 
00176     <span class="keywordflow">while</span> (*p)
00177     {
00178         <span class="keywordflow">if</span> (*p == 32)
00179         {
00180             xo += <a class="code" href="classXFuPrinter.html#n5">mSpaceWidth</a> + <a class="code" href="classXFuPrinter.html#n2">mLetterSpacing</a>;
00181         }
00182         <span class="keywordflow">else</span>
00183         {
00184             <span class="keywordflow">if</span> (*p == <span class="charliteral">'\n'</span>)
00185             {
00186                 xo = 0;
00187                 aY += <a class="code" href="classXFuPrinter.html#n3">mLineSpacing</a>;
00188             }
00189             <span class="keywordflow">else</span>
00190             {
00191                 i = ((UINT8)*p) - 33;
00192                 <span class="keywordflow">if</span> (i &gt;= 0 &amp;&amp; i &lt; <a class="code" href="classXFuPrinter.html#n0">mMaxletter</a>)
00193                 {
00194                     <span class="keywordflow">if</span> (<a class="code" href="classXFuRLESpritePrinter.html#n0">mLetterSprite</a>[i] != NULL)
00195                     {
00196                         INT32 w = <a class="code" href="classXFuRLESpritePrinter.html#n0">mLetterSprite</a>[i]-&gt;getWidth();
00197                         INT32 xp = aX + xo;
00198                         <span class="keywordflow">switch</span> (aBlendType)
00199                         {
00200                             <span class="keywordflow">case</span> XFCBLEND_NONE:
00201                                 mLetterSprite[i]-&gt;blit(aTarget,aClipRect,xp,aY);
00202                                 <span class="keywordflow">break</span>;
00203                             <span class="keywordflow">case</span> XFCBLEND_MUL:
00204                                 mLetterSprite[i]-&gt;blitMultiplicative(aTarget,aClipRect,xp,aY);
00205                                 <span class="keywordflow">break</span>;
00206                             <span class="keywordflow">case</span> XFCBLEND_ADD:
00207                                 mLetterSprite[i]-&gt;blitAdditive(aTarget,aClipRect,xp,aY);
00208                                 <span class="keywordflow">break</span>;
00209                             <span class="keywordflow">default</span>:
00210                                 mLetterSprite[i]-&gt;blit(aTarget,aClipRect,xp,aY);
00211                                 <span class="keywordflow">break</span>;
00212                         }
00213                         xo += w;
00214                     }
00215                     xo += <a class="code" href="classXFuPrinter.html#n2">mLetterSpacing</a>;
00216                 }
00217             }
00218         }
00219         ++p;
00220     }
00221 }
00222 
00223 
<a name="l00224"></a><a class="code" href="classXFuRLESpritePrinter.html#a1">00224</a> <span class="keywordtype">void</span> <a class="code" href="classXFuRLESpritePrinter.html#a1">XFuRLESpritePrinter::stringMetrics</a>(<span class="keyword">const</span> CHAR *aText, INT32 &amp;aWidth, INT32 &amp;aHeight)
00225 {
00226     <span class="keywordflow">if</span> (aText == NULL)
00227     {
00228         aHeight = 0;
00229         aWidth = 0;
00230         <span class="keywordflow">return</span>;
00231     }
00232     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *p = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)aText;
00233     <span class="keywordtype">int</span> xo = 0, y = 0;
00234     <span class="keywordtype">int</span> maxx = 0;
00235     INT32 i;
00236     <span class="keywordflow">while</span> (*p)
00237     {
00238         <span class="keywordflow">if</span> (*p == 32)
00239         {
00240             xo += <a class="code" href="classXFuPrinter.html#n5">mSpaceWidth</a>;
00241             <span class="keywordflow">if</span> (maxx &lt; xo) maxx = xo;
00242             xo += <a class="code" href="classXFuPrinter.html#n2">mLetterSpacing</a>;
00243         }
00244         <span class="keywordflow">else</span>
00245         {
00246             <span class="keywordflow">if</span> (*p == <span class="charliteral">'\n'</span>)
00247             {
00248                 xo = 0;
00249                 y += <a class="code" href="classXFuPrinter.html#n3">mLineSpacing</a>;
00250             }
00251             <span class="keywordflow">else</span>
00252             {
00253                 i = ((UINT8)*p) - 33;
00254                 <span class="keywordflow">if</span> ( i &gt;= 0 &amp;&amp; i &lt; <a class="code" href="classXFuPrinter.html#n0">mMaxletter</a> )
00255                 {
00256                     <span class="keywordflow">if</span> (<a class="code" href="classXFuRLESpritePrinter.html#n0">mLetterSprite</a>[i])
00257                         xo += <a class="code" href="classXFuRLESpritePrinter.html#n0">mLetterSprite</a>[i]-&gt;getWidth();
00258                     <span class="keywordflow">if</span> (maxx &lt; xo) maxx = xo;
00259                     xo += <a class="code" href="classXFuPrinter.html#n2">mLetterSpacing</a>;
00260                 }
00261             }
00262         }
00263 
00264         ++p;
00265 
00266     }
00267     y += <a class="code" href="classXFuPrinter.html#n4">mLineHeight</a>;
00268     aHeight = y;
00269     aWidth = maxx;
00270 }
00271 
00272 
<a name="l00273"></a><a class="code" href="classXFuRLESpritePrinter.html#a2">00273</a> INT32 <a class="code" href="classXFuRLESpritePrinter.html#a2">XFuRLESpritePrinter:: getCharWidth</a>(CHAR aChar)
00274 {
00275     INT32 i = (INT32)(((UINT8)aChar) - 33);
00276     <span class="keywordflow">if</span> (aChar == 32)
00277         <span class="keywordflow">return</span> <a class="code" href="classXFuPrinter.html#n5">mSpaceWidth</a>;
00278     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i &lt; 0 || i &gt;= <a class="code" href="classXFuPrinter.html#n0">mMaxletter</a> || <a class="code" href="classXFuRLESpritePrinter.html#n0">mLetterSprite</a>[i] == NULL)
00279         <span class="keywordflow">return</span> 0;
00280     <span class="keywordflow">else</span>
00281         <span class="keywordflow">return</span> <a class="code" href="classXFuRLESpritePrinter.html#n0">mLetterSprite</a>[i]-&gt;getWidth();
00282 }
00283 
00284 
<a name="l00285"></a><a class="code" href="classXFuRLESpritePrinter.html#a3">00285</a> <a class="code" href="classXFuRLESpritePrinter.html#a3">XFuRLESpritePrinter::~XFuRLESpritePrinter</a>() 
00286 {
00287     <span class="keywordtype">int</span> i;
00288     <span class="keywordflow">if</span> (mLetterSprite)
00289     {
00290         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="classXFuPrinter.html#n0">mMaxletter</a>; ++i)
00291             <span class="keyword">delete</span> <a class="code" href="classXFuRLESpritePrinter.html#n0">mLetterSprite</a>[i];
00292     }
00293     <span class="keyword">delete</span>[] <a class="code" href="classXFuRLESpritePrinter.html#n0">mLetterSprite</a>;
00294 }
00295 
00296 
<a name="l00297"></a><a class="code" href="classXFuRLESpritePrinter.html#b0">00297</a> <a class="code" href="classXFuRLESpritePrinter.html#b0">XFuRLESpritePrinter::XFuRLESpritePrinter</a>()
00298 {
00299     <a class="code" href="classXFuRLESpritePrinter.html#n0">mLetterSprite</a> = NULL;
00300 }
00301 
</pre></div><br clear=all>
<center><table border=0 cellpadding=0 cellspacing=0>
<tr><td colspan=5><img src="paleblue.gif" width=600 height=1></td></tr>
<tr><td>&nbsp;&nbsp;&nbsp;</td><td><a href="http://www.fathammer.com/"><img src="logo.gif" border=0></a></td>
<td valign=bottom><center><font face="arial, helvetica" size="-2" color="#003366">X-Forge Documentation<br>Confidential<br>Copyright &copy; 2002-2003 Fathammer</font></center></td><td>&nbsp;&nbsp;&nbsp;</td>
<td valign=bottom><center><font face="arial, helvetica" size="-2" color="#003366">Documentation generated<br>with <a href="http://www.doxygen.org/index.html">doxygen</a><br>by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a></font></center></td></tr></table>
</body></html>
