<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>XFuWavLoad.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>XFuWavLoad.cpp</h1><a href="XFuWavLoad_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*! \file </span>
00002 <span class="comment"> * X-Forge Util &lt;br&gt;</span>
00003 <span class="comment"> * Copyright 2000-2003 Fathammer Ltd</span>
00004 <span class="comment"> * </span>
00005 <span class="comment"> * \brief RIFF Wave loader</span>
00006 <span class="comment"> * </span>
00007 <span class="comment"> * $Id: XFuWavLoad.cpp,v 1.8.2.1 2003/12/15 09:26:22 jari Exp $</span>
00008 <span class="comment"> * $Date: 2003/12/15 09:26:22 $</span>
00009 <span class="comment"> * $Revision: 1.8.2.1 $</span>
00010 <span class="comment"> */</span>
00011 
00012 <span class="preprocessor">#include &lt;xfcore/XFcCore.h&gt;</span>
00013 <span class="preprocessor">#include &lt;<a class="code" href="XFuWavLoad_8h.html">xfutil/XFuWavLoad.h</a>&gt;</span>
00014 
00015 
<a name="l00016"></a><a class="code" href="classWavLoaderTempData.html">00016</a> <span class="keyword">class </span><a class="code" href="classWavLoaderTempData.html">WavLoaderTempData</a>
00017 {
00018 <span class="keyword">public</span>:
<a name="l00019"></a><a class="code" href="classWavLoaderTempData.html#m0">00019</a>     XFcFile *<a class="code" href="classWavLoaderTempData.html#m0">mFile</a>;
<a name="l00020"></a><a class="code" href="classWavLoaderTempData.html#m1">00020</a>     INT16 <a class="code" href="classWavLoaderTempData.html#m1">mWavFormat</a>;
<a name="l00021"></a><a class="code" href="classWavLoaderTempData.html#m2">00021</a>     INT16 <a class="code" href="classWavLoaderTempData.html#m2">mChannels</a>;
<a name="l00022"></a><a class="code" href="classWavLoaderTempData.html#m3">00022</a>     INT32 <a class="code" href="classWavLoaderTempData.html#m3">mSamplingRate</a>;
<a name="l00023"></a><a class="code" href="classWavLoaderTempData.html#m4">00023</a>     INT16 <a class="code" href="classWavLoaderTempData.html#m4">mBitsPerSample</a>;
<a name="l00024"></a><a class="code" href="classWavLoaderTempData.html#m5">00024</a>     INT32 <a class="code" href="classWavLoaderTempData.html#m5">mTotalBytes</a>;
<a name="l00025"></a><a class="code" href="classWavLoaderTempData.html#m6">00025</a>     INT32 <a class="code" href="classWavLoaderTempData.html#m6">mTotalSamples</a>;
<a name="l00026"></a><a class="code" href="classWavLoaderTempData.html#m7">00026</a>     <span class="keywordtype">void</span> *<a class="code" href="classWavLoaderTempData.html#m7">mData</a>;
00027 };
00028 
00029 
00030 <span class="comment">// All the formats we're even remotely likely to support here:</span>
00031 <span class="comment">//#define WAVE_FORMAT_PCM         0x0001</span>
00032 <span class="comment">//#define WAVE_FORMAT_ADPCM       0x0002  /*  Microsoft Corporation  */</span>
00033 <span class="comment">//#define WAVE_FORMAT_IEEE_FLOAT  0x0003  /*  Microsoft Corporation  */</span>
00034 <span class="comment">//                                        /*  IEEE754: range (+1, -1]  */</span>
00035 <span class="comment">//                                        /*  32-bit/64-bit format as defined by */</span>
00036 <span class="comment">//                                        /*  MSVC++ float/double type */</span>
00037 <span class="comment">//#define  WAVE_FORMAT_ALAW       0x0006  /*  Microsoft Corporation  */</span>
00038 <span class="comment">//#define  WAVE_FORMAT_MULAW      0x0007  /*  Microsoft Corporation  */</span>
00039 <span class="comment">//#define  WAVE_FORMAT_MPEGLAYER3 0x0055  /*  ISO/MPEG Layer3 Format Tag */</span>
00040 
00041 <span class="comment">// currently this loader only supports 8bit mono PCM data.</span>
00042 
00043 
<a name="l00044"></a><a class="code" href="XFuWavLoad_8cpp.html#a1">00044</a> <span class="keyword">static</span> INT <a class="code" href="XFuWavLoad_8cpp.html#a1">loadHeader</a>(<a class="code" href="classWavLoaderTempData.html">WavLoaderTempData</a> &amp;d)
00045 {
00046     INT32 t; 
00047     INT32 chunkSize;
00048     
00049     d.<a class="code" href="classWavLoaderTempData.html#m0">mFile</a>-&gt;read(&amp;t, 4, 1);
00050     <span class="keywordflow">if</span> (t != 0x46464952) <span class="keywordflow">return</span> 0; <span class="comment">// "RIFF" reversed</span>
00051 
00052     d.<a class="code" href="classWavLoaderTempData.html#m0">mFile</a>-&gt;read(&amp;t, 4, 1); <span class="comment">// skip file len</span>
00053 
00054     d.<a class="code" href="classWavLoaderTempData.html#m0">mFile</a>-&gt;read(&amp;t, 4, 1);
00055     <span class="keywordflow">if</span> (t != 0x45564157) <span class="keywordflow">return</span> 0; <span class="comment">// "WAVE" reversed</span>
00056 
00057     d.<a class="code" href="classWavLoaderTempData.html#m0">mFile</a>-&gt;read(&amp;t, 4, 1);
00058     <span class="keywordflow">if</span> (t != 0x20746d66) <span class="keywordflow">return</span> 0; <span class="comment">// "fmt " reversed</span>
00059 
00060     d.<a class="code" href="classWavLoaderTempData.html#m0">mFile</a>-&gt;read(&amp;chunkSize, 4, 1);
00061 
00062     d.<a class="code" href="classWavLoaderTempData.html#m0">mFile</a>-&gt;read(&amp;d.<a class="code" href="classWavLoaderTempData.html#m1">mWavFormat</a>, 2, 1);
00063     <span class="keywordflow">if</span> (!(d.<a class="code" href="classWavLoaderTempData.html#m1">mWavFormat</a> == 0x0001)) <span class="keywordflow">return</span> 0; <span class="comment">// unsupported format</span>
00064 
00065     d.<a class="code" href="classWavLoaderTempData.html#m0">mFile</a>-&gt;read(&amp;d.<a class="code" href="classWavLoaderTempData.html#m2">mChannels</a>, 2, 1);
00066 
00067     d.<a class="code" href="classWavLoaderTempData.html#m0">mFile</a>-&gt;read(&amp;d.<a class="code" href="classWavLoaderTempData.html#m3">mSamplingRate</a>, 4, 1);
00068 
00069     d.<a class="code" href="classWavLoaderTempData.html#m0">mFile</a>-&gt;read(&amp;t, 4, 1); <span class="comment">// skip "avgbytespersec"</span>
00070 
00071     d.<a class="code" href="classWavLoaderTempData.html#m0">mFile</a>-&gt;read(&amp;t, 2, 1); <span class="comment">// skip "bytespersample"</span>
00072 
00073     d.<a class="code" href="classWavLoaderTempData.html#m0">mFile</a>-&gt;read(&amp;d.<a class="code" href="classWavLoaderTempData.html#m4">mBitsPerSample</a>, 2, 1);
00074 
00075     chunkSize -= 2 + 2 + 4 + 4 + 2 + 2;
00076     
00077     <span class="comment">// skip the rest of the header, if any: </span>
00078     <span class="comment">// (microsoft PCM has 2 more bytes, bits per sample,</span>
00079     <span class="comment">// which we can figure out already)</span>
00080     d.<a class="code" href="classWavLoaderTempData.html#m0">mFile</a>-&gt;seek(d.<a class="code" href="classWavLoaderTempData.html#m0">mFile</a>-&gt;tell() + chunkSize, SEEK_SET);
00081     
00082     <span class="keywordflow">return</span> 1;
00083 }
00084 
00085 <span class="comment">//#define PANIC(x) XFcCore::systemPanic(x);</span>
<a name="l00086"></a><a class="code" href="XFuWavLoad_8cpp.html#a0">00086</a> <span class="preprocessor">#define PANIC(x)</span>
00087 <span class="preprocessor"></span>
<a name="l00088"></a><a class="code" href="XFuWavLoad_8cpp.html#a2">00088</a> XFcAudioBuffer * <a class="code" href="XFuWavLoad_8cpp.html#a3">xfuLoadWav</a>(<span class="keyword">const</span> CHAR *aFilename, UINT32 aFlags)
00089 {
00090     <a class="code" href="classWavLoaderTempData.html">WavLoaderTempData</a> d;
00091     
00092     d.<a class="code" href="classWavLoaderTempData.html#m7">mData</a> = NULL;
00093     d.<a class="code" href="classWavLoaderTempData.html#m0">mFile</a> = XFcFile::open(aFilename, XFCSTR(<span class="stringliteral">"rb"</span>));
00094 
00095     <span class="keywordflow">if</span> (d.<a class="code" href="classWavLoaderTempData.html#m0">mFile</a> == NULL) 
00096     {
00097         <a class="code" href="XFuWavLoad_8cpp.html#a0">PANIC</a>(<span class="stringliteral">"LoadWav:File not found"</span>);
00098         <span class="keywordflow">return</span> NULL;
00099     }
00100 
00101     <span class="keywordflow">if</span> (!<a class="code" href="XFuWavLoad_8cpp.html#a1">loadHeader</a>(d)) 
00102     {
00103         d.<a class="code" href="classWavLoaderTempData.html#m0">mFile</a>-&gt;close();
00104         <a class="code" href="XFuWavLoad_8cpp.html#a0">PANIC</a>(<span class="stringliteral">"LoadWav:Bad header"</span>);
00105         <span class="keywordflow">return</span> NULL;
00106     }
00107 
00108     aFlags &amp;= ~(XFCAUDIO_16BIT | XFCAUDIO_STEREO);
00109 
00110     <span class="keywordflow">if</span> (d.<a class="code" href="classWavLoaderTempData.html#m4">mBitsPerSample</a> == 16) aFlags |= XFCAUDIO_16BIT;
00111     <span class="keywordflow">if</span> (d.<a class="code" href="classWavLoaderTempData.html#m2">mChannels</a> == 2) aFlags |= XFCAUDIO_STEREO;
00112 
00113     INT32 tgtXor = 0;
00114     <span class="keywordflow">if</span> (aFlags &amp; XFCAUDIO_SIGNED)
00115     {
00116         <span class="keywordflow">if</span> (!(aFlags &amp; XFCAUDIO_16BIT)) tgtXor = -128;
00117     }
00118     <span class="keywordflow">else</span>
00119         <span class="keywordflow">if</span> (aFlags &amp; XFCAUDIO_16BIT) tgtXor = -32768;
00120 
00121     XFcAudioBuffer *sndBuf = NULL;
00122     INT dataFound = 0;
00123     INT32 chunkId;
00124     INT32 index = 0;
00125     <span class="comment">// while not end of file</span>
00126     <span class="keywordflow">while</span> (d.<a class="code" href="classWavLoaderTempData.html#m0">mFile</a>-&gt;read(&amp;chunkId, 4, 1) &amp;&amp; !dataFound) 
00127     {
00128         INT32 chunkSize;
00129         d.<a class="code" href="classWavLoaderTempData.html#m0">mFile</a>-&gt;read(&amp;chunkSize, 4, 1);
00130 
00131         <span class="keywordflow">if</span> (chunkId == 0x61746164 &amp;&amp; d.<a class="code" href="classWavLoaderTempData.html#m7">mData</a> == NULL)
00132         {
00133             d.<a class="code" href="classWavLoaderTempData.html#m5">mTotalBytes</a> = chunkSize;
00134             d.<a class="code" href="classWavLoaderTempData.html#m6">mTotalSamples</a> = d.<a class="code" href="classWavLoaderTempData.html#m5">mTotalBytes</a> / (d.<a class="code" href="classWavLoaderTempData.html#m2">mChannels</a> * (d.<a class="code" href="classWavLoaderTempData.html#m4">mBitsPerSample</a> / 8));
00135 
00136             sndBuf = XFcAudioBuffer::create((FLOAT32)d.<a class="code" href="classWavLoaderTempData.html#m3">mSamplingRate</a>, aFlags, d.<a class="code" href="classWavLoaderTempData.html#m6">mTotalSamples</a>, 1.0, 0.5);
00137             if (sndBuf == NULL) 
00138             {
00139                 <a class="code" href="XFuWavLoad_8cpp.html#a0">PANIC</a>(<span class="stringliteral">"LoadWav:Sound buffer alloc failed"</span>);
00140                 d.<a class="code" href="classWavLoaderTempData.html#m0">mFile</a>-&gt;close();
00141                 <span class="keywordflow">return</span> NULL;
00142             }
00143 
00144             dataFound = 1;
00145 
00146             <span class="keywordflow">if</span> (d.<a class="code" href="classWavLoaderTempData.html#m4">mBitsPerSample</a> == 8)     <span class="comment">// Sound is 8-bit</span>
00147             {
00148                 INT8 *buf = (INT8 *)XFcAudio::lock(sndBuf);
00149                 UINT8 value;
00150 
00151                 <span class="keywordflow">if</span> (d.<a class="code" href="classWavLoaderTempData.html#m2">mChannels</a> == 1)   <span class="comment">// Sound is 8-bit mono</span>
00152                 {
00153                     <span class="keywordflow">while</span> (index &lt; d.<a class="code" href="classWavLoaderTempData.html#m6">mTotalSamples</a>)
00154                     {
00155                         d.<a class="code" href="classWavLoaderTempData.html#m0">mFile</a>-&gt;readUINT8(value);
00156                         buf[index] = (INT8)(value ^ tgtXor);
00157                         index++;
00158                     }
00159                 }
00160                 <span class="keywordflow">else</span>    <span class="comment">// Sound is 8-bit stereo</span>
00161                 {
00162                     <span class="keywordflow">while</span> (index &lt; d.<a class="code" href="classWavLoaderTempData.html#m6">mTotalSamples</a>)
00163                     {
00164                         d.<a class="code" href="classWavLoaderTempData.html#m0">mFile</a>-&gt;readUINT8(value);
00165                         buf[(index * 2)] = (INT8)(value ^ tgtXor);
00166 
00167                         d.<a class="code" href="classWavLoaderTempData.html#m0">mFile</a>-&gt;readUINT8(value);
00168                         buf[(index * 2) + 1] = (INT8)(value ^ tgtXor);
00169 
00170                         index++;
00171                     }
00172                 }
00173 
00174                 XFcAudio::unlock(sndBuf);
00175             }
00176             <span class="keywordflow">else</span>    <span class="comment">// Sound is 16-bit</span>
00177             {
00178                 INT16 *buf = (INT16 *)XFcAudio::lock(sndBuf);
00179                 INT16 value;
00180 
00181                 <span class="keywordflow">if</span> (d.<a class="code" href="classWavLoaderTempData.html#m2">mChannels</a> == 1)   <span class="comment">// Sound is 16-bit mono</span>
00182                 {
00183                     <span class="keywordflow">while</span> (index &lt; d.<a class="code" href="classWavLoaderTempData.html#m6">mTotalSamples</a>)
00184                     {
00185                         d.<a class="code" href="classWavLoaderTempData.html#m0">mFile</a>-&gt;readINT16(value);
00186                         buf[index] = (INT16)(value ^ tgtXor);
00187                         index++;
00188                     }
00189                 }
00190                 <span class="keywordflow">else</span>    <span class="comment">// Sound is 16-bit stereo</span>
00191                 {
00192                     <span class="keywordflow">while</span> (index &lt; d.<a class="code" href="classWavLoaderTempData.html#m6">mTotalSamples</a>)
00193                     {
00194                         d.<a class="code" href="classWavLoaderTempData.html#m0">mFile</a>-&gt;readINT16(value);
00195                         buf[(index * 2)] = (INT16)(value ^ tgtXor);
00196 
00197                         d.<a class="code" href="classWavLoaderTempData.html#m0">mFile</a>-&gt;readINT16(value);
00198                         buf[(index * 2) + 1] = (INT16)(value ^ tgtXor);
00199 
00200                         index++;
00201                     }
00202                 }
00203 
00204                 XFcAudio::unlock(sndBuf);
00205             }
00206         }
00207         <span class="keywordflow">else</span>
00208         {
00209             <span class="comment">// skip chunk:</span>
00210             d.<a class="code" href="classWavLoaderTempData.html#m0">mFile</a>-&gt;seek(d.<a class="code" href="classWavLoaderTempData.html#m0">mFile</a>-&gt;tell() + chunkSize, SEEK_SET);
00211         }
00212     }
00213 
00214     d.mFile-&gt;close();
00215 
00216     <span class="keywordflow">if</span> (!dataFound)
00217     {
00218         <a class="code" href="XFuWavLoad_8cpp.html#a0">PANIC</a>(<span class="stringliteral">"LoadWav:No data block"</span>);
00219         <span class="keyword">delete</span> sndBuf;
00220         <span class="keywordflow">return</span> NULL;
00221     }
00222 
00223     <span class="keywordflow">return</span> sndBuf;
00224 }
00225 
00226 
<a name="l00227"></a><a class="code" href="XFuWavLoad_8cpp.html#a3">00227</a> XFcAudioBuffer * <a class="code" href="XFuWavLoad_8cpp.html#a3">xfuLoadWav</a>(<span class="keyword">const</span> CHAR *filename)
00228 {
00229     <span class="keywordflow">return</span> <a class="code" href="XFuWavLoad_8cpp.html#a3">xfuLoadWav</a>(filename, 0);
00230 }
00231 
</pre></div><br clear=all>
<center><table border=0 cellpadding=0 cellspacing=0>
<tr><td colspan=5><img src="paleblue.gif" width=600 height=1></td></tr>
<tr><td>&nbsp;&nbsp;&nbsp;</td><td><a href="http://www.fathammer.com/"><img src="logo.gif" border=0></a></td>
<td valign=bottom><center><font face="arial, helvetica" size="-2" color="#003366">X-Forge Documentation<br>Confidential<br>Copyright &copy; 2002-2003 Fathammer</font></center></td><td>&nbsp;&nbsp;&nbsp;</td>
<td valign=bottom><center><font face="arial, helvetica" size="-2" color="#003366">Documentation generated<br>with <a href="http://www.doxygen.org/index.html">doxygen</a><br>by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a></font></center></td></tr></table>
</body></html>
