<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>XFuConfiguration.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>XFuConfiguration.cpp</h1><a href="XFuConfiguration_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*! \file</span>
00002 <span class="comment"> * X-Forge Util &lt;br&gt;</span>
00003 <span class="comment"> * Copyright 2000-2003 Fathammer Ltd</span>
00004 <span class="comment"> *</span>
00005 <span class="comment"> * \brief XFuConfiguration.cpp is the implementation file for the XFuConfiguration</span>
00006 <span class="comment"> * class. For more information, see XFuConfiguration.h</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * $Id: XFuConfiguration.cpp,v 1.19 2003/09/23 13:33:42 toni Exp $</span>
00009 <span class="comment"> * $Date: 2003/09/23 13:33:42 $</span>
00010 <span class="comment"> * $Revision: 1.19 $</span>
00011 <span class="comment"> */</span>
00012 
00013 <span class="preprocessor">#include &lt;xfcore/XFcCore.h&gt;</span>
00014 <span class="preprocessor">#include &lt;<a class="code" href="XFuConfiguration_8h.html">xfutil/XFuConfiguration.h</a>&gt;</span>
00015 
00016 
<a name="l00017"></a><a class="code" href="classXFuConfiguration.html#d0">00017</a> <a class="code" href="classXFuConfiguration.html">XFuConfiguration</a> * <a class="code" href="classXFuConfiguration.html#d0">XFuConfiguration::create</a>()
00018 {
00019     <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classXFuConfiguration.html">XFuConfiguration</a>;
00020 }
00021 
00022 
<a name="l00023"></a><a class="code" href="classXFuConfiguration.html#d1">00023</a> <a class="code" href="classXFuConfiguration.html">XFuConfiguration</a> * <a class="code" href="classXFuConfiguration.html#d0">XFuConfiguration::create</a>(<span class="keyword">const</span> CHAR *aFilename)
00024 {
00025     <a class="code" href="classXFuConfiguration.html">XFuConfiguration</a> *config = <span class="keyword">new</span> <a class="code" href="classXFuConfiguration.html">XFuConfiguration</a>;
00026     <span class="keywordflow">if</span> (config != NULL)
00027     {
00028         <span class="keywordflow">if</span> (!config-&gt;<a class="code" href="classXFuConfiguration.html#a7">load</a>(aFilename))
00029         {
00030             <span class="keyword">delete</span> config;
00031             <span class="keywordflow">return</span> NULL;
00032         }
00033     }
00034     <span class="keywordflow">return</span> config;
00035 }
00036 
00037 
<a name="l00038"></a><a class="code" href="classXFuConfiguration.html#d2">00038</a> <a class="code" href="classXFuConfiguration.html">XFuConfiguration</a> * <a class="code" href="classXFuConfiguration.html#d0">XFuConfiguration::create</a>(XFcFile *aFile)
00039 {
00040     <a class="code" href="classXFuConfiguration.html">XFuConfiguration</a> *config = <span class="keyword">new</span> <a class="code" href="classXFuConfiguration.html">XFuConfiguration</a>;
00041     <span class="keywordflow">if</span> (config != NULL)
00042     {
00043         <span class="keywordflow">if</span> (!config-&gt;<a class="code" href="classXFuConfiguration.html#a7">load</a>(aFile))
00044         {
00045             <span class="keyword">delete</span> config;
00046             <span class="keywordflow">return</span> NULL;
00047         }
00048     }
00049     <span class="keywordflow">return</span> config;
00050 }
00051 
00052 
<a name="l00053"></a><a class="code" href="classXFuConfiguration.html#a0">00053</a> <a class="code" href="classXFuConfiguration.html#a0">XFuConfiguration::XFuConfiguration</a>() : mProperties(NULL)
00054 {
00055 }
00056 
00057 
<a name="l00058"></a><a class="code" href="classXFuConfiguration.html#a1">00058</a> <a class="code" href="classXFuConfiguration.html#a1">XFuConfiguration::~XFuConfiguration</a>()
00059 {
00060     <a class="code" href="classXFuConfiguration.html#a6">clear</a>();
00061 }
00062 
00063 
<a name="l00064"></a><a class="code" href="classXFuConfiguration.html#a2">00064</a> CHAR * <a class="code" href="classXFuConfiguration.html#a2">XFuConfiguration::get</a>(<span class="keyword">const</span> CHAR *aKey)
00065 {
00066     <span class="keywordflow">if</span> (<a class="code" href="classXFuConfiguration.html#n0">mProperties</a> == NULL) <span class="keywordflow">return</span> NULL;
00067     XFcHashtableIterator&lt;XFuStringKey, void *&gt; it = <a class="code" href="classXFuConfiguration.html#n0">mProperties</a>-&gt;find(<a class="code" href="classXFuStringKey.html">XFuStringKey</a>(aKey));
00068     <span class="keywordflow">return</span> (it.isValid() ? (CHAR *)it.getValue() : NULL);
00069 }
00070 
00071 
<a name="l00072"></a><a class="code" href="classXFuConfiguration.html#a3">00072</a> INT32 <a class="code" href="classXFuConfiguration.html#a3">XFuConfiguration::getINT32</a>(<span class="keyword">const</span> CHAR *aKey)
00073 {
00074     CHAR *value = <a class="code" href="classXFuConfiguration.html#a2">get</a>(aKey);
00075     <span class="keywordflow">if</span> (value == NULL)
00076         <span class="keywordflow">return</span> 0;
00077     <span class="keywordflow">else</span>
00078         <span class="keywordflow">return</span> XFcStringToolkit::toINT32(value);
00079 }
00080 
00081 
<a name="l00082"></a><a class="code" href="classXFuConfiguration.html#a4">00082</a> FLOAT32 <a class="code" href="classXFuConfiguration.html#a4">XFuConfiguration::getFLOAT32</a>(<span class="keyword">const</span> CHAR *aKey)
00083 {
00084     CHAR *value = <a class="code" href="classXFuConfiguration.html#a2">get</a>(aKey);
00085     <span class="keywordflow">if</span> (value == NULL)
00086         <span class="keywordflow">return</span> 0;
00087     <span class="keywordflow">else</span>
00088         <span class="keywordflow">return</span> XFcStringToolkit::toFLOAT32(value);
00089 }
00090 
00091 
<a name="l00092"></a><a class="code" href="classXFuConfiguration.html#a5">00092</a> <span class="keywordtype">void</span> <a class="code" href="classXFuConfiguration.html#a5">XFuConfiguration::put</a>(<span class="keyword">const</span> CHAR *aKey, <span class="keyword">const</span> CHAR *aValue)
00093 {
00094     <span class="keywordflow">if</span> (<a class="code" href="classXFuConfiguration.html#n0">mProperties</a> == NULL || aKey == NULL || aValue == NULL) <span class="keywordflow">return</span>;
00095     CHAR *oldVal = <a class="code" href="classXFuConfiguration.html#a2">get</a>(aKey);
00096     <span class="keywordflow">if</span> (oldVal != NULL)
00097     {
00098         <span class="keyword">delete</span>[] <a class="code" href="classXFuConfiguration.html#a2">get</a>(aKey);
00099         <a class="code" href="classXFuConfiguration.html#n0">mProperties</a>-&gt;remove(<a class="code" href="classXFuStringKey.html">XFuStringKey</a>(aKey));
00100     }
00101     CHAR *val = XFcStringToolkit::copy(aValue);
00102     <a class="code" href="classXFuConfiguration.html#n0">mProperties</a>-&gt;put(<a class="code" href="classXFuStringKey.html">XFuStringKey</a>(aKey), (<span class="keywordtype">void</span> *)val);
00103 }
00104 
00105 
<a name="l00106"></a><a class="code" href="classXFuConfiguration.html#a6">00106</a> <span class="keywordtype">void</span> <a class="code" href="classXFuConfiguration.html#a6">XFuConfiguration::clear</a>()
00107 {
00108     <span class="keywordflow">if</span> (<a class="code" href="classXFuConfiguration.html#n0">mProperties</a> != NULL)
00109     {
00110         XFcHashtableIterator&lt;XFuStringKey, void *&gt; it;
00111         <span class="keywordflow">for</span> (it = <a class="code" href="classXFuConfiguration.html#n0">mProperties</a>-&gt;begin(); it != <a class="code" href="classXFuConfiguration.html#n0">mProperties</a>-&gt;end(); ++it)
00112             <span class="keyword">delete</span>[] (CHAR *)it.getValue();
00113         <span class="keyword">delete</span> <a class="code" href="classXFuConfiguration.html#n0">mProperties</a>;
00114         <a class="code" href="classXFuConfiguration.html#n0">mProperties</a> = NULL;
00115     }
00116 }
00117 
00118 
<a name="l00119"></a><a class="code" href="classXFuConfiguration.html#a8">00119</a> INT <a class="code" href="classXFuConfiguration.html#a7">XFuConfiguration::load</a>(XFcFile *aFile)
00120 {
00121     <span class="keywordflow">if</span> (aFile == NULL)
00122         <span class="keywordflow">return</span> 0;
00123 
00124     <span class="keywordflow">if</span> (<a class="code" href="classXFuConfiguration.html#n0">mProperties</a> == NULL)
00125         <a class="code" href="classXFuConfiguration.html#n0">mProperties</a> = <span class="keyword">new</span> XFcHashtable&lt;XFuStringKey, void *&gt;;
00126     <span class="keywordflow">if</span> (<a class="code" href="classXFuConfiguration.html#n0">mProperties</a> == NULL)
00127         <span class="keywordflow">return</span> 0;
00128 
00129     <span class="comment">// check length of rest of the file</span>
00130     INT32 orgFilePos = aFile-&gt;tell();
00131     aFile-&gt;seek(0, SEEK_END);
00132     INT32 fileLen = aFile-&gt;tell();
00133     aFile-&gt;seek(orgFilePos, SEEK_SET);
00134 
00135     <span class="comment">// read until end of file</span>
00136     <span class="keywordflow">while</span> (aFile-&gt;tell() &lt; fileLen)
00137     {
00138         <span class="comment">// read a line, covert it to 16 bit and remove leading and trailing white spaces</span>
00139         CHAR8 *buffer8 = buffer8 = <a class="code" href="classXFuConfiguration.html#b1">readLine</a>(aFile);
00140         CHAR *buffer = XFcStringToolkit::copy(buffer8);
00141         CHAR *trimmedBuffer = <a class="code" href="classXFuConfiguration.html#b2">strDupTrim</a>(buffer);
00142 
00143         <span class="comment">// parse the line and add the property key and value to the property hashtable</span>
00144         <a class="code" href="classXFuConfiguration.html#b0">processLine</a>(trimmedBuffer);
00145 
00146         <span class="keyword">delete</span>[] trimmedBuffer;
00147         <span class="keyword">delete</span>[] buffer;
00148         <span class="keyword">delete</span>[] buffer8;
00149     }
00150 
00151     <span class="keywordflow">return</span> 1;
00152 }
00153 
00154 
<a name="l00155"></a><a class="code" href="classXFuConfiguration.html#a7">00155</a> INT <a class="code" href="classXFuConfiguration.html#a7">XFuConfiguration::load</a>(<span class="keyword">const</span> CHAR *aFilename)
00156 {
00157     XFcFile *file = XFcFile::open(aFilename, XFCSTR(<span class="stringliteral">"rb"</span>));
00158     <span class="keywordflow">if</span> (file == NULL)
00159         <span class="keywordflow">return</span> 0;
00160 
00161     INT result = <a class="code" href="classXFuConfiguration.html#a7">load</a>(file);
00162    
00163     file-&gt;close();
00164 
00165     <span class="keywordflow">return</span> result;
00166 }
00167 
00168 
<a name="l00169"></a><a class="code" href="classXFuConfiguration.html#b0">00169</a> <span class="keywordtype">void</span> <a class="code" href="classXFuConfiguration.html#b0">XFuConfiguration::processLine</a>(<span class="keyword">const</span> CHAR *aStr)
00170 {
00171     <span class="comment">// valid property definition?</span>
00172     INT32 len = XFcStringToolkit::getLength(aStr);
00173     <span class="keywordflow">if</span> (len &gt; 0 &amp;&amp; aStr[0] != <span class="charliteral">'#'</span>)
00174     {
00175 
00176         <span class="comment">// find the first = char</span>
00177         INT32 valStart = 0;
00178         <span class="keywordflow">while</span> (valStart &lt; len &amp;&amp; aStr[valStart] != <span class="charliteral">'='</span>) valStart++;
00179 
00180         <span class="keywordflow">if</span> (valStart != len &amp;&amp; valStart != 0)
00181         {
00182 
00183             INT32 i, p;
00184 
00185             CHAR * key = <span class="keyword">new</span> CHAR[valStart + 1];
00186 
00187             p = 0;
00188             <span class="keywordflow">for</span> (i = 0; i &lt; valStart; i++) key[p++] = aStr[i];
00189             <span class="comment">// find last non white space char of the key</span>
00190             <span class="keywordflow">do</span> --p; <span class="keywordflow">while</span> (key[p] == <span class="charliteral">' '</span> || key[p] == <span class="charliteral">'\t'</span>);
00191             key[p + 1] = <span class="charliteral">'\0'</span>;
00192             
00193             <span class="comment">// find first non white space char of the value</span>
00194             <span class="keywordflow">do</span> valStart++; <span class="keywordflow">while</span> (aStr[valStart] == <span class="charliteral">' '</span> || aStr[valStart] == <span class="charliteral">'\t'</span>);
00195 
00196             CHAR * val = <span class="keyword">new</span> CHAR[len - valStart + 1];
00197 
00198             p = 0;
00199             <span class="keywordflow">for</span> (i = valStart; i &lt; len; i++) val[p++] = aStr[i];
00200             val[p] = <span class="charliteral">'\0'</span>;
00201 
00202             <a class="code" href="classXFuConfiguration.html#a5">put</a>(key, val);
00203 
00204             <span class="keyword">delete</span>[] key;
00205             <span class="keyword">delete</span>[] val;
00206 
00207         }
00208 
00209     }
00210 }
00211 
00212 
<a name="l00213"></a><a class="code" href="classXFuConfiguration.html#b2">00213</a> CHAR * <a class="code" href="classXFuConfiguration.html#b2">XFuConfiguration::strDupTrim</a>(<span class="keyword">const</span> CHAR *aStr)
00214 {
00215     INT32 len = XFcStringToolkit::getLength(aStr);
00216 
00217     <span class="comment">// find first non white space char</span>
00218     INT32 start = 0;
00219     <span class="keywordflow">while</span> (start &lt; len &amp;&amp; (aStr[start] == <span class="charliteral">' '</span> || aStr[start] == <span class="charliteral">'\t'</span>))
00220         start++;
00221 
00222     <span class="comment">// find last non white space char</span>
00223     INT32 end = len - 1;
00224     <span class="keywordflow">while</span> (end &gt;= 0 &amp;&amp; (aStr[end] == <span class="charliteral">' '</span> || aStr[end] == <span class="charliteral">'\t'</span>))
00225         end--;
00226 
00227     CHAR *buf;
00228     INT32 p = 0;
00229     <span class="keywordflow">if</span> (end == -1)
00230     {
00231         <span class="comment">// only spaces so the result is an empty string</span>
00232         buf = <span class="keyword">new</span> CHAR[1];
00233     }
00234     <span class="keywordflow">else</span>
00235     {
00236         <span class="comment">// copy the chars between the first and the last white space</span>
00237         buf = <span class="keyword">new</span> CHAR[end - start + 2];
00238         INT32 i;
00239         <span class="keywordflow">for</span> (i = start; i &lt;= end; i++) buf[p++] = aStr[i];
00240     }
00241 
00242     buf[p] = <span class="charliteral">'\0'</span>;
00243     <span class="keywordflow">return</span> buf;
00244 }
00245 
00246 
<a name="l00247"></a><a class="code" href="classXFuConfiguration.html#b1">00247</a> CHAR8 * <a class="code" href="classXFuConfiguration.html#b1">XFuConfiguration::readLine</a>(XFcFile *aFile)
00248 {
00249     INT32 currentPos = aFile-&gt;tell();
00250 
00251     INT32 count = 0;
00252     CHAR8 c = 0;
00253 
00254     <span class="comment">// find end of line</span>
00255     <span class="keywordflow">while</span> (c != 10)
00256     {
00257         <span class="keywordflow">if</span> (aFile-&gt;read(&amp;c, <span class="keyword">sizeof</span>(CHAR8), 1) == 0) <span class="keywordflow">break</span>;
00258         count++;
00259     }
00260 
00261     aFile-&gt;seek(currentPos, SEEK_SET);
00262 
00263     <span class="comment">// read until end of line</span>
00264     CHAR8 *buffer = <span class="keyword">new</span> CHAR8[count + 1];
00265     <span class="keywordflow">if</span> (count &gt; 0) aFile-&gt;read(buffer, <span class="keyword">sizeof</span>(CHAR8), count);
00266 
00267     buffer[count] = <span class="charliteral">'\0'</span>;
00268 
00269     <span class="comment">// remove trailing CR and LF</span>
00270     <span class="keywordflow">if</span> (count &gt;= 1 &amp;&amp; buffer[count - 1] == 10) buffer[count - 1] = <span class="charliteral">'\0'</span>;
00271     <span class="keywordflow">if</span> (count &gt;= 2 &amp;&amp; buffer[count - 2] == 13) buffer[count - 2] = <span class="charliteral">'\0'</span>;
00272 
00273     <span class="keywordflow">return</span> buffer;
00274 }
00275 
</pre></div><br clear=all>
<center><table border=0 cellpadding=0 cellspacing=0>
<tr><td colspan=5><img src="paleblue.gif" width=600 height=1></td></tr>
<tr><td>&nbsp;&nbsp;&nbsp;</td><td><a href="http://www.fathammer.com/"><img src="logo.gif" border=0></a></td>
<td valign=bottom><center><font face="arial, helvetica" size="-2" color="#003366">X-Forge Documentation<br>Confidential<br>Copyright &copy; 2002-2003 Fathammer</font></center></td><td>&nbsp;&nbsp;&nbsp;</td>
<td valign=bottom><center><font face="arial, helvetica" size="-2" color="#003366">Documentation generated<br>with <a href="http://www.doxygen.org/index.html">doxygen</a><br>by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a></font></center></td></tr></table>
</body></html>
