<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>XFuXMPlayer.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>XFuXMPlayer.cpp</h1><a href="XFuXMPlayer_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*! \file </span>
00002 <span class="comment"> * X-Forge Util &lt;br&gt;</span>
00003 <span class="comment"> * Copyright 2000-2003 Fathammer Ltd</span>
00004 <span class="comment"> * </span>
00005 <span class="comment"> * \brief XM player.</span>
00006 <span class="comment"> * \todo doxygen comments</span>
00007 <span class="comment"> * \todo Panning envelope support on "key off"</span>
00008 <span class="comment"> * \todo Random waveform support for vibrato and tremolo</span>
00009 <span class="comment"> * \todo Set glissando control -command</span>
00010 <span class="comment"> * </span>
00011 <span class="comment"> * $Id: XFuXMPlayer.cpp,v 1.55 2003/10/10 11:34:51 toni Exp $</span>
00012 <span class="comment"> * $Date: 2003/10/10 11:34:51 $</span>
00013 <span class="comment"> * $Revision: 1.55 $</span>
00014 <span class="comment"> */</span>
00015 
00016 <span class="preprocessor">#include &lt;stdlib.h&gt;</span> <span class="comment">// \ needed for</span>
00017 <span class="preprocessor">#include &lt;stdarg.h&gt;</span> <span class="comment">// / va_args</span>
00018 <span class="preprocessor">#include &lt;xfcore/XFcCore.h&gt;</span>
00019 <span class="preprocessor">#include &lt;xfcore/XFcAudioFlags.h&gt;</span>
00020 <span class="preprocessor">#include &lt;xfcore/XFcLinkedList.h&gt;</span>
00021 <span class="preprocessor">#include &lt;<a class="code" href="XFuXMPlayer_8h.html">xfutil/XFuXMPlayer.h</a>&gt;</span>
00022 <span class="preprocessor">#include &lt;<a class="code" href="XFuXMPlayer__internal_8h.html">xfutil/XFuXMPlayer_internal.h</a>&gt;</span>
00023 <span class="preprocessor">#include &lt;<a class="code" href="XFuXMPlayerEventHandler_8h.html">xfutil/XFuXMPlayerEventHandler.h</a>&gt;</span>
00024 
00025 
<a name="l00026"></a><a class="code" href="XFuXMPlayer_8cpp.html#a10">00026</a> <span class="keyword">const</span> <span class="keyword">static</span> INT32 <a class="code" href="XFuXMPlayer_8cpp.html#a10">linearFrequencyTable</a>[768] =
00027 {
00028     535232,534749,534266,533784,533303,532822,532341,531861,
00029     531381,530902,530423,529944,529466,528988,528511,528034,
00030     527558,527082,526607,526131,525657,525183,524709,524236,
00031     523763,523290,522818,522346,521875,521404,520934,520464,
00032     519994,519525,519057,518588,518121,517653,517186,516720,
00033     516253,515788,515322,514858,514393,513929,513465,513002,
00034     512539,512077,511615,511154,510692,510232,509771,509312,
00035     508852,508393,507934,507476,507018,506561,506104,505647,
00036     505191,504735,504280,503825,503371,502917,502463,502010,
00037     501557,501104,500652,500201,499749,499298,498848,498398,
00038     497948,497499,497050,496602,496154,495706,495259,494812,
00039     494366,493920,493474,493029,492585,492140,491696,491253,
00040     490809,490367,489924,489482,489041,488600,488159,487718,
00041     487278,486839,486400,485961,485522,485084,484647,484210,
00042     483773,483336,482900,482465,482029,481595,481160,480726,
00043     480292,479859,479426,478994,478562,478130,477699,477268,
00044     476837,476407,475977,475548,475119,474690,474262,473834,
00045     473407,472979,472553,472126,471701,471275,470850,470425,
00046     470001,469577,469153,468730,468307,467884,467462,467041,
00047     466619,466198,465778,465358,464938,464518,464099,463681,
00048     463262,462844,462427,462010,461593,461177,460760,460345,
00049     459930,459515,459100,458686,458272,457859,457446,457033,
00050     456621,456209,455797,455386,454975,454565,454155,453745,
00051     453336,452927,452518,452110,451702,451294,450887,450481,
00052     450074,449668,449262,448857,448452,448048,447644,447240,
00053     446836,446433,446030,445628,445226,444824,444423,444022,
00054     443622,443221,442821,442422,442023,441624,441226,440828,
00055     440430,440033,439636,439239,438843,438447,438051,437656,
00056     437261,436867,436473,436079,435686,435293,434900,434508,
00057     434116,433724,433333,432942,432551,432161,431771,431382,
00058     430992,430604,430215,429827,429439,429052,428665,428278,
00059     427892,427506,427120,426735,426350,425965,425581,425197,
00060     424813,424430,424047,423665,423283,422901,422519,422138,
00061     421757,421377,420997,420617,420237,419858,419479,419101,
00062     418723,418345,417968,417591,417214,416838,416462,416086,
00063     415711,415336,414961,414586,414212,413839,413465,413092,
00064     412720,412347,411975,411604,411232,410862,410491,410121,
00065     409751,409381,409012,408643,408274,407906,407538,407170,
00066     406803,406436,406069,405703,405337,404971,404606,404241,
00067     403876,403512,403148,402784,402421,402058,401695,401333,
00068     400970,400609,400247,399886,399525,399165,398805,398445,
00069     398086,397727,397368,397009,396651,396293,395936,395579,
00070     395222,394865,394509,394153,393798,393442,393087,392733,
00071     392378,392024,391671,391317,390964,390612,390259,389907,
00072     389556,389204,388853,388502,388152,387802,387452,387102,
00073     386753,386404,386056,385707,385359,385012,384664,384317,
00074     383971,383624,383278,382932,382587,382242,381897,381552,
00075     381208,380864,380521,380177,379834,379492,379149,378807,
00076     378466,378124,377783,377442,377102,376762,376422,376082,
00077     375743,375404,375065,374727,374389,374051,373714,373377,
00078     373040,372703,372367,372031,371695,371360,371025,370690,
00079     370356,370022,369688,369355,369021,368688,368356,368023,
00080     367691,367360,367028,366697,366366,366036,365706,365376,
00081     365046,364717,364388,364059,363731,363403,363075,362747,
00082     362420,362093,361766,361440,361114,360788,360463,360137,
00083     359813,359488,359164,358840,358516,358193,357869,357547,
00084     357224,356902,356580,356258,355937,355616,355295,354974,
00085     354654,354334,354014,353695,353376,353057,352739,352420,
00086     352103,351785,351468,351150,350834,350517,350201,349885,
00087     349569,349254,348939,348624,348310,347995,347682,347368,
00088     347055,346741,346429,346116,345804,345492,345180,344869,
00089     344558,344247,343936,343626,343316,343006,342697,342388,
00090     342079,341770,341462,341154,340846,340539,340231,339924,
00091     339618,339311,339005,338700,338394,338089,337784,337479,
00092     337175,336870,336566,336263,335959,335656,335354,335051,
00093     334749,334447,334145,333844,333542,333242,332941,332641,
00094     332341,332041,331741,331442,331143,330844,330546,330247,
00095     329950,329652,329355,329057,328761,328464,328168,327872,
00096     327576,327280,326985,326690,326395,326101,325807,325513,
00097     325219,324926,324633,324340,324047,323755,323463,323171,
00098     322879,322588,322297,322006,321716,321426,321136,320846,
00099     320557,320267,319978,319690,319401,319113,318825,318538,
00100     318250,317963,317676,317390,317103,316817,316532,316246,
00101     315961,315676,315391,315106,314822,314538,314254,313971,
00102     313688,313405,313122,312839,312557,312275,311994,311712,
00103     311431,311150,310869,310589,310309,310029,309749,309470,
00104     309190,308911,308633,308354,308076,307798,307521,307243,
00105     306966,306689,306412,306136,305860,305584,305308,305033,
00106     304758,304483,304208,303934,303659,303385,303112,302838,
00107     302565,302292,302019,301747,301475,301203,300931,300660,
00108     300388,300117,299847,299576,299306,299036,298766,298497,
00109     298227,297958,297689,297421,297153,296884,296617,296349,
00110     296082,295815,295548,295281,295015,294749,294483,294217,
00111     293952,293686,293421,293157,292892,292628,292364,292100,
00112     291837,291574,291311,291048,290785,290523,290261,289999,
00113     289737,289476,289215,288954,288693,288433,288173,287913,
00114     287653,287393,287134,286875,286616,286358,286099,285841,
00115     285583,285326,285068,284811,284554,284298,284041,283785,
00116     283529,283273,283017,282762,282507,282252,281998,281743,
00117     281489,281235,280981,280728,280475,280222,279969,279716,
00118     279464,279212,278960,278708,278457,278206,277955,277704,
00119     277453,277203,276953,276703,276453,276204,275955,275706,
00120     275457,275209,274960,274712,274465,274217,273970,273722,
00121     273476,273229,272982,272736,272490,272244,271999,271753,
00122     271508,271263,271018,270774,270530,270286,270042,269798,
00123     269555,269312,269069,268826,268583,268341,268099,267857
00124 };
00125 
00126 
<a name="l00127"></a><a class="code" href="XFuXMPlayer_8cpp.html#a0">00127</a> <span class="preprocessor">#define ABS(x) (((x) &lt; 0) ? -(x) : (x))</span>
00128 <span class="preprocessor"></span>
<a name="l00129"></a><a class="code" href="XFuXMPlayer_8cpp.html#a1">00129</a> <span class="preprocessor">#define interpolateLinear8(ch, val1, val2) \</span>
00130 <span class="preprocessor">    val1 = *((INT8 *)ch.mOffset + (ch.mPointer &gt;&gt; FP_BITS)); \</span>
00131 <span class="preprocessor">    \</span>
00132 <span class="preprocessor">    if ((ch.mPointer + FP_VALUE) &lt; ch.mLength) \</span>
00133 <span class="preprocessor">        val2 = *((INT8 *)ch.mOffset + ((ch.mPointer + FP_VALUE) &gt;&gt; FP_BITS)); \</span>
00134 <span class="preprocessor">    else \</span>
00135 <span class="preprocessor">        val2 = 0;</span>
00136 <span class="preprocessor"></span>
00137 
<a name="l00138"></a><a class="code" href="XFuXMPlayer_8cpp.html#a2">00138</a> <span class="preprocessor">#define interpolateLinear16(ch, val1, val2) \</span>
00139 <span class="preprocessor">    val1 = *((INT16 *)ch.mOffset + (ch.mPointer &gt;&gt; FP_BITS)); \</span>
00140 <span class="preprocessor">    \</span>
00141 <span class="preprocessor">    if ((ch.mPointer + FP_VALUE) &lt; ch.mLength) \</span>
00142 <span class="preprocessor">        val2 = *((INT16 *)ch.mOffset + ((ch.mPointer + FP_VALUE) &gt;&gt; FP_BITS)); \</span>
00143 <span class="preprocessor">    else \</span>
00144 <span class="preprocessor">        val2 = 0;</span>
00145 <span class="preprocessor"></span>
00146 
<a name="l00147"></a><a class="code" href="XFuXMPlayer_8cpp.html#a3">00147</a> <span class="preprocessor">#define interpolateLinearForwardLoop8(ch, val1, val2, temp) \</span>
00148 <span class="preprocessor">    val1 = *((INT8 *)ch.mOffset + (ch.mPointer &gt;&gt; FP_BITS)); \</span>
00149 <span class="preprocessor">    \</span>
00150 <span class="preprocessor">    temp = (ch.mPointer + FP_VALUE); \</span>
00151 <span class="preprocessor">    if ((temp &gt;&gt; FP_BITS) &gt; (ch.mLoopEnd &gt;&gt; FP_BITS)) \</span>
00152 <span class="preprocessor">        temp = ch.mLoopStart + (temp - (ch.mLoopEnd + FP_VALUE)); \</span>
00153 <span class="preprocessor">    \</span>
00154 <span class="preprocessor">    val2 = *((INT8 *)ch.mOffset + (temp &gt;&gt; FP_BITS));</span>
00155 <span class="preprocessor"></span>
00156 
<a name="l00157"></a><a class="code" href="XFuXMPlayer_8cpp.html#a4">00157</a> <span class="preprocessor">#define interpolateLinearForwardLoop16(ch, val1, val2, temp) \</span>
00158 <span class="preprocessor">    val1 = *((INT16 *)ch.mOffset + (ch.mPointer &gt;&gt; FP_BITS)); \</span>
00159 <span class="preprocessor">    \</span>
00160 <span class="preprocessor">    temp = (ch.mPointer + FP_VALUE); \</span>
00161 <span class="preprocessor">    if ((temp &gt;&gt; FP_BITS) &gt; (ch.mLoopEnd &gt;&gt; FP_BITS)) \</span>
00162 <span class="preprocessor">        temp = ch.mLoopStart + (temp - (ch.mLoopEnd + FP_VALUE)); \</span>
00163 <span class="preprocessor">    \</span>
00164 <span class="preprocessor">    val2 = *((INT16 *)ch.mOffset + (temp &gt;&gt; FP_BITS));</span>
00165 <span class="preprocessor"></span>
00166 
<a name="l00167"></a><a class="code" href="XFuXMPlayer_8cpp.html#a5">00167</a> <span class="preprocessor">#define interpolateLinearBidirectionalLoop8(ch, val1, val2, temp) \</span>
00168 <span class="preprocessor">    val1 = *((INT8 *)ch.mOffset + (ch.mPointer &gt;&gt; FP_BITS)); \</span>
00169 <span class="preprocessor">    \</span>
00170 <span class="preprocessor">    temp = (ch.mPointer + FP_VALUE); \</span>
00171 <span class="preprocessor">    if ((temp &gt;&gt; FP_BITS) &gt; (ch.mLoopEnd &gt;&gt; FP_BITS)) \</span>
00172 <span class="preprocessor">        temp = ch.mLoopEnd - (temp - (ch.mLoopEnd + FP_VALUE)); \</span>
00173 <span class="preprocessor">    \</span>
00174 <span class="preprocessor">    val2 = *((INT8 *)ch.mOffset + (temp &gt;&gt; FP_BITS)); \</span>
00175 <span class="preprocessor"></span>
00176 <span class="preprocessor"></span>
<a name="l00177"></a><a class="code" href="XFuXMPlayer_8cpp.html#a6">00177</a> <span class="preprocessor">#define interpolateLinearBidirectionalLoop16(ch, val1, val2, temp) \</span>
00178 <span class="preprocessor">    val1 = *((INT16 *)ch.mOffset + (ch.mPointer &gt;&gt; FP_BITS)); \</span>
00179 <span class="preprocessor">    \</span>
00180 <span class="preprocessor">    temp = (ch.mPointer + FP_VALUE); \</span>
00181 <span class="preprocessor">    if ((temp &gt;&gt; FP_BITS) &gt; (ch.mLoopEnd &gt;&gt; FP_BITS)) \</span>
00182 <span class="preprocessor">        temp = ch.mLoopEnd - (temp - (ch.mLoopEnd + FP_VALUE)); \</span>
00183 <span class="preprocessor">    \</span>
00184 <span class="preprocessor">    val2 = *((INT16 *)ch.mOffset + (temp &gt;&gt; FP_BITS));</span>
00185 <span class="preprocessor"></span>
00186 
<a name="l00187"></a><a class="code" href="XFuXMPlayer_8cpp.html#a7">00187</a> <span class="preprocessor">#define addPointer(ch) \</span>
00188 <span class="preprocessor">    ch.mPointer += ch.mSpeed; \</span>
00189 <span class="preprocessor">    if (ch.mPointer &gt; (ch.mLength - FP_VALUE)) \</span>
00190 <span class="preprocessor">        ch.mIsSample = 0;</span>
00191 <span class="preprocessor"></span>
00192 
<a name="l00193"></a><a class="code" href="XFuXMPlayer_8cpp.html#a8">00193</a> <span class="preprocessor">#define addPointerForwardLoop(ch) \</span>
00194 <span class="preprocessor">    ch.mPointer += ch.mSpeed; \</span>
00195 <span class="preprocessor">    if ((ch.mPointer &gt;&gt; FP_BITS) &gt; (ch.mLoopEnd &gt;&gt; FP_BITS)) \</span>
00196 <span class="preprocessor">        ch.mPointer = ch.mLoopStart + (ch.mPointer - (ch.mLoopEnd + FP_VALUE));</span>
00197 <span class="preprocessor"></span>
00198 
<a name="l00199"></a><a class="code" href="XFuXMPlayer_8cpp.html#a9">00199</a> <span class="preprocessor">#define addPointerBidirectionalLoop(ch) \</span>
00200 <span class="preprocessor">    if (ch.mDirection == 1) \</span>
00201 <span class="preprocessor">    { \</span>
00202 <span class="preprocessor">        ch.mPointer += ch.mSpeed; \</span>
00203 <span class="preprocessor">        \</span>
00204 <span class="preprocessor">        if ((ch.mPointer &gt;&gt; FP_BITS) &gt; (ch.mLoopEnd &gt;&gt; FP_BITS)) \</span>
00205 <span class="preprocessor">        { \</span>
00206 <span class="preprocessor">            ch.mDirection = -1; \</span>
00207 <span class="preprocessor">            ch.mPointer = ch.mLoopEnd - (ch.mPointer - (ch.mLoopEnd + FP_VALUE)); \</span>
00208 <span class="preprocessor">        } \</span>
00209 <span class="preprocessor">    } \</span>
00210 <span class="preprocessor">    else \</span>
00211 <span class="preprocessor">    { \</span>
00212 <span class="preprocessor">        ch.mPointer -= ch.mSpeed; \</span>
00213 <span class="preprocessor">        \</span>
00214 <span class="preprocessor">        if ((ch.mPointer &gt;&gt; FP_BITS) &lt; (ch.mLoopStart &gt;&gt; FP_BITS)) \</span>
00215 <span class="preprocessor">        { \</span>
00216 <span class="preprocessor">            ch.mDirection = 1; \</span>
00217 <span class="preprocessor">            ch.mPointer = ch.mLoopStart + (ch.mLoopStart - ch.mPointer); \</span>
00218 <span class="preprocessor">        } \</span>
00219 <span class="preprocessor">    }</span>
00220 <span class="preprocessor"></span>
00221 
00222 <span class="comment">//#define OUTPUT_XM_INFO</span>
00223 
00224 <span class="preprocessor">#ifdef OUTPUT_XM_INFO</span>
00225 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">const</span> CHAR *notes[12] =
00226     {<span class="stringliteral">"C-"</span>,<span class="stringliteral">"C#"</span>,<span class="stringliteral">"D-"</span>,<span class="stringliteral">"D#"</span>,<span class="stringliteral">"E-"</span>,<span class="stringliteral">"F-"</span>,<span class="stringliteral">"F#"</span>,<span class="stringliteral">"G-"</span>,<span class="stringliteral">"G#"</span>,<span class="stringliteral">"A-"</span>,<span class="stringliteral">"A#"</span>,<span class="stringliteral">"B-"</span>};
00227 <span class="preprocessor">#endif // OUTPUT_XM_INFO</span>
00228 <span class="preprocessor"></span>
00229 
00230 <span class="keywordtype">void</span> <a class="code" href="classXFuXMPlayer.html#b8">XFuXMPlayer::debugPrint</a>(XFcFile *aTextout, CHAR *aFmt, ...)
00231 {
00232 <span class="preprocessor">#if !defined(XFC_PLATFORM_EPOC) &amp;&amp; !defined(XFC_PLATFORM_PALM)</span>
00233 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (aTextout != NULL)
00234     {
00235         va_list ap; 
00236         <span class="keyword">static</span> CHAR buffer[10240];  
00237         va_start(ap, aFmt);  
00238         vsprintf(buffer, aFmt, ap);  
00239         aTextout-&gt;write(buffer, 1, XFcStringToolkit::getLength(buffer));
00240         va_end(ap);
00241     }
00242 <span class="preprocessor">#endif // XFC_PLATFORM_EPOC</span>
00243 <span class="preprocessor"></span>}
00244 
00245 
<a name="l00246"></a><a class="code" href="classXFuXMPlayer.html#b2">00246</a> <span class="keywordtype">void</span> <a class="code" href="classXFuXMPlayer.html#b2">XFuXMPlayer::dumpSongParameters</a>(XFcFile *aTextout)
00247 {
00248     INT i = 0, x;
00249 
00250     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"\n\nParameters for current mSong. \n\n"</span>);
00251     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"song length: %d\n"</span>, <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m1">mSongLength</a>);
00252     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"song restart: %d\n"</span>, <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m2">mRestartPosition</a>);
00253     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"order: "</span>);
00254 
00255     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m1">mSongLength</a>; i++)
00256         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"%d "</span>, <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m0">mOrderTable</a>[i]);
00257 
00258     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"\n"</span>);
00259     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"nof patterns: %d\n"</span>, <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m3">mNbPatterns</a>);
00260     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"nof channels: %d\n"</span>, <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m4">mNbChannels</a>);
00261     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"nof instrument: %d\n"</span>, <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m5">mNbInstruments</a>);
00262     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"tempo: %d\n"</span>, <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m6">mTempo</a>);
00263     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"bpm: %d\n"</span>, <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m7">mBpm</a>);
00264     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"\nmInstruments: \n"</span>);
00265 
00266     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m5">mNbInstruments</a>; i++)
00267     {
00268         <a class="code" href="classXFuXMInstrument.html">XFuXMInstrument</a> &amp;ins = <a class="code" href="classXFuXMPlayer.html#n7">mInstruments</a>[i];
00269 
00270         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"\ninstr %02X \n"</span>, i);
00271 
00272         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"is vibrato? %d \n"</span>, ins.<a class="code" href="classXFuXMInstrument.html#m16">mIsVibrato</a>);
00273         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"vibratoType: %d \n"</span>, ins.<a class="code" href="classXFuXMInstrument.html#m17">mVibratoType</a>);
00274         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"vibratoSweep: %d \n"</span>, ins.<a class="code" href="classXFuXMInstrument.html#m18">mVibratoSweep</a>);
00275         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"vibratoDepth: %d \n"</span>, ins.<a class="code" href="classXFuXMInstrument.html#m19">mVibratoDepth</a>);
00276         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"vibratoRate: %d \n"</span>, ins.<a class="code" href="classXFuXMInstrument.html#m20">mVibratoRate</a>);
00277 
00278         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"\nvolume envelope: \n"</span>);
00279         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"  fadeout: %d \n"</span>, ins.<a class="code" href="classXFuXMInstrument.html#m9">mVolumeFadeout</a>);
00280         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"  end point: %d\n"</span>, ins.<a class="code" href="classXFuXMInstrument.html#m4">mVolEnvEnd</a>);  
00281         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"  type: %d\n"</span>, ins.<a class="code" href="classXFuXMInstrument.html#m5">mVolEnvType</a>);
00282         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"  on? %d\n"</span>, (ins.<a class="code" href="classXFuXMInstrument.html#m5">mVolEnvType</a> &amp; ENVELOPE_ON));
00283         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"  sustain? %d\n"</span>,
00284                    (ins.<a class="code" href="classXFuXMInstrument.html#m5">mVolEnvType</a> &amp; ENVELOPE_SUSTAIN));
00285         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"  sustain point: %d\n"</span>, (ins.<a class="code" href="classXFuXMInstrument.html#m8">mVolEnvSustain</a>));
00286         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"  loop? %d\n"</span>, (ins.<a class="code" href="classXFuXMInstrument.html#m5">mVolEnvType</a> &amp; ENVELOPE_LOOP));
00287         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"  loop start: %d\n"</span>, ins.<a class="code" href="classXFuXMInstrument.html#m6">mVolEnvLoopStart</a>);
00288         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"  loop end: %d\n"</span>, ins.<a class="code" href="classXFuXMInstrument.html#m7">mVolEnvLoopEnd</a>);
00289         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"  envelope: "</span>);
00290 
00291         <span class="keywordflow">for</span> (x = 0; x &lt; ins.<a class="code" href="classXFuXMInstrument.html#m4">mVolEnvEnd</a>; x++)
00292             <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout,<span class="stringliteral">"%2.2f "</span>, ins.<a class="code" href="classXFuXMInstrument.html#m3">mVolumeEnvelope</a>[x]);
00293 
00294         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"\n"</span>); 
00295         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"\npanning envelope: \n"</span>);
00296         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"  on? %d\n"</span>, (ins.<a class="code" href="classXFuXMInstrument.html#m12">mPanEnvType</a> &amp; ENVELOPE_ON));
00297         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"  loop? %d\n"</span>, (ins.<a class="code" href="classXFuXMInstrument.html#m12">mPanEnvType</a> &amp; ENVELOPE_LOOP));
00298         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"  loop start: %d\n"</span>, ins.<a class="code" href="classXFuXMInstrument.html#m13">mPanEnvLoopStart</a>);
00299         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"  loop end: %d\n"</span>, ins.<a class="code" href="classXFuXMInstrument.html#m14">mPanEnvLoopEnd</a>);
00300         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"  envelope: "</span>);
00301 
00302         <span class="keywordflow">for</span> (x = 0; x &lt; ins.<a class="code" href="classXFuXMInstrument.html#m11">mPanEnvEnd</a>; x++)
00303             <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"%d "</span>, ins.<a class="code" href="classXFuXMInstrument.html#m10">mPanningEnvelope</a>[x]);
00304 
00305         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout,<span class="stringliteral">"\n-----\n"</span>);   
00306     }
00307 }
00308 
00309 
<a name="l00310"></a><a class="code" href="classXFuXMPlayer.html#b0">00310</a> INT <a class="code" href="classXFuXMPlayer.html#b0">XFuXMPlayer::loadXM</a>(<span class="keyword">const</span> CHAR *aFilename, XFcFile *aTextout)
00311 {
00312     XFcFile *f;
00313 
00314     INT i, j, k, ii;
00315     FLOAT32 y1, y2, dx;
00316     INT xx, x1, x2;
00317 
00318     <a class="code" href="classXFuXMFormatInstrumentHeader.html">XFuXMFormatInstrumentHeader</a> xmInstrumentHeader;
00319     <a class="code" href="classXFuXMFormatInstrument.html">XFuXMFormatInstrument</a> xmInstrument;
00320     <a class="code" href="classXFuXMFormatSample.html">XFuXMFormatSample</a> xmSample;
00321 
00322     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"Fathammer XM-player debug file.\n"</span>);
00323     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"Opening %s.\n"</span>, aFilename);
00324 
00325     f = XFcFile::open(aFilename, <span class="stringliteral">"rb"</span>);
00326     <span class="keywordflow">if</span> (f == 0) {
00327         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"error opening file.\n"</span>);
00328         <span class="keywordflow">if</span> (aTextout != NULL) aTextout-&gt;close();
00329         <span class="keywordflow">return</span> 1;
00330     }
00331 
00332     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"opened.\n"</span>);
00333 
00334     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"reading header...\n\n"</span>);
00335     f-&gt;read(<a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m0">mIdString</a>, 17, <span class="keyword">sizeof</span>(UINT8));
00336     <a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m0">mIdString</a>[17] = 0;
00337 
00338     <span class="comment">// Check id string</span>
00339     INT wrongId = XFcStringToolkit::compare((<span class="keyword">const</span> CHAR *)<a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m0">mIdString</a>, <span class="stringliteral">"Extended Module: "</span>);
00340     <span class="keywordflow">if</span> (wrongId) <span class="keywordflow">return</span> 1;
00341 
00342     f-&gt;read(<a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m1">mModuleName</a>, 20, <span class="keyword">sizeof</span>(UINT8));
00343     <a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m1">mModuleName</a>[20] = 0;
00344 
00345     <span class="comment">// Check $1A byte</span>
00346     f-&gt;readUINT8(<a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m2">mH1A</a>);
00347     <span class="keywordflow">if</span> (<a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m2">mH1A</a> != 0x1A) <span class="keywordflow">return</span> 1;
00348 
00349     f-&gt;read(<a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m3">mTrackerName</a>, 20, <span class="keyword">sizeof</span>(UINT8));
00350     <a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m3">mTrackerName</a>[20] = 0;
00351 
00352     f-&gt;readUINT16(<a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m4">mVersion</a>);
00353 
00354     f-&gt;readUINT32(<a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m5">mHeaderSize</a>);
00355 
00356     f-&gt;readUINT16(<a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m6">mSongLength</a>);
00357     f-&gt;readUINT16(<a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m7">mRestartPosition</a>);
00358     f-&gt;readUINT16(<a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m8">mNbChannels</a>);
00359     f-&gt;readUINT16(<a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m9">mNbPatterns</a>);
00360     f-&gt;readUINT16(<a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m10">mNbInstruments</a>);
00361 
00362     f-&gt;readUINT16(<a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m11">mFlags</a>);
00363 
00364     f-&gt;readUINT16(<a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m12">mTempo</a>);
00365     f-&gt;readUINT16(<a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m13">mBpm</a>);
00366 
00367     f-&gt;read(<a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m14">mOrderTable</a>, 256, <span class="keyword">sizeof</span>(UINT8));
00368 
00369     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"id string: %s\n"</span>, <a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m0">mIdString</a>);
00370     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"module name: %s\n"</span>, <a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m1">mModuleName</a>);
00371     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"h1A: %d\n"</span>, <a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m2">mH1A</a>);
00372     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"tracker name: %s\n"</span>, <a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m3">mTrackerName</a>);
00373     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"tracker version: %d\n"</span>, <a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m4">mVersion</a>);
00374     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"header size: %d\n"</span>, <a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m5">mHeaderSize</a>);
00375     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"song length: %d\n"</span>, <a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m6">mSongLength</a>);
00376     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"restart pos: %d\n"</span>, <a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m7">mRestartPosition</a>);
00377     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"nof mChannels: %d\n"</span>, <a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m8">mNbChannels</a>);
00378     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"nof patterns: %d\n"</span>, <a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m9">mNbPatterns</a>);
00379     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"nof instrument: %d\n"</span>, <a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m10">mNbInstruments</a>);
00380     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"flags: %d\n"</span>, <a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m11">mFlags</a>);
00381     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"tempo: %d\n"</span>, <a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m12">mTempo</a>);
00382     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"bpm: %d\n"</span>, <a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m13">mBpm</a>);
00383     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"ordertable: \n"</span>);
00384 
00385     <span class="comment">// Allocate memory for order list</span>
00386     <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m0">mOrderTable</a> = <span class="keyword">new</span> UINT8[<a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m6">mSongLength</a>];
00387     memset(<a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m0">mOrderTable</a>, 0, <a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m6">mSongLength</a> * <span class="keyword">sizeof</span>(UINT8));
00388 
00389     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m6">mSongLength</a>; i++)
00390     {
00391         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"%2X-&gt;%2X\n"</span>, i, <a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m14">mOrderTable</a>[i]);
00392         <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m0">mOrderTable</a>[i] = <a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m14">mOrderTable</a>[i];
00393     }
00394 
00395     <span class="comment">// Save song header</span>
00396     <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m4">mNbChannels</a> = <a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m8">mNbChannels</a>;
00397     <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m3">mNbPatterns</a> = <a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m9">mNbPatterns</a>;
00398     <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m5">mNbInstruments</a> = <a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m10">mNbInstruments</a>;
00399     <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m1">mSongLength</a> = <a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m6">mSongLength</a>;
00400     <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m2">mRestartPosition</a> = <a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m7">mRestartPosition</a>;
00401     <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m7">mBpm</a> = <a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m13">mBpm</a>;
00402     <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m6">mTempo</a> = <a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m12">mTempo</a>;
00403     
00404     <span class="comment">// Allocate memory for mChannels</span>
00405     <a class="code" href="classXFuXMPlayer.html#n8">mChannels</a> = <span class="keyword">new</span> <a class="code" href="classXFuXMChannel.html">XFuXMChannel</a>[<a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m4">mNbChannels</a>];
00406     memset(mChannels, 0, <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m4">mNbChannels</a> * <span class="keyword">sizeof</span>(XFuXMChannel));
00407 
00408     <span class="comment">// Read pattern headers and pattern data</span>
00409     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"\npatterns:\n\n"</span>);
00410     
00411     <span class="comment">// Allocate memory for pattern headers</span>
00412     <a class="code" href="classXFuXMPlayer.html#n5">mXMPatternHeaders</a> = <span class="keyword">new</span> <a class="code" href="classXFuXMFormatPatternHeader.html">XFuXMFormatPatternHeader</a>[<a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m9">mNbPatterns</a>];
00413     memset(mXMPatternHeaders, 0, <a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m9">mNbPatterns</a> * <span class="keyword">sizeof</span>(XFuXMFormatPatternHeader));
00414 
00415     <span class="comment">// Allocate memory for pattern data blocks</span>
00416     <a class="code" href="classXFuXMPlayer.html#n6">mPatternData</a> = <span class="keyword">new</span> <a class="code" href="classXFuXMPattern.html">XFuXMPattern</a>[<a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m9">mNbPatterns</a>];
00417     memset(mPatternData, 0, <a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m9">mNbPatterns</a> * <span class="keyword">sizeof</span>(XFuXMPattern));
00418 
00419     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m9">mNbPatterns</a>; i++)
00420     {
00421         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"pattern %d \n"</span>, i);
00422 
00423         f-&gt;readUINT32(mXMPatternHeaders[i].mHeaderLength);
00424         f-&gt;readUINT8(mXMPatternHeaders[i].mPackingType);
00425         f-&gt;readUINT16(mXMPatternHeaders[i].mNbRows);
00426         f-&gt;readUINT16(mXMPatternHeaders[i].mSize);
00427 
00428         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"header length: %d \n"</span>, mXMPatternHeaders[i].mHeaderLength);
00429         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"packing type: %d \n"</span>, mXMPatternHeaders[i].mPackingType);
00430         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"nof rows: %d \n"</span>, mXMPatternHeaders[i].mNbRows);
00431         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"size: %d \n\n"</span>, mXMPatternHeaders[i].mSize);
00432 
00433         <span class="keywordflow">if</span> (<a class="code" href="classXFuXMPlayer.html#n5">mXMPatternHeaders</a>[i].<a class="code" href="classXFuXMFormatPatternHeader.html#m3">mSize</a> &gt; 0)
00434         {
00435             <span class="comment">// Allocate memory for actual pattern data</span>
00436             <a class="code" href="classXFuXMPlayer.html#n6">mPatternData</a>[i].<a class="code" href="classXFuXMPattern.html#m0">mData</a> = <span class="keyword">new</span> UINT8[<a class="code" href="classXFuXMPlayer.html#n5">mXMPatternHeaders</a>[i].<a class="code" href="classXFuXMFormatPatternHeader.html#m3">mSize</a>];
00437             <a class="code" href="classXFuXMPlayer.html#n6">mPatternData</a>[i].<a class="code" href="classXFuXMPattern.html#m1">mRows</a> = <span class="keyword">new</span> UINT32[mXMPatternHeaders[i].mNbRows];
00438             f-&gt;read(mPatternData[i].mData, mXMPatternHeaders[i].mSize, 1);
00439 
00440             UINT8 b = 0;
00441             UINT32 p = 0;
00442             <span class="keywordflow">for</span> (j = 0; j &lt; mXMPatternHeaders[i].mNbRows; j++)
00443             {
00444                 <a class="code" href="classXFuXMPlayer.html#n6">mPatternData</a>[i].<a class="code" href="classXFuXMPattern.html#m1">mRows</a>[j] = p;
00445 
00446                 <span class="keywordflow">for</span> (k = 0; k &lt; <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m4">mNbChannels</a>; k++)
00447                 {
00448                     b = *(<a class="code" href="classXFuXMPlayer.html#n6">mPatternData</a>[i].<a class="code" href="classXFuXMPattern.html#m0">mData</a> + p++);
00449 
00450                     <span class="keywordflow">if</span> ((b &amp; 128) == 128) {
00451                         <span class="comment">// Packed atom</span>
00452                         <span class="keywordflow">if</span> ((b &amp; 1) == 1) p++;
00453                         <span class="keywordflow">if</span> ((b &amp; 2) == 2) p++;
00454                         <span class="keywordflow">if</span> ((b &amp; 4) == 4) p++;
00455                         <span class="keywordflow">if</span> ((b &amp; 8) == 8) p++;
00456                         <span class="keywordflow">if</span> ((b &amp; 16) == 16) p++;
00457                     }
00458                     <span class="keywordflow">else</span>
00459                     {
00460                         <span class="comment">// Normal atom</span>
00461                         p += 4;
00462                     }
00463                 }
00464             }
00465         }
00466     }
00467 
00468     <span class="comment">// Allocate memory for mInstruments</span>
00469     <a class="code" href="classXFuXMPlayer.html#n7">mInstruments</a> = <span class="keyword">new</span> <a class="code" href="classXFuXMInstrument.html">XFuXMInstrument</a>[<a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m10">mNbInstruments</a>];
00470     memset(mInstruments, 0, <a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m10">mNbInstruments</a> * <span class="keyword">sizeof</span>(XFuXMInstrument));
00471 
00472     <span class="comment">// Read mInstruments</span>
00473     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"mInstruments \n\n"</span>);
00474     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m10">mNbInstruments</a>; i++)
00475     {
00476         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"instrument %02x \n"</span>, i);
00477 
00478         XFuXMInstrument &amp;ins = <a class="code" href="classXFuXMPlayer.html#n7">mInstruments</a>[i];
00479 
00480         memset(&amp;xmInstrumentHeader, 0, <span class="keyword">sizeof</span>(<a class="code" href="classXFuXMFormatInstrumentHeader.html">XFuXMFormatInstrumentHeader</a>));
00481 
00482         f-&gt;readUINT32(xmInstrumentHeader.<a class="code" href="classXFuXMFormatInstrumentHeader.html#m0">mSize</a>);
00483 
00484         f-&gt;read(xmInstrumentHeader.<a class="code" href="classXFuXMFormatInstrumentHeader.html#m1">mInstrumentName</a>, 22, <span class="keyword">sizeof</span>(UINT8));
00485         xmInstrumentHeader.<a class="code" href="classXFuXMFormatInstrumentHeader.html#m1">mInstrumentName</a>[22] = 0;
00486 
00487         f-&gt;readUINT8(xmInstrumentHeader.<a class="code" href="classXFuXMFormatInstrumentHeader.html#m2">mType</a>);
00488         f-&gt;readUINT16(xmInstrumentHeader.<a class="code" href="classXFuXMFormatInstrumentHeader.html#m3">mNbSamples</a>);
00489 
00490         ins.<a class="code" href="classXFuXMInstrument.html#m0">mNbSamples</a> = xmInstrumentHeader.<a class="code" href="classXFuXMFormatInstrumentHeader.html#m3">mNbSamples</a>;
00491 
00492         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"size: %d \n"</span>, xmInstrumentHeader.<a class="code" href="classXFuXMFormatInstrumentHeader.html#m0">mSize</a>);
00493         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"name: %s \n"</span>, xmInstrumentHeader.<a class="code" href="classXFuXMFormatInstrumentHeader.html#m1">mInstrumentName</a>);
00494         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"type: %d \n"</span>, xmInstrumentHeader.<a class="code" href="classXFuXMFormatInstrumentHeader.html#m2">mType</a>);
00495         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"nof samples: %d \n"</span>,
00496                    xmInstrumentHeader.<a class="code" href="classXFuXMFormatInstrumentHeader.html#m3">mNbSamples</a>);
00497 
00498         <span class="comment">// sizeof(xmInstrumentHeader) could return an ALIGNED value</span>
00499         INT32 skip = xmInstrumentHeader.<a class="code" href="classXFuXMFormatInstrumentHeader.html#m0">mSize</a> - 29;
00500 
00501         <span class="keywordflow">if</span> (xmInstrumentHeader.<a class="code" href="classXFuXMFormatInstrumentHeader.html#m3">mNbSamples</a> &gt; 0)
00502         {
00503             memset(&amp;xmInstrument, 0, <span class="keyword">sizeof</span>(<a class="code" href="classXFuXMFormatInstrument.html">XFuXMFormatInstrument</a>));
00504 
00505             f-&gt;readUINT32(xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m0">mSampleHeaderSize</a>);
00506             f-&gt;read(xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m1">mKeyboard</a>, 96, <span class="keyword">sizeof</span>(UINT8));
00507             f-&gt;read(xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m2">mVolumeEnvelope</a>, 24, <span class="keyword">sizeof</span>(UINT16));
00508             f-&gt;read(xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m3">mPanningEnvelope</a>, 24, <span class="keyword">sizeof</span>(UINT16));
00509             f-&gt;readUINT8(xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m4">mNbVolEnvPoints</a>);
00510             f-&gt;readUINT8(xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m5">mNbPanEnvPoints</a>);
00511             f-&gt;readUINT8(xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m6">mVolEnvSustain</a>);
00512             f-&gt;readUINT8(xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m7">mVolEnvLoopStart</a>);
00513             f-&gt;readUINT8(xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m8">mVolEnvLoopEnd</a>);
00514             f-&gt;readUINT8(xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m9">mPanEnvSustain</a>);
00515             f-&gt;readUINT8(xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m10">mPanEnvLoopStart</a>);
00516             f-&gt;readUINT8(xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m11">mPanEnvLoopEnd</a>);
00517             f-&gt;readUINT8(xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m12">mVolEnvType</a>);
00518             f-&gt;readUINT8(xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m13">mPanEnvType</a>);
00519 
00520             f-&gt;readUINT8(xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m14">mVibratoType</a>);
00521             f-&gt;readUINT8(xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m15">mVibratoSweep</a>);
00522             f-&gt;readUINT8(xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m16">mVibratoDepth</a>);
00523             f-&gt;readUINT8(xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m17">mVibratoRate</a>);
00524 
00525             f-&gt;readUINT16(xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m18">mVolumeFadeout</a>);
00526 
00527             f-&gt;readUINT16(xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m19">mReserved</a>);
00528 
00529             <span class="comment">// sizeof(xmInstrument) could return an ALIGNED value</span>
00530             skip -= 214;
00531             f-&gt;seek(skip, SEEK_CUR);
00532 
00533             <span class="comment">// Allocate memory for samples in instrument</span>
00534             ins.<a class="code" href="classXFuXMInstrument.html#m1">mSamples</a> = <span class="keyword">new</span> <a class="code" href="classXFuXMSample.html">XFuXMSample</a>[xmInstrumentHeader.<a class="code" href="classXFuXMFormatInstrumentHeader.html#m3">mNbSamples</a>];
00535             memset(ins.<a class="code" href="classXFuXMInstrument.html#m1">mSamples</a>, 0, xmInstrumentHeader.<a class="code" href="classXFuXMFormatInstrumentHeader.html#m3">mNbSamples</a> * <span class="keyword">sizeof</span>(<a class="code" href="classXFuXMSample.html">XFuXMSample</a>));
00536 
00537             <span class="keywordflow">for</span> (j = 0; j &lt; xmInstrumentHeader.<a class="code" href="classXFuXMFormatInstrumentHeader.html#m3">mNbSamples</a>; j++)
00538             {
00539                 <a class="code" href="classXFuXMSample.html">XFuXMSample</a> &amp;smp = ins.<a class="code" href="classXFuXMInstrument.html#m1">mSamples</a>[j];
00540 
00541                 memset(&amp;xmSample, 0, <span class="keyword">sizeof</span>(<a class="code" href="classXFuXMFormatSample.html">XFuXMFormatSample</a>));
00542 
00543                 f-&gt;readUINT32(xmSample.<a class="code" href="classXFuXMFormatSample.html#m0">mSampleLength</a>);
00544                 f-&gt;readUINT32(xmSample.<a class="code" href="classXFuXMFormatSample.html#m1">mLoopStart</a>);
00545                 f-&gt;readUINT32(xmSample.<a class="code" href="classXFuXMFormatSample.html#m2">mLoopLength</a>);
00546                 f-&gt;readUINT8(xmSample.<a class="code" href="classXFuXMFormatSample.html#m3">mVolume</a>);
00547                 f-&gt;readINT8(xmSample.<a class="code" href="classXFuXMFormatSample.html#m4">mFinetune</a>);
00548                 f-&gt;readUINT8(xmSample.<a class="code" href="classXFuXMFormatSample.html#m5">mType</a>);
00549                 f-&gt;readUINT8(xmSample.<a class="code" href="classXFuXMFormatSample.html#m6">mPan</a>);
00550                 f-&gt;readINT8(xmSample.<a class="code" href="classXFuXMFormatSample.html#m7">mRelativeNote</a>);
00551                 f-&gt;readUINT8(xmSample.<a class="code" href="classXFuXMFormatSample.html#m8">mReserved</a>);
00552 
00553                 f-&gt;read(xmSample.<a class="code" href="classXFuXMFormatSample.html#m9">mSampleName</a>, 22, <span class="keyword">sizeof</span>(UINT8));
00554                 xmSample.<a class="code" href="classXFuXMFormatSample.html#m9">mSampleName</a>[22] = 0;
00555 
00556                 <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"Allocating %d bytes for sample %02X in "</span>
00557                            <span class="stringliteral">"instrument %02X\n"</span>, xmSample.<a class="code" href="classXFuXMFormatSample.html#m0">mSampleLength</a>, j, i);
00558                 <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"sample length %d \n"</span>, xmSample.<a class="code" href="classXFuXMFormatSample.html#m0">mSampleLength</a>);
00559                 <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"loop start %d \n"</span>, xmSample.<a class="code" href="classXFuXMFormatSample.html#m1">mLoopStart</a>);
00560                 <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"loop length %d \n"</span>, xmSample.<a class="code" href="classXFuXMFormatSample.html#m2">mLoopLength</a>);
00561                 <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"volume %d \n"</span>, xmSample.<a class="code" href="classXFuXMFormatSample.html#m3">mVolume</a>);
00562                 <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"finetune %d \n"</span>, xmSample.<a class="code" href="classXFuXMFormatSample.html#m4">mFinetune</a>);
00563                 <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"type %d \n"</span>, xmSample.<a class="code" href="classXFuXMFormatSample.html#m5">mType</a>);
00564                 <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"  loop fwd? %d\n"</span>, (xmSample.<a class="code" href="classXFuXMFormatSample.html#m5">mType</a> &amp; LOOP_FORWARD) ? 1 : 0);
00565                 <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"  loop pingpong? %d\n"</span>, 
00566                     (xmSample.<a class="code" href="classXFuXMFormatSample.html#m5">mType</a> &amp; LOOP_PINGPONG) ? 1 : 0);
00567                 <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"  16 bit? %d\n"</span>, 
00568                     (xmSample.<a class="code" href="classXFuXMFormatSample.html#m5">mType</a> &amp; XMFORMAT_SAMPLE_16BIT) ? 1 : 0);
00569                 <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"pan %d \n"</span>, xmSample.<a class="code" href="classXFuXMFormatSample.html#m6">mPan</a>);
00570                 <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"relative note %d \n"</span>, xmSample.<a class="code" href="classXFuXMFormatSample.html#m7">mRelativeNote</a>);
00571                 <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"sample name %s \n"</span>, xmSample.<a class="code" href="classXFuXMFormatSample.html#m9">mSampleName</a>);
00572 
00573                 smp.<a class="code" href="classXFuXMSample.html#m5">mSize</a> = xmSample.<a class="code" href="classXFuXMFormatSample.html#m0">mSampleLength</a>;
00574                 smp.<a class="code" href="classXFuXMSample.html#m0">mVolume</a> = xmSample.<a class="code" href="classXFuXMFormatSample.html#m3">mVolume</a>;
00575                 smp.<a class="code" href="classXFuXMSample.html#m1">mPan</a> = xmSample.<a class="code" href="classXFuXMFormatSample.html#m6">mPan</a>;
00576                 smp.<a class="code" href="classXFuXMSample.html#m6">mLoopForward</a> = (UINT8)((xmSample.<a class="code" href="classXFuXMFormatSample.html#m5">mType</a> &amp; <a class="code" href="XFuXMPlayer__internal_8h.html#a21a8">LOOP_FORWARD</a>) ? 1 : 0);
00577                 smp.<a class="code" href="classXFuXMSample.html#m7">mLoopPingpong</a> = (UINT8)((xmSample.<a class="code" href="classXFuXMFormatSample.html#m5">mType</a> &amp; <a class="code" href="XFuXMPlayer__internal_8h.html#a21a9">LOOP_PINGPONG</a>) ? 1 : 0);
00578                 smp.<a class="code" href="classXFuXMSample.html#m10">m16Bit</a> = (UINT8)((xmSample.<a class="code" href="classXFuXMFormatSample.html#m5">mType</a> &amp; <a class="code" href="XFuXMPlayer__internal_8h.html#a3">XMFORMAT_SAMPLE_16BIT</a>) ? 1 : 0);
00579                 smp.<a class="code" href="classXFuXMSample.html#m8">mLoopStart</a> = xmSample.<a class="code" href="classXFuXMFormatSample.html#m1">mLoopStart</a>;
00580                 smp.<a class="code" href="classXFuXMSample.html#m9">mLoopEnd</a> = xmSample.<a class="code" href="classXFuXMFormatSample.html#m1">mLoopStart</a> + xmSample.<a class="code" href="classXFuXMFormatSample.html#m2">mLoopLength</a> - 1;
00581 
00582                 <span class="keywordflow">if</span> (smp.<a class="code" href="classXFuXMSample.html#m8">mLoopStart</a> == smp.<a class="code" href="classXFuXMSample.html#m9">mLoopEnd</a>)
00583                 {
00584                     smp.<a class="code" href="classXFuXMSample.html#m7">mLoopPingpong</a> = 0;
00585                     smp.<a class="code" href="classXFuXMSample.html#m6">mLoopForward</a> = 0;
00586                 }
00587 
00588                 smp.<a class="code" href="classXFuXMSample.html#m3">mRelativeNote</a> = xmSample.<a class="code" href="classXFuXMFormatSample.html#m7">mRelativeNote</a>;
00589                 smp.<a class="code" href="classXFuXMSample.html#m2">mFinetune</a> = xmSample.<a class="code" href="classXFuXMFormatSample.html#m4">mFinetune</a>;
00590             }
00591 
00592             <span class="comment">// Read samples</span>
00593             <span class="keywordflow">for</span> (j = 0; j &lt; xmInstrumentHeader.<a class="code" href="classXFuXMFormatInstrumentHeader.html#m3">mNbSamples</a>; j++)
00594             {
00595                 <a class="code" href="classXFuXMSample.html">XFuXMSample</a> &amp;smp = ins.<a class="code" href="classXFuXMInstrument.html#m1">mSamples</a>[j];
00596 
00597                 <span class="keywordflow">if</span> (smp.<a class="code" href="classXFuXMSample.html#m5">mSize</a> &gt; 0)
00598                 {
00599                     smp.<a class="code" href="classXFuXMSample.html#m4">mOffset</a> = <span class="keyword">new</span> INT8[smp.<a class="code" href="classXFuXMSample.html#m5">mSize</a>];
00600                     memset((INT8 *)smp.<a class="code" href="classXFuXMSample.html#m4">mOffset</a>, 0, smp.<a class="code" href="classXFuXMSample.html#m5">mSize</a> * <span class="keyword">sizeof</span>(INT8));
00601 
00602                     <span class="keywordflow">if</span> (smp.<a class="code" href="classXFuXMSample.html#m4">mOffset</a> == NULL)
00603                     {
00604                         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"! Memory allocation for sample "</span>
00605                                    <span class="stringliteral">"%02X in instrument %02X failed \n"</span>, j, i);
00606                         <span class="keywordflow">return</span> 1;
00607                     }
00608 
00609                     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"Reading sample \n"</span>);
00610                     f-&gt;read((INT8 *)smp.<a class="code" href="classXFuXMSample.html#m4">mOffset</a>, smp.<a class="code" href="classXFuXMSample.html#m5">mSize</a>, 1);
00611 
00612                     <span class="keywordflow">if</span> (smp.<a class="code" href="classXFuXMSample.html#m10">m16Bit</a>)
00613                     {
00614                         INT16 os, ns;
00615                         INT16 *temp = (INT16 *)smp.<a class="code" href="classXFuXMSample.html#m4">mOffset</a>;
00616                         os = 0;
00617 
00618                         smp.<a class="code" href="classXFuXMSample.html#m5">mSize</a> &gt;&gt;= 1;
00619                         smp.<a class="code" href="classXFuXMSample.html#m8">mLoopStart</a> &gt;&gt;= 1;
00620                         smp.<a class="code" href="classXFuXMSample.html#m9">mLoopEnd</a> &gt;&gt;= 1;
00621 
00622                         <span class="keywordflow">if</span> (<a class="code" href="classXFuXMPlayer.html#n1">mFlags</a> &amp; XFCAUDIO_16BIT)
00623                         {
00624                             UINT32 a;
00625                             <span class="keywordflow">for</span> (a = 0; a &lt; smp.<a class="code" href="classXFuXMSample.html#m5">mSize</a>; ++a)
00626                             {
00627                                 ns = (INT16)(os + *(temp + a));
00628                                 *((INT16 *)smp.<a class="code" href="classXFuXMSample.html#m4">mOffset</a> + a) = ns;
00629                                 os = ns;
00630                             }
00631                         }
00632                         <span class="keywordflow">else</span>
00633                         {
00634                             UINT32 a;
00635                             <span class="keywordflow">for</span> (a = 0; a &lt; smp.<a class="code" href="classXFuXMSample.html#m5">mSize</a>; ++a)
00636                             {
00637                                 ns = (INT16)(os + *(temp + a));
00638                                 *((INT8 *)smp.<a class="code" href="classXFuXMSample.html#m4">mOffset</a> + a) = (INT8)(ns &gt;&gt; 8);
00639                                 os = ns;
00640                             }
00641                             
00642                             smp.<a class="code" href="classXFuXMSample.html#m10">m16Bit</a> = 0;
00643 
00644                             INT8 *temp = <span class="keyword">new</span> INT8[smp.<a class="code" href="classXFuXMSample.html#m5">mSize</a>];
00645                             memcpy(temp, smp.<a class="code" href="classXFuXMSample.html#m4">mOffset</a>, smp.<a class="code" href="classXFuXMSample.html#m5">mSize</a>);
00646                             <span class="keyword">delete</span>[] (INT8 *)smp.<a class="code" href="classXFuXMSample.html#m4">mOffset</a>;
00647                             smp.<a class="code" href="classXFuXMSample.html#m4">mOffset</a> = temp;
00648                         }
00649                     }
00650                     <span class="keywordflow">else</span>
00651                     {
00652                         INT8 os, ns;
00653                         os = 0;
00654                         UINT32 a;
00655                         <span class="keywordflow">for</span> (a = 0; a &lt; smp.<a class="code" href="classXFuXMSample.html#m5">mSize</a>; a++)
00656                         {
00657                             ns = (INT8)(os + *((INT8 *)smp.<a class="code" href="classXFuXMSample.html#m4">mOffset</a> + a));
00658                             *((INT8 *)smp.<a class="code" href="classXFuXMSample.html#m4">mOffset</a> + a) = ns;
00659                             os = ns;
00660                         }
00661                     }
00662                 }
00663             }
00664         
00665             ins.<a class="code" href="classXFuXMInstrument.html#m9">mVolumeFadeout</a> = REALf(xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m18">mVolumeFadeout</a> / 65536.0f);
00666 
00667             <span class="keywordflow">if</span> (xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m17">mVibratoRate</a>) 
00668                 ins.<a class="code" href="classXFuXMInstrument.html#m16">mIsVibrato</a> = 1;
00669             <span class="keywordflow">else</span>
00670                 ins.<a class="code" href="classXFuXMInstrument.html#m16">mIsVibrato</a> = 0;
00671 
00672             ins.<a class="code" href="classXFuXMInstrument.html#m17">mVibratoType</a> = xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m14">mVibratoType</a>;
00673             ins.<a class="code" href="classXFuXMInstrument.html#m18">mVibratoSweep</a> = xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m15">mVibratoSweep</a>;
00674             ins.<a class="code" href="classXFuXMInstrument.html#m19">mVibratoDepth</a> = xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m16">mVibratoDepth</a>;
00675             ins.<a class="code" href="classXFuXMInstrument.html#m20">mVibratoRate</a> = xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m17">mVibratoRate</a>;
00676 
00677             <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"sampleheader size: %d \n"</span>, xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m0">mSampleHeaderSize</a>);
00678 
00679             <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"keyboard: "</span>);
00680 
00681             <span class="keywordflow">for</span> (ii = 0; ii &lt; 96; ii++)
00682             {
00683                 <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"%d, "</span>, xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m1">mKeyboard</a>[ii]);
00684                 <span class="keywordflow">if</span> (((ii + 1) % 20) == 0)
00685                     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"\n    "</span>);
00686             }
00687 
00688             memcpy(ins.<a class="code" href="classXFuXMInstrument.html#m2">mKeyboard</a>, xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m1">mKeyboard</a>, 96);
00689 
00690             <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"\n"</span>);
00691             <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"volume. envelope: "</span>);
00692 
00693 <span class="comment">//            if (xmInstrument.mVolEnvType &amp; ENVELOPE_LOOP)</span>
00694 <span class="comment">//                xmInstrument.mNbVolEnvPoints =</span>
00695 <span class="comment">//                    xmInstrument.mVolEnvLoopEnd + 1;</span>
00696 
00697             <span class="keywordflow">for</span> (ii = 0; ii &lt; xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m4">mNbVolEnvPoints</a> * 2; ii++)
00698             {
00699                 <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"%d, "</span>, xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m2">mVolumeEnvelope</a>[ii]);
00700 
00701                 <span class="keywordflow">if</span> (((ii + 1) % 20) == 0)
00702                     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"\n    "</span>);
00703             }
00704 
00705             <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"\n"</span>);
00706             <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"pan. envelope: "</span>);
00707 
00708 <span class="comment">//            if (xmInstrument.mPanEnvType &amp; ENVELOPE_LOOP)</span>
00709 <span class="comment">//                xmInstrument.mNbPanEnvPoints =</span>
00710 <span class="comment">//                    xmInstrument.mPanEnvLoopEnd + 1;</span>
00711 
00712             <span class="keywordflow">for</span> (ii = 0; ii &lt; xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m5">mNbPanEnvPoints</a> * 2; ii++)
00713             {
00714                 <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"%d, "</span>, xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m3">mPanningEnvelope</a>[ii]);
00715 
00716                 <span class="keywordflow">if</span> (((ii + 1) % 20) == 0)
00717                     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"\n    "</span>);
00718             }
00719 
00720             <span class="comment">// Volume envelope</span>
00721             ins.<a class="code" href="classXFuXMInstrument.html#m5">mVolEnvType</a> = xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m12">mVolEnvType</a>;
00722 
00723             <span class="keywordflow">if</span> (xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m7">mVolEnvLoopStart</a> != xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m8">mVolEnvLoopEnd</a>)
00724             {
00725                 ins.<a class="code" href="classXFuXMInstrument.html#m6">mVolEnvLoopStart</a> = xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m2">mVolumeEnvelope</a>[
00726                     xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m7">mVolEnvLoopStart</a> * 2];
00727                 ins.<a class="code" href="classXFuXMInstrument.html#m7">mVolEnvLoopEnd</a> = xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m2">mVolumeEnvelope</a>[
00728                     xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m8">mVolEnvLoopEnd</a> * 2];
00729             }
00730             memset(ins.<a class="code" href="classXFuXMInstrument.html#m3">mVolumeEnvelope</a>, 0, XMFORMAT_SIZEOF_ENVELOPE);
00731 
00732             <span class="keywordflow">if</span> (xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m4">mNbVolEnvPoints</a> == 1)
00733             {
00734                 <span class="comment">// Volume envelope fix for trackers that don't follow FT2 standard</span>
00735                 ins.<a class="code" href="classXFuXMInstrument.html#m3">mVolumeEnvelope</a>[0] = REALf(xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m2">mVolumeEnvelope</a>[1] / 64.0f);
00736             }
00737             <span class="keywordflow">else</span>
00738             {
00739                 <span class="keywordflow">for</span> (ii = 0; ii &lt; xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m4">mNbVolEnvPoints</a> - 1; ii++)
00740                 {
00741                     x1 = xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m2">mVolumeEnvelope</a>[(ii * 2)];
00742                     y1 = xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m2">mVolumeEnvelope</a>[(ii * 2) + 1];
00743                     x2 = xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m2">mVolumeEnvelope</a>[((ii + 1) * 2)];
00744                     y2 = xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m2">mVolumeEnvelope</a>[((ii + 1) * 2) + 1];
00745 
00746                     dx = (y2 - y1) / (x2 - x1);
00747 
00748                     <span class="keywordflow">for</span> (xx = x1; xx &lt;= x2; xx++)
00749                     {
00750                         ins.<a class="code" href="classXFuXMInstrument.html#m3">mVolumeEnvelope</a>[xx] = REALf(y1 / 64.0f);
00751                         y1 += dx;
00752                     }
00753                 }
00754             }
00755 
00756             <span class="keywordflow">if</span> (xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m12">mVolEnvType</a> &amp; <a class="code" href="XFuXMPlayer__internal_8h.html#a22a11">ENVELOPE_SUSTAIN</a>)
00757                 ins.<a class="code" href="classXFuXMInstrument.html#m8">mVolEnvSustain</a> = xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m2">mVolumeEnvelope</a>[
00758                     xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m6">mVolEnvSustain</a> * 2];
00759 
00760             <span class="keywordflow">if</span> (xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m4">mNbVolEnvPoints</a> &gt; 0)
00761                 ins.<a class="code" href="classXFuXMInstrument.html#m4">mVolEnvEnd</a> = xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m2">mVolumeEnvelope</a>[
00762                     (xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m4">mNbVolEnvPoints</a> - 1) * 2];
00763 
00764             <span class="comment">// Panning envelope</span>
00765             ins.<a class="code" href="classXFuXMInstrument.html#m12">mPanEnvType</a> = xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m13">mPanEnvType</a>;
00766 
00767             <span class="keywordflow">if</span> (xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m10">mPanEnvLoopStart</a> != xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m11">mPanEnvLoopEnd</a>)
00768             {
00769                 ins.<a class="code" href="classXFuXMInstrument.html#m13">mPanEnvLoopStart</a> = xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m3">mPanningEnvelope</a>[
00770                     xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m10">mPanEnvLoopStart</a> * 2];
00771                 ins.<a class="code" href="classXFuXMInstrument.html#m14">mPanEnvLoopEnd</a> = xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m3">mPanningEnvelope</a>[
00772                     xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m11">mPanEnvLoopEnd</a> * 2];
00773             }
00774             memset(ins.<a class="code" href="classXFuXMInstrument.html#m10">mPanningEnvelope</a>, 0, XMFORMAT_SIZEOF_ENVELOPE);
00775 
00776             <span class="keywordflow">if</span> (xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m5">mNbPanEnvPoints</a> == 1)
00777             {
00778                 <span class="comment">// Panning envelope fix for trackers that don't follow FT2 standard</span>
00779                 ins.<a class="code" href="classXFuXMInstrument.html#m10">mPanningEnvelope</a>[0] = (UINT8)xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m3">mPanningEnvelope</a>[1];
00780             }
00781             <span class="keywordflow">else</span>
00782             {
00783                 <span class="keywordflow">for</span> (ii = 0; ii &lt; xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m5">mNbPanEnvPoints</a> - 1; ii++)
00784                 {
00785                     x1 = xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m3">mPanningEnvelope</a>[(ii * 2)];
00786                     y1 = xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m3">mPanningEnvelope</a>[(ii * 2) + 1];
00787                     x2 = xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m3">mPanningEnvelope</a>[((ii + 1) * 2)];
00788                     y2 = xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m3">mPanningEnvelope</a>[((ii + 1) * 2) + 1];
00789 
00790                     dx = (y2 - y1) / (x2 - x1);
00791 
00792                     <span class="keywordflow">for</span> (xx = x1; xx &lt; x2; xx++)
00793                     {
00794                         ins.<a class="code" href="classXFuXMInstrument.html#m10">mPanningEnvelope</a>[xx] = (UINT8)((INT8)y1);
00795                         y1 += dx;
00796                     }
00797                 }
00798             }
00799 
00800             ins.<a class="code" href="classXFuXMInstrument.html#m15">mPanEnvSustain</a> = xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m3">mPanningEnvelope</a>[
00801                 xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m9">mPanEnvSustain</a> * 2];
00802 
00803             <span class="keywordflow">if</span> (xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m5">mNbPanEnvPoints</a> &gt; 0)
00804                 ins.<a class="code" href="classXFuXMInstrument.html#m11">mPanEnvEnd</a> = xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m3">mPanningEnvelope</a>[
00805                     (xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m5">mNbPanEnvPoints</a> - 1) * 2];
00806         
00807             <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"\n"</span>);
00808 
00809             <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"nof volpoints %d\n"</span>,
00810                        xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m4">mNbVolEnvPoints</a>);
00811             <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"nof panpoints %d\n"</span>,
00812                        xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m5">mNbPanEnvPoints</a>);
00813             <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"volume. sustain %d\n"</span>,
00814                        xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m6">mVolEnvSustain</a>);
00815             <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"volume. loop start %d\n"</span>,
00816                        xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m7">mVolEnvLoopStart</a>);
00817             <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"volume. loop end %d\n"</span>,
00818                        xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m8">mVolEnvLoopEnd</a>);
00819             <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"pan. sustain %d\n"</span>,
00820                        xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m9">mPanEnvSustain</a>);
00821             <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"pan. loop start %d\n"</span>,
00822                        xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m10">mPanEnvLoopStart</a>);
00823             <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"pan. loop end %d\n"</span>,
00824                        xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m11">mPanEnvLoopEnd</a>);
00825             <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"volume. type %d\n"</span>, xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m12">mVolEnvType</a>);
00826             <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"  env. on? %d\n"</span>,
00827                        (xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m12">mVolEnvType</a> &amp; ENVELOPE_ON) ? 1 : 0);
00828             <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"  env. sustain? %d\n"</span>,
00829                        (xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m12">mVolEnvType</a> &amp; ENVELOPE_SUSTAIN) ? 1 : 0);
00830             <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"  env. loop? %d \n"</span>,
00831                        (xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m12">mVolEnvType</a> &amp; ENVELOPE_LOOP) ? 1 : 0);
00832             <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"pan. type %d\n"</span>,
00833                        xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m13">mPanEnvType</a>);
00834 
00835             <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"  env. on? %d\n"</span>,
00836                        (xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m13">mPanEnvType</a> &amp; ENVELOPE_ON) ? 1 : 0);
00837             <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"  env. sustain? %d\n"</span>,
00838                        (xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m13">mPanEnvType</a> &amp; ENVELOPE_SUSTAIN) ? 1 : 0);
00839             <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"  env. loop? %d \n"</span>,
00840                        (xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m13">mPanEnvType</a> &amp; ENVELOPE_LOOP) ? 1 : 0);
00841             
00842             <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"vibr. type %d \n"</span>,
00843                        xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m14">mVibratoType</a>);
00844             <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"vibr. sweep %d \n"</span>,
00845                        xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m15">mVibratoSweep</a>);
00846             <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"vibr. depth %d \n"</span>,
00847                        xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m16">mVibratoDepth</a>);
00848             <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"vibr. rate %d \n"</span>,
00849                        xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m17">mVibratoRate</a>);
00850             <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"volume. fadeout %d \n\n"</span>,
00851                        xmInstrument.<a class="code" href="classXFuXMFormatInstrument.html#m18">mVolumeFadeout</a>);
00852         }
00853         <span class="keywordflow">else</span>
00854         {
00855             f-&gt;seek(skip, SEEK_CUR);
00856         }
00857 
00858         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"-----\n\n"</span>);
00859     }
00860 
00861     <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m5">mNbInstruments</a> = <a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m10">mNbInstruments</a>;
00862 
00863     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"XM read. \n"</span>);
00864     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(aTextout, <span class="stringliteral">"Not changing pattern structure yet.. \n"</span>);
00865 
00866     f-&gt;close();
00867 
00868     <span class="keywordflow">return</span> 0;
00869 }
00870 
00871 
<a name="l00872"></a><a class="code" href="classXFuXMPlayer.html#b3">00872</a> UINT32 <a class="code" href="classXFuXMPlayer.html#b3">XFuXMPlayer::getPeriod</a>(INT8 aNote, INT8 aFinetune)
00873 {
00874     <span class="keywordflow">if</span> (aNote &lt; 0) aNote = 0;
00875     <span class="keywordflow">if</span> (aNote &gt; 96) aNote = 96;
00876 
00877     <span class="keywordflow">return</span> (7680 - (aNote &lt;&lt; 6) - (aFinetune &gt;&gt; 1));
00878 }
00879 
00880 
<a name="l00881"></a><a class="code" href="classXFuXMPlayer.html#b4">00881</a> UINT32 <a class="code" href="classXFuXMPlayer.html#b4">XFuXMPlayer::getSpeed</a>(UINT32 aPeriod, FLOAT32 aSamplingRate)
00882 {
00883     INT32 freq;
00884     INT32 shift = (INT32)(aPeriod / 768);
00885     
00886     <span class="keywordflow">if</span> (shift &gt;= 0)
00887         freq = <a class="code" href="XFuXMPlayer_8cpp.html#a10">linearFrequencyTable</a>[aPeriod - (shift &lt;&lt; 9) - (shift &lt;&lt; 8)] &gt;&gt; shift;
00888     <span class="comment">//return linearFrequencyTable[aPeriod % 768] &gt;&gt; shift;</span>
00889     <span class="keywordflow">else</span>
00890         freq = <a class="code" href="XFuXMPlayer_8cpp.html#a10">linearFrequencyTable</a>[aPeriod - (shift &lt;&lt; 9) - (shift &lt;&lt; 8)] &lt;&lt; (-shift);
00891     <span class="comment">//return linearFrequencyTable[aPeriod % 768] &lt;&lt; (-shift);</span>
00892     
00893 <span class="comment">/*</span>
00894 <span class="comment">    FLOAT32 freq = (FLOAT32)(8363.0f * pow(2.0f, (4608.f - (FLOAT32)period) / 768.0f));</span>
00895 <span class="comment">*/</span>
00896     
00897     <span class="keywordflow">return</span> (INT32)((freq / aSamplingRate) * <a class="code" href="XFuXMPlayer__internal_8h.html#a5">FP_VALUE</a>);
00898 }
00899 
00900 
<a name="l00901"></a><a class="code" href="classXFuXMPlayer.html#b1">00901</a> <a class="code" href="classXFuXMFormatAtom.html">XFuXMFormatAtom</a> <a class="code" href="classXFuXMPlayer.html#b1">XFuXMPlayer::getAtom</a>()
00902 {
00903     UINT8 *XMFORMAT_pa = <a class="code" href="classXFuXMPlayer.html#n6">mPatternData</a>[<a class="code" href="classXFuXMPlayer.html#n15">mPatternNb</a>].mData;
00904     <a class="code" href="classXFuXMFormatAtom.html">XFuXMFormatAtom</a> ta;
00905     UINT8 b;
00906     ta.<a class="code" href="classXFuXMFormatAtom.html#m0">mNote</a> = 0;
00907     ta.<a class="code" href="classXFuXMFormatAtom.html#m2">mVolume</a> = 0;
00908     ta.<a class="code" href="classXFuXMFormatAtom.html#m1">mInstrumentNb</a> = 0;
00909     ta.<a class="code" href="classXFuXMFormatAtom.html#m3">mEffectType</a> = 0;
00910     ta.<a class="code" href="classXFuXMFormatAtom.html#m4">mEffectValue</a> = 0;
00911 
00912     b = *(XMFORMAT_pa + <a class="code" href="classXFuXMPlayer.html#n13">mPpoint</a>++);
00913     <span class="keywordflow">if</span> (b &amp; 0x80)
00914     {
00915         <span class="comment">// Packed atom</span>
00916         <span class="keywordflow">if</span> (b &amp; 0x1)
00917             ta.<a class="code" href="classXFuXMFormatAtom.html#m0">mNote</a> = *(XMFORMAT_pa + <a class="code" href="classXFuXMPlayer.html#n13">mPpoint</a>++);
00918         <span class="keywordflow">if</span> (b &amp; 0x2)
00919             ta.<a class="code" href="classXFuXMFormatAtom.html#m1">mInstrumentNb</a> = *(XMFORMAT_pa + <a class="code" href="classXFuXMPlayer.html#n13">mPpoint</a>++);
00920         <span class="keywordflow">if</span> (b &amp; 0x4)
00921             ta.<a class="code" href="classXFuXMFormatAtom.html#m2">mVolume</a> = *(XMFORMAT_pa + <a class="code" href="classXFuXMPlayer.html#n13">mPpoint</a>++);
00922         <span class="keywordflow">if</span> (b &amp; 0x8)
00923             ta.<a class="code" href="classXFuXMFormatAtom.html#m3">mEffectType</a> = *(XMFORMAT_pa + <a class="code" href="classXFuXMPlayer.html#n13">mPpoint</a>++);
00924         <span class="keywordflow">if</span> (b &amp; 0x10)
00925             ta.<a class="code" href="classXFuXMFormatAtom.html#m4">mEffectValue</a> = *(XMFORMAT_pa + <a class="code" href="classXFuXMPlayer.html#n13">mPpoint</a>++);
00926     }
00927     <span class="keywordflow">else</span>
00928     {
00929         <span class="comment">// Normal atom</span>
00930         ta.<a class="code" href="classXFuXMFormatAtom.html#m0">mNote</a> = b;
00931         ta.<a class="code" href="classXFuXMFormatAtom.html#m1">mInstrumentNb</a> = *(XMFORMAT_pa + <a class="code" href="classXFuXMPlayer.html#n13">mPpoint</a>++);
00932         ta.<a class="code" href="classXFuXMFormatAtom.html#m2">mVolume</a> = *(XMFORMAT_pa + <a class="code" href="classXFuXMPlayer.html#n13">mPpoint</a>++);
00933         ta.<a class="code" href="classXFuXMFormatAtom.html#m3">mEffectType</a> = *(XMFORMAT_pa + <a class="code" href="classXFuXMPlayer.html#n13">mPpoint</a>++);
00934         ta.<a class="code" href="classXFuXMFormatAtom.html#m4">mEffectValue</a> = *(XMFORMAT_pa + <a class="code" href="classXFuXMPlayer.html#n13">mPpoint</a>++);
00935     }
00936 
00937     <span class="keywordflow">return</span> ta;
00938 }
00939 
00940 
<a name="l00941"></a><a class="code" href="classXFuXMPlayer.html#b5">00941</a> <span class="keywordtype">void</span> <a class="code" href="classXFuXMPlayer.html#b5">XFuXMPlayer::initChannel</a>(<a class="code" href="classXFuXMChannel.html">XFuXMChannel</a> &amp;aCh)
00942 {
00943     aCh.<a class="code" href="classXFuXMChannel.html#m1">mIsValid</a> = 1;
00944     aCh.<a class="code" href="classXFuXMChannel.html#m2">mInitSample</a> = 0;
00945 
00946     <span class="comment">// Initialize sample if valid note</span>
00947     <span class="keywordflow">if</span> ((aCh.<a class="code" href="classXFuXMChannel.html#m0">mTa</a>.<a class="code" href="classXFuXMFormatAtom.html#m0">mNote</a> &gt; 0) &amp;&amp; (aCh.<a class="code" href="classXFuXMChannel.html#m0">mTa</a>.<a class="code" href="classXFuXMFormatAtom.html#m0">mNote</a> &lt; 97))
00948     {
00949         aCh.<a class="code" href="classXFuXMChannel.html#m14">mNote</a> = (INT8)(aCh.<a class="code" href="classXFuXMChannel.html#m0">mTa</a>.<a class="code" href="classXFuXMFormatAtom.html#m0">mNote</a> - 1);
00950         aCh.<a class="code" href="classXFuXMChannel.html#m2">mInitSample</a> = 1;
00951 
00952         aCh.<a class="code" href="classXFuXMChannel.html#m60">mTremorTicker</a> = 0;
00953         aCh.<a class="code" href="classXFuXMChannel.html#m59">mMultiRetrigTicker</a> = 0;        
00954     }
00955     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (aCh.<a class="code" href="classXFuXMChannel.html#m0">mTa</a>.<a class="code" href="classXFuXMFormatAtom.html#m0">mNote</a> != 0)
00956         aCh.<a class="code" href="classXFuXMChannel.html#m1">mIsValid</a> = 0;
00957 
00958     aCh.<a class="code" href="classXFuXMChannel.html#m41">mVolumeColumn</a> = aCh.<a class="code" href="classXFuXMChannel.html#m0">mTa</a>.<a class="code" href="classXFuXMFormatAtom.html#m2">mVolume</a>;
00959 
00960     <span class="keywordflow">if</span> (aCh.<a class="code" href="classXFuXMChannel.html#m0">mTa</a>.<a class="code" href="classXFuXMFormatAtom.html#m1">mInstrumentNb</a> != 0)
00961     {
00962         <span class="comment">// New instrument</span>
00963         aCh.<a class="code" href="classXFuXMChannel.html#m8">mInstrumentNb</a> = (INT16)(aCh.<a class="code" href="classXFuXMChannel.html#m0">mTa</a>.<a class="code" href="classXFuXMFormatAtom.html#m1">mInstrumentNb</a> - 1);
00964 
00965         <span class="keywordflow">if</span> (aCh.<a class="code" href="classXFuXMChannel.html#m8">mInstrumentNb</a> &lt; <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m5">mNbInstruments</a>)
00966         {
00967             aCh.<a class="code" href="classXFuXMChannel.html#m4">mCurrentInstrument</a> = <a class="code" href="classXFuXMPlayer.html#n7">mInstruments</a>[aCh.<a class="code" href="classXFuXMChannel.html#m8">mInstrumentNb</a>];
00968 
00969             <span class="keywordflow">if</span> (aCh.<a class="code" href="classXFuXMChannel.html#m4">mCurrentInstrument</a>.<a class="code" href="classXFuXMInstrument.html#m2">mKeyboard</a>[aCh.<a class="code" href="classXFuXMChannel.html#m14">mNote</a>] &lt; aCh.<a class="code" href="classXFuXMChannel.html#m4">mCurrentInstrument</a>.<a class="code" href="classXFuXMInstrument.html#m0">mNbSamples</a>)
00970             {
00971                 <span class="keywordflow">if</span> (aCh.<a class="code" href="classXFuXMChannel.html#m4">mCurrentInstrument</a>.<a class="code" href="classXFuXMInstrument.html#m1">mSamples</a>[aCh.<a class="code" href="classXFuXMChannel.html#m4">mCurrentInstrument</a>.<a class="code" href="classXFuXMInstrument.html#m2">mKeyboard</a>[aCh.<a class="code" href="classXFuXMChannel.html#m14">mNote</a>]].mOffset != NULL)
00972                 {
00973                     aCh.<a class="code" href="classXFuXMChannel.html#m5">mCurrentSample</a> = aCh.<a class="code" href="classXFuXMChannel.html#m4">mCurrentInstrument</a>.<a class="code" href="classXFuXMInstrument.html#m1">mSamples</a>[aCh.<a class="code" href="classXFuXMChannel.html#m4">mCurrentInstrument</a>.<a class="code" href="classXFuXMInstrument.html#m2">mKeyboard</a>[aCh.<a class="code" href="classXFuXMChannel.html#m14">mNote</a>]];
00974                 }
00975                 <span class="keywordflow">else</span> aCh.<a class="code" href="classXFuXMChannel.html#m1">mIsValid</a> = 0;
00976             }
00977             <span class="keywordflow">else</span> aCh.<a class="code" href="classXFuXMChannel.html#m1">mIsValid</a> = 0;
00978         }
00979         <span class="keywordflow">else</span> aCh.<a class="code" href="classXFuXMChannel.html#m1">mIsValid</a> = 0;
00980         
00981         aCh.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> = aCh.<a class="code" href="classXFuXMChannel.html#m5">mCurrentSample</a>.<a class="code" href="classXFuXMSample.html#m0">mVolume</a>;
00982         aCh.<a class="code" href="classXFuXMChannel.html#m27">mBaseVolume</a> = aCh.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a>;
00983 
00984         aCh.<a class="code" href="classXFuXMChannel.html#m38">mPan</a> = aCh.<a class="code" href="classXFuXMChannel.html#m5">mCurrentSample</a>.<a class="code" href="classXFuXMSample.html#m1">mPan</a>;
00985     }
00986     <span class="keywordflow">else</span>
00987     {
00988         <span class="keywordflow">if</span> ((aCh.<a class="code" href="classXFuXMChannel.html#m8">mInstrumentNb</a> != -1) &amp;&amp; (aCh.<a class="code" href="classXFuXMChannel.html#m8">mInstrumentNb</a> &lt; <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m5">mNbInstruments</a>))
00989         {            
00990             aCh.<a class="code" href="classXFuXMChannel.html#m4">mCurrentInstrument</a> = <a class="code" href="classXFuXMPlayer.html#n7">mInstruments</a>[aCh.<a class="code" href="classXFuXMChannel.html#m8">mInstrumentNb</a>];
00991 
00992             <span class="keywordflow">if</span> (aCh.<a class="code" href="classXFuXMChannel.html#m4">mCurrentInstrument</a>.<a class="code" href="classXFuXMInstrument.html#m2">mKeyboard</a>[aCh.<a class="code" href="classXFuXMChannel.html#m14">mNote</a>] &lt; aCh.<a class="code" href="classXFuXMChannel.html#m4">mCurrentInstrument</a>.<a class="code" href="classXFuXMInstrument.html#m0">mNbSamples</a>)
00993             {
00994                 <span class="keywordflow">if</span> (aCh.<a class="code" href="classXFuXMChannel.html#m4">mCurrentInstrument</a>.<a class="code" href="classXFuXMInstrument.html#m1">mSamples</a>[aCh.<a class="code" href="classXFuXMChannel.html#m4">mCurrentInstrument</a>.<a class="code" href="classXFuXMInstrument.html#m2">mKeyboard</a>[aCh.<a class="code" href="classXFuXMChannel.html#m14">mNote</a>]].mOffset != NULL)
00995                 {
00996                     aCh.<a class="code" href="classXFuXMChannel.html#m5">mCurrentSample</a> = aCh.<a class="code" href="classXFuXMChannel.html#m4">mCurrentInstrument</a>.<a class="code" href="classXFuXMInstrument.html#m1">mSamples</a>[aCh.<a class="code" href="classXFuXMChannel.html#m4">mCurrentInstrument</a>.<a class="code" href="classXFuXMInstrument.html#m2">mKeyboard</a>[aCh.<a class="code" href="classXFuXMChannel.html#m14">mNote</a>]];
00997                 }
00998                 <span class="keywordflow">else</span> aCh.<a class="code" href="classXFuXMChannel.html#m1">mIsValid</a> = 0;
00999             }
01000             <span class="keywordflow">else</span> aCh.<a class="code" href="classXFuXMChannel.html#m1">mIsValid</a> = 0;
01001         }
01002         <span class="keywordflow">else</span> aCh.<a class="code" href="classXFuXMChannel.html#m1">mIsValid</a> = 0;
01003     }
01004 
01005     aCh.<a class="code" href="classXFuXMChannel.html#m62">mOldPeriod</a> = aCh.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a>;
01006 
01007     <span class="comment">// Do not initialize sound if note delay or pattern delay effect on</span>
01008     <span class="keywordflow">if</span> ((aCh.<a class="code" href="classXFuXMChannel.html#m2">mInitSample</a>) || (<a class="code" href="classXFuXMPlayer.html#n21">mPatternDelayCounter</a> != 0))
01009         <a class="code" href="classXFuXMPlayer.html#b6">initSound</a>(aCh);
01010 }
01011 
01012 
<a name="l01013"></a><a class="code" href="classXFuXMPlayer.html#b6">01013</a> <span class="keywordtype">void</span> <a class="code" href="classXFuXMPlayer.html#b6">XFuXMPlayer::initSound</a>(<a class="code" href="classXFuXMChannel.html">XFuXMChannel</a> &amp;aCh)
01014 {
01015     <span class="keywordflow">if</span> (aCh.<a class="code" href="classXFuXMChannel.html#m1">mIsValid</a>)
01016     {
01017         <span class="comment">// Initialize sample</span>
01018         <span class="keywordflow">if</span> (aCh.<a class="code" href="classXFuXMChannel.html#m2">mInitSample</a>) aCh.<a class="code" href="classXFuXMChannel.html#m13">mIsSample</a> = 1;
01019 
01020         <span class="comment">// New note</span>
01021         aCh.<a class="code" href="classXFuXMChannel.html#m16">mDirection</a> = 1;
01022 
01023         <span class="comment">// Init vibrato</span>
01024         <span class="comment">/* Instrument vibrato is independent</span>
01025 <span class="comment">        aCh.mIsVibrato = aCh.mCurrentInstrument.mIsVibrato;</span>
01026 <span class="comment">        if (aCh.mCurrentInstrument.mVibratoDepth != 0)</span>
01027 <span class="comment">            aCh.mVibratoDepth = aCh.mCurrentInstrument.mVibratoDepth;</span>
01028 <span class="comment">        if (aCh.mCurrentInstrument.mVibratoRate != 0)</span>
01029 <span class="comment">            aCh.mVibratoRate = aCh.mCurrentInstrument.mVibratoRate;</span>
01030 <span class="comment">        */</span>
01031         aCh.<a class="code" href="classXFuXMChannel.html#m65">mIsVibrato</a> = 0;
01032 
01033         <span class="keywordflow">if</span> ((aCh.<a class="code" href="classXFuXMChannel.html#m69">mVibratoWaveform</a> &amp; <a class="code" href="XFuXMPlayer__internal_8h.html#a23a16">WAVEFORM_NO_RETRIG</a>) == 0) aCh.<a class="code" href="classXFuXMChannel.html#m68">mVibratoPointer</a> = 0;
01034         <span class="keywordflow">if</span> ((aCh.<a class="code" href="classXFuXMChannel.html#m73">mTremoloWaveform</a> &amp; <a class="code" href="XFuXMPlayer__internal_8h.html#a23a16">WAVEFORM_NO_RETRIG</a>) == 0) aCh.<a class="code" href="classXFuXMChannel.html#m72">mTremoloPointer</a> = 0;
01035 
01036         <span class="comment">// Init volume envelope</span>
01037         aCh.<a class="code" href="classXFuXMChannel.html#m17">mVolEnvType</a> = aCh.<a class="code" href="classXFuXMChannel.html#m4">mCurrentInstrument</a>.<a class="code" href="classXFuXMInstrument.html#m5">mVolEnvType</a>;
01038         aCh.<a class="code" href="classXFuXMChannel.html#m18">mVolEnvPointer</a> = 0;
01039         aCh.<a class="code" href="classXFuXMChannel.html#m19">mVolEnvSpeed</a> = 1;
01040         aCh.<a class="code" href="classXFuXMChannel.html#m20">mVolEnvLoopStart</a> = aCh.<a class="code" href="classXFuXMChannel.html#m4">mCurrentInstrument</a>.<a class="code" href="classXFuXMInstrument.html#m6">mVolEnvLoopStart</a>;
01041         aCh.<a class="code" href="classXFuXMChannel.html#m21">mVolEnvLoopEnd</a> = aCh.<a class="code" href="classXFuXMChannel.html#m4">mCurrentInstrument</a>.<a class="code" href="classXFuXMInstrument.html#m7">mVolEnvLoopEnd</a>;
01042         aCh.<a class="code" href="classXFuXMChannel.html#m22">mVolEnvSustain</a> = aCh.<a class="code" href="classXFuXMChannel.html#m4">mCurrentInstrument</a>.<a class="code" href="classXFuXMInstrument.html#m8">mVolEnvSustain</a>;
01043 
01044         aCh.<a class="code" href="classXFuXMChannel.html#m24">mVolumeFadeout</a> = aCh.<a class="code" href="classXFuXMChannel.html#m4">mCurrentInstrument</a>.<a class="code" href="classXFuXMInstrument.html#m9">mVolumeFadeout</a>;
01045         aCh.<a class="code" href="classXFuXMChannel.html#m25">mVolumeFadeoutValue</a> = REAL(1);
01046 
01047         <span class="comment">// Init panning envelope</span>
01048         aCh.<a class="code" href="classXFuXMChannel.html#m31">mPanEnvType</a> = aCh.<a class="code" href="classXFuXMChannel.html#m4">mCurrentInstrument</a>.<a class="code" href="classXFuXMInstrument.html#m12">mPanEnvType</a>;
01049         aCh.<a class="code" href="classXFuXMChannel.html#m32">mPanEnvPointer</a> = 0;
01050         aCh.<a class="code" href="classXFuXMChannel.html#m33">mPanEnvSpeed</a> = 1;
01051         aCh.<a class="code" href="classXFuXMChannel.html#m34">mPanEnvLoopStart</a> = aCh.<a class="code" href="classXFuXMChannel.html#m4">mCurrentInstrument</a>.<a class="code" href="classXFuXMInstrument.html#m13">mPanEnvLoopStart</a>;
01052         aCh.<a class="code" href="classXFuXMChannel.html#m35">mPanEnvLoopEnd</a> = aCh.<a class="code" href="classXFuXMChannel.html#m4">mCurrentInstrument</a>.<a class="code" href="classXFuXMInstrument.html#m14">mPanEnvLoopEnd</a>;
01053         aCh.<a class="code" href="classXFuXMChannel.html#m36">mPanEnvSustain</a> = aCh.<a class="code" href="classXFuXMChannel.html#m4">mCurrentInstrument</a>.<a class="code" href="classXFuXMInstrument.html#m15">mPanEnvSustain</a>;
01054 
01055         aCh.<a class="code" href="classXFuXMChannel.html#m40">mSustainReleased</a> = 0;
01056 
01057         aCh.<a class="code" href="classXFuXMChannel.html#m6">mOffset</a> = aCh.<a class="code" href="classXFuXMChannel.html#m5">mCurrentSample</a>.<a class="code" href="classXFuXMSample.html#m4">mOffset</a>;
01058         aCh.<a class="code" href="classXFuXMChannel.html#m15">mFinetune</a> = aCh.<a class="code" href="classXFuXMChannel.html#m5">mCurrentSample</a>.<a class="code" href="classXFuXMSample.html#m2">mFinetune</a>;
01059 
01060         <span class="keywordflow">if</span> ((aCh.<a class="code" href="classXFuXMChannel.html#m42">mEffectType</a> != 0x3) &amp;&amp;   <span class="comment">// No tone portamento</span>
01061             (aCh.<a class="code" href="classXFuXMChannel.html#m42">mEffectType</a> != 0x5) &amp;&amp;   <span class="comment">// No tone portamento + volume slide</span>
01062             (aCh.<a class="code" href="classXFuXMChannel.html#m41">mVolumeColumn</a> &lt; 0xF0)) <span class="comment">// No volume column tone portamento</span>
01063             aCh.<a class="code" href="classXFuXMChannel.html#m3">mPointer</a> = 0; <span class="comment">// Reset pointer if no tone effect</span>
01064 
01065         aCh.<a class="code" href="classXFuXMChannel.html#m7">mLength</a> = (aCh.<a class="code" href="classXFuXMChannel.html#m5">mCurrentSample</a>.<a class="code" href="classXFuXMSample.html#m5">mSize</a> &lt;&lt; <a class="code" href="XFuXMPlayer__internal_8h.html#a4">FP_BITS</a>);
01066         aCh.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a> = <a class="code" href="classXFuXMPlayer.html#b3">getPeriod</a>((INT8)(aCh.<a class="code" href="classXFuXMChannel.html#m14">mNote</a> + aCh.<a class="code" href="classXFuXMChannel.html#m5">mCurrentSample</a>.<a class="code" href="classXFuXMSample.html#m3">mRelativeNote</a>), aCh.<a class="code" href="classXFuXMChannel.html#m15">mFinetune</a>);
01067         aCh.<a class="code" href="classXFuXMChannel.html#m64">mBasePeriod</a> = aCh.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a>;
01068 
01069         aCh.<a class="code" href="classXFuXMChannel.html#m10">mLoop</a> = 0;
01070         <span class="keywordflow">if</span> (aCh.<a class="code" href="classXFuXMChannel.html#m5">mCurrentSample</a>.<a class="code" href="classXFuXMSample.html#m6">mLoopForward</a>) aCh.<a class="code" href="classXFuXMChannel.html#m10">mLoop</a> = <a class="code" href="XFuXMPlayer__internal_8h.html#a21a8">LOOP_FORWARD</a>;
01071         <span class="keywordflow">if</span> (aCh.<a class="code" href="classXFuXMChannel.html#m5">mCurrentSample</a>.<a class="code" href="classXFuXMSample.html#m7">mLoopPingpong</a>) aCh.<a class="code" href="classXFuXMChannel.html#m10">mLoop</a> = <a class="code" href="XFuXMPlayer__internal_8h.html#a21a9">LOOP_PINGPONG</a>;
01072         aCh.<a class="code" href="classXFuXMChannel.html#m11">mLoopStart</a> = (aCh.<a class="code" href="classXFuXMChannel.html#m5">mCurrentSample</a>.<a class="code" href="classXFuXMSample.html#m8">mLoopStart</a> &lt;&lt; <a class="code" href="XFuXMPlayer__internal_8h.html#a4">FP_BITS</a>);
01073         aCh.<a class="code" href="classXFuXMChannel.html#m12">mLoopEnd</a> = (aCh.<a class="code" href="classXFuXMChannel.html#m5">mCurrentSample</a>.<a class="code" href="classXFuXMSample.html#m9">mLoopEnd</a> &lt;&lt; <a class="code" href="XFuXMPlayer__internal_8h.html#a4">FP_BITS</a>);
01074     }
01075     <span class="keywordflow">else</span>
01076         aCh.<a class="code" href="classXFuXMChannel.html#m13">mIsSample</a> = 0;
01077 }
01078 
01079 
<a name="l01080"></a><a class="code" href="classXFuXMPlayer.html#b7">01080</a> <span class="keywordtype">void</span> <a class="code" href="classXFuXMPlayer.html#b7">XFuXMPlayer::notifyHandlers</a>(<a class="code" href="classXFuXMChannel.html">XFuXMChannel</a> &amp;aCh)
01081 {
01082     <a class="code" href="classXFuXMPlayerEvent.html">XFuXMPlayerEvent</a> event;
01083 
01084     event.<a class="code" href="classXFuXMPlayerEvent.html#m0">mNote</a> = aCh.<a class="code" href="classXFuXMChannel.html#m14">mNote</a>;
01085     event.<a class="code" href="classXFuXMPlayerEvent.html#m1">mInstrumentNb</a> = aCh.<a class="code" href="classXFuXMChannel.html#m8">mInstrumentNb</a>;
01086     event.<a class="code" href="classXFuXMPlayerEvent.html#m2">mVolume</a> = aCh.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a>;
01087 
01088     <span class="keywordflow">if</span> ((aCh.<a class="code" href="classXFuXMChannel.html#m42">mEffectType</a> != 0xE) &amp;&amp; (aCh.<a class="code" href="classXFuXMChannel.html#m42">mEffectType</a> != 0x21))
01089     {
01090         event.<a class="code" href="classXFuXMPlayerEvent.html#m3">mEffectType</a> = aCh.<a class="code" href="classXFuXMChannel.html#m42">mEffectType</a>;
01091         event.<a class="code" href="classXFuXMPlayerEvent.html#m4">mEffectValue</a> = aCh.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a>;
01092     }
01093     <span class="keywordflow">else</span>
01094     {
01095         event.<a class="code" href="classXFuXMPlayerEvent.html#m3">mEffectType</a> = (INT16)((aCh.<a class="code" href="classXFuXMChannel.html#m42">mEffectType</a> &lt;&lt; 4) | (aCh.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &gt;&gt; 4));
01096         event.<a class="code" href="classXFuXMPlayerEvent.html#m4">mEffectValue</a> = (INT16)(aCh.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &amp; 0xF);
01097     }
01098 
01099     event.<a class="code" href="classXFuXMPlayerEvent.html#m5">mPlayer</a> = <span class="keyword">this</span>;
01100 
01101     XFcLinkedList&lt;XFuXMPlayerEventHandlerSlot&gt;::forwardIterator i;
01102     <a class="code" href="classXFuXMPlayerEventHandlerSlot.html">XFuXMPlayerEventHandlerSlot</a> temp;
01103 
01104     <span class="keywordflow">for</span> (i = <a class="code" href="classXFuXMPlayer.html#n29">mEventHandlers</a>-&gt;forwardBegin(); i != <a class="code" href="classXFuXMPlayer.html#n29">mEventHandlers</a>-&gt;forwardEnd(); ++i)
01105     {
01106         temp = i.getData();
01107 
01108         <span class="keywordflow">if</span> (((temp.<a class="code" href="classXFuXMPlayerEventHandlerSlot.html#m0">mEvent</a>.<a class="code" href="classXFuXMPlayerEvent.html#m0">mNote</a> != -1) &amp;&amp; (temp.<a class="code" href="classXFuXMPlayerEventHandlerSlot.html#m0">mEvent</a>.<a class="code" href="classXFuXMPlayerEvent.html#m0">mNote</a> == event.<a class="code" href="classXFuXMPlayerEvent.html#m0">mNote</a>)) ||
01109             ((temp.<a class="code" href="classXFuXMPlayerEventHandlerSlot.html#m0">mEvent</a>.<a class="code" href="classXFuXMPlayerEvent.html#m1">mInstrumentNb</a> != -1) &amp;&amp; (temp.<a class="code" href="classXFuXMPlayerEventHandlerSlot.html#m0">mEvent</a>.<a class="code" href="classXFuXMPlayerEvent.html#m1">mInstrumentNb</a> == event.<a class="code" href="classXFuXMPlayerEvent.html#m1">mInstrumentNb</a>)) ||
01110             ((temp.<a class="code" href="classXFuXMPlayerEventHandlerSlot.html#m0">mEvent</a>.<a class="code" href="classXFuXMPlayerEvent.html#m3">mEffectType</a> != -1) &amp;&amp; (temp.<a class="code" href="classXFuXMPlayerEventHandlerSlot.html#m0">mEvent</a>.<a class="code" href="classXFuXMPlayerEvent.html#m3">mEffectType</a> == event.<a class="code" href="classXFuXMPlayerEvent.html#m3">mEffectType</a>)))
01111         {
01112             temp.<a class="code" href="classXFuXMPlayerEventHandlerSlot.html#m1">mHandler</a>-&gt;<a class="code" href="classXFuXMPlayerEventHandler.html#a0">handleXMPlayerEvent</a>(event);
01113         }
01114     }
01115 }
01116 
01117 
<a name="l01118"></a><a class="code" href="classXFuXMPlayer.html#a0">01118</a> <span class="keywordtype">void</span> <a class="code" href="classXFuXMPlayer.html#a0">XFuXMPlayer::initSong</a>(INT16 aStartOrder)
01119 {
01120     INT i;
01121 
01122     <span class="keywordflow">if</span> ((aStartOrder &lt; 0) || (aStartOrder &gt;= <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m1">mSongLength</a>)) aStartOrder = 0;
01123     <a class="code" href="classXFuXMPlayer.html#n14">mCurrentOrder</a> = (INT16)(aStartOrder - 1);
01124 
01125     <a class="code" href="classXFuXMPlayer.html#n15">mPatternNb</a> = <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m0">mOrderTable</a>[aStartOrder];
01126     <span class="keywordflow">if</span> (<a class="code" href="classXFuXMPlayer.html#n15">mPatternNb</a> &gt;= <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m3">mNbPatterns</a>) <a class="code" href="classXFuXMPlayer.html#n15">mPatternNb</a> = <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m0">mOrderTable</a>[0];
01127 
01128     <a class="code" href="classXFuXMPlayer.html#n16">mCurrentRow</a> = 1024;
01129 
01130     <a class="code" href="classXFuXMPlayer.html#n21">mPatternDelayCounter</a> = 0;
01131     <a class="code" href="classXFuXMPlayer.html#n22">mPatternDelayCounterTemp</a> = 0;
01132     <a class="code" href="classXFuXMPlayer.html#n23">mPatternDelaySkip</a> = 0;
01133     <a class="code" href="classXFuXMPlayer.html#n25">mJumpFlag</a> = 0;
01134     <a class="code" href="classXFuXMPlayer.html#n24">mIsRead</a> = 1;
01135 
01136     <a class="code" href="classXFuXMPlayer.html#n19">mTickRate</a> = (2.0f * <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m7">mBpm</a> / 5.0f);
01137 
01138     <a class="code" href="classXFuXMPlayer.html#n17">mSamplesPerTick</a> = (INT32)(<a class="code" href="classXFuXMPlayer.html#n0">mSamplingRate</a> / <a class="code" href="classXFuXMPlayer.html#n19">mTickRate</a>);
01139 
01140     <a class="code" href="classXFuXMPlayer.html#n26">mCurrentTick</a> = (UINT8)(<a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m6">mTempo</a> - 1); <span class="comment">// Playing starts from last tick</span>
01141     <a class="code" href="classXFuXMPlayer.html#n18">mSamplePointer</a> = <a class="code" href="classXFuXMPlayer.html#n17">mSamplesPerTick</a>;         <span class="comment">// Playing starts from last sample of last tick</span>
01142 
01143     <a class="code" href="classXFuXMPlayer.html#n27">mTotalTicks</a> = 0;
01144 
01145     <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m8">mGlobalVolume</a> = 64;
01146 
01147     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m4">mNbChannels</a>; i++)
01148     {
01149         <a class="code" href="classXFuXMChannel.html">XFuXMChannel</a> &amp;ch = <a class="code" href="classXFuXMPlayer.html#n8">mChannels</a>[i];
01150 
01151         ch.<a class="code" href="classXFuXMChannel.html#m6">mOffset</a> = NULL;
01152         ch.<a class="code" href="classXFuXMChannel.html#m3">mPointer</a> = 0;
01153         ch.<a class="code" href="classXFuXMChannel.html#m7">mLength</a> = 0;
01154         ch.<a class="code" href="classXFuXMChannel.html#m8">mInstrumentNb</a> = -1;
01155         ch.<a class="code" href="classXFuXMChannel.html#m9">mSpeed</a> = 0;
01156         ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a> = 0;
01157 
01158         ch.<a class="code" href="classXFuXMChannel.html#m10">mLoop</a> = 0;
01159         ch.<a class="code" href="classXFuXMChannel.html#m11">mLoopStart</a> = 0;
01160         ch.<a class="code" href="classXFuXMChannel.html#m12">mLoopEnd</a> = 0;
01161 
01162         ch.<a class="code" href="classXFuXMChannel.html#m13">mIsSample</a> = 0;
01163 
01164         ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> = 0;
01165         ch.<a class="code" href="classXFuXMChannel.html#m27">mBaseVolume</a> = 0;
01166         ch.<a class="code" href="classXFuXMChannel.html#m29">mFinalOldVolume</a> = 0;
01167         ch.<a class="code" href="classXFuXMChannel.html#m30">mFinalVolumeSpeed</a> = 0;
01168 
01169         ch.<a class="code" href="classXFuXMChannel.html#m14">mNote</a> = 0;
01170 
01171         ch.<a class="code" href="classXFuXMChannel.html#m16">mDirection</a> = 1;
01172 
01173         ch.<a class="code" href="classXFuXMChannel.html#m17">mVolEnvType</a> = 0;
01174         ch.<a class="code" href="classXFuXMChannel.html#m18">mVolEnvPointer</a> = 0;
01175         ch.<a class="code" href="classXFuXMChannel.html#m19">mVolEnvSpeed</a> = 0;
01176         ch.<a class="code" href="classXFuXMChannel.html#m20">mVolEnvLoopStart</a> = 0;
01177         ch.<a class="code" href="classXFuXMChannel.html#m21">mVolEnvLoopEnd</a> = 0;
01178         ch.<a class="code" href="classXFuXMChannel.html#m22">mVolEnvSustain</a> = 0;
01179         ch.<a class="code" href="classXFuXMChannel.html#m23">mVolEnvValue</a> = 0;
01180 
01181         ch.<a class="code" href="classXFuXMChannel.html#m31">mPanEnvType</a> = 0;
01182         ch.<a class="code" href="classXFuXMChannel.html#m32">mPanEnvPointer</a> = 0;
01183         ch.<a class="code" href="classXFuXMChannel.html#m33">mPanEnvSpeed</a> = 0;
01184         ch.<a class="code" href="classXFuXMChannel.html#m34">mPanEnvLoopStart</a> = 0;
01185         ch.<a class="code" href="classXFuXMChannel.html#m35">mPanEnvLoopEnd</a> = 0;
01186         ch.<a class="code" href="classXFuXMChannel.html#m36">mPanEnvSustain</a> = 0;
01187         ch.<a class="code" href="classXFuXMChannel.html#m37">mPanEnvValue</a> = 0;
01188 
01189         ch.<a class="code" href="classXFuXMChannel.html#m24">mVolumeFadeout</a> = 0;
01190         ch.<a class="code" href="classXFuXMChannel.html#m25">mVolumeFadeoutValue</a> = 0;
01191 
01192         ch.<a class="code" href="classXFuXMChannel.html#m40">mSustainReleased</a> = 0;
01193 
01194         ch.<a class="code" href="classXFuXMChannel.html#m41">mVolumeColumn</a> = 0;
01195 
01196         ch.<a class="code" href="classXFuXMChannel.html#m42">mEffectType</a> = 0;
01197         ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> = 0;
01198         ch.<a class="code" href="classXFuXMChannel.html#m46">mTonePortamentoV</a> = 0;
01199         ch.<a class="code" href="classXFuXMChannel.html#m47">mVolumeSlideV</a> = 0;
01200         ch.<a class="code" href="classXFuXMChannel.html#m52">mGlobalVolumeSlideV</a> = 0;
01201         ch.<a class="code" href="classXFuXMChannel.html#m50">mFineVolumeSlideUpV</a> = 0;
01202         ch.<a class="code" href="classXFuXMChannel.html#m51">mFineVolumeSlideDownV</a> = 0;
01203         ch.<a class="code" href="classXFuXMChannel.html#m48">mFinePortamentoUpV</a> = 0;
01204         ch.<a class="code" href="classXFuXMChannel.html#m49">mFinePortamentoDownV</a> = 0;
01205         ch.<a class="code" href="classXFuXMChannel.html#m50">mFineVolumeSlideUpV</a> = 0;
01206         ch.<a class="code" href="classXFuXMChannel.html#m51">mFineVolumeSlideDownV</a> = 0;
01207         ch.<a class="code" href="classXFuXMChannel.html#m52">mGlobalVolumeSlideV</a> = 0;
01208         ch.<a class="code" href="classXFuXMChannel.html#m53">mMultiRetrigVolumeV</a> = 0;
01209         ch.<a class="code" href="classXFuXMChannel.html#m54">mMultiRetrigRateV</a> = 0;
01210         ch.<a class="code" href="classXFuXMChannel.html#m55">mTremorV</a> = 0;
01211         ch.<a class="code" href="classXFuXMChannel.html#m56">mExtraFinePortamentoUpV</a> = 0;
01212         ch.<a class="code" href="classXFuXMChannel.html#m57">mExtraFinePortamentoDownV</a> = 0;
01213 
01214         ch.<a class="code" href="classXFuXMChannel.html#m59">mMultiRetrigTicker</a> = 0;
01215         ch.<a class="code" href="classXFuXMChannel.html#m60">mTremorTicker</a> = 0;
01216 
01217         ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a> = 0;
01218         ch.<a class="code" href="classXFuXMChannel.html#m64">mBasePeriod</a> = 0;
01219         ch.<a class="code" href="classXFuXMChannel.html#m62">mOldPeriod</a> = 0;
01220         ch.<a class="code" href="classXFuXMChannel.html#m63">mDestPeriod</a> = 0;
01221 
01222         ch.<a class="code" href="classXFuXMChannel.html#m65">mIsVibrato</a> = 0;
01223         ch.<a class="code" href="classXFuXMChannel.html#m67">mVibratoDepth</a> = 0;
01224         ch.<a class="code" href="classXFuXMChannel.html#m66">mVibratoRate</a> = 0;
01225         ch.<a class="code" href="classXFuXMChannel.html#m68">mVibratoPointer</a> = 0;
01226         ch.<a class="code" href="classXFuXMChannel.html#m69">mVibratoWaveform</a> = <a class="code" href="XFuXMPlayer__internal_8h.html#a23a13">WAVEFORM_SINEWAVE</a>;
01227 
01228         ch.<a class="code" href="classXFuXMChannel.html#m71">mTremoloDepth</a> = 0;
01229         ch.<a class="code" href="classXFuXMChannel.html#m70">mTremoloRate</a> = 0;
01230         ch.<a class="code" href="classXFuXMChannel.html#m72">mTremoloPointer</a> = 0;
01231         ch.<a class="code" href="classXFuXMChannel.html#m73">mTremoloWaveform</a> = <a class="code" href="XFuXMPlayer__internal_8h.html#a23a13">WAVEFORM_SINEWAVE</a>;
01232     }
01233 }
01234 
01235 
<a name="l01236"></a><a class="code" href="classXFuXMPlayer.html#a1">01236</a> INT32 <a class="code" href="classXFuXMPlayer.html#a1">XFuXMPlayer::getTick</a>()
01237 {
01238     <span class="keywordflow">return</span> (INT32)((<a class="code" href="classXFuXMPlayer.html#n27">mTotalTicks</a> * 1000) / <a class="code" href="classXFuXMPlayer.html#n0">mSamplingRate</a>);
01239 }
01240 
01241 
<a name="l01242"></a><a class="code" href="classXFuXMPlayer.html#a2">01242</a> INT16 <a class="code" href="classXFuXMPlayer.html#a2">XFuXMPlayer::getCurrentOrder</a>()
01243 {
01244     <span class="keywordflow">return</span> <a class="code" href="classXFuXMPlayer.html#n14">mCurrentOrder</a>;
01245 }
01246 
01247 
<a name="l01248"></a><a class="code" href="classXFuXMPlayer.html#a3">01248</a> <span class="keywordtype">void</span> <a class="code" href="classXFuXMPlayer.html#a3">XFuXMPlayer::addHandler</a>(<a class="code" href="classXFuXMPlayerEvent.html">XFuXMPlayerEvent</a> aEvent, <a class="code" href="classXFuXMPlayerEventHandler.html">XFuXMPlayerEventHandler</a> *aHandler)
01249 {
01250     <span class="keywordflow">if</span> (aHandler != NULL)
01251     {
01252         <a class="code" href="classXFuXMPlayerEventHandlerSlot.html">XFuXMPlayerEventHandlerSlot</a> temp;
01253         temp.<a class="code" href="classXFuXMPlayerEventHandlerSlot.html#m0">mEvent</a> = aEvent;
01254         temp.<a class="code" href="classXFuXMPlayerEventHandlerSlot.html#m1">mHandler</a> = aHandler;
01255 
01256         <a class="code" href="classXFuXMPlayer.html#n29">mEventHandlers</a>-&gt;addLast(temp);
01257     }
01258 }
01259 
01260 
<a name="l01261"></a><a class="code" href="classXFuXMPlayer.html#a4">01261</a> INT <a class="code" href="classXFuXMPlayer.html#a4">XFuXMPlayer::removeHandler</a>(<a class="code" href="classXFuXMPlayerEventHandler.html">XFuXMPlayerEventHandler</a> *aHandler)
01262 {
01263     <span class="keywordflow">if</span> (aHandler != NULL)
01264     {
01265         <a class="code" href="classXFuXMPlayerEventHandlerSlot.html">XFuXMPlayerEventHandlerSlot</a> temp;
01266         temp.<a class="code" href="classXFuXMPlayerEventHandlerSlot.html#m1">mHandler</a> = aHandler;
01267 
01268         <span class="keywordflow">return</span> <a class="code" href="classXFuXMPlayer.html#n29">mEventHandlers</a>-&gt;remove(temp);
01269     }
01270 
01271     <span class="keywordflow">return</span> 0;
01272 }
01273 
01274 
<a name="l01275"></a><a class="code" href="classXFuXMPlayer.html#a5">01275</a> <span class="keywordtype">void</span> <a class="code" href="classXFuXMPlayer.html#a5">XFuXMPlayer::removeHandlers</a>()
01276 {
01277     XFcLinkedList&lt;XFuXMPlayerEventHandlerSlot&gt;::forwardIterator i = <a class="code" href="classXFuXMPlayer.html#n29">mEventHandlers</a>-&gt;forwardBegin();
01278     <a class="code" href="classXFuXMPlayerEventHandlerSlot.html">XFuXMPlayerEventHandlerSlot</a> temp;
01279 
01280     <span class="keywordflow">while</span> (i.isValid())
01281     {
01282         <a class="code" href="classXFuXMPlayer.html#n29">mEventHandlers</a>-&gt;remove(i);
01283     }
01284 }
01285 
01286 
<a name="l01287"></a><a class="code" href="classXFuXMPlayer.html#a6">01287</a> <span class="keywordtype">void</span> <a class="code" href="classXFuXMPlayer.html#a6">XFuXMPlayer::stop</a>()
01288 {
01289     <a class="code" href="classXFuXMPlayer.html#a0">initSong</a>(0);
01290 }
01291 
01292 <span class="comment">// For MSVC</span>
01293 <span class="preprocessor">#pragma warning(disable:4244)</span>
01294 <span class="preprocessor"></span>
<a name="l01295"></a><a class="code" href="classXFuXMPlayer.html#a7">01295</a> UINT32 <a class="code" href="classXFuXMPlayer.html#a7">XFuXMPlayer::stream</a>(<span class="keywordtype">void</span> *aBuffer, INT32 aTargetSamples, INT32 aOffset, 
01296                            INT32 aSamples)
01297 {
01298     INT32 cLeft, cRight;
01299 
01300     INT32 chan;
01301 
01302     INT32 index;
01303     INT32 targetOffset = aOffset;
01304     INT32 counter;
01305     INT32 indicesLeft;
01306     INT32 ticksLeft;
01307     INT32 samplesToRender;
01308 
01309     INT32 delta;
01310     INT32 val1, val2;
01311     INT32 value;
01312     INT32 temp;
01313 
01314     <a class="code" href="classXFuXMFormatAtom.html">XFuXMFormatAtom</a> ta;
01315     INT16 *vibratoTable = <a class="code" href="classXFuXMPlayer.html#n9">mSineWaveTable</a>;
01316     INT16 *tremoloTable = mSineWaveTable;
01317 
01318     <span class="keywordflow">for</span> (index = 0; index &lt; aSamples; )
01319     {
01320         <span class="keywordflow">if</span> (<a class="code" href="classXFuXMPlayer.html#n18">mSamplePointer</a> == <a class="code" href="classXFuXMPlayer.html#n17">mSamplesPerTick</a>)
01321         {
01322             <span class="comment">// Tick finished</span>
01323             <a class="code" href="classXFuXMPlayer.html#n18">mSamplePointer</a> = 0;
01324 
01325             <a class="code" href="classXFuXMPlayer.html#n20">mRamp</a> = 0;
01326 
01327             <span class="keywordflow">if</span> (<a class="code" href="classXFuXMPlayer.html#n24">mIsRead</a> &amp;&amp; (++<a class="code" href="classXFuXMPlayer.html#n26">mCurrentTick</a> == <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m6">mTempo</a>))
01328             {
01329                 <span class="comment">// Row finished</span>
01330                 <a class="code" href="classXFuXMPlayer.html#n26">mCurrentTick</a> = 0;
01331 
01332                 <span class="keywordflow">if</span> (<a class="code" href="classXFuXMPlayer.html#n21">mPatternDelayCounter</a> == 0)
01333                 {
01334                     <a class="code" href="classXFuXMPlayer.html#n16">mCurrentRow</a>++;
01335                     <a class="code" href="classXFuXMPlayer.html#n23">mPatternDelaySkip</a> = 0;
01336                 }
01337                 <span class="keywordflow">else</span> 
01338                     <a class="code" href="classXFuXMPlayer.html#n21">mPatternDelayCounter</a>--;
01339 
01340                 <span class="keywordflow">if</span> ((<a class="code" href="classXFuXMPlayer.html#n16">mCurrentRow</a> &gt;= <a class="code" href="classXFuXMPlayer.html#n5">mXMPatternHeaders</a>[<a class="code" href="classXFuXMPlayer.html#n15">mPatternNb</a>].mNbRows) || (<a class="code" href="classXFuXMPlayer.html#n25">mJumpFlag</a> != 0))
01341                 {
01342                     <span class="comment">// Pattern finished</span>
01343                     <a class="code" href="classXFuXMPlayer.html#n14">mCurrentOrder</a>++;
01344                     <span class="keywordflow">if</span> (<a class="code" href="classXFuXMPlayer.html#n14">mCurrentOrder</a> &gt;= <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m1">mSongLength</a>) <a class="code" href="classXFuXMPlayer.html#n14">mCurrentOrder</a> = <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m2">mRestartPosition</a>;
01345 
01346                     <a class="code" href="classXFuXMPlayer.html#n15">mPatternNb</a> = <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m0">mOrderTable</a>[<a class="code" href="classXFuXMPlayer.html#n14">mCurrentOrder</a>];
01347                     <span class="keywordflow">if</span> (<a class="code" href="classXFuXMPlayer.html#n15">mPatternNb</a> &gt;= <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m3">mNbPatterns</a>) <a class="code" href="classXFuXMPlayer.html#n15">mPatternNb</a> = <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m0">mOrderTable</a>[0];
01348 
01349                     <span class="keywordflow">if</span> (<a class="code" href="classXFuXMPlayer.html#n25">mJumpFlag</a> == 0) <a class="code" href="classXFuXMPlayer.html#n16">mCurrentRow</a> = 0;
01350 
01351                     <a class="code" href="classXFuXMPlayer.html#n25">mJumpFlag</a> = 0;
01352                 }
01353 
01354                 <a class="code" href="classXFuXMPlayer.html#n13">mPpoint</a> = <a class="code" href="classXFuXMPlayer.html#n6">mPatternData</a>[<a class="code" href="classXFuXMPlayer.html#n15">mPatternNb</a>].mRows[<a class="code" href="classXFuXMPlayer.html#n16">mCurrentRow</a>];
01355 
01356                 <span class="keywordflow">for</span> (chan = 0; chan &lt; <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m4">mNbChannels</a>; chan++)
01357                 {
01358                     <a class="code" href="classXFuXMChannel.html">XFuXMChannel</a> &amp;ch = <a class="code" href="classXFuXMPlayer.html#n8">mChannels</a>[chan];
01359 
01360                     <span class="keywordflow">if</span> (<a class="code" href="classXFuXMPlayer.html#n21">mPatternDelayCounter</a> == 0)
01361                     {
01362                         ta = <a class="code" href="classXFuXMPlayer.html#b1">getAtom</a>(); <span class="comment">// Get track data</span>
01363 
01364                         ch.<a class="code" href="classXFuXMChannel.html#m0">mTa</a> = ta;
01365 
01366                         ch.<a class="code" href="classXFuXMChannel.html#m42">mEffectType</a> = ta.<a class="code" href="classXFuXMFormatAtom.html#m3">mEffectType</a>;
01367                         ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> = ta.<a class="code" href="classXFuXMFormatAtom.html#m4">mEffectValue</a>;
01368 
01369                         <span class="keywordflow">if</span> (!((ch.<a class="code" href="classXFuXMChannel.html#m42">mEffectType</a> == 0xE) &amp;&amp;
01370                             <span class="comment">// No change if note delay effect</span>
01371                             (((ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &gt;&gt; 4) &amp; 0xF) == 0xD)))
01372                         {
01373                             <a class="code" href="classXFuXMPlayer.html#b5">initChannel</a>(ch);
01374                         }
01375                     }
01376 
01377                     <span class="comment">// Volume column effects</span>
01378                     <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m41">mVolumeColumn</a> != 0)
01379                     {
01380                         <span class="comment">// Set volume</span>
01381                         <span class="keywordflow">if</span> ((ch.<a class="code" href="classXFuXMChannel.html#m41">mVolumeColumn</a> &gt;= 0x10) &amp;&amp; (ch.<a class="code" href="classXFuXMChannel.html#m41">mVolumeColumn</a> &lt;= 0x50))
01382                         {
01383                             ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> = (INT8)(ch.<a class="code" href="classXFuXMChannel.html#m41">mVolumeColumn</a> - 0x10);
01384                             <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> &gt; 0x40) ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> = 0x40;
01385                             ch.<a class="code" href="classXFuXMChannel.html#m27">mBaseVolume</a> = ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a>;
01386                         }
01387                         <span class="keywordflow">else</span>
01388                         {
01389                             <span class="keywordflow">switch</span> (ch.<a class="code" href="classXFuXMChannel.html#m41">mVolumeColumn</a> &gt;&gt; 4)
01390                             {
01391                             <span class="keywordflow">case</span> 0x8:   <span class="comment">// Fine volume slide down (arrow down)</span>
01392                                 <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> &gt; 0) ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> -= (ch.<a class="code" href="classXFuXMChannel.html#m41">mVolumeColumn</a> &amp; 0xF);
01393                                 ch.<a class="code" href="classXFuXMChannel.html#m27">mBaseVolume</a> = ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a>;
01394                                 <span class="keywordflow">break</span>;
01395 
01396                             <span class="keywordflow">case</span> 0x9:    <span class="comment">// Fine volume slide up (arrow up)</span>
01397                                 <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> &lt; 0x40) ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> += (ch.<a class="code" href="classXFuXMChannel.html#m41">mVolumeColumn</a> &amp; 0xF);
01398                                 ch.<a class="code" href="classXFuXMChannel.html#m27">mBaseVolume</a> = ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a>;
01399                                 <span class="keywordflow">break</span>;
01400 
01401                             <span class="keywordflow">case</span> 0xA:   <span class="comment">// Set vibrato speed (Sxy)</span>
01402                                 <span class="keywordflow">if</span> ((ch.<a class="code" href="classXFuXMChannel.html#m41">mVolumeColumn</a> &amp; 0xF) != 0) 
01403                                     ch.<a class="code" href="classXFuXMChannel.html#m66">mVibratoRate</a> = (UINT8)(ch.<a class="code" href="classXFuXMChannel.html#m41">mVolumeColumn</a> &amp; 0xF);
01404                                 <span class="keywordflow">break</span>;
01405 
01406                             <span class="keywordflow">case</span> 0xB:   <span class="comment">// Set vibrato depth (Vxy)</span>
01407                                 <span class="keywordflow">if</span> ((ch.<a class="code" href="classXFuXMChannel.html#m41">mVolumeColumn</a> &amp; 0xF) != 0)
01408                                 {
01409                                     ch.<a class="code" href="classXFuXMChannel.html#m67">mVibratoDepth</a> = (UINT8)((ch.<a class="code" href="classXFuXMChannel.html#m41">mVolumeColumn</a> &amp; 0xF) * 4);
01410                                     ch.<a class="code" href="classXFuXMChannel.html#m65">mIsVibrato</a> = 1;
01411                                 }
01412                                 <span class="keywordflow">break</span>;
01413 
01414                             <span class="keywordflow">case</span> 0xC:   <span class="comment">// Set panning (Pxy)</span>
01415                                 ch.<a class="code" href="classXFuXMChannel.html#m38">mPan</a> = (UINT8)((ch.<a class="code" href="classXFuXMChannel.html#m41">mVolumeColumn</a> &amp; 0xF) &lt;&lt; 4);
01416                                 <span class="keywordflow">break</span>;
01417 
01418                             <span class="keywordflow">case</span> 0xD:   <span class="comment">// Panning slide left (left arrow)</span>
01419                                 <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m38">mPan</a> &gt; 0) ch.<a class="code" href="classXFuXMChannel.html#m38">mPan</a> -= (ch.<a class="code" href="classXFuXMChannel.html#m41">mVolumeColumn</a> &amp; 0xF);
01420                                 <span class="keywordflow">break</span>;
01421 
01422                             <span class="keywordflow">case</span> 0xE:   <span class="comment">// Panning slide right (right arrow)</span>
01423                                 <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m38">mPan</a> &lt; 0xFF) ch.<a class="code" href="classXFuXMChannel.html#m38">mPan</a> += (ch.<a class="code" href="classXFuXMChannel.html#m41">mVolumeColumn</a> &amp; 0xF);
01424                                 <span class="keywordflow">break</span>;
01425 
01426                             <span class="keywordflow">case</span> 0xF:   <span class="comment">// Tone portamento (Mxy)</span>
01427                                 <span class="keywordflow">if</span> ((ch.<a class="code" href="classXFuXMChannel.html#m41">mVolumeColumn</a> &amp; 0xF) != 0)
01428                                     ch.<a class="code" href="classXFuXMChannel.html#m46">mTonePortamentoV</a> = (UINT8)((ch.<a class="code" href="classXFuXMChannel.html#m41">mVolumeColumn</a> &amp; 0xF) &lt;&lt; 4);
01429                         
01430                                 <span class="keywordflow">if</span> ((ch.<a class="code" href="classXFuXMChannel.html#m0">mTa</a>.<a class="code" href="classXFuXMFormatAtom.html#m0">mNote</a> != 0) &amp;&amp; (ch.<a class="code" href="classXFuXMChannel.html#m0">mTa</a>.<a class="code" href="classXFuXMFormatAtom.html#m0">mNote</a> != 97))
01431                                 {
01432                                     ch.<a class="code" href="classXFuXMChannel.html#m63">mDestPeriod</a> = ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a>;
01433                                     ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a> = ch.<a class="code" href="classXFuXMChannel.html#m62">mOldPeriod</a>;
01434                                     ch.<a class="code" href="classXFuXMChannel.html#m64">mBasePeriod</a> = ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a>;
01435                                 }
01436                                 <span class="keywordflow">break</span>;
01437                             }
01438                         }
01439                     }
01440 
01441                     <span class="comment">// Row effects</span>
01442                     <span class="keywordflow">switch</span> (ch.<a class="code" href="classXFuXMChannel.html#m42">mEffectType</a>)
01443                     {
01444                         <span class="keywordflow">case</span> 0x0:   <span class="comment">// Arpeggio (0xy)</span>
01445                             ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a> = ch.<a class="code" href="classXFuXMChannel.html#m64">mBasePeriod</a>;
01446                             <span class="keywordflow">break</span>;
01447 
01448                         <span class="keywordflow">case</span> 0x1:   <span class="comment">// Portamento up (1xy)</span>
01449                             <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> != 0) ch.<a class="code" href="classXFuXMChannel.html#m44">mPortamentoUpV</a> = ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a>;
01450                             <span class="keywordflow">break</span>;
01451 
01452                         <span class="keywordflow">case</span> 0x2:   <span class="comment">// Portamento down (2xy)</span>
01453                             <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> != 0) ch.<a class="code" href="classXFuXMChannel.html#m45">mPortamentoDownV</a> = ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a>;
01454                             <span class="keywordflow">break</span>;
01455 
01456                         <span class="keywordflow">case</span> 0x3:   <span class="comment">// Tone portamento (3xy)</span>
01457                             <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m62">mOldPeriod</a> != 0)
01458                             {
01459                                 <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> != 0) ch.<a class="code" href="classXFuXMChannel.html#m46">mTonePortamentoV</a> = ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a>;
01460 
01461                                 <span class="keywordflow">if</span> ((ch.<a class="code" href="classXFuXMChannel.html#m0">mTa</a>.<a class="code" href="classXFuXMFormatAtom.html#m0">mNote</a> != 0) &amp;&amp; (ch.<a class="code" href="classXFuXMChannel.html#m0">mTa</a>.<a class="code" href="classXFuXMFormatAtom.html#m0">mNote</a> != 97))
01462                                 {
01463                                     ch.<a class="code" href="classXFuXMChannel.html#m63">mDestPeriod</a> = ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a>;
01464                                     ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a> = ch.<a class="code" href="classXFuXMChannel.html#m62">mOldPeriod</a>;
01465                                     ch.<a class="code" href="classXFuXMChannel.html#m64">mBasePeriod</a> = ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a>;
01466                                 }
01467                             }
01468                             <span class="keywordflow">break</span>;
01469                     
01470                         <span class="keywordflow">case</span> 0x4:   <span class="comment">// Vibrato (4xy)</span>
01471                             <span class="keywordflow">if</span> ((ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &amp; 0xF) != 0)
01472                                 ch.<a class="code" href="classXFuXMChannel.html#m67">mVibratoDepth</a> = (UINT8)((ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &amp; 0xF) * 4);
01473 
01474                             <span class="keywordflow">if</span> ((ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &gt;&gt; 4) != 0)
01475                                 ch.<a class="code" href="classXFuXMChannel.html#m66">mVibratoRate</a> = (UINT8)(ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &gt;&gt; 4);
01476 
01477                             ch.<a class="code" href="classXFuXMChannel.html#m65">mIsVibrato</a> = 1;
01478                             <span class="keywordflow">break</span>;
01479                     
01480                         <span class="keywordflow">case</span> 0x5:   <span class="comment">// Tone portamento + volume slide (5xy)</span>
01481                             <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> != 0) ch.<a class="code" href="classXFuXMChannel.html#m47">mVolumeSlideV</a> = ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a>;
01482                             <span class="keywordflow">break</span>;
01483 
01484                         <span class="keywordflow">case</span> 0x6:   <span class="comment">// Vibrato + volume slide (6xy)</span>
01485                             <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> != 0) ch.<a class="code" href="classXFuXMChannel.html#m47">mVolumeSlideV</a> = ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a>;
01486 
01487                             ch.<a class="code" href="classXFuXMChannel.html#m65">mIsVibrato</a> = 1;
01488                             <span class="keywordflow">break</span>;
01489 
01490                         <span class="keywordflow">case</span> 0x7:   <span class="comment">// Tremolo (7xy)</span>
01491                             <span class="keywordflow">if</span> ((ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &amp; 0xF) != 0)
01492                                 ch.<a class="code" href="classXFuXMChannel.html#m71">mTremoloDepth</a> = (UINT8)(ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &amp; 0xF);
01493 
01494                             <span class="keywordflow">if</span> ((ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &gt;&gt; 4) != 0)
01495                                 ch.<a class="code" href="classXFuXMChannel.html#m70">mTremoloRate</a> = (UINT8)(ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &gt;&gt; 4);
01496                             <span class="keywordflow">break</span>;
01497 
01498                         <span class="keywordflow">case</span> 0x8:   <span class="comment">// Set panning (8xy)</span>
01499                             ch.<a class="code" href="classXFuXMChannel.html#m38">mPan</a> = ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a>;
01500                             <span class="keywordflow">break</span>;
01501 
01502                         <span class="keywordflow">case</span> 0x9:   <span class="comment">// Sample offset (9xy)</span>
01503                             ch.<a class="code" href="classXFuXMChannel.html#m3">mPointer</a> = ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &lt;&lt; (8 + <a class="code" href="XFuXMPlayer__internal_8h.html#a4">FP_BITS</a>);
01504                             XFCASSERT(ch.<a class="code" href="classXFuXMChannel.html#m3">mPointer</a> &lt; ch.<a class="code" href="classXFuXMChannel.html#m7">mLength</a>);
01505                             <span class="comment">// FastTracker2 behaviour when not in debug mode,</span>
01506                             <span class="comment">// if offset is beyond sample length, stop sample</span>
01507                             <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m3">mPointer</a> &gt;= ch.<a class="code" href="classXFuXMChannel.html#m7">mLength</a>) ch.<a class="code" href="classXFuXMChannel.html#m13">mIsSample</a> = 0;
01508                             <span class="keywordflow">break</span>;
01509 
01510                         <span class="keywordflow">case</span> 0xA:   <span class="comment">// Volume slide (Axy)</span>
01511                             <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> != 0) ch.<a class="code" href="classXFuXMChannel.html#m47">mVolumeSlideV</a> = ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a>;
01512                             <span class="keywordflow">break</span>;
01513 
01514                         <span class="keywordflow">case</span> 0xB:   <span class="comment">// Jump to pattern (Bxy)</span>
01515                             <span class="keywordflow">if</span> (<a class="code" href="classXFuXMPlayer.html#n25">mJumpFlag</a> == 0)
01516                             {
01517                                 <a class="code" href="classXFuXMPlayer.html#n16">mCurrentRow</a> = -1;
01518                                 <a class="code" href="classXFuXMPlayer.html#n14">mCurrentOrder</a> = (INT16)(ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> - 1);
01519                                 <a class="code" href="classXFuXMPlayer.html#n25">mJumpFlag</a> = 1;
01520                             }
01521                             <span class="keywordflow">break</span>;
01522 
01523                         <span class="keywordflow">case</span> 0xC:   <span class="comment">// Volume (Cxy)</span>
01524                             ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> = ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a>;
01525                             <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> &gt; 0x40) ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> = 0x40;
01526                             ch.<a class="code" href="classXFuXMChannel.html#m27">mBaseVolume</a> = ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a>;
01527                             <span class="keywordflow">break</span>;
01528                     
01529                         <span class="keywordflow">case</span> 0xD:   <span class="comment">// Pattern break (Dxy)</span>
01530                             <span class="keywordflow">if</span> (<a class="code" href="classXFuXMPlayer.html#n25">mJumpFlag</a> == 0)
01531                             {
01532                                 <a class="code" href="classXFuXMPlayer.html#n16">mCurrentRow</a> = (INT16)(ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> - 1);
01533                                 <a class="code" href="classXFuXMPlayer.html#n25">mJumpFlag</a> = 1;
01534                             }
01535                             <span class="keywordflow">break</span>;
01536 
01537                         <span class="keywordflow">case</span> 0xE:   <span class="comment">// Extra effects (Exy)</span>
01538                             <span class="keywordflow">switch</span> ((ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &gt;&gt; 4))
01539                             {
01540                                 <span class="keywordflow">case</span> 0x1:   <span class="comment">// Fine portamento up (E1y)</span>
01541                                     <span class="keywordflow">if</span> ((ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &amp; 0xF) != 0)
01542                                         ch.<a class="code" href="classXFuXMChannel.html#m48">mFinePortamentoUpV</a> = (UINT8)(ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &amp; 0xF);
01543 
01544                                     ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a> -= ch.<a class="code" href="classXFuXMChannel.html#m48">mFinePortamentoUpV</a> * 4;
01545                                     ch.<a class="code" href="classXFuXMChannel.html#m64">mBasePeriod</a> = ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a>;
01546                                     <span class="keywordflow">break</span>;
01547 
01548                                 <span class="keywordflow">case</span> 0x2:   <span class="comment">// Fine portamento down (E2y)</span>
01549                                     <span class="keywordflow">if</span> ((ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &amp; 0xF) != 0)
01550                                         ch.<a class="code" href="classXFuXMChannel.html#m48">mFinePortamentoUpV</a> = (UINT8)(ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &amp; 0xF);
01551 
01552                                     ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a> += ch.<a class="code" href="classXFuXMChannel.html#m48">mFinePortamentoUpV</a> * 4;
01553                                     ch.<a class="code" href="classXFuXMChannel.html#m64">mBasePeriod</a> = ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a>;
01554                                     <span class="keywordflow">break</span>;
01555 
01556                                 <span class="keywordflow">case</span> 0x3:   <span class="comment">// Glissando control (E3y), FIX ME!</span>
01557                                     <span class="keywordflow">break</span>;
01558 
01559                                 <span class="keywordflow">case</span> 0x4:   <span class="comment">// Vibrato waveform (E4y)</span>
01560                                     <span class="keywordflow">if</span> ((ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &amp; 0xF) &lt; 7)
01561                                         ch.<a class="code" href="classXFuXMChannel.html#m69">mVibratoWaveform</a> = (UINT8)(ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &amp; 0xF);
01562                                     <span class="keywordflow">break</span>;
01563 
01564                                 <span class="keywordflow">case</span> 0x5:   <span class="comment">// Set finetune (E5y)</span>
01565                                     ch.<a class="code" href="classXFuXMChannel.html#m15">mFinetune</a> = (INT8)((ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &amp; 0xF) &lt;&lt; 1);
01566                                     <span class="keywordflow">break</span>;
01567 
01568                                 <span class="keywordflow">case</span> 0x6:   <span class="comment">// Pattern loop (E6y), FIX ME!</span>
01569                                     <span class="keywordflow">break</span>;
01570 
01571                                 <span class="keywordflow">case</span> 0x7:   <span class="comment">// Tremolo waveform (E7y)</span>
01572                                     <span class="keywordflow">if</span> ((ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &amp; 0xF) &lt; 7)
01573                                         ch.<a class="code" href="classXFuXMChannel.html#m73">mTremoloWaveform</a> = (UINT8)(ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &amp; 0xF);
01574                                     <span class="keywordflow">break</span>;
01575 
01576                                 <span class="keywordflow">case</span> 0xA:   <span class="comment">// Fine volume slide up (EAy)</span>
01577                                     <span class="keywordflow">if</span> ((ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &amp; 0xF) != 0)
01578                                         ch.<a class="code" href="classXFuXMChannel.html#m50">mFineVolumeSlideUpV</a> = (UINT8)(ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &amp; 0xF);
01579 
01580                                     <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> &lt; 0x40) ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> += ch.<a class="code" href="classXFuXMChannel.html#m50">mFineVolumeSlideUpV</a>;
01581                                     ch.<a class="code" href="classXFuXMChannel.html#m27">mBaseVolume</a> = ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a>;
01582                                     <span class="keywordflow">break</span>;
01583 
01584                                 <span class="keywordflow">case</span> 0xB:   <span class="comment">// Fine volume slide down (EBy)</span>
01585                                     <span class="keywordflow">if</span> ((ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &amp; 0xF) != 0)
01586                                         ch.<a class="code" href="classXFuXMChannel.html#m51">mFineVolumeSlideDownV</a> = (UINT8)(ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &amp; 0xF);
01587 
01588                                     <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> &gt; 0) ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> -= ch.<a class="code" href="classXFuXMChannel.html#m51">mFineVolumeSlideDownV</a>;
01589                                     ch.<a class="code" href="classXFuXMChannel.html#m27">mBaseVolume</a> = ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a>;
01590                                     <span class="keywordflow">break</span>;
01591 
01592                                 <span class="keywordflow">case</span> 0xE:   <span class="comment">// Pattern delay (EEy)</span>
01593                                     <span class="keywordflow">if</span> ((<a class="code" href="classXFuXMPlayer.html#n21">mPatternDelayCounter</a> == 0) &amp;&amp; (<a class="code" href="classXFuXMPlayer.html#n23">mPatternDelaySkip</a> == 0))
01594                                         <a class="code" href="classXFuXMPlayer.html#n22">mPatternDelayCounterTemp</a> = (UINT8)(ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &amp; 0xF);
01595                                     <span class="keywordflow">break</span>;
01596 
01597                                 }
01598                             <span class="keywordflow">break</span>;
01599                     
01600                         <span class="keywordflow">case</span> 0xF:   <span class="comment">// Tempo or BPM change (Fxy)</span>
01601                             <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &lt; 32) 
01602                             {
01603                                 <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m6">mTempo</a> = ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a>;
01604                                 <span class="keywordflow">if</span> (<a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m6">mTempo</a> == 0) <a class="code" href="classXFuXMPlayer.html#n24">mIsRead</a> = 0;
01605                             }
01606                             <span class="keywordflow">else</span>
01607                             { <span class="comment">// BPM</span>
01608                                 <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m7">mBpm</a> = ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a>;
01609                                 <a class="code" href="classXFuXMPlayer.html#n19">mTickRate</a> = 2.0f * <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m7">mBpm</a> / 5.0f;
01610 
01611                                 <a class="code" href="classXFuXMPlayer.html#n17">mSamplesPerTick</a> = (INT)(<a class="code" href="classXFuXMPlayer.html#n0">mSamplingRate</a> / <a class="code" href="classXFuXMPlayer.html#n19">mTickRate</a>);
01612                             }
01613                             <span class="keywordflow">break</span>;
01614 
01615                         <span class="keywordflow">case</span> 0x10:  <span class="comment">// Global volume (Gxy)</span>
01616                             <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m8">mGlobalVolume</a> = ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a>;
01617 
01618                             <span class="keywordflow">if</span> (<a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m8">mGlobalVolume</a> &gt; 0x40) <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m8">mGlobalVolume</a> = 0x40;
01619                             <span class="keywordflow">break</span>;
01620 
01621                         <span class="keywordflow">case</span> 0x11:  <span class="comment">// Global volume slide (Hxy)</span>
01622                             <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> != 0) ch.<a class="code" href="classXFuXMChannel.html#m52">mGlobalVolumeSlideV</a> = ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a>;
01623 
01624                             <span class="keywordflow">if</span> (<a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m8">mGlobalVolume</a> &lt; 0x40) 
01625                                 <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m8">mGlobalVolume</a> += (ch.<a class="code" href="classXFuXMChannel.html#m52">mGlobalVolumeSlideV</a> &gt;&gt; 4) &lt;&lt; 1;
01626                             <span class="keywordflow">if</span> (<a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m8">mGlobalVolume</a> &gt; 0) 
01627                                 <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m8">mGlobalVolume</a> -= (ch.<a class="code" href="classXFuXMChannel.html#m52">mGlobalVolumeSlideV</a> &amp; 0xF) &lt;&lt; 1;
01628                             <span class="keywordflow">break</span>;
01629 
01630                         <span class="keywordflow">case</span> 0x15:  <span class="comment">// Set envelope position (Lxy)</span>
01631                             ch.<a class="code" href="classXFuXMChannel.html#m18">mVolEnvPointer</a> = ch.<a class="code" href="classXFuXMChannel.html#m32">mPanEnvPointer</a> = ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a>;
01632                             <span class="keywordflow">break</span>;
01633 
01634                         <span class="keywordflow">case</span> 0x19:  <span class="comment">// Panning slide (Pxy)</span>
01635                             <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> != 0) ch.<a class="code" href="classXFuXMChannel.html#m58">mPanningSlideV</a> = ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a>;
01636                             <span class="keywordflow">break</span>;
01637 
01638                         <span class="keywordflow">case</span> 0x1B:  <span class="comment">// Multi retrig note (Rxy)</span>
01639                             <span class="keywordflow">if</span> ((ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &gt;&gt; 4) != 0)
01640                                 ch.<a class="code" href="classXFuXMChannel.html#m53">mMultiRetrigVolumeV</a> = (UINT8)(ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &gt;&gt; 4);
01641 
01642                             <span class="keywordflow">if</span> ((ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &amp; 0xF) != 0)
01643                                 ch.<a class="code" href="classXFuXMChannel.html#m54">mMultiRetrigRateV</a> = (UINT8)(ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &amp; 0xF);
01644 
01645                             <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m54">mMultiRetrigRateV</a> != 0)
01646                             {
01647                                 <span class="keywordflow">if</span> ((ch.<a class="code" href="classXFuXMChannel.html#m59">mMultiRetrigTicker</a> % ch.<a class="code" href="classXFuXMChannel.html#m54">mMultiRetrigRateV</a>) == 0)
01648                                 {
01649                                     ch.<a class="code" href="classXFuXMChannel.html#m2">mInitSample</a> = 1;
01650                                     <a class="code" href="classXFuXMPlayer.html#b6">initSound</a>(ch);
01651 
01652                                     <span class="keywordflow">if</span> ((ch.<a class="code" href="classXFuXMChannel.html#m53">mMultiRetrigVolumeV</a> != 8) &amp;&amp; (ch.<a class="code" href="classXFuXMChannel.html#m59">mMultiRetrigTicker</a> != 0))
01653                                     {
01654                                         <span class="comment">// Don't affect volume on first tick</span>
01655                                         <span class="keywordflow">switch</span> (ch.<a class="code" href="classXFuXMChannel.html#m53">mMultiRetrigVolumeV</a>)
01656                                         {
01657                                             <span class="keywordflow">case</span> 0x1:
01658                                                 ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> -= 1;
01659                                                 <span class="keywordflow">break</span>;
01660                                             <span class="keywordflow">case</span> 0x2:
01661                                                 ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> -= 2;
01662                                                 <span class="keywordflow">break</span>;
01663                                             <span class="keywordflow">case</span> 0x3:
01664                                                 ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> -= 4;
01665                                                 <span class="keywordflow">break</span>;
01666                                             <span class="keywordflow">case</span> 0x4:
01667                                                 ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> -= 8;
01668                                                 <span class="keywordflow">break</span>;
01669                                             <span class="keywordflow">case</span> 0x5:
01670                                                 ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> -= 16;
01671                                                 <span class="keywordflow">break</span>;
01672                                             <span class="keywordflow">case</span> 0x6:
01673                                                 ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> = (INT8)((ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> * 2) / 3);
01674                                                 <span class="keywordflow">break</span>;
01675                                             <span class="keywordflow">case</span> 0x7:
01676                                                 ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> &gt;&gt;= 1;
01677                                                 <span class="keywordflow">break</span>;
01678                                             <span class="keywordflow">case</span> 0x9:
01679                                                 ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> += 1;
01680                                                 <span class="keywordflow">break</span>;
01681                                             <span class="keywordflow">case</span> 0xA:
01682                                                 ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> += 2;
01683                                                 <span class="keywordflow">break</span>;
01684                                             <span class="keywordflow">case</span> 0xB:
01685                                                 ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> += 4;
01686                                                 <span class="keywordflow">break</span>;
01687                                             <span class="keywordflow">case</span> 0xC:
01688                                                 ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> += 8;
01689                                                 <span class="keywordflow">break</span>;
01690                                             <span class="keywordflow">case</span> 0xD:
01691                                                 ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> += 16;
01692                                                 <span class="keywordflow">break</span>;
01693                                             <span class="keywordflow">case</span> 0xE:
01694                                                 ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> = (INT8)((ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> * 3) / 2);
01695                                                 <span class="keywordflow">break</span>;
01696                                             <span class="keywordflow">case</span> 0xF:
01697                                                 ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> &lt;&lt;= 1;
01698                                                 <span class="keywordflow">break</span>;
01699                                         }
01700 
01701                                         ch.<a class="code" href="classXFuXMChannel.html#m27">mBaseVolume</a> = ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a>;
01702                                     }
01703                                 }
01704                             }
01705 
01706                             ch.<a class="code" href="classXFuXMChannel.html#m59">mMultiRetrigTicker</a>++;
01707                             <span class="keywordflow">break</span>;
01708 
01709                         <span class="keywordflow">case</span> 0x1D:  <span class="comment">// Tremor (Txy)</span>
01710                             <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> != 0) ch.<a class="code" href="classXFuXMChannel.html#m55">mTremorV</a> = ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a>;
01711                         
01712                             <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m55">mTremorV</a> != 0)
01713                             {
01714                                 <span class="keywordflow">if</span> ((UINT8)(ch.<a class="code" href="classXFuXMChannel.html#m60">mTremorTicker</a> % 
01715                                     ((ch.<a class="code" href="classXFuXMChannel.html#m55">mTremorV</a> &gt;&gt; 4) + (ch.<a class="code" href="classXFuXMChannel.html#m55">mTremorV</a> &amp; 0xF) + 2)) &lt; 
01716                                     (ch.<a class="code" href="classXFuXMChannel.html#m55">mTremorV</a> &gt;&gt; 4) + 1)
01717                                     ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> = ch.<a class="code" href="classXFuXMChannel.html#m27">mBaseVolume</a>;
01718                                 <span class="keywordflow">else</span>
01719                                     ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> = 0;
01720                             }
01721                             <span class="keywordflow">break</span>;
01722 
01723                         <span class="keywordflow">case</span> 0x21:  <span class="comment">// Extra fine portamento up/down (X1y/X2y)</span>
01724                             <span class="keywordflow">switch</span>(ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &gt;&gt; 4)
01725                             {
01726                                 <span class="keywordflow">case</span> 0x1:   <span class="comment">// Extra fine portamento up (X1y)</span>
01727                                     <span class="keywordflow">if</span> ((ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &amp; 0xF) != 0)
01728                                         ch.<a class="code" href="classXFuXMChannel.html#m56">mExtraFinePortamentoUpV</a> = (UINT8)(ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &amp; 0xF);
01729 
01730                                     ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a> -= ch.<a class="code" href="classXFuXMChannel.html#m56">mExtraFinePortamentoUpV</a>;
01731                                     ch.<a class="code" href="classXFuXMChannel.html#m64">mBasePeriod</a> = ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a>;
01732                                     <span class="keywordflow">break</span>;
01733                                 <span class="keywordflow">case</span> 0x2:   <span class="comment">// Extra fine portamento down (X2y)</span>
01734                                     <span class="keywordflow">if</span> ((ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &amp; 0xF) != 0)
01735                                         ch.<a class="code" href="classXFuXMChannel.html#m57">mExtraFinePortamentoDownV</a> = (UINT8)(ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &amp; 0xF);
01736 
01737                                     ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a> -= ch.<a class="code" href="classXFuXMChannel.html#m56">mExtraFinePortamentoUpV</a>;
01738                                     ch.<a class="code" href="classXFuXMChannel.html#m64">mBasePeriod</a> = ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a>;
01739                                     <span class="keywordflow">break</span>;
01740                             }
01741                             <span class="keywordflow">break</span>;
01742                     }
01743 
01744                     <a class="code" href="classXFuXMPlayer.html#b7">notifyHandlers</a>(ch);
01745 
01746                     <span class="comment">// Key off (Kxy)</span>
01747                     <span class="keywordflow">if</span> ((ch.<a class="code" href="classXFuXMChannel.html#m42">mEffectType</a> == 0x14) || (ch.<a class="code" href="classXFuXMChannel.html#m0">mTa</a>.<a class="code" href="classXFuXMFormatAtom.html#m0">mNote</a> == 97))
01748                     {
01749                         <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m40">mSustainReleased</a> == 0)
01750                         {
01751                             ch.<a class="code" href="classXFuXMChannel.html#m40">mSustainReleased</a> = 1;
01752                             <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m17">mVolEnvType</a> &amp; <a class="code" href="XFuXMPlayer__internal_8h.html#a22a11">ENVELOPE_SUSTAIN</a>)
01753                                 ch.<a class="code" href="classXFuXMChannel.html#m19">mVolEnvSpeed</a> = 1; <span class="comment">// Start envelope</span>
01754 
01755                             <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m17">mVolEnvType</a> == 0)
01756                                 ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> = 0;
01757 
01758                             <span class="comment">// FIX ME!!! PANNING ENVELOPE STUFF MISSING!!!</span>
01759                         }
01760                      }
01761                 }
01762 
01763                 <span class="keywordflow">if</span> (<a class="code" href="classXFuXMPlayer.html#n22">mPatternDelayCounterTemp</a> != 0)
01764                 {
01765                     <a class="code" href="classXFuXMPlayer.html#n21">mPatternDelayCounter</a> = <a class="code" href="classXFuXMPlayer.html#n22">mPatternDelayCounterTemp</a>;
01766                     mPatternDelayCounterTemp = 0;
01767                     <a class="code" href="classXFuXMPlayer.html#n23">mPatternDelaySkip</a> = 1;
01768                 }
01769             }
01770             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m6">mTempo</a> != 0)
01771             {
01772                 <span class="comment">// Tick effects</span>
01773                 <span class="keywordflow">for</span> (chan = 0; chan &lt; <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m4">mNbChannels</a>; chan++)
01774                 {
01775                     <a class="code" href="classXFuXMChannel.html">XFuXMChannel</a> &amp;ch = <a class="code" href="classXFuXMPlayer.html#n8">mChannels</a>[chan];
01776 
01777                     <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m41">mVolumeColumn</a> != 0)
01778                     {
01779                         <span class="keywordflow">switch</span>(ch.<a class="code" href="classXFuXMChannel.html#m41">mVolumeColumn</a> &gt;&gt; 4)
01780                         {
01781                         <span class="keywordflow">case</span> 0x6:   <span class="comment">// Volume slide down (-xy)</span>
01782                             ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> -= (ch.<a class="code" href="classXFuXMChannel.html#m41">mVolumeColumn</a> &amp; 0xF);
01783                             ch.<a class="code" href="classXFuXMChannel.html#m27">mBaseVolume</a> = ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a>;
01784                             <span class="keywordflow">break</span>;
01785 
01786                         <span class="keywordflow">case</span> 0x7:   <span class="comment">// Volume slide up (+xy)</span>
01787                             ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> += (ch.<a class="code" href="classXFuXMChannel.html#m41">mVolumeColumn</a> &amp; 0xF);
01788                             ch.<a class="code" href="classXFuXMChannel.html#m27">mBaseVolume</a> = ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a>;
01789                             <span class="keywordflow">break</span>;
01790 
01791                         <span class="keywordflow">case</span> 0xF:   <span class="comment">// Tone portamento (Mxy)</span>
01792                             <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m62">mOldPeriod</a> != 0)
01793                             {
01794                                 <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m63">mDestPeriod</a> &gt; ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a>)
01795                                 {
01796                                     ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a> += (ch.<a class="code" href="classXFuXMChannel.html#m46">mTonePortamentoV</a> * 4);
01797                                     <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a> &gt; ch.<a class="code" href="classXFuXMChannel.html#m63">mDestPeriod</a>)
01798                                         ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a> = ch.<a class="code" href="classXFuXMChannel.html#m63">mDestPeriod</a>;
01799                                 }
01800                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m63">mDestPeriod</a> &lt; ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a>)
01801                                 {
01802                                     ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a> -= (ch.<a class="code" href="classXFuXMChannel.html#m46">mTonePortamentoV</a> * 4);
01803                                     <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a> &lt; ch.<a class="code" href="classXFuXMChannel.html#m63">mDestPeriod</a>)
01804                                         ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a> = ch.<a class="code" href="classXFuXMChannel.html#m63">mDestPeriod</a>;
01805                                 }
01806 
01807                                 ch.<a class="code" href="classXFuXMChannel.html#m64">mBasePeriod</a> = ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a>;
01808                             }
01809                             <span class="keywordflow">break</span>;
01810                         }
01811                     }
01812 
01813                     <span class="keywordflow">switch</span> (ch.<a class="code" href="classXFuXMChannel.html#m42">mEffectType</a>)
01814                     {
01815                         <span class="keywordflow">case</span> 0x0:   <span class="comment">// Arpeggio (0xy)</span>
01816                             <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> != 0)
01817                             {
01818                                 <span class="keywordflow">switch</span> (<a class="code" href="classXFuXMPlayer.html#n26">mCurrentTick</a> % 3)
01819                                 {
01820                                     <span class="keywordflow">case</span> 0:
01821                                         ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a> = ch.<a class="code" href="classXFuXMChannel.html#m64">mBasePeriod</a>;
01822                                         <span class="keywordflow">break</span>;
01823                                     <span class="keywordflow">case</span> 1:
01824                                         ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a> = ch.<a class="code" href="classXFuXMChannel.html#m64">mBasePeriod</a> - (ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &gt;&gt; 4) * 64;
01825                                         <span class="keywordflow">break</span>;
01826                                     <span class="keywordflow">case</span> 2:
01827                                         ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a> = ch.<a class="code" href="classXFuXMChannel.html#m64">mBasePeriod</a> - (ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &amp; 0xF) * 64;
01828                                         <span class="keywordflow">break</span>;
01829                                 }
01830                             }
01831                             <span class="keywordflow">break</span>;
01832 
01833                         <span class="keywordflow">case</span> 0x1:   <span class="comment">// Portamento up (1xy)</span>
01834                             ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a> -= (ch.<a class="code" href="classXFuXMChannel.html#m44">mPortamentoUpV</a> * 4);
01835                             ch.<a class="code" href="classXFuXMChannel.html#m64">mBasePeriod</a> = ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a>;
01836                             <span class="keywordflow">break</span>;
01837 
01838                         <span class="keywordflow">case</span> 0x2:   <span class="comment">// Portamento down (2xy)</span>
01839                             ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a> += (ch.<a class="code" href="classXFuXMChannel.html#m45">mPortamentoDownV</a> * 4);
01840                             ch.<a class="code" href="classXFuXMChannel.html#m64">mBasePeriod</a> = ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a>;
01841                             <span class="keywordflow">break</span>;
01842 
01843                         <span class="keywordflow">case</span> 0x7:   <span class="comment">// Tremolo (7xy), FIX ME!</span>
01844                             <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m73">mTremoloWaveform</a> &amp; <a class="code" href="XFuXMPlayer__internal_8h.html#a23a13">WAVEFORM_SINEWAVE</a>)
01845                                 tremoloTable = mSineWaveTable;
01846                             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m73">mTremoloWaveform</a> &amp; <a class="code" href="XFuXMPlayer__internal_8h.html#a23a15">WAVEFORM_SQUAREWAVE</a>)
01847                                 tremoloTable = <a class="code" href="classXFuXMPlayer.html#n10">mSquareWaveTable</a>;
01848                             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m73">mTremoloWaveform</a> &amp; <a class="code" href="XFuXMPlayer__internal_8h.html#a23a14">WAVEFORM_RAMPDOWN</a>)
01849                                 tremoloTable = <a class="code" href="classXFuXMPlayer.html#n12">mRampDownTable</a>;
01850                             <span class="comment">// FIX ME! Random waveform not supported</span>
01851 
01852                             ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> = (INT8)(ch.<a class="code" href="classXFuXMChannel.html#m27">mBaseVolume</a> + 
01853                                 ((tremoloTable[ch.<a class="code" href="classXFuXMChannel.html#m72">mTremoloPointer</a>] * ch.<a class="code" href="classXFuXMChannel.html#m71">mTremoloDepth</a>) &gt;&gt; 6));
01854                             ch.<a class="code" href="classXFuXMChannel.html#m72">mTremoloPointer</a> = (UINT8)(
01855                                 (ch.<a class="code" href="classXFuXMChannel.html#m72">mTremoloPointer</a> + ch.<a class="code" href="classXFuXMChannel.html#m70">mTremoloRate</a>) % <a class="code" href="XFuXMPlayer__internal_8h.html#a1">XMFORMAT_SIZEOF_WAVEFORM</a>);
01856                             <span class="keywordflow">break</span>;
01857 
01858                         <span class="keywordflow">case</span> 0xE:   <span class="comment">// Extra effects (Exy)</span>
01859                             <span class="keywordflow">switch</span> ((ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &gt;&gt; 4))
01860                             {
01861                                 <span class="keywordflow">case</span> 0x9:   <span class="comment">// Retrig note (E9y)</span>
01862                                     <span class="keywordflow">if</span> (((ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &amp; 0xF) != 0) &amp;&amp;
01863                                         ((<a class="code" href="classXFuXMPlayer.html#n26">mCurrentTick</a> % (ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &amp; 0xF)) == 0))
01864                                     {
01865                                         ch.<a class="code" href="classXFuXMChannel.html#m2">mInitSample</a> = 1;
01866                                         <a class="code" href="classXFuXMPlayer.html#b6">initSound</a>(ch);
01867                                     }
01868                                     <span class="keywordflow">break</span>;
01869 
01870                                 <span class="keywordflow">case</span> 0xC:   <span class="comment">// Note cut (ECy)</span>
01871                                     <span class="keywordflow">if</span> (<a class="code" href="classXFuXMPlayer.html#n26">mCurrentTick</a> == (ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &amp; 0xF))
01872                                     {
01873                                         ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> = 0;
01874                                         ch.<a class="code" href="classXFuXMChannel.html#m27">mBaseVolume</a> = ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a>;
01875                                     }
01876                                     <span class="keywordflow">break</span>;
01877 
01878                                 <span class="keywordflow">case</span> 0xD:   <span class="comment">// Note delay (EDy)</span>
01879                                     <span class="keywordflow">if</span> (<a class="code" href="classXFuXMPlayer.html#n26">mCurrentTick</a> == (ch.<a class="code" href="classXFuXMChannel.html#m43">mEffectValue</a> &amp; 0xF))
01880                                     {
01881                                         <a class="code" href="classXFuXMPlayer.html#b5">initChannel</a>(ch);
01882                                     }
01883                                     <span class="keywordflow">break</span>;
01884                             }
01885                             <span class="keywordflow">break</span>;
01886 
01887                         <span class="keywordflow">case</span> 0x19:  <span class="comment">// Panning slide (Pxy)</span>
01888                             ch.<a class="code" href="classXFuXMChannel.html#m38">mPan</a> += (ch.<a class="code" href="classXFuXMChannel.html#m58">mPanningSlideV</a> &gt;&gt; 4);
01889                             <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m38">mPan</a> &gt; 0xFF) ch.<a class="code" href="classXFuXMChannel.html#m38">mPan</a> = 0xFF;
01890 
01891                             ch.<a class="code" href="classXFuXMChannel.html#m38">mPan</a> -= (ch.<a class="code" href="classXFuXMChannel.html#m58">mPanningSlideV</a> &amp; 0xF);
01892                             <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m38">mPan</a> &lt; 0) ch.<a class="code" href="classXFuXMChannel.html#m38">mPan</a> = 0;
01893 
01894                             <span class="keywordflow">break</span>;
01895 
01896                         <span class="keywordflow">case</span> 0x1B:  <span class="comment">// Multi retrig note (Rxy)</span>
01897                             <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m54">mMultiRetrigRateV</a> != 0)
01898                             {
01899                                 <span class="keywordflow">if</span> ((ch.<a class="code" href="classXFuXMChannel.html#m59">mMultiRetrigTicker</a> % ch.<a class="code" href="classXFuXMChannel.html#m54">mMultiRetrigRateV</a>) == 0)
01900                                 {
01901                                     ch.<a class="code" href="classXFuXMChannel.html#m2">mInitSample</a> = 1;
01902                                     <a class="code" href="classXFuXMPlayer.html#b6">initSound</a>(ch);
01903 
01904                                     <span class="keywordflow">if</span> ((ch.<a class="code" href="classXFuXMChannel.html#m53">mMultiRetrigVolumeV</a> != 8) &amp;&amp; (ch.<a class="code" href="classXFuXMChannel.html#m59">mMultiRetrigTicker</a> != 0))
01905                                     {
01906                                         <span class="comment">// Don't affect volume on first tick</span>
01907                                         <span class="keywordflow">switch</span> (ch.<a class="code" href="classXFuXMChannel.html#m53">mMultiRetrigVolumeV</a>)
01908                                         {
01909                                             <span class="keywordflow">case</span> 0x1:
01910                                                 ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> -= 1;
01911                                                 <span class="keywordflow">break</span>;
01912                                             <span class="keywordflow">case</span> 0x2:
01913                                                 ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> -= 2;
01914                                                 <span class="keywordflow">break</span>;
01915                                             <span class="keywordflow">case</span> 0x3:
01916                                                 ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> -= 4;
01917                                                 <span class="keywordflow">break</span>;
01918                                             <span class="keywordflow">case</span> 0x4:
01919                                                 ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> -= 8;
01920                                                 <span class="keywordflow">break</span>;
01921                                             <span class="keywordflow">case</span> 0x5:
01922                                                 ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> -= 16;
01923                                                 <span class="keywordflow">break</span>;
01924                                             <span class="keywordflow">case</span> 0x6:
01925                                                 ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> = (INT8)(ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> * 2.0f / 3.0f);
01926                                                 <span class="keywordflow">break</span>;
01927                                             <span class="keywordflow">case</span> 0x7:
01928                                                 ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> &gt;&gt;= 1;
01929                                                 <span class="keywordflow">break</span>;
01930                                             <span class="keywordflow">case</span> 0x9:
01931                                                 ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> += 1;
01932                                                 <span class="keywordflow">break</span>;
01933                                             <span class="keywordflow">case</span> 0xA:
01934                                                 ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> += 2;
01935                                                 <span class="keywordflow">break</span>;
01936                                             <span class="keywordflow">case</span> 0xB:
01937                                                 ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> += 4;
01938                                                 <span class="keywordflow">break</span>;
01939                                             <span class="keywordflow">case</span> 0xC:
01940                                                 ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> += 8;
01941                                                 <span class="keywordflow">break</span>;
01942                                             <span class="keywordflow">case</span> 0xD:
01943                                                 ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> += 16;
01944                                                 <span class="keywordflow">break</span>;
01945                                             <span class="keywordflow">case</span> 0xE:
01946                                                 ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> = (INT8)(ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> * 3.0f / 2.0f);
01947                                                 <span class="keywordflow">break</span>;
01948                                             <span class="keywordflow">case</span> 0xF:
01949                                                 ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> &lt;&lt;= 1;
01950                                                 <span class="keywordflow">break</span>;
01951                                         }
01952 
01953                                         <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> &gt; 0x40) ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> = 0x40;
01954                                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> &lt; 0) ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> = 0;
01955 
01956                                         ch.<a class="code" href="classXFuXMChannel.html#m27">mBaseVolume</a> = ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a>;
01957                                     }
01958                                 }
01959                             }
01960 
01961                             ch.<a class="code" href="classXFuXMChannel.html#m59">mMultiRetrigTicker</a>++;
01962                             <span class="keywordflow">break</span>;
01963 
01964                         <span class="keywordflow">case</span> 0x1D:  <span class="comment">// Tremor (Txy)</span>
01965                             <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m55">mTremorV</a> != 0)
01966                             {
01967                                 <span class="keywordflow">if</span> ((UINT8)(ch.<a class="code" href="classXFuXMChannel.html#m60">mTremorTicker</a> % 
01968                                     ((ch.<a class="code" href="classXFuXMChannel.html#m55">mTremorV</a> &gt;&gt; 4) + (ch.<a class="code" href="classXFuXMChannel.html#m55">mTremorV</a> &amp; 0xF) + 2)) &lt; 
01969                                     (ch.<a class="code" href="classXFuXMChannel.html#m55">mTremorV</a> &gt;&gt; 4) + 1)
01970                                     ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> = ch.<a class="code" href="classXFuXMChannel.html#m27">mBaseVolume</a>;
01971                                 <span class="keywordflow">else</span>
01972                                     ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> = 0;
01973                             }
01974 
01975                             ch.<a class="code" href="classXFuXMChannel.html#m60">mTremorTicker</a>++;
01976                             <span class="keywordflow">break</span>;
01977 
01978                     }
01979 
01980                     <span class="comment">// Tone portamento (3xy) /</span>
01981                     <span class="comment">// tone portamento + volume slide (5xy) /</span>
01982                     <span class="comment">// volume column tone portamento (Mxy)</span>
01983                     <span class="keywordflow">if</span> ((ch.<a class="code" href="classXFuXMChannel.html#m42">mEffectType</a> == 0x3) || (ch.<a class="code" href="classXFuXMChannel.html#m42">mEffectType</a> == 0x5))
01984                     {
01985                         <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m62">mOldPeriod</a> != 0)
01986                         {
01987                             <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m63">mDestPeriod</a> &gt; ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a>)
01988                             {
01989                                 ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a> += (ch.<a class="code" href="classXFuXMChannel.html#m46">mTonePortamentoV</a> * 4);
01990                                 <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a> &gt; ch.<a class="code" href="classXFuXMChannel.html#m63">mDestPeriod</a>) ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a> = ch.<a class="code" href="classXFuXMChannel.html#m63">mDestPeriod</a>;
01991                             }
01992                             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m63">mDestPeriod</a> &lt; ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a>)
01993                             {
01994                                 ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a> -= (ch.<a class="code" href="classXFuXMChannel.html#m46">mTonePortamentoV</a> * 4);
01995                                 <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a> &lt; ch.<a class="code" href="classXFuXMChannel.html#m63">mDestPeriod</a>) ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a> = ch.<a class="code" href="classXFuXMChannel.html#m63">mDestPeriod</a>;
01996                             }
01997 
01998                             ch.<a class="code" href="classXFuXMChannel.html#m64">mBasePeriod</a> = ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a>;
01999                         }
02000                     }
02001 
02002                     <span class="comment">// Volume slide (Axy) / </span>
02003                     <span class="comment">// tone portamento + volume slide (5xy) / </span>
02004                     <span class="comment">// vibrato + volume slide (6xy)</span>
02005                     <span class="keywordflow">if</span> ((ch.<a class="code" href="classXFuXMChannel.html#m42">mEffectType</a> == 0xA) || (ch.<a class="code" href="classXFuXMChannel.html#m42">mEffectType</a> == 0x5) || (ch.<a class="code" href="classXFuXMChannel.html#m42">mEffectType</a> == 0x6))
02006                     {
02007                         ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> += (ch.<a class="code" href="classXFuXMChannel.html#m47">mVolumeSlideV</a> &gt;&gt; 4);
02008                         <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> &gt; 0x40) ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> = 0x40;
02009 
02010                         ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> -= (ch.<a class="code" href="classXFuXMChannel.html#m47">mVolumeSlideV</a> &amp; 0xF);
02011                         <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> &lt; 0) ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> = 0;
02012 
02013                         ch.<a class="code" href="classXFuXMChannel.html#m27">mBaseVolume</a> = ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a>;
02014                     }
02015 
02016                     <span class="comment">// Vibrato</span>
02017                     <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m65">mIsVibrato</a>)
02018                     {
02019                         <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m69">mVibratoWaveform</a> &amp; <a class="code" href="XFuXMPlayer__internal_8h.html#a23a13">WAVEFORM_SINEWAVE</a>)
02020                             vibratoTable = mSineWaveTable;
02021                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m69">mVibratoWaveform</a> &amp; <a class="code" href="XFuXMPlayer__internal_8h.html#a23a15">WAVEFORM_SQUAREWAVE</a>)
02022                             vibratoTable = <a class="code" href="classXFuXMPlayer.html#n10">mSquareWaveTable</a>;
02023                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m69">mVibratoWaveform</a> &amp; <a class="code" href="XFuXMPlayer__internal_8h.html#a23a14">WAVEFORM_RAMPDOWN</a>)
02024                             vibratoTable = <a class="code" href="classXFuXMPlayer.html#n12">mRampDownTable</a>;
02025                         <span class="comment">// FIX ME! Random waveform not supported</span>
02026 
02027                         ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a> = ch.<a class="code" href="classXFuXMChannel.html#m64">mBasePeriod</a> + 
02028                             ((vibratoTable[ch.<a class="code" href="classXFuXMChannel.html#m68">mVibratoPointer</a>] * ch.<a class="code" href="classXFuXMChannel.html#m67">mVibratoDepth</a>) &gt;&gt; 7);
02029                         ch.<a class="code" href="classXFuXMChannel.html#m68">mVibratoPointer</a> = (UINT8)(
02030                             (ch.<a class="code" href="classXFuXMChannel.html#m68">mVibratoPointer</a> + ch.<a class="code" href="classXFuXMChannel.html#m66">mVibratoRate</a>) % <a class="code" href="XFuXMPlayer__internal_8h.html#a1">XMFORMAT_SIZEOF_WAVEFORM</a>);
02031                     }
02032                 }
02033             }
02034 
02035             <span class="keywordflow">for</span> (chan = 0; chan &lt; <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m4">mNbChannels</a>; chan++)
02036             {
02037                 <a class="code" href="classXFuXMChannel.html">XFuXMChannel</a> &amp;ch = <a class="code" href="classXFuXMPlayer.html#n8">mChannels</a>[chan];
02038                 <a class="code" href="classXFuXMInstrument.html">XFuXMInstrument</a> *in = NULL;
02039 
02040                 <span class="keywordflow">if</span> ((ch.<a class="code" href="classXFuXMChannel.html#m8">mInstrumentNb</a> != -1) &amp;&amp; (ch.<a class="code" href="classXFuXMChannel.html#m8">mInstrumentNb</a> &lt; <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m5">mNbInstruments</a>))
02041                 {
02042                     in = &amp;<a class="code" href="classXFuXMPlayer.html#n7">mInstruments</a>[ch.<a class="code" href="classXFuXMChannel.html#m8">mInstrumentNb</a>];
02043 
02044                     ch.<a class="code" href="classXFuXMChannel.html#m29">mFinalOldVolume</a> = ch.<a class="code" href="classXFuXMChannel.html#m28">mFinalVolume</a>;
02045 
02046                     <span class="comment">// Volume envelope</span>
02047                     <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m17">mVolEnvType</a> &amp; <a class="code" href="XFuXMPlayer__internal_8h.html#a22a10">ENVELOPE_ON</a>)
02048                     {
02049                         <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m18">mVolEnvPointer</a> &gt;= in-&gt;<a class="code" href="classXFuXMInstrument.html#m4">mVolEnvEnd</a>)
02050                         {
02051                             <span class="comment">// Not normal behavior but can happen when using</span>
02052                             <span class="comment">// set envelope position (Lxy) command with a value</span>
02053                             <span class="comment">// which is bigger than the last envelope point</span>
02054                             ch.<a class="code" href="classXFuXMChannel.html#m18">mVolEnvPointer</a> = in-&gt;<a class="code" href="classXFuXMInstrument.html#m4">mVolEnvEnd</a>;
02055                             ch.<a class="code" href="classXFuXMChannel.html#m19">mVolEnvSpeed</a> = 0;
02056                         }
02057 
02058                         ch.<a class="code" href="classXFuXMChannel.html#m23">mVolEnvValue</a> = in-&gt;<a class="code" href="classXFuXMInstrument.html#m3">mVolumeEnvelope</a>[ch.<a class="code" href="classXFuXMChannel.html#m18">mVolEnvPointer</a>];
02059 
02060                         <span class="keywordflow">if</span> ((ch.<a class="code" href="classXFuXMChannel.html#m17">mVolEnvType</a> &amp; <a class="code" href="XFuXMPlayer__internal_8h.html#a22a11">ENVELOPE_SUSTAIN</a>) &amp;&amp; 
02061                             (ch.<a class="code" href="classXFuXMChannel.html#m18">mVolEnvPointer</a> == ch.<a class="code" href="classXFuXMChannel.html#m22">mVolEnvSustain</a>) &amp;&amp;
02062                             (ch.<a class="code" href="classXFuXMChannel.html#m40">mSustainReleased</a> == 0))
02063                         {
02064                             <span class="comment">// Sustain point, stop envelope</span>
02065                             ch.<a class="code" href="classXFuXMChannel.html#m19">mVolEnvSpeed</a> = 0;
02066                         }
02067 
02068                         <span class="comment">// Fix for trackers which don't follow FT2 standard in envelopes</span>
02069                         <span class="keywordflow">if</span> (in-&gt;<a class="code" href="classXFuXMInstrument.html#m4">mVolEnvEnd</a> != 0) ch.<a class="code" href="classXFuXMChannel.html#m18">mVolEnvPointer</a> += ch.<a class="code" href="classXFuXMChannel.html#m19">mVolEnvSpeed</a>;
02070 
02071                         <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m17">mVolEnvType</a> &amp; <a class="code" href="XFuXMPlayer__internal_8h.html#a22a12">ENVELOPE_LOOP</a>)
02072                         {
02073                             <span class="comment">// Envelope loop</span>
02074                             <span class="comment">// The loop check is faulty and should check whether</span>
02075                             <span class="comment">// the pointer has passed the end point instead, but </span>
02076                             <span class="comment">// as the bug is in FT2, it is also here for the sake </span>
02077                             <span class="comment">// of compatibility</span>
02078                             <span class="keywordflow">if</span> ((ch.<a class="code" href="classXFuXMChannel.html#m19">mVolEnvSpeed</a>) &amp;&amp; (ch.<a class="code" href="classXFuXMChannel.html#m18">mVolEnvPointer</a> == ch.<a class="code" href="classXFuXMChannel.html#m21">mVolEnvLoopEnd</a>))
02079                                 ch.<a class="code" href="classXFuXMChannel.html#m18">mVolEnvPointer</a> = ch.<a class="code" href="classXFuXMChannel.html#m20">mVolEnvLoopStart</a>;
02080                         }
02081                         <span class="keywordflow">else</span>
02082                         {
02083                             <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m18">mVolEnvPointer</a> == in-&gt;<a class="code" href="classXFuXMInstrument.html#m4">mVolEnvEnd</a>)
02084                                 ch.<a class="code" href="classXFuXMChannel.html#m19">mVolEnvSpeed</a> = 0;
02085                         }
02086 
02087                         <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m40">mSustainReleased</a>)
02088                         {
02089                             ch.<a class="code" href="classXFuXMChannel.html#m25">mVolumeFadeoutValue</a> -= (ch.<a class="code" href="classXFuXMChannel.html#m24">mVolumeFadeout</a> * 2);
02090                             <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m25">mVolumeFadeoutValue</a> &lt; 0) ch.<a class="code" href="classXFuXMChannel.html#m25">mVolumeFadeoutValue</a> = 0;
02091                         }
02092                     } <span class="keywordflow">else</span> ch.<a class="code" href="classXFuXMChannel.html#m23">mVolEnvValue</a> = REALf(1.0f); <span class="comment">// No volume envelope</span>
02093 
02094                     <span class="comment">// Panning envelope</span>
02095                     <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m31">mPanEnvType</a> &amp; <a class="code" href="XFuXMPlayer__internal_8h.html#a22a10">ENVELOPE_ON</a>)
02096                     {
02097                         <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m32">mPanEnvPointer</a> &gt;= in-&gt;<a class="code" href="classXFuXMInstrument.html#m11">mPanEnvEnd</a>)
02098                         {
02099                             <span class="comment">// Not normal behavior but can happen when using</span>
02100                             <span class="comment">// set envelope position (Lxy) command with a value</span>
02101                             <span class="comment">// which is bigger than the last envelope point</span>
02102                             ch.<a class="code" href="classXFuXMChannel.html#m32">mPanEnvPointer</a> = in-&gt;<a class="code" href="classXFuXMInstrument.html#m11">mPanEnvEnd</a>;
02103                             ch.<a class="code" href="classXFuXMChannel.html#m33">mPanEnvSpeed</a> = 0;
02104                         }
02105 
02106                         ch.<a class="code" href="classXFuXMChannel.html#m37">mPanEnvValue</a> = in-&gt;<a class="code" href="classXFuXMInstrument.html#m10">mPanningEnvelope</a>[ch.<a class="code" href="classXFuXMChannel.html#m32">mPanEnvPointer</a>];
02107 
02108                         <span class="keywordflow">if</span> ((ch.<a class="code" href="classXFuXMChannel.html#m31">mPanEnvType</a> &amp; <a class="code" href="XFuXMPlayer__internal_8h.html#a22a11">ENVELOPE_SUSTAIN</a>) &amp;&amp; 
02109                             (ch.<a class="code" href="classXFuXMChannel.html#m32">mPanEnvPointer</a> == ch.<a class="code" href="classXFuXMChannel.html#m36">mPanEnvSustain</a>) &amp;&amp;
02110                             (ch.<a class="code" href="classXFuXMChannel.html#m40">mSustainReleased</a> == 0))
02111                         {
02112                             <span class="comment">// Sustain point, stop envelope</span>
02113                             ch.<a class="code" href="classXFuXMChannel.html#m33">mPanEnvSpeed</a> = 0;
02114                         }
02115 
02116                         <span class="comment">// Fix for trackers which don't follow FT2 standard in envelopes</span>
02117                         <span class="keywordflow">if</span> (in-&gt;<a class="code" href="classXFuXMInstrument.html#m11">mPanEnvEnd</a> != 0) ch.<a class="code" href="classXFuXMChannel.html#m32">mPanEnvPointer</a> += ch.<a class="code" href="classXFuXMChannel.html#m33">mPanEnvSpeed</a>;
02118 
02119                         <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m31">mPanEnvType</a> &amp; <a class="code" href="XFuXMPlayer__internal_8h.html#a22a12">ENVELOPE_LOOP</a>)
02120                         {
02121                             <span class="comment">// Envelope loop</span>
02122                             <span class="comment">// The loop check is faulty and should check whether</span>
02123                             <span class="comment">// the pointer has passed the end point instead, but </span>
02124                             <span class="comment">// as the bug is in FT2, it is also here for the sake </span>
02125                             <span class="comment">// of compatibility</span>
02126                             <span class="keywordflow">if</span> ((ch.<a class="code" href="classXFuXMChannel.html#m33">mPanEnvSpeed</a>) &amp;&amp; (ch.<a class="code" href="classXFuXMChannel.html#m32">mPanEnvPointer</a> == ch.<a class="code" href="classXFuXMChannel.html#m35">mPanEnvLoopEnd</a>))
02127                                 ch.<a class="code" href="classXFuXMChannel.html#m32">mPanEnvPointer</a> = ch.<a class="code" href="classXFuXMChannel.html#m34">mPanEnvLoopStart</a>;
02128                         }
02129                         <span class="keywordflow">else</span>
02130                         {
02131                             <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m32">mPanEnvPointer</a> == in-&gt;<a class="code" href="classXFuXMInstrument.html#m11">mPanEnvEnd</a>) ch.<a class="code" href="classXFuXMChannel.html#m33">mPanEnvSpeed</a> = 0;
02132                         }
02133                     } <span class="keywordflow">else</span> ch.<a class="code" href="classXFuXMChannel.html#m37">mPanEnvValue</a> = 0x20;  <span class="comment">// No panning envelope</span>
02134 
02135                     <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> &gt; 0x40) ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> = 0x40;
02136                     <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> &lt; 0) ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> = 0;
02137 
02138                     INT32 intVolume = (ch.<a class="code" href="classXFuXMChannel.html#m26">mVolume</a> * <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m8">mGlobalVolume</a>);
02139                     REAL volumeTemp;
02140                     volumeTemp.mValue = (intVolume &lt;&lt; 3) + (intVolume &lt;&lt; 1);
02141                     ch.<a class="code" href="classXFuXMChannel.html#m28">mFinalVolume</a> = (volumeTemp * ch.<a class="code" href="classXFuXMChannel.html#m23">mVolEnvValue</a> * ch.<a class="code" href="classXFuXMChannel.html#m25">mVolumeFadeoutValue</a>);
02142                     
02143                     volumeTemp = (ch.<a class="code" href="classXFuXMChannel.html#m28">mFinalVolume</a> - ch.<a class="code" href="classXFuXMChannel.html#m29">mFinalOldVolume</a>);
02144                     ch.<a class="code" href="classXFuXMChannel.html#m30">mFinalVolumeSpeed</a> = (volumeTemp * <a class="code" href="classXFuXMPlayer.html#n28">mVolumeRampDivOpt</a>);
02145                     
02146 <span class="comment">/*</span>
02147 <span class="comment">                    REAL volumeTemp;</span>
02148 <span class="comment">                    volumeTemp.mValue = (ch.mVolume * mSong.mGlobalVolume * ch.mVolumeFadeoutValue) &gt;&gt; 13;</span>
02149 <span class="comment">                    ch.mFinalVolume = (volumeTemp * ch.mVolEnvValue);</span>
02150 <span class="comment"></span>
02151 <span class="comment">                    volumeTemp = (ch.mFinalVolume - ch.mFinalOldVolume);</span>
02152 <span class="comment">                    ch.mFinalVolumeSpeed = (volumeTemp * mVolumeRampDivOpt);</span>
02153 <span class="comment">*/</span>
02154 <span class="comment">/*</span>
02155 <span class="comment">                    FLOAT32 volumeReal;</span>
02156 <span class="comment">                    volumeReal = (((FLOAT32)ch.mVolume / 65.0f) * (FLOAT32)ch.mVolEnvValue * </span>
02157 <span class="comment">                        (FLOAT32)ch.mVolumeFadeoutValue * ((FLOAT32)mSong.mGlobalVolume / 65.0f));</span>
02158 <span class="comment">                    </span>
02159 <span class="comment">                    ch.mFinalVolume = REALf(volumeReal);</span>
02160 <span class="comment">                    </span>
02161 <span class="comment">                    ch.mFinalVolumeSpeed = (ch.mFinalVolume - ch.mFinalOldVolume) / REALf(32);</span>
02162 <span class="comment">*/</span>                    
02163 <span class="comment">/*</span>
02164 <span class="comment">                    volumeReal = (ch.mVolume * (FLOAT32)ch.mVolEnvValue *</span>
02165 <span class="comment">                        ch.mVolumeFadeoutValue * mSong.mGlobalVolume) *</span>
02166 <span class="comment">                        VOLUME_DIV_OPT;</span>
02167 <span class="comment"></span>
02168 <span class="comment">                    ch.mFinalVolume = (INT32)volumeReal;</span>
02169 <span class="comment"></span>
02170 <span class="comment">                    ch.mFinalVolumeSpeed = (INT32)((ch.mFinalVolume - ch.mFinalOldVolume) *</span>
02171 <span class="comment">                        VOLUME_RAMP_WIDTH_OPT);</span>
02172 <span class="comment">*/</span>
02173                     
02174                     ch.<a class="code" href="classXFuXMChannel.html#m39">mFinalPan</a> = (INT16)(ch.<a class="code" href="classXFuXMChannel.html#m38">mPan</a> + (((ch.<a class="code" href="classXFuXMChannel.html#m37">mPanEnvValue</a> - 0x20) *
02175                           (0x80 - <a class="code" href="XFuXMPlayer_8cpp.html#a0">ABS</a>(ch.<a class="code" href="classXFuXMChannel.html#m38">mPan</a> - 0x80))) &gt;&gt; 5));
02176                     <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m39">mFinalPan</a> &gt; 0xFF) ch.<a class="code" href="classXFuXMChannel.html#m39">mFinalPan</a> = 0xFF;
02177                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m39">mFinalPan</a> &lt; 0) ch.<a class="code" href="classXFuXMChannel.html#m39">mFinalPan</a> = 0;
02178 
02179                     ch.<a class="code" href="classXFuXMChannel.html#m9">mSpeed</a> = <a class="code" href="classXFuXMPlayer.html#b4">getSpeed</a>(ch.<a class="code" href="classXFuXMChannel.html#m61">mPeriod</a>, mSamplingRate);
02180                 }
02181             }
02182         }
02183 
02184         ticksLeft = (<a class="code" href="classXFuXMPlayer.html#n17">mSamplesPerTick</a> - <a class="code" href="classXFuXMPlayer.html#n18">mSamplePointer</a>);
02185         indicesLeft = (aSamples - index);
02186 
02187         <span class="keywordflow">if</span> (ticksLeft &lt; indicesLeft) samplesToRender = ticksLeft;
02188         <span class="keywordflow">else</span> samplesToRender = indicesLeft;
02189 
02190         INT startChan = 0;
02191         INT endChan = <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m4">mNbChannels</a>;
02192         <span class="keywordflow">if</span> (<a class="code" href="classXFuXMPlayer.html#n1">mFlags</a> &amp; XFCAUDIO_16BIT)    <span class="comment">// 16bit</span>
02193         {
02194             <span class="keywordflow">if</span> (<a class="code" href="classXFuXMPlayer.html#n1">mFlags</a> &amp; XFCAUDIO_STEREO)   <span class="comment">// 16bit stereo</span>
02195             {
02196                 <span class="keywordflow">for</span> (counter = 0; counter &lt; samplesToRender; ++counter, ++index)
02197                 {
02198                     cLeft = cRight = 0;
02199 
02200                     <span class="keywordflow">for</span> (chan = startChan; chan &lt; endChan; chan++)
02201                     {
02202                         <a class="code" href="classXFuXMChannel.html">XFuXMChannel</a> &amp;ch = <a class="code" href="classXFuXMPlayer.html#n8">mChannels</a>[chan];
02203 
02204                         <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m13">mIsSample</a>)
02205                         {
02206                             delta = ch.<a class="code" href="classXFuXMChannel.html#m3">mPointer</a> &amp; (<a class="code" href="XFuXMPlayer__internal_8h.html#a5">FP_VALUE</a> - 1);
02207 
02208                             val1 = 0;
02209                             val2 = 0;
02210 
02211                             <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m5">mCurrentSample</a>.<a class="code" href="classXFuXMSample.html#m10">m16Bit</a>)
02212                             {
02213                                 val1 = *((INT16 *)ch.<a class="code" href="classXFuXMChannel.html#m6">mOffset</a> + (ch.<a class="code" href="classXFuXMChannel.html#m3">mPointer</a> &gt;&gt; <a class="code" href="XFuXMPlayer__internal_8h.html#a4">FP_BITS</a>));
02214 
02215                                 <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m10">mLoop</a> == 0)
02216                                 {
02217                                     <a class="code" href="XFuXMPlayer_8cpp.html#a2">interpolateLinear16</a>(ch, val1, val2);
02218                                     <a class="code" href="XFuXMPlayer_8cpp.html#a7">addPointer</a>(ch);
02219                                 }
02220                                 <span class="keywordflow">else</span>
02221                                 {
02222                                     temp = (ch.<a class="code" href="classXFuXMChannel.html#m3">mPointer</a> + <a class="code" href="XFuXMPlayer__internal_8h.html#a5">FP_VALUE</a>);
02223 
02224                                     <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m10">mLoop</a> == <a class="code" href="XFuXMPlayer__internal_8h.html#a21a8">LOOP_FORWARD</a>)
02225                                     {
02226                                         <a class="code" href="XFuXMPlayer_8cpp.html#a4">interpolateLinearForwardLoop16</a>(ch, val1, val2, temp);
02227                                         <a class="code" href="XFuXMPlayer_8cpp.html#a8">addPointerForwardLoop</a>(ch);
02228                                     }
02229                                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m10">mLoop</a> == <a class="code" href="XFuXMPlayer__internal_8h.html#a21a9">LOOP_PINGPONG</a>)
02230                                     {
02231                                         <a class="code" href="XFuXMPlayer_8cpp.html#a6">interpolateLinearBidirectionalLoop16</a>(ch, val1, val2, temp);
02232                                         <a class="code" href="XFuXMPlayer_8cpp.html#a9">addPointerBidirectionalLoop</a>(ch);
02233                                     }
02234                                 }
02235                             }
02236                             <span class="keywordflow">else</span>
02237                             {
02238                                 val1 = *((INT8 *)ch.<a class="code" href="classXFuXMChannel.html#m6">mOffset</a> + (ch.<a class="code" href="classXFuXMChannel.html#m3">mPointer</a> &gt;&gt; <a class="code" href="XFuXMPlayer__internal_8h.html#a4">FP_BITS</a>));
02239 
02240                                 <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m10">mLoop</a> == 0)
02241                                 {
02242                                     <a class="code" href="XFuXMPlayer_8cpp.html#a1">interpolateLinear8</a>(ch, val1, val2);
02243                                     <a class="code" href="XFuXMPlayer_8cpp.html#a7">addPointer</a>(ch);
02244                                 }
02245                                 <span class="keywordflow">else</span>
02246                                 {
02247                                     temp = (ch.<a class="code" href="classXFuXMChannel.html#m3">mPointer</a> + <a class="code" href="XFuXMPlayer__internal_8h.html#a5">FP_VALUE</a>);
02248 
02249                                     <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m10">mLoop</a> == <a class="code" href="XFuXMPlayer__internal_8h.html#a21a8">LOOP_FORWARD</a>)
02250                                     {
02251                                         <a class="code" href="XFuXMPlayer_8cpp.html#a3">interpolateLinearForwardLoop8</a>(ch, val1, val2, temp);
02252                                         <a class="code" href="XFuXMPlayer_8cpp.html#a8">addPointerForwardLoop</a>(ch);
02253                                     }
02254                                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m10">mLoop</a> == <a class="code" href="XFuXMPlayer__internal_8h.html#a21a9">LOOP_PINGPONG</a>)
02255                                     {
02256                                         <a class="code" href="XFuXMPlayer_8cpp.html#a5">interpolateLinearBidirectionalLoop8</a>(ch, val1, val2, temp);
02257                                         <a class="code" href="XFuXMPlayer_8cpp.html#a9">addPointerBidirectionalLoop</a>(ch);
02258                                     }
02259                                 }
02260 
02261                                 val1 &lt;&lt;= 8;
02262                                 val2 &lt;&lt;= 8;
02263                             }
02264 
02265                             value = (((val2 * delta) + (val1 * (<a class="code" href="XFuXMPlayer__internal_8h.html#a5">FP_VALUE</a> - delta))) &gt;&gt; <a class="code" href="XFuXMPlayer__internal_8h.html#a4">FP_BITS</a>);
02266 
02267                             value = (INT16)(value * ch.<a class="code" href="classXFuXMChannel.html#m29">mFinalOldVolume</a>);
02268                             cLeft += ((value * (0xFF - (UINT8)ch.<a class="code" href="classXFuXMChannel.html#m39">mFinalPan</a>)) &gt;&gt; 8);
02269                             cRight += ((value * (UINT8)ch.<a class="code" href="classXFuXMChannel.html#m39">mFinalPan</a>) &gt;&gt; 8);
02270 
02271                             <span class="keywordflow">if</span> (<a class="code" href="classXFuXMPlayer.html#n20">mRamp</a> &lt; <a class="code" href="XFuXMPlayer__internal_8h.html#a7">VOLUME_RAMP_WIDTH</a>) ch.<a class="code" href="classXFuXMChannel.html#m29">mFinalOldVolume</a> += ch.<a class="code" href="classXFuXMChannel.html#m30">mFinalVolumeSpeed</a>;
02272                         }
02273                     }
02274 
02275                     <span class="keywordflow">if</span> (cLeft &lt; -32768) cLeft = -32768;
02276                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cLeft &gt; 32767) cLeft = 32767;
02277                     <span class="keywordflow">if</span> (cRight &lt; -32768) cRight = -32768;
02278                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cRight &gt; 32767) cRight = 32767;
02279 
02280                     *((INT16 *)aBuffer + (targetOffset &lt;&lt; 1)) = (INT16)(cLeft ^ <a class="code" href="classXFuXMPlayer.html#n2">mTgtXor</a>);
02281                     *((INT16 *)aBuffer + (targetOffset &lt;&lt; 1) + 1) = (INT16)(cRight ^ <a class="code" href="classXFuXMPlayer.html#n2">mTgtXor</a>);
02282 
02283                     targetOffset++;
02284                     <span class="keywordflow">if</span> (targetOffset == aTargetSamples) targetOffset = 0;
02285 
02286                     <span class="keywordflow">if</span> (<a class="code" href="classXFuXMPlayer.html#n20">mRamp</a> &lt; <a class="code" href="XFuXMPlayer__internal_8h.html#a7">VOLUME_RAMP_WIDTH</a>) <a class="code" href="classXFuXMPlayer.html#n20">mRamp</a>++;
02287                 }
02288             }
02289             <span class="keywordflow">else</span>    <span class="comment">// 16bit mono</span>
02290             {
02291                 <span class="keywordflow">for</span> (counter = 0; counter &lt; samplesToRender; ++counter, ++index)
02292                 {
02293                     cLeft = 0;
02294 
02295                     <span class="keywordflow">for</span> (chan = startChan; chan &lt; endChan; chan++)
02296                     {
02297                         <a class="code" href="classXFuXMChannel.html">XFuXMChannel</a> &amp;ch = <a class="code" href="classXFuXMPlayer.html#n8">mChannels</a>[chan];
02298 
02299                         <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m13">mIsSample</a>)
02300                         {
02301                             delta = ch.<a class="code" href="classXFuXMChannel.html#m3">mPointer</a> &amp; (<a class="code" href="XFuXMPlayer__internal_8h.html#a5">FP_VALUE</a> - 1);
02302 
02303                             val1 = 0;
02304                             val2 = 0;
02305 
02306                             <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m5">mCurrentSample</a>.<a class="code" href="classXFuXMSample.html#m10">m16Bit</a>)
02307                             {
02308                                 val1 = *((INT16 *)ch.<a class="code" href="classXFuXMChannel.html#m6">mOffset</a> + (ch.<a class="code" href="classXFuXMChannel.html#m3">mPointer</a> &gt;&gt; <a class="code" href="XFuXMPlayer__internal_8h.html#a4">FP_BITS</a>));
02309 
02310                                 <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m10">mLoop</a> == 0)
02311                                 {
02312                                     <a class="code" href="XFuXMPlayer_8cpp.html#a2">interpolateLinear16</a>(ch, val1, val2);
02313                                     <a class="code" href="XFuXMPlayer_8cpp.html#a7">addPointer</a>(ch);
02314                                 }
02315                                 <span class="keywordflow">else</span>
02316                                 {
02317                                     temp = (ch.<a class="code" href="classXFuXMChannel.html#m3">mPointer</a> + <a class="code" href="XFuXMPlayer__internal_8h.html#a5">FP_VALUE</a>);
02318 
02319                                     <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m10">mLoop</a> == <a class="code" href="XFuXMPlayer__internal_8h.html#a21a8">LOOP_FORWARD</a>)
02320                                     {
02321                                         <a class="code" href="XFuXMPlayer_8cpp.html#a4">interpolateLinearForwardLoop16</a>(ch, val1, val2, temp);
02322                                         <a class="code" href="XFuXMPlayer_8cpp.html#a8">addPointerForwardLoop</a>(ch);
02323                                     }
02324                                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m10">mLoop</a> == <a class="code" href="XFuXMPlayer__internal_8h.html#a21a9">LOOP_PINGPONG</a>)
02325                                     {
02326                                         <a class="code" href="XFuXMPlayer_8cpp.html#a6">interpolateLinearBidirectionalLoop16</a>(ch, val1, val2, temp);
02327                                         <a class="code" href="XFuXMPlayer_8cpp.html#a9">addPointerBidirectionalLoop</a>(ch);
02328                                     }
02329                                 }
02330                             }
02331                             <span class="keywordflow">else</span>
02332                             {
02333                                 val1 = *((INT8 *)ch.<a class="code" href="classXFuXMChannel.html#m6">mOffset</a> + (ch.<a class="code" href="classXFuXMChannel.html#m3">mPointer</a> &gt;&gt; <a class="code" href="XFuXMPlayer__internal_8h.html#a4">FP_BITS</a>));
02334 
02335                                 <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m10">mLoop</a> == 0)
02336                                 {
02337                                     <a class="code" href="XFuXMPlayer_8cpp.html#a1">interpolateLinear8</a>(ch, val1, val2);
02338                                     <a class="code" href="XFuXMPlayer_8cpp.html#a7">addPointer</a>(ch);
02339                                 }
02340                                 <span class="keywordflow">else</span>
02341                                 {
02342                                     temp = (ch.<a class="code" href="classXFuXMChannel.html#m3">mPointer</a> + <a class="code" href="XFuXMPlayer__internal_8h.html#a5">FP_VALUE</a>);
02343 
02344                                     <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m10">mLoop</a> == <a class="code" href="XFuXMPlayer__internal_8h.html#a21a8">LOOP_FORWARD</a>)
02345                                     {
02346                                         <a class="code" href="XFuXMPlayer_8cpp.html#a3">interpolateLinearForwardLoop8</a>(ch, val1, val2, temp);
02347                                         <a class="code" href="XFuXMPlayer_8cpp.html#a8">addPointerForwardLoop</a>(ch);
02348                                     }
02349                                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m10">mLoop</a> == <a class="code" href="XFuXMPlayer__internal_8h.html#a21a9">LOOP_PINGPONG</a>)
02350                                     {
02351                                         <a class="code" href="XFuXMPlayer_8cpp.html#a5">interpolateLinearBidirectionalLoop8</a>(ch, val1, val2, temp);
02352                                         <a class="code" href="XFuXMPlayer_8cpp.html#a9">addPointerBidirectionalLoop</a>(ch);
02353                                     }
02354                                 }
02355 
02356                                 val1 &lt;&lt;= 8;
02357                                 val2 &lt;&lt;= 8;
02358                             }
02359 
02360                             value = (((val2 * delta) + (val1 * (<a class="code" href="XFuXMPlayer__internal_8h.html#a5">FP_VALUE</a> - delta))) &gt;&gt; <a class="code" href="XFuXMPlayer__internal_8h.html#a4">FP_BITS</a>);
02361 
02362                             cLeft += (INT16)(value * ch.<a class="code" href="classXFuXMChannel.html#m29">mFinalOldVolume</a>);
02363 
02364                             <span class="keywordflow">if</span> (<a class="code" href="classXFuXMPlayer.html#n20">mRamp</a> &lt; <a class="code" href="XFuXMPlayer__internal_8h.html#a7">VOLUME_RAMP_WIDTH</a>) ch.<a class="code" href="classXFuXMChannel.html#m29">mFinalOldVolume</a> += ch.<a class="code" href="classXFuXMChannel.html#m30">mFinalVolumeSpeed</a>;
02365                         }
02366                     }
02367 
02368                     <span class="keywordflow">if</span> (cLeft &gt; 32767) cLeft = 32767;
02369                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cLeft &lt; -32768) cLeft = -32768;
02370 
02371                     *((INT16 *)aBuffer + targetOffset) = (INT16)(cLeft ^ <a class="code" href="classXFuXMPlayer.html#n2">mTgtXor</a>);
02372 
02373                     targetOffset++;
02374                     <span class="keywordflow">if</span> (targetOffset == aTargetSamples) targetOffset = 0;
02375 
02376                     <span class="keywordflow">if</span> (<a class="code" href="classXFuXMPlayer.html#n20">mRamp</a> &lt; <a class="code" href="XFuXMPlayer__internal_8h.html#a7">VOLUME_RAMP_WIDTH</a>) <a class="code" href="classXFuXMPlayer.html#n20">mRamp</a>++;
02377                 }
02378             }
02379         }
02380         <span class="keywordflow">else</span>    <span class="comment">// 8bit</span>
02381         {
02382             <span class="keywordflow">if</span> (<a class="code" href="classXFuXMPlayer.html#n1">mFlags</a> &amp; XFCAUDIO_STEREO)   <span class="comment">// 8bit stereo</span>
02383             {
02384                 <span class="keywordflow">for</span> (counter = 0; counter &lt; samplesToRender; ++counter, ++index)
02385                 {
02386                     cLeft = cRight = 0;
02387 
02388                     <span class="keywordflow">for</span> (chan = startChan; chan &lt; endChan; chan++)
02389                     {
02390                         <a class="code" href="classXFuXMChannel.html">XFuXMChannel</a> &amp;ch = <a class="code" href="classXFuXMPlayer.html#n8">mChannels</a>[chan];
02391 
02392                         <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m13">mIsSample</a>)
02393                         {
02394                             delta = ch.<a class="code" href="classXFuXMChannel.html#m3">mPointer</a> &amp; (<a class="code" href="XFuXMPlayer__internal_8h.html#a5">FP_VALUE</a> - 1);
02395 
02396                             val1 = 0;
02397                             val2 = 0;
02398 
02399                             <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m5">mCurrentSample</a>.<a class="code" href="classXFuXMSample.html#m10">m16Bit</a>)
02400                             {
02401                                 val1 = *((INT16 *)ch.<a class="code" href="classXFuXMChannel.html#m6">mOffset</a> + (ch.<a class="code" href="classXFuXMChannel.html#m3">mPointer</a> &gt;&gt; <a class="code" href="XFuXMPlayer__internal_8h.html#a4">FP_BITS</a>));
02402 
02403                                 <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m10">mLoop</a> == 0)
02404                                 {
02405                                     <a class="code" href="XFuXMPlayer_8cpp.html#a2">interpolateLinear16</a>(ch, val1, val2);
02406                                     <a class="code" href="XFuXMPlayer_8cpp.html#a7">addPointer</a>(ch);
02407                                 }
02408                                 <span class="keywordflow">else</span>
02409                                 {
02410                                     temp = (ch.<a class="code" href="classXFuXMChannel.html#m3">mPointer</a> + <a class="code" href="XFuXMPlayer__internal_8h.html#a5">FP_VALUE</a>);
02411 
02412                                     <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m10">mLoop</a> == <a class="code" href="XFuXMPlayer__internal_8h.html#a21a8">LOOP_FORWARD</a>)
02413                                     {
02414                                         <a class="code" href="XFuXMPlayer_8cpp.html#a4">interpolateLinearForwardLoop16</a>(ch, val1, val2, temp);
02415                                         <a class="code" href="XFuXMPlayer_8cpp.html#a8">addPointerForwardLoop</a>(ch);
02416                                     }
02417                                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m10">mLoop</a> == <a class="code" href="XFuXMPlayer__internal_8h.html#a21a9">LOOP_PINGPONG</a>)
02418                                     {
02419                                         <a class="code" href="XFuXMPlayer_8cpp.html#a6">interpolateLinearBidirectionalLoop16</a>(ch, val1, val2, temp);
02420                                         <a class="code" href="XFuXMPlayer_8cpp.html#a9">addPointerBidirectionalLoop</a>(ch);
02421                                     }
02422                                 }
02423 
02424                                 val1 &gt;&gt;= 8;
02425                                 val2 &gt;&gt;= 8;
02426                             }
02427                             <span class="keywordflow">else</span>
02428                             {
02429                                 val1 = *((INT8 *)ch.<a class="code" href="classXFuXMChannel.html#m6">mOffset</a> + (ch.<a class="code" href="classXFuXMChannel.html#m3">mPointer</a> &gt;&gt; <a class="code" href="XFuXMPlayer__internal_8h.html#a4">FP_BITS</a>));
02430 
02431                                 <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m10">mLoop</a> == 0)
02432                                 {
02433                                     <a class="code" href="XFuXMPlayer_8cpp.html#a1">interpolateLinear8</a>(ch, val1, val2);
02434                                     <a class="code" href="XFuXMPlayer_8cpp.html#a7">addPointer</a>(ch);
02435                                 }
02436                                 <span class="keywordflow">else</span>
02437                                 {
02438                                     temp = (ch.<a class="code" href="classXFuXMChannel.html#m3">mPointer</a> + <a class="code" href="XFuXMPlayer__internal_8h.html#a5">FP_VALUE</a>);
02439 
02440                                     <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m10">mLoop</a> == <a class="code" href="XFuXMPlayer__internal_8h.html#a21a8">LOOP_FORWARD</a>)
02441                                     {
02442                                         <a class="code" href="XFuXMPlayer_8cpp.html#a3">interpolateLinearForwardLoop8</a>(ch, val1, val2, temp);
02443                                         <a class="code" href="XFuXMPlayer_8cpp.html#a8">addPointerForwardLoop</a>(ch);
02444                                     }
02445                                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m10">mLoop</a> == <a class="code" href="XFuXMPlayer__internal_8h.html#a21a9">LOOP_PINGPONG</a>)
02446                                     {
02447                                         <a class="code" href="XFuXMPlayer_8cpp.html#a5">interpolateLinearBidirectionalLoop8</a>(ch, val1, val2, temp);
02448                                         <a class="code" href="XFuXMPlayer_8cpp.html#a9">addPointerBidirectionalLoop</a>(ch);
02449                                     }
02450                                 }
02451                             }
02452 
02453                             value = (((val2 * delta) + (val1 * (<a class="code" href="XFuXMPlayer__internal_8h.html#a5">FP_VALUE</a> - delta))) &gt;&gt; <a class="code" href="XFuXMPlayer__internal_8h.html#a4">FP_BITS</a>);
02454 
02455                             value = (INT8)(value * ch.<a class="code" href="classXFuXMChannel.html#m29">mFinalOldVolume</a>);
02456                             cLeft += ((value * (0xFF - (UINT8)ch.<a class="code" href="classXFuXMChannel.html#m39">mFinalPan</a>)) &gt;&gt; 8);
02457                             cRight += ((value * (UINT8)ch.<a class="code" href="classXFuXMChannel.html#m39">mFinalPan</a>) &gt;&gt; 8);
02458 
02459                             <span class="keywordflow">if</span> (<a class="code" href="classXFuXMPlayer.html#n20">mRamp</a> &lt; <a class="code" href="XFuXMPlayer__internal_8h.html#a7">VOLUME_RAMP_WIDTH</a>) ch.<a class="code" href="classXFuXMChannel.html#m29">mFinalOldVolume</a> += ch.<a class="code" href="classXFuXMChannel.html#m30">mFinalVolumeSpeed</a>;
02460                         }
02461                     }
02462 
02463                     <span class="keywordflow">if</span> (cLeft &lt; -128) cLeft = -128;
02464                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cLeft &gt; 127) cLeft = 127;
02465                     <span class="keywordflow">if</span> (cRight &lt; -128) cRight = -128;
02466                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cRight &gt; 127) cRight = 127;
02467 
02468                     *((INT8 *)aBuffer + (targetOffset &lt;&lt; 1)) = (INT8)(cLeft ^ <a class="code" href="classXFuXMPlayer.html#n2">mTgtXor</a>);
02469                     *((INT8 *)aBuffer + (targetOffset &lt;&lt; 1) + 1) = (INT8)(cRight ^ <a class="code" href="classXFuXMPlayer.html#n2">mTgtXor</a>);
02470 
02471                     targetOffset++;
02472                     <span class="keywordflow">if</span> (targetOffset == aTargetSamples) targetOffset = 0;
02473                     
02474                     <span class="keywordflow">if</span> (<a class="code" href="classXFuXMPlayer.html#n20">mRamp</a> &lt; <a class="code" href="XFuXMPlayer__internal_8h.html#a7">VOLUME_RAMP_WIDTH</a>) <a class="code" href="classXFuXMPlayer.html#n20">mRamp</a>++;
02475                 }
02476             }
02477             <span class="keywordflow">else</span>    <span class="comment">// 8bit mono</span>
02478             {
02479                 <span class="keywordflow">for</span> (counter = 0; counter &lt; samplesToRender; ++counter, ++index)
02480                 {
02481                     cLeft = 0;
02482 
02483                     <span class="keywordflow">for</span> (chan = startChan; chan &lt; endChan; chan++)
02484                     {
02485                         <a class="code" href="classXFuXMChannel.html">XFuXMChannel</a> &amp;ch = <a class="code" href="classXFuXMPlayer.html#n8">mChannels</a>[chan];
02486 
02487                         <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m13">mIsSample</a>)
02488                         {
02489                             delta = ch.<a class="code" href="classXFuXMChannel.html#m3">mPointer</a> &amp; (<a class="code" href="XFuXMPlayer__internal_8h.html#a5">FP_VALUE</a> - 1);
02490 
02491                             val1 = 0;
02492                             val2 = 0;
02493 
02494                             <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m5">mCurrentSample</a>.<a class="code" href="classXFuXMSample.html#m10">m16Bit</a>)
02495                             {
02496                                 val1 = *((INT16 *)ch.<a class="code" href="classXFuXMChannel.html#m6">mOffset</a> + (ch.<a class="code" href="classXFuXMChannel.html#m3">mPointer</a> &gt;&gt; <a class="code" href="XFuXMPlayer__internal_8h.html#a4">FP_BITS</a>));
02497 
02498                                 <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m10">mLoop</a> == 0)
02499                                 {
02500                                     <a class="code" href="XFuXMPlayer_8cpp.html#a2">interpolateLinear16</a>(ch, val1, val2);
02501                                     <a class="code" href="XFuXMPlayer_8cpp.html#a7">addPointer</a>(ch);
02502                                 }
02503                                 <span class="keywordflow">else</span>
02504                                 {
02505                                     temp = (ch.<a class="code" href="classXFuXMChannel.html#m3">mPointer</a> + <a class="code" href="XFuXMPlayer__internal_8h.html#a5">FP_VALUE</a>);
02506 
02507                                     <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m10">mLoop</a> == <a class="code" href="XFuXMPlayer__internal_8h.html#a21a8">LOOP_FORWARD</a>)
02508                                     {
02509                                         <a class="code" href="XFuXMPlayer_8cpp.html#a4">interpolateLinearForwardLoop16</a>(ch, val1, val2, temp);
02510                                         <a class="code" href="XFuXMPlayer_8cpp.html#a8">addPointerForwardLoop</a>(ch);
02511                                     }
02512                                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m10">mLoop</a> == <a class="code" href="XFuXMPlayer__internal_8h.html#a21a9">LOOP_PINGPONG</a>)
02513                                     {
02514                                         <a class="code" href="XFuXMPlayer_8cpp.html#a6">interpolateLinearBidirectionalLoop16</a>(ch, val1, val2, temp);
02515                                         <a class="code" href="XFuXMPlayer_8cpp.html#a9">addPointerBidirectionalLoop</a>(ch);
02516                                     }
02517                                 }
02518 
02519                                 val1 &gt;&gt;= 8;
02520                                 val2 &gt;&gt;= 8;
02521                             }
02522                             <span class="keywordflow">else</span>
02523                             {
02524                                 val1 = *((INT8 *)ch.<a class="code" href="classXFuXMChannel.html#m6">mOffset</a> + (ch.<a class="code" href="classXFuXMChannel.html#m3">mPointer</a> &gt;&gt; <a class="code" href="XFuXMPlayer__internal_8h.html#a4">FP_BITS</a>));
02525 
02526                                 <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m10">mLoop</a> == 0)
02527                                 {
02528                                     <a class="code" href="XFuXMPlayer_8cpp.html#a1">interpolateLinear8</a>(ch, val1, val2);
02529                                     <a class="code" href="XFuXMPlayer_8cpp.html#a7">addPointer</a>(ch);
02530                                 }
02531                                 <span class="keywordflow">else</span>
02532                                 {
02533                                     temp = (ch.<a class="code" href="classXFuXMChannel.html#m3">mPointer</a> + <a class="code" href="XFuXMPlayer__internal_8h.html#a5">FP_VALUE</a>);
02534 
02535                                     <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m10">mLoop</a> == <a class="code" href="XFuXMPlayer__internal_8h.html#a21a8">LOOP_FORWARD</a>)
02536                                     {
02537                                         <a class="code" href="XFuXMPlayer_8cpp.html#a3">interpolateLinearForwardLoop8</a>(ch, val1, val2, temp);
02538                                         <a class="code" href="XFuXMPlayer_8cpp.html#a8">addPointerForwardLoop</a>(ch);
02539                                     }
02540                                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ch.<a class="code" href="classXFuXMChannel.html#m10">mLoop</a> == <a class="code" href="XFuXMPlayer__internal_8h.html#a21a9">LOOP_PINGPONG</a>)
02541                                     {
02542                                         <a class="code" href="XFuXMPlayer_8cpp.html#a5">interpolateLinearBidirectionalLoop8</a>(ch, val1, val2, temp);
02543                                         <a class="code" href="XFuXMPlayer_8cpp.html#a9">addPointerBidirectionalLoop</a>(ch);
02544                                     }
02545                                 }
02546                             }
02547 
02548                             value = (((val2 * delta) + (val1 * (<a class="code" href="XFuXMPlayer__internal_8h.html#a5">FP_VALUE</a> - delta))) &gt;&gt; <a class="code" href="XFuXMPlayer__internal_8h.html#a4">FP_BITS</a>);
02549 
02550                             cLeft += (INT8)(value * ch.<a class="code" href="classXFuXMChannel.html#m29">mFinalOldVolume</a>);
02551 
02552                             <span class="keywordflow">if</span> (<a class="code" href="classXFuXMPlayer.html#n20">mRamp</a> &lt; <a class="code" href="XFuXMPlayer__internal_8h.html#a7">VOLUME_RAMP_WIDTH</a>) ch.<a class="code" href="classXFuXMChannel.html#m29">mFinalOldVolume</a> += ch.<a class="code" href="classXFuXMChannel.html#m30">mFinalVolumeSpeed</a>;
02553                         }
02554                     }
02555 
02556                     <span class="keywordflow">if</span> (cLeft &gt; 127) cLeft = 127;
02557                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cLeft &lt; -128) cLeft = -128;
02558 
02559                     *((INT8 *)aBuffer + targetOffset) = (INT8)(cLeft ^ <a class="code" href="classXFuXMPlayer.html#n2">mTgtXor</a>);
02560 
02561                     targetOffset++;
02562                     <span class="keywordflow">if</span> (targetOffset == aTargetSamples) targetOffset = 0;
02563                     
02564                     <span class="keywordflow">if</span> (<a class="code" href="classXFuXMPlayer.html#n20">mRamp</a> &lt; <a class="code" href="XFuXMPlayer__internal_8h.html#a7">VOLUME_RAMP_WIDTH</a>) <a class="code" href="classXFuXMPlayer.html#n20">mRamp</a>++;
02565                 }
02566             }
02567         }
02568 
02569         <a class="code" href="classXFuXMPlayer.html#n18">mSamplePointer</a> += samplesToRender;
02570     }
02571 
02572     <a class="code" href="classXFuXMPlayer.html#n27">mTotalTicks</a> += aSamples;
02573 
02574     <span class="keywordflow">return</span> 1;
02575 }
02576 
02577 <span class="comment">// For MSVC</span>
02578 <span class="preprocessor">#pragma warning(default:4244)</span>
02579 <span class="preprocessor"></span>
02580 
<a name="l02581"></a><a class="code" href="classXFuXMPlayer.html#b9">02581</a> <a class="code" href="classXFuXMPlayer.html#b9">XFuXMPlayer::XFuXMPlayer</a>(FLOAT32 aSamplingRate, UINT32 aFlags)
02582 {
02583     <a class="code" href="classXFuXMPlayer.html#n0">mSamplingRate</a> = aSamplingRate;
02584     <a class="code" href="classXFuXMPlayer.html#n1">mFlags</a> = aFlags;
02585 
02586     <a class="code" href="classXFuXMPlayer.html#n2">mTgtXor</a> = 0;
02587     <span class="keywordflow">if</span> (!(<a class="code" href="classXFuXMPlayer.html#n1">mFlags</a> &amp; XFCAUDIO_SIGNED))
02588     {
02589         <span class="keywordflow">if</span> (<a class="code" href="classXFuXMPlayer.html#n1">mFlags</a> &amp; XFCAUDIO_16BIT) <a class="code" href="classXFuXMPlayer.html#n2">mTgtXor</a> = -32768;
02590         <span class="keywordflow">else</span> <a class="code" href="classXFuXMPlayer.html#n2">mTgtXor</a> = -128;
02591     }
02592 
02593     <span class="comment">/* Sinewave table */</span>
02594     <a class="code" href="classXFuXMPlayer.html#n9">mSineWaveTable</a>[0] = 0;
02595     <a class="code" href="classXFuXMPlayer.html#n9">mSineWaveTable</a>[1] = 24;
02596     <a class="code" href="classXFuXMPlayer.html#n9">mSineWaveTable</a>[2] = 49;
02597     <a class="code" href="classXFuXMPlayer.html#n9">mSineWaveTable</a>[3] = 74;
02598     <a class="code" href="classXFuXMPlayer.html#n9">mSineWaveTable</a>[4] = 97;
02599     <a class="code" href="classXFuXMPlayer.html#n9">mSineWaveTable</a>[5] = 120;
02600     <a class="code" href="classXFuXMPlayer.html#n9">mSineWaveTable</a>[6] = 141;
02601     <a class="code" href="classXFuXMPlayer.html#n9">mSineWaveTable</a>[7] = 161;
02602     <a class="code" href="classXFuXMPlayer.html#n9">mSineWaveTable</a>[8] = 180;
02603     <a class="code" href="classXFuXMPlayer.html#n9">mSineWaveTable</a>[9] = 197;
02604     <a class="code" href="classXFuXMPlayer.html#n9">mSineWaveTable</a>[10] = 212;
02605     <a class="code" href="classXFuXMPlayer.html#n9">mSineWaveTable</a>[11] = 224;
02606     <a class="code" href="classXFuXMPlayer.html#n9">mSineWaveTable</a>[12] = 235;
02607     <a class="code" href="classXFuXMPlayer.html#n9">mSineWaveTable</a>[13] = 244;
02608     <a class="code" href="classXFuXMPlayer.html#n9">mSineWaveTable</a>[14] = 250;
02609     <a class="code" href="classXFuXMPlayer.html#n9">mSineWaveTable</a>[15] = 253;
02610     <a class="code" href="classXFuXMPlayer.html#n9">mSineWaveTable</a>[16] = 255;
02611     <a class="code" href="classXFuXMPlayer.html#n9">mSineWaveTable</a>[17] = 253;
02612     <a class="code" href="classXFuXMPlayer.html#n9">mSineWaveTable</a>[18] = 250;
02613     <a class="code" href="classXFuXMPlayer.html#n9">mSineWaveTable</a>[19] = 244;
02614     <a class="code" href="classXFuXMPlayer.html#n9">mSineWaveTable</a>[20] = 235;
02615     <a class="code" href="classXFuXMPlayer.html#n9">mSineWaveTable</a>[21] = 224;
02616     <a class="code" href="classXFuXMPlayer.html#n9">mSineWaveTable</a>[22] = 212;
02617     <a class="code" href="classXFuXMPlayer.html#n9">mSineWaveTable</a>[23] = 197;
02618     <a class="code" href="classXFuXMPlayer.html#n9">mSineWaveTable</a>[24] = 180;
02619     <a class="code" href="classXFuXMPlayer.html#n9">mSineWaveTable</a>[25] = 161;
02620     <a class="code" href="classXFuXMPlayer.html#n9">mSineWaveTable</a>[26] = 141;
02621     <a class="code" href="classXFuXMPlayer.html#n9">mSineWaveTable</a>[27] = 120;
02622     <a class="code" href="classXFuXMPlayer.html#n9">mSineWaveTable</a>[28] = 97;
02623     <a class="code" href="classXFuXMPlayer.html#n9">mSineWaveTable</a>[29] = 74;
02624     <a class="code" href="classXFuXMPlayer.html#n9">mSineWaveTable</a>[30] = 49;
02625     <a class="code" href="classXFuXMPlayer.html#n9">mSineWaveTable</a>[31] = 24;
02626 
02627     INT i;
02628 
02629     <span class="keywordflow">for</span> (i = 32; i &lt; 64; i++)
02630     {
02631         <a class="code" href="classXFuXMPlayer.html#n9">mSineWaveTable</a>[i] = (INT16)-<a class="code" href="classXFuXMPlayer.html#n9">mSineWaveTable</a>[i - 32];
02632     }
02633 
02634     <span class="comment">/* Squarewave table */</span>
02635     <span class="keywordflow">for</span> (i = 0; i &lt; 32; i++) <a class="code" href="classXFuXMPlayer.html#n10">mSquareWaveTable</a>[i] = -255;
02636     <span class="keywordflow">for</span> (i = 32; i &lt; 64; i++) <a class="code" href="classXFuXMPlayer.html#n10">mSquareWaveTable</a>[i] = 255;
02637 
02638     <span class="comment">/* Ramp up/down tables */</span>
02639     <span class="keywordflow">for</span> (i = 0; i &lt; 32; i++)
02640     {
02641         <a class="code" href="classXFuXMPlayer.html#n11">mRampUpTable</a>[i] = (INT16)(255.0f - (FLOAT32)i * (510.0f / 32.0f));
02642         <a class="code" href="classXFuXMPlayer.html#n11">mRampUpTable</a>[i + 32] = (INT16)(255.0f - (FLOAT32)i * (510.0f / 32.0f));
02643 
02644         <a class="code" href="classXFuXMPlayer.html#n12">mRampDownTable</a>[i] = (INT16)(-255.0f + (FLOAT32)i * (510.0f / 32.0f));
02645         <a class="code" href="classXFuXMPlayer.html#n12">mRampDownTable</a>[i + 32] =
02646             (INT16)(-255.0f + (FLOAT32)i * (510.0f / 32.0f));
02647     }
02648 
02649     <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m0">mOrderTable</a> = NULL;
02650     <a class="code" href="classXFuXMPlayer.html#n5">mXMPatternHeaders</a> = NULL;
02651     <a class="code" href="classXFuXMPlayer.html#n6">mPatternData</a> = NULL;
02652     <a class="code" href="classXFuXMPlayer.html#n7">mInstruments</a> = NULL;
02653     <a class="code" href="classXFuXMPlayer.html#n8">mChannels</a> = NULL;
02654 
02655     <a class="code" href="classXFuXMPlayer.html#n29">mEventHandlers</a> = NULL;
02656 }
02657 
02658 
<a name="l02659"></a><a class="code" href="classXFuXMPlayer.html#a8">02659</a> <a class="code" href="classXFuXMPlayer.html#a8">XFuXMPlayer::~XFuXMPlayer</a>()
02660 {
02661     INT i, j;
02662 
02663     <span class="keyword">delete</span>[] <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m0">mOrderTable</a>;
02664 
02665     <span class="keyword">delete</span>[] <a class="code" href="classXFuXMPlayer.html#n5">mXMPatternHeaders</a>;
02666 
02667     <span class="keywordflow">if</span> (<a class="code" href="classXFuXMPlayer.html#n6">mPatternData</a> != NULL)
02668     {
02669         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m3">mNbPatterns</a>; i++)
02670         {
02671             <span class="keyword">delete</span>[] <a class="code" href="classXFuXMPlayer.html#n6">mPatternData</a>[i].<a class="code" href="classXFuXMPattern.html#m0">mData</a>;
02672             <span class="keyword">delete</span>[] <a class="code" href="classXFuXMPlayer.html#n6">mPatternData</a>[i].<a class="code" href="classXFuXMPattern.html#m1">mRows</a>;
02673         }
02674 
02675         <span class="keyword">delete</span>[] <a class="code" href="classXFuXMPlayer.html#n6">mPatternData</a>;
02676     }
02677 
02678     <span class="keywordflow">if</span> (<a class="code" href="classXFuXMPlayer.html#n7">mInstruments</a> != NULL)
02679     {
02680         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="classXFuXMPlayer.html#n4">mSong</a>.<a class="code" href="classXFuXMSong.html#m5">mNbInstruments</a>; i++)
02681         {
02682             <a class="code" href="classXFuXMInstrument.html">XFuXMInstrument</a> &amp;ins = <a class="code" href="classXFuXMPlayer.html#n7">mInstruments</a>[i];
02683 
02684             <span class="keywordflow">if</span> (ins.<a class="code" href="classXFuXMInstrument.html#m1">mSamples</a> != NULL)
02685             {
02686                 <span class="keywordflow">for</span> (j = 0; j &lt; ins.<a class="code" href="classXFuXMInstrument.html#m0">mNbSamples</a>; j++)
02687                 {
02688                     <span class="keyword">delete</span>[] (INT8 *)ins.<a class="code" href="classXFuXMInstrument.html#m1">mSamples</a>[j].<a class="code" href="classXFuXMSample.html#m4">mOffset</a>;
02689                 }
02690 
02691                 <span class="keyword">delete</span>[] ins.<a class="code" href="classXFuXMInstrument.html#m1">mSamples</a>;
02692             }
02693         }
02694 
02695         <span class="keyword">delete</span>[] <a class="code" href="classXFuXMPlayer.html#n7">mInstruments</a>;
02696     }
02697 
02698     <span class="keyword">delete</span>[] <a class="code" href="classXFuXMPlayer.html#n8">mChannels</a>;
02699 
02700     <span class="keyword">delete</span> <a class="code" href="classXFuXMPlayer.html#n29">mEventHandlers</a>;
02701 }
02702 
02703 
<a name="l02704"></a><a class="code" href="classXFuXMPlayer.html#d0">02704</a> <a class="code" href="classXFuXMPlayer.html">XFuXMPlayer</a> * <a class="code" href="classXFuXMPlayer.html#d0">XFuXMPlayer::create</a>(<span class="keyword">const</span> CHAR *aTunename, FLOAT32 aSampleRate, UINT32 aFlags)
02705 {
02706     XFcFile *textout = NULL;
02707 
02708     <a class="code" href="classXFuXMPlayer.html">XFuXMPlayer</a> *pl = <span class="keyword">new</span> <a class="code" href="classXFuXMPlayer.html#b9">XFuXMPlayer</a>(aSampleRate, aFlags);
02709 
02710     <span class="keywordflow">if</span> (pl != NULL)
02711     {
02712         pl-&gt;initialize(aSampleRate, aFlags, 1.0, 0.5, 0);
02713 
02714         pl-&gt;<a class="code" href="classXFuXMPlayer.html#n29">mEventHandlers</a> = <span class="keyword">new</span> XFcLinkedList&lt;XFuXMPlayerEventHandlerSlot&gt;();
02715 
02716         <span class="keywordflow">if</span> (pl-&gt;<a class="code" href="classXFuXMPlayer.html#n29">mEventHandlers</a> == NULL)
02717         {
02718             <span class="keyword">delete</span> pl;
02719             <span class="keywordflow">return</span> NULL;
02720         }
02721 
02722 <span class="preprocessor">#ifdef OUTPUT_XM_INFO</span>
02723 <span class="preprocessor"></span>        <a class="code" href="classXFuXMFormatAtom.html">XFuXMFormatAtom</a> ta;
02724 
02725         textout = XFcFile::open(<span class="stringliteral">"xmoutput.txt"</span>,<span class="stringliteral">"wt"</span>);
02726 <span class="preprocessor">#endif</span>
02727 <span class="preprocessor"></span>
02728         <span class="keywordflow">if</span> (pl-&gt;<a class="code" href="classXFuXMPlayer.html#b0">loadXM</a>(aTunename, textout) != 0)
02729         {
02730             <span class="comment">// file not found</span>
02731             <span class="keyword">delete</span> pl;
02732             <span class="keywordflow">return</span> NULL;
02733         }
02734 
02735 <span class="preprocessor">#ifdef OUTPUT_XM_INFO</span>
02736 <span class="preprocessor"></span>        pl-&gt;<a class="code" href="classXFuXMPlayer.html#b2">dumpSongParameters</a>(textout);
02737 
02738         pl-&gt;<a class="code" href="classXFuXMPlayer.html#n15">mPatternNb</a> = -1;
02739         INT i;
02740         <span class="keywordflow">for</span> (i = 0; i &lt; pl-&gt;<a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m9">mNbPatterns</a>; i++)
02741         {
02742             pl-&gt;<a class="code" href="classXFuXMPlayer.html#n15">mPatternNb</a>++;
02743             <span class="keywordflow">if</span> (pl-&gt;<a class="code" href="classXFuXMPlayer.html#n5">mXMPatternHeaders</a>[i].<a class="code" href="classXFuXMFormatPatternHeader.html#m3">mSize</a> &gt; 0)
02744             {
02745                 <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(textout, <span class="stringliteral">"* Pattern: %02X\n"</span>, pl-&gt;<a class="code" href="classXFuXMPlayer.html#n15">mPatternNb</a>);
02746                 {
02747                     INT row, channel;
02748                     pl-&gt;<a class="code" href="classXFuXMPlayer.html#n13">mPpoint</a> = 0; 
02749                     <span class="keywordflow">for</span> (row = 0; row &lt; pl-&gt;<a class="code" href="classXFuXMPlayer.html#n5">mXMPatternHeaders</a>[i].<a class="code" href="classXFuXMFormatPatternHeader.html#m2">mNbRows</a>; row++)
02750                     {
02751                         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(textout, <span class="stringliteral">"%02X: "</span>, row);
02752                         <span class="keywordflow">for</span> (channel = 0; channel &lt; pl-&gt;<a class="code" href="classXFuXMPlayer.html#n3">mXMHeader</a>.<a class="code" href="classXFuXMFormatHeader.html#m8">mNbChannels</a>; channel++)
02753                         {
02754                             ta = pl-&gt;<a class="code" href="classXFuXMPlayer.html#b1">getAtom</a>();
02755                         
02756                             <span class="keywordflow">if</span> (ta.<a class="code" href="classXFuXMFormatAtom.html#m0">mNote</a> == 0)
02757                             {
02758                                 <span class="keywordflow">if</span> (ta.<a class="code" href="classXFuXMFormatAtom.html#m2">mVolume</a> != 0)
02759                                     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(textout, <span class="stringliteral">"--- %02X %02X %1X%02X ; "</span>,
02760                                                ta.<a class="code" href="classXFuXMFormatAtom.html#m1">mInstrumentNb</a>, ta.<a class="code" href="classXFuXMFormatAtom.html#m2">mVolume</a> - 0x10,
02761                                                ta.<a class="code" href="classXFuXMFormatAtom.html#m3">mEffectType</a>, ta.<a class="code" href="classXFuXMFormatAtom.html#m4">mEffectValue</a>);
02762                                 <span class="keywordflow">else</span>
02763                                     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(textout, <span class="stringliteral">"--- %02X -- %1X%02X ; "</span>,
02764                                                ta.<a class="code" href="classXFuXMFormatAtom.html#m1">mInstrumentNb</a>, ta.<a class="code" href="classXFuXMFormatAtom.html#m3">mEffectType</a>,
02765                                                ta.<a class="code" href="classXFuXMFormatAtom.html#m4">mEffectValue</a>);
02766                             }
02767                             <span class="keywordflow">else</span>
02768                             {
02769                                 <span class="keywordflow">if</span> (ta.<a class="code" href="classXFuXMFormatAtom.html#m2">mVolume</a> != 0)
02770                                     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(textout,
02771                                                <span class="stringliteral">"%s%1d %02X %02X %1X%02X ; "</span>,
02772                                                notes[(ta.<a class="code" href="classXFuXMFormatAtom.html#m0">mNote</a> - 1) % 12],
02773                                                (INT)((ta.<a class="code" href="classXFuXMFormatAtom.html#m0">mNote</a> - 1) / 12),
02774                                                ta.<a class="code" href="classXFuXMFormatAtom.html#m1">mInstrumentNb</a>, ta.<a class="code" href="classXFuXMFormatAtom.html#m2">mVolume</a> - 0x10,
02775                                                ta.<a class="code" href="classXFuXMFormatAtom.html#m3">mEffectType</a>, ta.<a class="code" href="classXFuXMFormatAtom.html#m4">mEffectValue</a>);
02776                                 <span class="keywordflow">else</span>
02777                                     <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(textout, <span class="stringliteral">"%s%1d %02X -- %1X%02X ; "</span>,
02778                                                notes[(ta.<a class="code" href="classXFuXMFormatAtom.html#m0">mNote</a> - 1) % 12],
02779                                                (INT)((ta.<a class="code" href="classXFuXMFormatAtom.html#m0">mNote</a> - 1) / 12),
02780                                                ta.<a class="code" href="classXFuXMFormatAtom.html#m1">mInstrumentNb</a>, ta.<a class="code" href="classXFuXMFormatAtom.html#m3">mEffectType</a>,
02781                                                ta.<a class="code" href="classXFuXMFormatAtom.html#m4">mEffectValue</a>);
02782                             }
02783                         }
02784 
02785                         <a class="code" href="classXFuXMPlayer.html#b8">debugPrint</a>(textout, <span class="stringliteral">"\n"</span>);
02786                     }
02787                 }
02788             }
02789         }
02790 
02791         <span class="keywordflow">if</span> (textout != NULL) textout-&gt;close();
02792 <span class="preprocessor">#endif</span>
02793 <span class="preprocessor"></span>
02794         pl-&gt;<a class="code" href="classXFuXMPlayer.html#a0">initSong</a>(0);
02795         pl-&gt;<a class="code" href="classXFuXMPlayer.html#n28">mVolumeRampDivOpt</a> = REALf(1.0f / VOLUME_RAMP_WIDTH);
02796     }
02797 
02798     <span class="keywordflow">return</span> pl;
02799 }
02800 
</pre></div><br clear=all>
<center><table border=0 cellpadding=0 cellspacing=0>
<tr><td colspan=5><img src="paleblue.gif" width=600 height=1></td></tr>
<tr><td>&nbsp;&nbsp;&nbsp;</td><td><a href="http://www.fathammer.com/"><img src="logo.gif" border=0></a></td>
<td valign=bottom><center><font face="arial, helvetica" size="-2" color="#003366">X-Forge Documentation<br>Confidential<br>Copyright &copy; 2002-2003 Fathammer</font></center></td><td>&nbsp;&nbsp;&nbsp;</td>
<td valign=bottom><center><font face="arial, helvetica" size="-2" color="#003366">Documentation generated<br>with <a href="http://www.doxygen.org/index.html">doxygen</a><br>by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a></font></center></td></tr></table>
</body></html>
