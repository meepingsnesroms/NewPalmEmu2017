<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>XFuInetNetwork.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>XFuInetNetwork.cpp</h1><a href="XFuInetNetwork_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*!</span>
00002 <span class="comment"> * \file</span>
00003 <span class="comment"> * X-Forge Engine &lt;br&gt;</span>
00004 <span class="comment"> * Copyright 2000-2002 Fathammer Ltd</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> * \brief Default implementation for a inet communication manager.</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * $Id: XFuInetNetwork.cpp,v 1.3 2003/10/08 11:08:34 slehti Exp $</span>
00009 <span class="comment"> * $Date: 2003/10/08 11:08:34 $</span>
00010 <span class="comment"> * $Revision: 1.3 $</span>
00011 <span class="comment"> */</span>
00012 
00013 <span class="preprocessor">#include &lt;xforge.h&gt;</span>
00014 
00015 <span class="preprocessor">#include &lt;xfcore/net/XFcInetHandler.h&gt;</span>
00016 <span class="preprocessor">#include &lt;xfcore/net/XFcInetClientWin.h&gt;</span>
00017 <span class="preprocessor">#include &lt;xfcore/net/XFcObjectDataFrame.h&gt;</span>
00018 <span class="preprocessor">#include &lt;xfcore/net/XFcCommunicationScheduler.h&gt;</span>
00019 <span class="preprocessor">#include &lt;xfcore/net/XFcCommunicationConstants.h&gt;</span>
00020 <span class="preprocessor">#include &lt;xfcore/net/socket/XFcSocketConstants.h&gt;</span>
00021 <span class="preprocessor">#include &lt;xfcore/net/XFcUnknownSender.h&gt;</span>
00022 <span class="preprocessor">#include &lt;xfcore/net/XFcClientLost.h&gt;</span>
00023 <span class="preprocessor">#include &lt;xfcore/net/XFcDataReceiver.h&gt;</span>
00024 <span class="preprocessor">#include &lt;xfcore/net/XFcObjectDataFrame.h&gt;</span>
00025 <span class="preprocessor">#include &lt;xfcore/net/socket/XFcInetHostEntry.h&gt;</span>
00026 <span class="preprocessor">#include &lt;xfcore/net/socket/XFcInetHostResolver.h&gt;</span>
00027 <span class="preprocessor">#include &lt;xfcore/net/socket/XFcInetAdvertiser.h&gt;</span>
00028 <span class="preprocessor">#include &lt;xfcore/net/XFcUdpEngine.h&gt;</span>
00029 <span class="preprocessor">#include &lt;xfcore/net/socket/XFcInetCommService.h&gt;</span>
00030 
00031 <span class="preprocessor">#include &lt;<a class="code" href="XFuSerializable_8h.html">xfutil/XFuSerializable.h</a>&gt;</span>
00032 <span class="preprocessor">#include &lt;<a class="code" href="XFuNetwork_8h.html">xfutil/XFuNetwork.h</a>&gt;</span>
00033 <span class="preprocessor">#include &lt;<a class="code" href="XFuNetworkEventHandler_8h.html">xfutil/XFuNetworkEventHandler.h</a>&gt;</span>
00034 <span class="preprocessor">#include &lt;<a class="code" href="XFuInetNetwork_8h.html">xfutil/XFuInetNetwork.h</a>&gt;</span>
00035 
00036 <span class="comment"></span>
00037 <span class="comment">//! Static constructor</span>
<a name="l00038"></a><a class="code" href="classXFuInetNetwork.html#d0">00038</a> <span class="comment"></span><a class="code" href="classXFuInetNetwork.html">XFuInetNetwork</a> * <a class="code" href="classXFuInetNetwork.html#d0">XFuInetNetwork::create</a>()
00039 {
00040     <a class="code" href="classXFuInetNetwork.html">XFuInetNetwork</a> * manager = <span class="keyword">new</span> <a class="code" href="classXFuInetNetwork.html">XFuInetNetwork</a>;
00041     <span class="keywordflow">if</span> (manager != NULL &amp;&amp; !manager-&gt;<a class="code" href="classXFuInetNetwork.html#b3">init</a>())
00042     {
00043         <span class="keyword">delete</span> manager;
00044         <span class="keywordflow">return</span> NULL;
00045     }
00046     <span class="keywordflow">return</span> manager;
00047 }
00048 
00049 <span class="comment"></span>
00050 <span class="comment">//! Protected constructor</span>
<a name="l00051"></a><a class="code" href="classXFuInetNetwork.html#b0">00051</a> <span class="comment"></span><a class="code" href="classXFuInetNetwork.html#b0">XFuInetNetwork::XFuInetNetwork</a>()
00052 {
00053     <a class="code" href="classXFuInetNetwork.html#o0">mNetworkEventHandlers</a> = NULL;
00054     <a class="code" href="classXFuInetNetwork.html#o1">mCommunicationScheduler</a> = NULL;
00055     <a class="code" href="classXFuInetNetwork.html#o2">mCommunicationHandler</a> = NULL;
00056 
00057     <a class="code" href="classXFuInetNetwork.html#o8">mAdvertiserStatus</a> = 0;
00058 
00059     <a class="code" href="classXFuInetNetwork.html#o10">mHostResolver</a> = NULL;
00060     <a class="code" href="classXFuInetNetwork.html#o6">mMaxClients</a> = -1;
00061     <a class="code" href="classXFuInetNetwork.html#o7">mAcceptGameToken</a> = 0;
00062 
00063     <a class="code" href="classXFuInetNetwork.html#o4">mCommunicationHandlerId</a> = -1;
00064 
00065     <a class="code" href="classXFuInetNetwork.html#o11">mCommService</a> = NULL;
00066 
00067 }
00068 
00069 <span class="comment"></span>
00070 <span class="comment">//! Destructor</span>
<a name="l00071"></a><a class="code" href="classXFuInetNetwork.html#a0">00071</a> <span class="comment"></span><a class="code" href="classXFuInetNetwork.html#a0">XFuInetNetwork::~XFuInetNetwork</a>()
00072 {
00073     <a class="code" href="classXFuInetNetwork.html#a6">closeService</a>();
00074     <a class="code" href="classXFuInetNetwork.html#b2">deleteAllClients</a>();
00075     <a class="code" href="classXFuInetNetwork.html#a27">removeAllEventHandlers</a>();
00076 
00077     <span class="keyword">delete</span> <a class="code" href="classXFuInetNetwork.html#o10">mHostResolver</a>;
00078     <span class="keyword">delete</span> <a class="code" href="classXFuInetNetwork.html#o0">mNetworkEventHandlers</a>;
00079     <span class="keyword">delete</span> <a class="code" href="classXFuInetNetwork.html#o2">mCommunicationHandler</a>;
00080     <span class="keyword">delete</span> <a class="code" href="classXFuInetNetwork.html#o11">mCommService</a>;
00081 
00082 }
00083 
00084 <span class="comment"></span>
00085 <span class="comment">//! Initializes default communication manager specific items that would normally be in the constructor</span>
<a name="l00086"></a><a class="code" href="classXFuInetNetwork.html#b3">00086</a> <span class="comment"></span>INT <a class="code" href="classXFuInetNetwork.html#b3">XFuInetNetwork::init</a>()
00087 {
00088 
00089     <a class="code" href="classXFuInetNetwork.html#o1">mCommunicationScheduler</a> = (XFcCommunicationScheduler *)XFcCore::getCommunicationScheduler();
00090     <span class="keywordflow">if</span> (<a class="code" href="classXFuInetNetwork.html#o0">mNetworkEventHandlers</a> == NULL)
00091         <a class="code" href="classXFuInetNetwork.html#o0">mNetworkEventHandlers</a> = <a class="code" href="classXFuDynamicArray.html#d0">XFuDynamicArray&lt;XFuNetworkEventHandler*&gt;::create</a>(5);
00092 
00093     <span class="keywordflow">if</span> (<a class="code" href="classXFuInetNetwork.html#o1">mCommunicationScheduler</a> == NULL ||
00094         <a class="code" href="classXFuInetNetwork.html#o0">mNetworkEventHandlers</a> == NULL) <span class="keywordflow">return</span> 0;
00095 
00096     <span class="keywordflow">return</span> 1;
00097 
00098 }
00099 
00100 <span class="comment"></span>
00101 <span class="comment">//! Runs the communication scheduler</span>
<a name="l00102"></a><a class="code" href="classXFuInetNetwork.html#a2">00102</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="classXFuInetNetwork.html#a2">XFuInetNetwork::runCommunicationScheduler</a>()
00103 {
00104     <a class="code" href="classXFuInetNetwork.html#o1">mCommunicationScheduler</a>-&gt;runScheduler();
00105 }
00106 
00107 <span class="comment"></span>
00108 <span class="comment">//! Resets the communication manager</span>
<a name="l00109"></a><a class="code" href="classXFuInetNetwork.html#a1">00109</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="classXFuInetNetwork.html#a1">XFuInetNetwork::reset</a>()
00110 {
00111     <a class="code" href="classXFuInetNetwork.html#a6">closeService</a>();
00112     <a class="code" href="classXFuInetNetwork.html#a10">removeAllClients</a>();
00113     <a class="code" href="classXFuInetNetwork.html#a27">removeAllEventHandlers</a>();
00114     <a class="code" href="classXFuInetNetwork.html#o6">mMaxClients</a> = -1;
00115     <a class="code" href="classXFuInetNetwork.html#o7">mAcceptGameToken</a> = 0;
00116     <a class="code" href="classXFuInetNetwork.html#b3">init</a>();
00117 }
00118 
00119 
00120 <span class="comment"></span>
00121 <span class="comment">//! Enables the inet communication handler and opens it for service. Use port 0 for random port.</span>
00122 <span class="comment">//! Default speed is one of the XFCNET_CONNECTION_SPEED values (see XFcClientCommWin.h)</span>
<a name="l00123"></a><a class="code" href="classXFuInetNetwork.html#a5">00123</a> <span class="comment"></span>INT <a class="code" href="classXFuInetNetwork.html#a5">XFuInetNetwork::enableService</a>(INT32 aMaxClients, UINT16 aPort, INT32 aDefaultSpeed)
00124 {
00125     <a class="code" href="classXFuInetNetwork.html#a6">closeService</a>();
00126     <a class="code" href="classXFuInetNetwork.html#a10">removeAllClients</a>();
00127     
00128 
00129     <a class="code" href="classXFuInetNetwork.html#o2">mCommunicationHandler</a> = XFcInetHandler::create();
00130     <a class="code" href="classXFuInetNetwork.html#o11">mCommService</a> = XFcInetCommService::create();
00131 
00132     <span class="keywordflow">if</span> (<a class="code" href="classXFuInetNetwork.html#o2">mCommunicationHandler</a> &amp;&amp; <a class="code" href="classXFuInetNetwork.html#o11">mCommService</a>)
00133     {
00134 
00135         <span class="keywordflow">if</span> (aPort != 0)
00136             <a class="code" href="classXFuInetNetwork.html#o2">mCommunicationHandler</a>-&gt;setPort(aPort);
00137 
00138         <a class="code" href="classXFuInetNetwork.html#o9">mGamePort</a> = aPort;
00139 
00140         <a class="code" href="classXFuInetNetwork.html#o2">mCommunicationHandler</a>-&gt;setConnectionSpeed(aDefaultSpeed);
00141         <a class="code" href="classXFuInetNetwork.html#o2">mCommunicationHandler</a>-&gt;setUnknownSenderHandler(<span class="keyword">this</span>);
00142         <a class="code" href="classXFuInetNetwork.html#o2">mCommunicationHandler</a>-&gt;setClientLost(<span class="keyword">this</span>);
00143         <a class="code" href="classXFuInetNetwork.html#o2">mCommunicationHandler</a>-&gt;setMaxClientCount(aMaxClients);
00144 
00145         <a class="code" href="classXFuInetNetwork.html#b1">initClients</a>(aMaxClients);
00146 
00147         <a class="code" href="classXFuInetNetwork.html#o4">mCommunicationHandlerId</a> = <a class="code" href="classXFuInetNetwork.html#o1">mCommunicationScheduler</a>-&gt;addCommunicationHandler(mCommunicationHandler);
00148         <a class="code" href="classXFuInetNetwork.html#o2">mCommunicationHandler</a>-&gt;openService();
00149 
00150         <span class="keywordflow">if</span> (<a class="code" href="classXFuInetNetwork.html#o2">mCommunicationHandler</a>-&gt;getLastError() != XFcUdpEngine::XFCNET_UDP_CLOSE)
00151             <span class="keywordflow">return</span> 1;
00152     }
00153     <span class="keywordflow">return</span> 0;
00154 }
00155 
00156 <span class="comment"></span>
00157 <span class="comment">//! Closes the currently active service (communication handler)</span>
<a name="l00158"></a><a class="code" href="classXFuInetNetwork.html#a6">00158</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="classXFuInetNetwork.html#a6">XFuInetNetwork::closeService</a>()
00159 {
00160 
00161     <a class="code" href="classXFuInetNetwork.html#a29">stopAdvertiser</a>();
00162     <a class="code" href="classXFuInetNetwork.html#a31">stopServerDiscovery</a>();
00163 
00164     <span class="keywordflow">if</span> (mCommunicationHandler)
00165     {
00166         <a class="code" href="classXFuInetNetwork.html#o2">mCommunicationHandler</a>-&gt;closeService();
00167         <a class="code" href="classXFuInetNetwork.html#o1">mCommunicationScheduler</a>-&gt;removeCommunicationHandler(mCommunicationHandlerId);
00168         <span class="keyword">delete</span> <a class="code" href="classXFuInetNetwork.html#o2">mCommunicationHandler</a>;
00169         <a class="code" href="classXFuInetNetwork.html#o2">mCommunicationHandler</a> = NULL;
00170     }
00171 
00172     <span class="keyword">delete</span> <a class="code" href="classXFuInetNetwork.html#o10">mHostResolver</a>;
00173     <a class="code" href="classXFuInetNetwork.html#o10">mHostResolver</a> = NULL;
00174     <span class="keyword">delete</span> <a class="code" href="classXFuInetNetwork.html#o11">mCommService</a>;
00175     <a class="code" href="classXFuInetNetwork.html#o11">mCommService</a> = NULL;
00176 
00177 }
00178 
00179 <span class="comment"></span>
00180 <span class="comment">//! Returns the game token that is checked before new clients are allowed to connect</span>
<a name="l00181"></a><a class="code" href="classXFuInetNetwork.html#a11">00181</a> <span class="comment"></span>UINT32 <a class="code" href="classXFuInetNetwork.html#a11">XFuInetNetwork::getAcceptGameToken</a>()
00182 {
00183     <span class="keywordflow">return</span> <a class="code" href="classXFuInetNetwork.html#o7">mAcceptGameToken</a>;
00184 }
00185 <span class="comment"></span>
00186 <span class="comment">//! Sets the game token that is checked before new clients are allowed to connect</span>
<a name="l00187"></a><a class="code" href="classXFuInetNetwork.html#a12">00187</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="classXFuInetNetwork.html#a12">XFuInetNetwork::setAcceptGameToken</a>(UINT32 aAcceptGameToken)
00188 {
00189     <a class="code" href="classXFuInetNetwork.html#o7">mAcceptGameToken</a> = aAcceptGameToken;
00190 }
00191 
00192 <span class="comment"></span>
00193 <span class="comment">//! Sends a game connection packet</span>
<a name="l00194"></a><a class="code" href="classXFuInetNetwork.html#a13">00194</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="classXFuInetNetwork.html#a13">XFuInetNetwork::sendGameConnectPacket</a>(INT32 aClientId, UINT32 aGameToken)
00195 {
00196     XFcObjectDataFrame *frame = <a class="code" href="classXFuInetNetwork.html#a20">getPacketFrame</a>(aClientId, XFCNET_NONGUARANTEED);
00197     <span class="keywordflow">if</span> (frame)
00198     {
00199 
00200         frame-&gt;setReceiverId(0);
00201         <span class="keywordtype">void</span> *buffer = frame-&gt;lock();
00202         <span class="keywordflow">if</span> (buffer)
00203         {
00204             memcpy(buffer, &amp;aGameToken, 4);
00205             frame-&gt;setPacketSize(4);
00206         }
00207         frame-&gt;unlock();
00208     }
00209 
00210 }
00211 
00212 <span class="comment"></span>
00213 <span class="comment">//! Reserves memory for the client array (mClients) and initializes all the client</span>
00214 <span class="comment">//! pointers to NULL</span>
<a name="l00215"></a><a class="code" href="classXFuInetNetwork.html#b1">00215</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="classXFuInetNetwork.html#b1">XFuInetNetwork::initClients</a>(INT32 aMaxClients)
00216 {
00217     <a class="code" href="classXFuInetNetwork.html#o6">mMaxClients</a> = aMaxClients;
00218 }
00219 
00220 <span class="comment"></span>
00221 <span class="comment">//! Cleanup of all clients</span>
<a name="l00222"></a><a class="code" href="classXFuInetNetwork.html#b2">00222</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="classXFuInetNetwork.html#b2">XFuInetNetwork::deleteAllClients</a>()
00223 {
00224 
00225     XFcHashtableIterator&lt;UINT32, XFcInetClientWin *&gt; itClient;
00226 
00227      <span class="keywordflow">while</span> (<a class="code" href="classXFuInetNetwork.html#o5">mClients</a>.size() &gt; 0)
00228      {
00229          itClient = <a class="code" href="classXFuInetNetwork.html#o5">mClients</a>.begin();
00230          INT32 key = itClient.getKey();
00231          XFcClientCommWin *base_client = <a class="code" href="classXFuInetNetwork.html#a7">getClient</a>(key);
00232          <a class="code" href="classXFuInetNetwork.html#o1">mCommunicationScheduler</a>-&gt;removeClient(key);
00233          base_client-&gt;deinitializeClient();
00234          <a class="code" href="classXFuInetNetwork.html#o5">mClients</a>.remove(key);
00235          <span class="keyword">delete</span> base_client;
00236      }
00237 }
00238 <span class="comment"></span>
00239 <span class="comment">//! Removes all clients and frees the memory reserved by the clients and the client array  (mClients)</span>
<a name="l00240"></a><a class="code" href="classXFuInetNetwork.html#a10">00240</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="classXFuInetNetwork.html#a10">XFuInetNetwork::removeAllClients</a>()
00241 {
00242 
00243     XFcHashtableIterator&lt;UINT32, XFcInetClientWin *&gt; itClient;
00244 
00245     <span class="keywordflow">if</span> (!<a class="code" href="classXFuInetNetwork.html#o2">mCommunicationHandler</a>)
00246         <span class="keywordflow">return</span>;
00247 
00248     <span class="keywordflow">while</span> (<a class="code" href="classXFuInetNetwork.html#o5">mClients</a>.size() &gt; 0)
00249     {
00250         itClient = <a class="code" href="classXFuInetNetwork.html#o5">mClients</a>.begin();
00251         INT32 key = itClient.getKey();
00252         <a class="code" href="classXFuInetNetwork.html#a9">removeClient</a>(key);
00253     }
00254 }
00255 
00256 <span class="comment"></span>
00257 <span class="comment">//! Returns a pointer to the default data receiver</span>
<a name="l00258"></a><a class="code" href="classXFuInetNetwork.html#a14">00258</a> <span class="comment"></span>XFcDataReceiver * <a class="code" href="classXFuInetNetwork.html#a14">XFuInetNetwork::getDefaultDataReceiver</a>()
00259 {
00260     <span class="keywordflow">return</span> <a class="code" href="classXFuInetNetwork.html#o3">mDefaultDataReceiver</a>;
00261 }
00262 
00263 <span class="comment"></span>
00264 <span class="comment">//! Sets the default data receiver</span>
<a name="l00265"></a><a class="code" href="classXFuInetNetwork.html#a15">00265</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="classXFuInetNetwork.html#a15">XFuInetNetwork::setDefaultDataReceiver</a>(XFcDataReceiver *aReceiver)
00266 {
00267     <a class="code" href="classXFuInetNetwork.html#o3">mDefaultDataReceiver</a> = aReceiver;
00268     <a class="code" href="classXFuInetNetwork.html#o1">mCommunicationScheduler</a>-&gt;setDataReceiver(aReceiver);
00269 }
00270 
00271 <span class="comment"></span>
00272 <span class="comment">//! Returns the specified data receiver</span>
<a name="l00273"></a><a class="code" href="classXFuInetNetwork.html#a16">00273</a> <span class="comment"></span>XFcDataReceiver * <a class="code" href="classXFuInetNetwork.html#a16">XFuInetNetwork::getDataReceiver</a>(UINT32 aId)
00274 {
00275     <span class="keywordflow">return</span> <a class="code" href="classXFuInetNetwork.html#o1">mCommunicationScheduler</a>-&gt;getDataReceiver(aId);
00276 }
00277 
00278 <span class="comment"></span>
00279 <span class="comment">//! Adds a new data receiver</span>
<a name="l00280"></a><a class="code" href="classXFuInetNetwork.html#a17">00280</a> <span class="comment"></span>INT <a class="code" href="classXFuInetNetwork.html#a17">XFuInetNetwork::addDataReceiver</a>(UINT32 aId, XFcDataReceiver *aReceiver)
00281 {
00282     <span class="keywordflow">return</span> <a class="code" href="classXFuInetNetwork.html#o1">mCommunicationScheduler</a>-&gt;addDataReceiver(aId, aReceiver);
00283 }
00284 
00285 <span class="comment"></span>
00286 <span class="comment">//! Removes a data receiver</span>
<a name="l00287"></a><a class="code" href="classXFuInetNetwork.html#a18">00287</a> <span class="comment"></span>XFcDataReceiver * <a class="code" href="classXFuInetNetwork.html#a18">XFuInetNetwork::removeDataReceiver</a>(UINT32 aId)
00288 {
00289     <span class="keywordflow">return</span> <a class="code" href="classXFuInetNetwork.html#o1">mCommunicationScheduler</a>-&gt;removeDataReceiver(aId);
00290 }
00291 
00292 <span class="comment"></span>
00293 <span class="comment">//! Adds a communication event handler</span>
<a name="l00294"></a><a class="code" href="classXFuInetNetwork.html#a25">00294</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="classXFuInetNetwork.html#a25">XFuInetNetwork::addEventHandler</a>(<a class="code" href="classXFuNetworkEventHandler.html">XFuNetworkEventHandler</a> *aHandler)
00295 {
00296     <a class="code" href="classXFuInetNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a7">put</a>(aHandler);
00297 }
00298 
00299 <span class="comment"></span>
00300 <span class="comment">//! Removes a communication event handler</span>
<a name="l00301"></a><a class="code" href="classXFuInetNetwork.html#a26">00301</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="classXFuInetNetwork.html#a26">XFuInetNetwork::removeEventHandler</a>(<a class="code" href="classXFuNetworkEventHandler.html">XFuNetworkEventHandler</a> *aHandler)
00302 {
00303     <a class="code" href="classXFuInetNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a10">remove</a>(aHandler);
00304 }
00305 
00306 <span class="comment"></span>
00307 <span class="comment">//! Removes all communication event handlers</span>
<a name="l00308"></a><a class="code" href="classXFuInetNetwork.html#a27">00308</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="classXFuInetNetwork.html#a27">XFuInetNetwork::removeAllEventHandlers</a>()
00309 {
00310     <span class="keywordflow">while</span> (!<a class="code" href="classXFuInetNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a4">isEmpty</a>()) <a class="code" href="classXFuInetNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a10">remove</a>();
00311 }
00312 
00313 <span class="comment"></span>
00314 <span class="comment">//! Returns the specified client</span>
<a name="l00315"></a><a class="code" href="classXFuInetNetwork.html#a7">00315</a> <span class="comment"></span>XFcClientCommWin * <a class="code" href="classXFuInetNetwork.html#a7">XFuInetNetwork::getClient</a>(INT32 aClientId)
00316 {
00317     XFcHashtable&lt;UINT32, XFcInetClientWin *&gt;::iterator it;
00318     XFcClientCommWin * value = NULL;
00319 
00320     it = <a class="code" href="classXFuInetNetwork.html#o5">mClients</a>.find(aClientId);
00321 
00322     <span class="keywordflow">if</span>(it.isValid())
00323     {
00324         value = it.getValue();
00325     }
00326 
00327     <span class="keywordflow">return</span> value;
00328 
00329 }
00330 
00331 <span class="comment"></span>
00332 <span class="comment">//! Adds a client with the specific address. Returns the client id or XFCNET_CLIENTADD_ERROR if failed</span>
<a name="l00333"></a><a class="code" href="classXFuInetNetwork.html#a8">00333</a> <span class="comment"></span>INT32 <a class="code" href="classXFuInetNetwork.html#a8">XFuInetNetwork::addClient</a>(XFcAddress *aAddress, INT32 aTimeoutTime)
00334 {
00335     XFcInetClientWin *client = NULL;
00336     INT32 clientId = -1;
00337 
00338     <span class="keywordflow">if</span> (aAddress-&gt;getType() != (INT32)XFCNET_AFINET)
00339         <span class="keywordflow">return</span> 0;
00340 
00341     <span class="keywordflow">if</span> ((client = XFcInetClientWin::create()) != NULL)
00342     {
00343         client-&gt;setAddress(*aAddress);
00344         client-&gt;setConnectionTimeout(aTimeoutTime);
00345 
00346         <span class="keywordflow">if</span> (((clientId = <a class="code" href="classXFuInetNetwork.html#o1">mCommunicationScheduler</a>-&gt;addClient(client)) != XFCNET_CLIENTADD_ERROR &amp;&amp;
00347              clientId != XFCNET_ERROR) &amp;&amp;
00348             <a class="code" href="classXFuInetNetwork.html#o5">mClients</a>.put(clientId, client))
00349         {
00350              <span class="keywordflow">return</span> clientId;
00351         }
00352     }
00353     <span class="keyword">delete</span> client;
00354     <span class="keywordflow">return</span> 0;
00355 }
00356 
00357 <span class="comment"></span>
00358 <span class="comment">//! Removes the specified client</span>
<a name="l00359"></a><a class="code" href="classXFuInetNetwork.html#a9">00359</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="classXFuInetNetwork.html#a9">XFuInetNetwork::removeClient</a>(INT32 aClientId)
00360 {
00361     <span class="keywordflow">if</span> (!<a class="code" href="classXFuInetNetwork.html#o2">mCommunicationHandler</a>)
00362         <span class="keywordflow">return</span>;
00363 
00364     XFcClientCommWin *client = NULL;
00365 
00366     <span class="keywordflow">if</span> ((client = <a class="code" href="classXFuInetNetwork.html#a7">getClient</a>(aClientId)) != NULL)
00367     {
00368         <a class="code" href="classXFuInetNetwork.html#o1">mCommunicationScheduler</a>-&gt;removeClient(aClientId);
00369         <a class="code" href="classXFuInetNetwork.html#o5">mClients</a>.remove(aClientId);
00370         <span class="keyword">delete</span> client;
00371     }
00372 }
00373 
00374 <span class="comment"></span>
00375 <span class="comment">//! Returns the round trip time for the specified client</span>
<a name="l00376"></a><a class="code" href="classXFuInetNetwork.html#a19">00376</a> <span class="comment"></span>INT32 <a class="code" href="classXFuInetNetwork.html#a19">XFuInetNetwork::getRoundTripTime</a>(INT32 aClientId)
00377 {
00378     <span class="keywordflow">return</span> <a class="code" href="classXFuInetNetwork.html#o1">mCommunicationScheduler</a>-&gt;getRoundTripTime(aClientId);
00379 }
00380 
00381 <span class="comment"></span>
00382 <span class="comment">//! Get packet frame</span>
<a name="l00383"></a><a class="code" href="classXFuInetNetwork.html#a20">00383</a> <span class="comment"></span>XFcObjectDataFrame * <a class="code" href="classXFuInetNetwork.html#a20">XFuInetNetwork::getPacketFrame</a>(INT32 aClientId, XFCNET_MESSAGE_SLOT aSlot)
00384 {
00385     <span class="keywordflow">return</span> <a class="code" href="classXFuInetNetwork.html#o1">mCommunicationScheduler</a>-&gt;getPacketFrame(aClientId, aSlot);
00386 }
00387 
00388 <span class="comment"></span>
00389 <span class="comment">//! Get recent state frame</span>
<a name="l00390"></a><a class="code" href="classXFuInetNetwork.html#a21">00390</a> <span class="comment"></span>XFcObjectDataFrame * <a class="code" href="classXFuInetNetwork.html#a21">XFuInetNetwork::getRecentStateFrame</a>(INT32 aClientId, INT32 aRecentId)
00391 {
00392     <span class="keywordflow">return</span> <a class="code" href="classXFuInetNetwork.html#o1">mCommunicationScheduler</a>-&gt;getRecentStateFrame(aClientId, aRecentId);
00393 }
00394 
00395 <span class="comment"></span>
00396 <span class="comment">//! Remove recent state frame</span>
<a name="l00397"></a><a class="code" href="classXFuInetNetwork.html#a22">00397</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="classXFuInetNetwork.html#a22">XFuInetNetwork::removeRecentStateFrame</a>(INT32 aClientId, INT32 aRecentId)
00398 {
00399     <a class="code" href="classXFuInetNetwork.html#o1">mCommunicationScheduler</a>-&gt;removeRecentStateFrame(aClientId, aRecentId);
00400 }
00401 
00402 <span class="comment"></span>
00403 <span class="comment">//! Sends a serializable object to the specified client</span>
<a name="l00404"></a><a class="code" href="classXFuInetNetwork.html#a23">00404</a> <span class="comment"></span>INT32 <a class="code" href="classXFuInetNetwork.html#a23">XFuInetNetwork::send</a>(INT32 aClientId, UINT32 aReceiverId, XFCNET_MESSAGE_SLOT aSlot, <a class="code" href="classXFuSerializable.html">XFuSerializable</a> *aSerializable)
00405 {
00406     INT32 size = -1;
00407     XFcObjectDataFrame *frame = <a class="code" href="classXFuInetNetwork.html#a20">getPacketFrame</a>(aClientId, aSlot);
00408     <span class="keywordflow">if</span> (frame)
00409     {
00410         <span class="keywordtype">void</span> *buffer = frame-&gt;lock();
00411         <span class="keywordflow">if</span> (buffer)
00412         {
00413             size = aSerializable-&gt;<a class="code" href="classXFuSerializable.html#a1">serialize</a>((CHAR8*)buffer, frame-&gt;sizeofBuffer());
00414             frame-&gt;setPacketSize(size);
00415             frame-&gt;setReceiverId(aReceiverId);
00416 
00417         }
00418         frame-&gt;unlock();
00419     }
00420     <span class="keywordflow">return</span> size;
00421 }
00422 
00423 <span class="comment"></span>
00424 <span class="comment">//! Sends a serializable object to the specified client as a recent state packet</span>
<a name="l00425"></a><a class="code" href="classXFuInetNetwork.html#a24">00425</a> <span class="comment"></span>INT32 <a class="code" href="classXFuInetNetwork.html#a24">XFuInetNetwork::sendRecentState</a>(INT32 aClientId, UINT32 aReceiverId, INT32 aRecentId, <a class="code" href="classXFuSerializable.html">XFuSerializable</a> *aSerializable)
00426 {
00427     INT32 size = -1;
00428     XFcObjectDataFrame *frame = <a class="code" href="classXFuInetNetwork.html#a21">getRecentStateFrame</a>(aClientId, aRecentId);
00429     <span class="keywordflow">if</span> (frame)
00430     {
00431         <span class="keywordtype">void</span> *buffer = frame-&gt;lock();
00432         <span class="keywordflow">if</span> (buffer)
00433         {
00434             size = aSerializable-&gt;<a class="code" href="classXFuSerializable.html#a1">serialize</a>((CHAR8*)buffer, frame-&gt;sizeofBuffer());
00435             frame-&gt;setPacketSize(size);
00436             frame-&gt;setReceiverId(aReceiverId);
00437         }
00438         frame-&gt;unlock();
00439     }
00440     <span class="keywordflow">return</span> size;
00441 }
00442 
00443 <span class="comment"></span>
00444 <span class="comment">//! Connection lost handler (XFuClientLost)</span>
<a name="l00445"></a><a class="code" href="classXFuInetNetwork.html#a3">00445</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="classXFuInetNetwork.html#a3">XFuInetNetwork::clientLost</a>(INT32 aClientId)
00446 {
00447     <a class="code" href="classXFuInetNetwork.html#a9">removeClient</a>(aClientId);
00448     INT32 handlersNum = <a class="code" href="classXFuInetNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a2">size</a>();
00449     INT32 i;
00450     <span class="keywordflow">for</span> (i = 0; i &lt; handlersNum; i++)
00451     {
00452         <a class="code" href="classXFuInetNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a5">get</a>(i)-&gt;<a class="code" href="classXFuNetworkEventHandler.html#a2">handleClientLost</a>(aClientId);
00453     }
00454 }
00455 
00456 <span class="comment"></span>
00457 <span class="comment">//! Handle data from an unknown client</span>
<a name="l00458"></a><a class="code" href="classXFuInetNetwork.html#a4">00458</a> <span class="comment"></span>INT <a class="code" href="classXFuInetNetwork.html#a4">XFuInetNetwork::handleSender</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *aAddress, <span class="keyword">const</span> CHAR8 *aData, INT32 aLen)
00459 {
00460 
00461     UINT32 gameToken;
00462 
00463     <span class="keywordflow">if</span> (((XFcAddress *)aAddress)-&gt;getType() != (INT32)XFCNET_AFINET)
00464         <span class="keywordflow">return</span> 0;
00465 
00466     <span class="keywordflow">if</span> (aLen == 4)
00467     {
00468         memcpy(&amp;gameToken, aData, 4);
00469 
00470         <span class="keywordflow">if</span> (gameToken == <a class="code" href="classXFuInetNetwork.html#o7">mAcceptGameToken</a>)
00471         {
00472             INT32 clientId = <a class="code" href="classXFuInetNetwork.html#a8">addClient</a>((XFcAddress*)aAddress);
00473             <span class="keywordflow">if</span> (clientId != XFCNET_CLIENTADD_ERROR)
00474             {
00475                 INT32 handlersNum = <a class="code" href="classXFuInetNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a2">size</a>();
00476                 INT32 i;
00477                 <span class="keywordflow">for</span> (i = 0; i &lt; handlersNum; i++)
00478                 {
00479                     <a class="code" href="classXFuInetNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a5">get</a>(i)-&gt;<a class="code" href="classXFuNetworkEventHandler.html#a1">handleClientAccepted</a>(clientId);
00480                 }
00481             }
00482         }
00483     }
00484     <span class="keywordflow">return</span> 0;
00485 }
00486 
00487 
<a name="l00488"></a><a class="code" href="classXFuInetNetwork.html#a30">00488</a> INT <a class="code" href="classXFuInetNetwork.html#a30">XFuInetNetwork::startServerDiscovery</a>(<span class="keyword">const</span> CHAR8 *aMessage, UINT16 aAdvertisePort)
00489 {
00490 
00491     INT retValue = 0;
00492     <span class="keywordflow">if</span> (!<a class="code" href="classXFuInetNetwork.html#o11">mCommService</a>)
00493         <span class="keywordflow">return</span> 0;
00494 
00495     XFcInetAdvertiser *inetAdvertise = NULL;
00496 
00497     <span class="keywordflow">if</span> (aMessage)
00498         inetAdvertise = XFcInetAdvertiser::create(aMessage, strlen(aMessage));
00499     <span class="keywordflow">else</span>
00500     {
00501         CHAR8 *string = <span class="stringliteral">"X-Forge server query"</span>;
00502         inetAdvertise = XFcInetAdvertiser::create(string, 20);
00503     }
00504 
00505     <span class="keywordflow">if</span> (inetAdvertise)
00506     {
00507         inetAdvertise-&gt;setAdvertisePort(aAdvertisePort);
00508         retValue = <a class="code" href="classXFuInetNetwork.html#o11">mCommService</a>-&gt;inquiry(*inetAdvertise, <span class="keyword">this</span>);
00509     }
00510 
00511     <span class="keyword">delete</span> inetAdvertise;
00512 
00513     <span class="keywordflow">return</span> (retValue != XFCNET_ERROR) ? 1 : 0;
00514 }
00515 
<a name="l00516"></a><a class="code" href="classXFuInetNetwork.html#a31">00516</a> <span class="keywordtype">void</span> <a class="code" href="classXFuInetNetwork.html#a31">XFuInetNetwork::stopServerDiscovery</a>()
00517 {
00518     <span class="keywordflow">if</span> (!<a class="code" href="classXFuInetNetwork.html#o11">mCommService</a>)
00519         <span class="keywordflow">return</span>;
00520     <a class="code" href="classXFuInetNetwork.html#o11">mCommService</a>-&gt;cancelInquiry();
00521 }
00522 
<a name="l00523"></a><a class="code" href="classXFuInetNetwork.html#a28">00523</a> INT <a class="code" href="classXFuInetNetwork.html#a28">XFuInetNetwork::startAdvertiser</a>(<span class="keyword">const</span> CHAR8 *aMessage, UINT16 aAdvertisePort)
00524 {
00525     INT retVal = XFCNET_ERROR;
00526 
00527     <span class="keywordflow">if</span> (!<a class="code" href="classXFuInetNetwork.html#o11">mCommService</a>)
00528         <span class="keywordflow">return</span> 0;
00529 
00530     XFcInetAdvertiser *advertise = NULL;
00531 
00532     <span class="keywordflow">if</span> ((advertise = XFcInetAdvertiser::create()) != NULL)
00533     {
00534         <span class="keywordflow">if</span> (aMessage == NULL)
00535             advertise-&gt;setMessageHeader(<span class="stringliteral">"X-Forge server"</span>, 14);
00536         <span class="keywordflow">else</span>
00537             advertise-&gt;setMessageHeader(aMessage, strlen(aMessage));
00538 
00539         advertise-&gt;setGamePort(mGamePort);
00540         advertise-&gt;setAdvertisePort(aAdvertisePort);
00541 
00542         retVal = <a class="code" href="classXFuInetNetwork.html#o11">mCommService</a>-&gt;advertise(*advertise);
00543         <span class="keyword">delete</span> advertise;
00544     }
00545     <span class="keywordflow">return</span> (retVal != XFCNET_ERROR) ? 1 : 0;
00546 }
00547 
00548 
<a name="l00549"></a><a class="code" href="classXFuInetNetwork.html#a29">00549</a> <span class="keywordtype">void</span> <a class="code" href="classXFuInetNetwork.html#a29">XFuInetNetwork::stopAdvertiser</a>()
00550 {
00551      <span class="keywordflow">if</span> (!<a class="code" href="classXFuInetNetwork.html#o11">mCommService</a>)
00552         <span class="keywordflow">return</span>;
00553 
00554     <a class="code" href="classXFuInetNetwork.html#o11">mCommService</a>-&gt;cancelAdvertise();
00555 }
00556 
00557 
<a name="l00558"></a><a class="code" href="classXFuInetNetwork.html#a32">00558</a> <span class="keywordtype">void</span> <a class="code" href="classXFuInetNetwork.html#a32">XFuInetNetwork::deviceDiscovery</a>(<span class="keyword">const</span> XFcLinkedList&lt;XFcAdvertiser *&gt; &amp;aAdvertiser)
00559 {
00560     XFcLinkedList&lt;XFcAdvertiser *&gt;::forwardIterator it;
00561     INT32 handlersNum = <a class="code" href="classXFuInetNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a2">size</a>();
00562     INT32 i;
00563 
00564     <span class="keywordflow">if</span> (aAdvertiser.size() != 0)
00565     {
00566         <span class="keywordflow">for</span> (it = aAdvertiser.forwardBegin(); it != aAdvertiser.forwardEnd(); it++)
00567         {
00568             <span class="keywordflow">for</span> (i = 0; i &lt; handlersNum; i++)
00569                 <a class="code" href="classXFuInetNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a5">get</a>(i)-&gt;<a class="code" href="classXFuNetworkEventHandler.html#a4">handleAdvertiseDiscovered</a>(it.getData());
00570         }
00571     }
00572     <span class="keywordflow">else</span>
00573     {
00574         <span class="keywordflow">for</span> (i = 0; i &lt; handlersNum; i++)
00575         {
00576             <a class="code" href="classXFuInetNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a5">get</a>(i)-&gt;<a class="code" href="classXFuNetworkEventHandler.html#a4">handleAdvertiseDiscovered</a>(NULL);
00577         }
00578     }
00579 }
00580 
00581 
<a name="l00582"></a><a class="code" href="classXFuInetNetwork.html#a34">00582</a> INT <a class="code" href="classXFuInetNetwork.html#a34">XFuInetNetwork::deviceLocalName</a>(XFcName &amp;aName)
00583 {
00584     <span class="comment">// Delete host resolver</span>
00585     <span class="keywordflow">if</span> (!<a class="code" href="classXFuInetNetwork.html#o10">mHostResolver</a>)
00586         <a class="code" href="classXFuInetNetwork.html#o10">mHostResolver</a> = XFcInetHostResolver::create();
00587 
00588     <span class="comment">// Do the device discovery, async found devices are returned througth deviceDiscovery callback.</span>
00589     <span class="keywordflow">if</span> (mHostResolver)
00590     {
00591         INT error = <a class="code" href="classXFuInetNetwork.html#o10">mHostResolver</a>-&gt;localName(aName);
00592 
00593         <span class="keywordflow">if</span> (error != XFCNET_ERROR)
00594         {
00595             <span class="keywordflow">if</span> (aName.mLen &lt; 0x40)
00596                 aName.mName[aName.mLen] = <span class="charliteral">'\0'</span>;
00597 
00598             <span class="keywordflow">return</span> 1;
00599         }
00600     }
00601     <span class="keywordflow">return</span> 0;
00602 }
00603 
</pre></div><br clear=all>
<center><table border=0 cellpadding=0 cellspacing=0>
<tr><td colspan=5><img src="paleblue.gif" width=600 height=1></td></tr>
<tr><td>&nbsp;&nbsp;&nbsp;</td><td><a href="http://www.fathammer.com/"><img src="logo.gif" border=0></a></td>
<td valign=bottom><center><font face="arial, helvetica" size="-2" color="#003366">X-Forge Documentation<br>Confidential<br>Copyright &copy; 2002-2003 Fathammer</font></center></td><td>&nbsp;&nbsp;&nbsp;</td>
<td valign=bottom><center><font face="arial, helvetica" size="-2" color="#003366">Documentation generated<br>with <a href="http://www.doxygen.org/index.html">doxygen</a><br>by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a></font></center></td></tr></table>
</body></html>
