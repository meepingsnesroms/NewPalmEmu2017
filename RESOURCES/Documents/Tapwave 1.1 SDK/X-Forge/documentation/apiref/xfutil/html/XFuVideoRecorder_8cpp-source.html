<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>XFuVideoRecorder.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>XFuVideoRecorder.cpp</h1><a href="XFuVideoRecorder_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*! \file </span>
00002 <span class="comment"> * X-Forge Util &lt;br&gt;</span>
00003 <span class="comment"> * Copyright 2000-2003 Fathammer Ltd</span>
00004 <span class="comment"> * </span>
00005 <span class="comment"> * \brief Video recorder class (for desktop use)</span>
00006 <span class="comment"> * </span>
00007 <span class="comment"> * $Id: XFuVideoRecorder.cpp,v 1.7 2003/08/12 13:34:08 lars Exp $</span>
00008 <span class="comment"> * $Date: 2003/08/12 13:34:08 $</span>
00009 <span class="comment"> * $Revision: 1.7 $</span>
00010 <span class="comment"> */</span>
00011 <span class="preprocessor">#include &lt;xfcore/XFcCore.h&gt;</span>
00012 <span class="preprocessor">#include &lt;<a class="code" href="XFuVideoRecorder_8h.html">xfutil/XFuVideoRecorder.h</a>&gt;</span>
00013 
<a name="l00014"></a><a class="code" href="classXFuVideoRecorder.html#b0">00014</a> <a class="code" href="classXFuVideoRecorder.html#b0">XFuVideoRecorder::XFuVideoRecorder</a>()
00015 {
00016     <a class="code" href="classXFuVideoRecorder.html#n0">mLastTick</a> = (FLOAT32)XFcCore::getTick();
00017     <a class="code" href="classXFuVideoRecorder.html#n1">mTicksPerFrame</a> = 1;
00018     <a class="code" href="classXFuVideoRecorder.html#n2">mFrame</a> = 0;
00019     <a class="code" href="classXFuVideoRecorder.html#n3">mPrefix</a> = NULL;
00020 }
00021 
00022 
<a name="l00023"></a><a class="code" href="XFuVideoRecorder_8cpp.html#a0">00023</a> <span class="keyword">static</span> <span class="keyword">const</span> UINT8 <a class="code" href="XFuVideoRecorder_8cpp.html#a0">xfuBmpHdr</a>[] = 
00024 {
00025         0x42,0x4d,0x38,0x84,
00026         0x03,0x00,0x00,0x00,
00027         0x00,0x00,0x36,0x00,
00028         0x00,0x00,0x28,0x00,
00029         0x00,0x00,0xF0,0x00,
00030         0x00,0x00,0x40,0x01,
00031         0x00,0x00,0x01,0x00,
00032         0x18,0x00,0x00,0x00,
00033         0x00,0x00,0x00,0x00,
00034         0x00,0x00,0x12,0x0B,
00035         0x00,0x00,0x12,0x0B,
00036         0x00,0x00,0x00,0x00,
00037         0x00,0x00,0x00,0x00,
00038         0x00,0x00
00039 };
00040 
00041 
<a name="l00042"></a><a class="code" href="classXFuVideoRecorder.html#b1">00042</a> <span class="keywordtype">void</span> <a class="code" href="classXFuVideoRecorder.html#b1">XFuVideoRecorder::storeFrame</a>(XFcGLSurface *aSurface)
00043 {
00044     CHAR name[32];
00045     XFcStringToolkit::format(name, <span class="stringliteral">"%s%04d.bmp"</span>, mPrefix, mFrame);
00046     XFcFile *f = XFcFile::open(name, XFCSTR(<span class="stringliteral">"wb"</span>));
00047 
00048     UINT8 bmphdr[54];
00049     memcpy(bmphdr, xfuBmpHdr, 54);
00050 
00051     UINT16 *buf;
00052     aSurface-&gt;lock((<span class="keywordtype">void</span> **)&amp;buf, XFCGF_R5G5X1B5, XFCGFX_DISCARDCHANGES);    
00053     <span class="keywordflow">if</span> (buf == NULL)
00054     {
00055         f-&gt;close();
00056         <span class="keywordflow">return</span>;
00057     }
00058     
00059     INT32 width = aSurface-&gt;getWidth();
00060     INT32 height = aSurface-&gt;getHeight();
00061 
00062     *((INT32 *)(bmphdr + 18)) = width;
00063     *((INT32 *)(bmphdr + 22)) = height;   
00064     
00065     f-&gt;write(bmphdr, 1, 54);
00066     
00067     INT32 j,i;
00068     <span class="keywordflow">for</span> (j = 0; j &lt; height; j++)
00069     {
00070         <span class="keywordflow">for</span> (i = 0; i &lt; width; i++) 
00071         {
00072             <span class="keywordtype">int</span> srccolor = buf[((height - 1) - j) * width + i];
00073             <span class="keywordtype">int</span> c = ((srccolor &amp; 0x001f) &lt;&lt; 3) + 
00074                     ((srccolor &amp; 0x07c0) &lt;&lt; 5) + 
00075                     ((srccolor &amp; 0xf800) &lt;&lt; 8); 
00076             f-&gt;write(&amp;c, 3, 1);
00077         }                
00078     }
00079     f-&gt;close();
00080     aSurface-&gt;unlock();
00081 
00082     <a class="code" href="classXFuVideoRecorder.html#n2">mFrame</a>++;
00083 }
00084 
00085 
<a name="l00086"></a><a class="code" href="classXFuVideoRecorder.html#d0">00086</a> <a class="code" href="classXFuVideoRecorder.html">XFuVideoRecorder</a> * <a class="code" href="classXFuVideoRecorder.html#d0">XFuVideoRecorder::create</a>(<span class="keyword">const</span> CHAR *aPrefix, INT32 aDesiredFPS)
00087 {
00088     <span class="keywordflow">if</span> (aDesiredFPS &lt;= 0)
00089         <span class="keywordflow">return</span> NULL;
00090 
00091     <a class="code" href="classXFuVideoRecorder.html">XFuVideoRecorder</a> * v = <span class="keyword">new</span> <a class="code" href="classXFuVideoRecorder.html#b0">XFuVideoRecorder</a>();
00092     
00093     <span class="keywordflow">if</span> (v == NULL)
00094         <span class="keywordflow">return</span> NULL;
00095     
00096     <span class="keywordflow">if</span> (aPrefix != NULL)
00097     {
00098         v-&gt;<a class="code" href="classXFuVideoRecorder.html#n3">mPrefix</a> = XFcStringToolkit::copy(aPrefix);
00099         <span class="keywordflow">if</span> (v-&gt;<a class="code" href="classXFuVideoRecorder.html#n3">mPrefix</a> == NULL)
00100         {
00101             <span class="keyword">delete</span> v;
00102             <span class="keywordflow">return</span> NULL;
00103         }
00104         
00105     }
00106     
00107     v-&gt;<a class="code" href="classXFuVideoRecorder.html#n1">mTicksPerFrame</a> = 1000.0f / (FLOAT32)aDesiredFPS;
00108     
00109     <span class="keywordflow">return</span> v;
00110 }
00111  
00112 
<a name="l00113"></a><a class="code" href="classXFuVideoRecorder.html#a0">00113</a> <span class="keywordtype">void</span> <a class="code" href="classXFuVideoRecorder.html#a0">XFuVideoRecorder::tick</a>(XFcGLSurface *aSurface)
00114 {
00115     FLOAT32 <a class="code" href="classXFuVideoRecorder.html#a0">tick</a> = (FLOAT32)XFcCore::getTick();
00116 
00117     <span class="keywordflow">if</span> (tick - <a class="code" href="classXFuVideoRecorder.html#n0">mLastTick</a> &lt; <a class="code" href="classXFuVideoRecorder.html#n1">mTicksPerFrame</a>)
00118         <span class="keywordflow">return</span>;
00119 
00120     <span class="keywordflow">while</span> (<a class="code" href="classXFuVideoRecorder.html#n0">mLastTick</a> &lt; tick - <a class="code" href="classXFuVideoRecorder.html#n1">mTicksPerFrame</a>)
00121     {
00122         <a class="code" href="classXFuVideoRecorder.html#b1">storeFrame</a>(aSurface);
00123         <a class="code" href="classXFuVideoRecorder.html#n0">mLastTick</a> += <a class="code" href="classXFuVideoRecorder.html#n1">mTicksPerFrame</a>;
00124     }
00125 }
00126 
00127 
<a name="l00128"></a><a class="code" href="classXFuVideoRecorder.html#a1">00128</a> <a class="code" href="classXFuVideoRecorder.html#a1">XFuVideoRecorder::~XFuVideoRecorder</a>()
00129 {
00130     <span class="keyword">delete</span>[] <a class="code" href="classXFuVideoRecorder.html#n3">mPrefix</a>;
00131 }
00132 
</pre></div><br clear=all>
<center><table border=0 cellpadding=0 cellspacing=0>
<tr><td colspan=5><img src="paleblue.gif" width=600 height=1></td></tr>
<tr><td>&nbsp;&nbsp;&nbsp;</td><td><a href="http://www.fathammer.com/"><img src="logo.gif" border=0></a></td>
<td valign=bottom><center><font face="arial, helvetica" size="-2" color="#003366">X-Forge Documentation<br>Confidential<br>Copyright &copy; 2002-2003 Fathammer</font></center></td><td>&nbsp;&nbsp;&nbsp;</td>
<td valign=bottom><center><font face="arial, helvetica" size="-2" color="#003366">Documentation generated<br>with <a href="http://www.doxygen.org/index.html">doxygen</a><br>by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a></font></center></td></tr></table>
</body></html>
