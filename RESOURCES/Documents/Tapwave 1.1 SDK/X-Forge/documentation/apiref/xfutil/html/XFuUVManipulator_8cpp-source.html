<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>XFuUVManipulator.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>XFuUVManipulator.cpp</h1><a href="XFuUVManipulator_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*! \file </span>
00002 <span class="comment"> * X-Forge Util &lt;br&gt;</span>
00003 <span class="comment"> * Copyright 2000-2003 Fathammer Ltd</span>
00004 <span class="comment"> * </span>
00005 <span class="comment"> * \brief UV Coordinate manipulation routines</span>
00006 <span class="comment"> * </span>
00007 <span class="comment"> * $Id: XFuUVManipulator.cpp,v 1.7 2003/08/12 13:34:08 lars Exp $</span>
00008 <span class="comment"> * $Date: 2003/08/12 13:34:08 $</span>
00009 <span class="comment"> * $Revision: 1.7 $</span>
00010 <span class="comment"> */</span>
00011 
00012 <span class="preprocessor">#include &lt;xfcore/XFcCore.h&gt;</span>
00013 <span class="preprocessor">#include &lt;<a class="code" href="XFuUVManipulator_8h.html">xfutil/XFuUVManipulator.h</a>&gt;</span>
00014 
<a name="l00015"></a><a class="code" href="classXFuUVManipulator.html#d0">00015</a> <span class="keywordtype">void</span> <a class="code" href="classXFuUVManipulator.html#d0">XFuUVManipulator::generateEnvmapCoordinates</a>(XFcGLVertexBuffer *aVertexBuffer, XFcGL *aGL)
00016 {
00017     <span class="keywordflow">if</span> (aVertexBuffer-&gt;getFlags() == (XFCGLVF_XYZ | 
00018                                       XFCGLVF_NORMAL | 
00019                                       XFCGLVF_DIFFUSECOLOR |
00020                                       XFCGLVF_TEXTURE1))
00021     {
00022         INT32 *v = (INT32*)aVertexBuffer-&gt;lock(XFCGLVBLOCK_MODIFY);
00023         <span class="keywordflow">if</span> (v != NULL)
00024         {
00025             INT32 t = aVertexBuffer-&gt;getNumVertices();            
00026             INT32 i;
00027 
00028             XFcMatrix4 m, tm;
00029             aGL-&gt;getMatrix(XFCGLMAT_VIEW, tm);
00030             aGL-&gt;getMatrix(XFCGLMAT_WORLD, m);
00031             m *= tm;     
00032             
00033             <span class="comment">// remove translation from above matrix</span>
00034             m.m[3][0] = REALi(0);
00035             m.m[3][1] = REALi(0);
00036             m.m[3][2] = REALi(0);
00037             m.m[3][3] = REALi(1);
00038 
00039             <span class="comment">// cycle through all vertices in buffer</span>
00040             <span class="keywordflow">for</span> (i = 0; i &lt; t; i++)
00041             {
00042 
00043                 XFcVector4 vec, rvec;
00044                 <span class="comment">// fetch normal value</span>
00045 <span class="preprocessor">#ifndef XFC_USE_FLOAT</span>
00046 <span class="preprocessor"></span>                vec.x.mValue = v[3];
00047                 vec.y.mValue = v[4];
00048                 vec.z.mValue = v[5];
00049 <span class="preprocessor">#else</span>
00050 <span class="preprocessor"></span>                vec.x = *((REAL*)&amp;v[3]);
00051                 vec.y = *((REAL*)&amp;v[4]);
00052                 vec.z = *((REAL*)&amp;v[5]);
00053 <span class="preprocessor">#endif</span>
00054 <span class="preprocessor"></span>                vec.w = REALi(1);
00055         
00056                 <span class="comment">// rotate normals to the camera direction</span>
00057                 XFcMath::matrixProject(m, vec, rvec);
00058 
00059                 REAL w2 = rvec.w * 2;
00060 
00061                 rvec.x /= w2; <span class="comment">// scale rotated normals to -0.5 - 0.5</span>
00062                 rvec.y /= w2;
00063                 rvec.x += REALf(0.5f); <span class="comment">// translate rotated normals to 0 - 1.0</span>
00064                 rvec.y += REALf(0.5f);
00065         
00066                 <span class="comment">// overwrite UV coordinates with normal values</span>
00067 <span class="preprocessor">#ifndef XFC_USE_FLOAT</span>
00068 <span class="preprocessor"></span>                v[7] = rvec.x.mValue;
00069                 v[8] = rvec.y.mValue;
00070 <span class="preprocessor">#else</span>
00071 <span class="preprocessor"></span>                *((REAL*)&amp;v[7]) = rvec.x;
00072                 *((REAL*)&amp;v[8]) = rvec.y;
00073 <span class="preprocessor">#endif</span>
00074 <span class="preprocessor"></span>                v += aVertexBuffer-&gt;getVertexStride() / 4;
00075             }
00076             aVertexBuffer-&gt;unlock();
00077         }
00078     }
00079 }
00080 
</pre></div><br clear=all>
<center><table border=0 cellpadding=0 cellspacing=0>
<tr><td colspan=5><img src="paleblue.gif" width=600 height=1></td></tr>
<tr><td>&nbsp;&nbsp;&nbsp;</td><td><a href="http://www.fathammer.com/"><img src="logo.gif" border=0></a></td>
<td valign=bottom><center><font face="arial, helvetica" size="-2" color="#003366">X-Forge Documentation<br>Confidential<br>Copyright &copy; 2002-2003 Fathammer</font></center></td><td>&nbsp;&nbsp;&nbsp;</td>
<td valign=bottom><center><font face="arial, helvetica" size="-2" color="#003366">Documentation generated<br>with <a href="http://www.doxygen.org/index.html">doxygen</a><br>by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a></font></center></td></tr></table>
</body></html>
