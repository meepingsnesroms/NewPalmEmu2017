<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>XFuBluetoothMultiNetwork.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>XFuBluetoothMultiNetwork.cpp</h1><a href="XFuBluetoothMultiNetwork_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*!</span>
00002 <span class="comment"> * \file</span>
00003 <span class="comment"> * X-Forge Engine &lt;br&gt;</span>
00004 <span class="comment"> * Copyright 2000-2002 Fathammer Ltd</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> * \brief Default implementation for a Bluetooth communication manager.</span>
00007 <span class="comment"> *</span>
00008 <span class="comment"> * $Id: XFuBluetoothMultiNetwork.cpp,v 1.9 2003/10/02 11:43:01 slehti Exp $</span>
00009 <span class="comment"> * $Date: 2003/10/02 11:43:01 $</span>
00010 <span class="comment"> * $Revision: 1.9 $</span>
00011 <span class="comment"> */</span>
00012 
00013 <span class="preprocessor">#include &lt;xforge.h&gt;</span>
00014 
00015 <span class="preprocessor">#include &lt;xfcore/net/XFcBtHandler.h&gt;</span>
00016 <span class="preprocessor">#include &lt;xfcore/net/XFcBtClientWin.h&gt;</span>
00017 <span class="preprocessor">#include &lt;xfcore/net/XFcObjectDataFrame.h&gt;</span>
00018 <span class="preprocessor">#include &lt;xfcore/net/XFcCommunicationScheduler.h&gt;</span>
00019 <span class="preprocessor">#include &lt;xfcore/net/XFcCommunicationConstants.h&gt;</span>
00020 <span class="preprocessor">#include &lt;xfcore/net/socket/XFcSocketConstants.h&gt;</span>
00021 <span class="preprocessor">#include &lt;xfcore/net/socket/XFcBtAddress.h&gt;</span>
00022 <span class="preprocessor">#include &lt;xfcore/net/XFcUnknownSender.h&gt;</span>
00023 <span class="preprocessor">#include &lt;xfcore/net/XFcClientLost.h&gt;</span>
00024 <span class="preprocessor">#include &lt;xfcore/net/XFcDataReceiver.h&gt;</span>
00025 <span class="preprocessor">#include &lt;xfcore/net/XFcObjectDataFrame.h&gt;</span>
00026 <span class="preprocessor">#include &lt;xfcore/net/socket/XFcHostEntry.h&gt;</span>
00027 <span class="preprocessor">#include &lt;xfcore/net/socket/XFcBtHostResolver.h&gt;</span>
00028 <span class="preprocessor">#include &lt;xfcore/net/socket/XFcBtAdvertiser.h&gt;</span>
00029 <span class="preprocessor">#include &lt;xfcore/net/XFcUdpEngine.h&gt;</span>
00030 <span class="preprocessor">#include &lt;xfcore/net/socket/XFcBtCommService.h&gt;</span>
00031 <span class="preprocessor">#include &lt;xfcore/net/socket/XFcBtServerSearch.h&gt;</span>
00032 <span class="preprocessor">#include &lt;xfcore/net/socket/XFcBtUUID.h&gt;</span>
00033 <span class="preprocessor">#include &lt;xfcore/net/socket/XFcName.h&gt;</span>
00034 <span class="preprocessor">#include &lt;<a class="code" href="XFuSerializable_8h.html">xfutil/XFuSerializable.h</a>&gt;</span>
00035 <span class="preprocessor">#include &lt;<a class="code" href="XFuNetwork_8h.html">xfutil/XFuNetwork.h</a>&gt;</span>
00036 <span class="preprocessor">#include &lt;<a class="code" href="XFuNetworkEventHandler_8h.html">xfutil/XFuNetworkEventHandler.h</a>&gt;</span>
00037 <span class="preprocessor">#include &lt;<a class="code" href="XFuBluetoothMultiNetwork_8h.html">xfutil/XFuBluetoothMultiNetwork.h</a>&gt;</span>
00038 
00039 
<a name="l00040"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#d0">00040</a> <a class="code" href="classXFuBluetoothMultiNetwork.html">XFuBluetoothMultiNetwork</a> * <a class="code" href="classXFuBluetoothMultiNetwork.html#d0">XFuBluetoothMultiNetwork::create</a>()
00041 {
00042     <a class="code" href="classXFuBluetoothMultiNetwork.html">XFuBluetoothMultiNetwork</a> * manager = <span class="keyword">new</span> <a class="code" href="classXFuBluetoothMultiNetwork.html">XFuBluetoothMultiNetwork</a>;
00043     <span class="keywordflow">if</span> (manager != NULL &amp;&amp; !manager-&gt;<a class="code" href="classXFuBluetoothMultiNetwork.html#b2">init</a>())
00044     {
00045         <span class="keyword">delete</span> manager;
00046         <span class="keywordflow">return</span> NULL;
00047     }
00048     <span class="keywordflow">return</span> manager;
00049 }
00050 
00051 
<a name="l00052"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#b1">00052</a> <a class="code" href="classXFuBluetoothMultiNetwork.html#b1">XFuBluetoothMultiNetwork::XFuBluetoothMultiNetwork</a>() 
00053 {
00054     <a class="code" href="classXFuBluetoothMultiNetwork.html#o0">mNetworkEventHandlers</a> = NULL;
00055     <a class="code" href="classXFuBluetoothMultiNetwork.html#o1">mCommunicationScheduler</a> = NULL;
00056     <a class="code" href="classXFuBluetoothMultiNetwork.html#o2">mCommunicationHandler</a> = NULL;
00057     <a class="code" href="classXFuBluetoothMultiNetwork.html#o4">mDefaultDataReceiver</a> = NULL;
00058     <a class="code" href="classXFuBluetoothMultiNetwork.html#o6">mHostResolver</a> = NULL;
00059     <a class="code" href="classXFuBluetoothMultiNetwork.html#o3">mCommunicationService</a> = NULL;
00060    
00061     <a class="code" href="classXFuBluetoothMultiNetwork.html#o10">mAcceptGameToken</a> = 0;
00062     <a class="code" href="classXFuBluetoothMultiNetwork.html#o7">mCommunicationHandlerId</a> = -1;
00063     <a class="code" href="classXFuBluetoothMultiNetwork.html#o11">mGamePort</a> = 0;
00064     <a class="code" href="classXFuBluetoothMultiNetwork.html#o9">mSlaveClientId</a> = -1;
00065 
00066     <a class="code" href="classXFuBluetoothMultiNetwork.html#o12">mService</a> = NULL;
00067     <a class="code" href="classXFuBluetoothMultiNetwork.html#o5">mBtServerSearch</a> = NULL;
00068 }
00069 
00070 
<a name="l00071"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a37">00071</a> <a class="code" href="classXFuBluetoothMultiNetwork.html#a37">XFuBluetoothMultiNetwork::~XFuBluetoothMultiNetwork</a>()
00072 {
00073     <a class="code" href="classXFuBluetoothMultiNetwork.html#a2">closeService</a>();
00074     <a class="code" href="classXFuBluetoothMultiNetwork.html#b0">deleteAllClients</a>();
00075 
00076     <a class="code" href="classXFuBluetoothMultiNetwork.html#a27">removeAllEventHandlers</a>();
00077 
00078     <span class="keyword">delete</span> <a class="code" href="classXFuBluetoothMultiNetwork.html#o12">mService</a>;
00079     <span class="keyword">delete</span> <a class="code" href="classXFuBluetoothMultiNetwork.html#o6">mHostResolver</a>;
00080     <span class="keyword">delete</span> <a class="code" href="classXFuBluetoothMultiNetwork.html#o0">mNetworkEventHandlers</a>;
00081 }
00082 
00083 
<a name="l00084"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#b2">00084</a> INT <a class="code" href="classXFuBluetoothMultiNetwork.html#b2">XFuBluetoothMultiNetwork::init</a>()
00085 {
00086     <a class="code" href="classXFuBluetoothMultiNetwork.html#o1">mCommunicationScheduler</a> = (XFcCommunicationScheduler *)XFcCore::getCommunicationScheduler();
00087     <span class="keywordflow">if</span> (<a class="code" href="classXFuBluetoothMultiNetwork.html#o0">mNetworkEventHandlers</a> == NULL)
00088         <a class="code" href="classXFuBluetoothMultiNetwork.html#o0">mNetworkEventHandlers</a> = <a class="code" href="classXFuDynamicArray.html#d0">XFuDynamicArray&lt;XFuNetworkEventHandler*&gt;::create</a>(5);
00089 
00090     <span class="keywordflow">if</span> (<a class="code" href="classXFuBluetoothMultiNetwork.html#o1">mCommunicationScheduler</a> == NULL ||
00091         <a class="code" href="classXFuBluetoothMultiNetwork.html#o0">mNetworkEventHandlers</a> == NULL) <span class="keywordflow">return</span> 0;
00092 
00093     <span class="keywordflow">return</span> 1;
00094 
00095 }
00096 
00097 
<a name="l00098"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a4">00098</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothMultiNetwork.html#a4">XFuBluetoothMultiNetwork::runCommunicationScheduler</a>()
00099 {
00100     <a class="code" href="classXFuBluetoothMultiNetwork.html#o1">mCommunicationScheduler</a>-&gt;runScheduler();
00101 }
00102 
00103 
<a name="l00104"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a3">00104</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothMultiNetwork.html#a3">XFuBluetoothMultiNetwork::reset</a>()
00105 {
00106     XFCLOGFUNC(<span class="stringliteral">"reset()"</span>, 3);
00107     <a class="code" href="classXFuBluetoothMultiNetwork.html#a2">closeService</a>();
00108     <a class="code" href="classXFuBluetoothMultiNetwork.html#b0">deleteAllClients</a>();
00109     <a class="code" href="classXFuBluetoothMultiNetwork.html#a27">removeAllEventHandlers</a>();
00110 
00111     
00112     <a class="code" href="classXFuBluetoothMultiNetwork.html#o10">mAcceptGameToken</a> = 0;
00113     <a class="code" href="classXFuBluetoothMultiNetwork.html#b2">init</a>();
00114 
00115 }
00116 
00117 
<a name="l00118"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#b3">00118</a> INT <a class="code" href="classXFuBluetoothMultiNetwork.html#b3">XFuBluetoothMultiNetwork::initEnable</a>(UINT16 aPort, INT aIsServer)
00119 {
00120     XFCLOGFUNC(<span class="stringliteral">"initEnable()"</span>, 3);
00121     <a class="code" href="classXFuBluetoothMultiNetwork.html#a2">closeService</a>();
00122     <a class="code" href="classXFuBluetoothMultiNetwork.html#b0">deleteAllClients</a>();
00123 
00124 
00125     <a class="code" href="classXFuBluetoothMultiNetwork.html#o12">mService</a> = XFcBtCommService::create();
00126 
00127     <a class="code" href="classXFuBluetoothMultiNetwork.html#o11">mGamePort</a> = aPort;
00128     
00129     <span class="comment">// Are we bluetooth server, bt-slave.</span>
00130     <span class="keywordflow">if</span> (aIsServer)
00131     {
00132         <span class="keywordflow">if</span> (aPort == 0 &amp;&amp; <a class="code" href="classXFuBluetoothMultiNetwork.html#o12">mService</a>)
00133             <a class="code" href="classXFuBluetoothMultiNetwork.html#o11">mGamePort</a> = <a class="code" href="classXFuBluetoothMultiNetwork.html#o12">mService</a>-&gt;getFirstFreeRFCOMMPort();
00134 
00135     }
00136     <span class="keywordflow">else</span>
00137     {
00138         <span class="comment">// Create piconet. Works only with master device.</span>
00139         <a class="code" href="classXFuBluetoothMultiNetwork.html#o12">mService</a>-&gt;createPiconet();
00140         <a class="code" href="classXFuBluetoothMultiNetwork.html#o12">mService</a>-&gt;lockPiconet();
00141     }
00142     
00143     <span class="keywordflow">if</span> (<a class="code" href="classXFuBluetoothMultiNetwork.html#o11">mGamePort</a> == XFCNET_NOT_SUPPORTED)
00144         <a class="code" href="classXFuBluetoothMultiNetwork.html#o11">mGamePort</a>  = 0;
00145 
00146     <a class="code" href="classXFuBluetoothMultiNetwork.html#o2">mCommunicationHandler</a> = XFcBtHandler::create(aIsServer);
00147     
00148     <span class="keywordflow">return</span> (<a class="code" href="classXFuBluetoothMultiNetwork.html#o2">mCommunicationHandler</a> &amp;&amp; <a class="code" href="classXFuBluetoothMultiNetwork.html#o12">mService</a>) ? 1 : 0;
00149 
00150 }
00151 
00152 
<a name="l00153"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a0">00153</a> INT <a class="code" href="classXFuBluetoothMultiNetwork.html#a0">XFuBluetoothMultiNetwork::enableClientService</a>(UINT16 aPort)
00154 {
00155     XFCLOGFUNC(<span class="stringliteral">"enableClientService()"</span>, 3);
00156 
00157     XFcBtAddress *address = XFcBtAddress::create();
00158     XFcBtClientWin *client = XFcBtClientWin::create(NULL);
00159 
00160     <span class="keywordflow">if</span> (address &amp;&amp; client &amp;&amp; <a class="code" href="classXFuBluetoothMultiNetwork.html#b3">initEnable</a>(aPort, 1))
00161     {
00162         address-&gt;setPort(mGamePort);
00163 
00164         <span class="comment">// Max client count must be more than 1</span>
00165         INT32 maxClients = 2;
00166 
00167         <span class="comment">// Open server, will return 1 if success else 0</span>
00168         <span class="keywordflow">if</span> (<a class="code" href="classXFuBluetoothMultiNetwork.html#o2">mCommunicationHandler</a>-&gt;openServer(*address, maxClients))
00169         {
00170             <a class="code" href="classXFuBluetoothMultiNetwork.html#o2">mCommunicationHandler</a>-&gt;setUnknownSenderHandler(<span class="keyword">this</span>);
00171             <a class="code" href="classXFuBluetoothMultiNetwork.html#o2">mCommunicationHandler</a>-&gt;setClientLost(<span class="keyword">this</span>);
00172 
00173             <a class="code" href="classXFuBluetoothMultiNetwork.html#o7">mCommunicationHandlerId</a> = <a class="code" href="classXFuBluetoothMultiNetwork.html#o1">mCommunicationScheduler</a>-&gt;addCommunicationHandler(mCommunicationHandler);
00174             <a class="code" href="classXFuBluetoothMultiNetwork.html#o2">mCommunicationHandler</a>-&gt;listenConnection(*client);
00175 
00176             INT32 clientId = <a class="code" href="classXFuBluetoothMultiNetwork.html#o1">mCommunicationScheduler</a>-&gt;addClient(client);
00177 
00178             <span class="keywordflow">if</span> (clientId != XFCNET_CLIENTADD_ERROR)
00179             {
00180 
00181                 <span class="comment">// XXXX</span>
00182                 <a class="code" href="classXFuBluetoothMultiNetwork.html#o8">mClients</a>.put(clientId, client);
00183                 <span class="keyword">delete</span> address;
00184                 address = NULL;
00185                 <a class="code" href="classXFuBluetoothMultiNetwork.html#o9">mSlaveClientId</a> = clientId;
00186 
00187                 <span class="keywordflow">return</span> 1;
00188             }
00189         }
00190     }
00191     <span class="keyword">delete</span> address;
00192     address = NULL;
00193     <span class="keyword">delete</span> client;
00194     client = NULL;
00195 
00196     <span class="keywordflow">return</span> 0;
00197 }
00198 
00199 
<a name="l00200"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a1">00200</a> INT <a class="code" href="classXFuBluetoothMultiNetwork.html#a1">XFuBluetoothMultiNetwork::enableHostService</a>()
00201 {
00202     XFCLOGFUNC(<span class="stringliteral">"enableServerService()"</span>, 3);
00203     INT error = 0;
00204 
00205     <span class="keywordflow">if</span> (<a class="code" href="classXFuBluetoothMultiNetwork.html#b3">initEnable</a>(0, 0))
00206     {
00207         <a class="code" href="classXFuBluetoothMultiNetwork.html#o2">mCommunicationHandler</a>-&gt;setUnknownSenderHandler(<span class="keyword">this</span>);
00208         <a class="code" href="classXFuBluetoothMultiNetwork.html#o2">mCommunicationHandler</a>-&gt;setClientLost(<span class="keyword">this</span>);
00209 
00210         <a class="code" href="classXFuBluetoothMultiNetwork.html#o7">mCommunicationHandlerId</a> = <a class="code" href="classXFuBluetoothMultiNetwork.html#o1">mCommunicationScheduler</a>-&gt;addCommunicationHandler(mCommunicationHandler);
00211         error = 1;
00212     }
00213     <span class="keywordflow">return</span> error;
00214 }
00215 
00216 
<a name="l00217"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a2">00217</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothMultiNetwork.html#a2">XFuBluetoothMultiNetwork::closeService</a>()
00218 {
00219     XFCLOGFUNC(<span class="stringliteral">"closeService()"</span>, 3);
00220 
00221     <span class="comment">// Unlock and destroy piconet if any.</span>
00222     <a class="code" href="classXFuBluetoothMultiNetwork.html#o12">mService</a>-&gt;unlockPiconet();
00223     <a class="code" href="classXFuBluetoothMultiNetwork.html#o12">mService</a>-&gt;destroyPiconet();
00224 
00225     <a class="code" href="classXFuBluetoothMultiNetwork.html#a28">stopDeviceDiscovery</a>();
00226     <a class="code" href="classXFuBluetoothMultiNetwork.html#a29">stopClientDiscovery</a>();
00227     <a class="code" href="classXFuBluetoothMultiNetwork.html#a30">stopAdvertiser</a>();
00228 
00229     <span class="keywordflow">if</span> (<a class="code" href="classXFuBluetoothMultiNetwork.html#o2">mCommunicationHandler</a> != NULL)
00230     {
00231         <a class="code" href="classXFuBluetoothMultiNetwork.html#o2">mCommunicationHandler</a>-&gt;closeService();
00232         <a class="code" href="classXFuBluetoothMultiNetwork.html#o1">mCommunicationScheduler</a>-&gt;removeCommunicationHandler(mCommunicationHandlerId);
00233         <span class="keyword">delete</span> <a class="code" href="classXFuBluetoothMultiNetwork.html#o2">mCommunicationHandler</a>;
00234         <a class="code" href="classXFuBluetoothMultiNetwork.html#o2">mCommunicationHandler</a> = NULL;
00235     }
00236     <span class="keyword">delete</span> <a class="code" href="classXFuBluetoothMultiNetwork.html#o12">mService</a>;
00237     <a class="code" href="classXFuBluetoothMultiNetwork.html#o12">mService</a> = NULL;
00238 }
00239 
00240 
<a name="l00241"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a10">00241</a> UINT32 <a class="code" href="classXFuBluetoothMultiNetwork.html#a10">XFuBluetoothMultiNetwork::getAcceptGameToken</a>()
00242 {
00243     <span class="keywordflow">return</span> <a class="code" href="classXFuBluetoothMultiNetwork.html#o10">mAcceptGameToken</a>;
00244 }
00245 
00246 
<a name="l00247"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a11">00247</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothMultiNetwork.html#a11">XFuBluetoothMultiNetwork::setAcceptGameToken</a>(UINT32 aAcceptGameToken)
00248 {
00249     <a class="code" href="classXFuBluetoothMultiNetwork.html#o10">mAcceptGameToken</a> = aAcceptGameToken;
00250 }
00251 
00252 
<a name="l00253"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a12">00253</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothMultiNetwork.html#a12">XFuBluetoothMultiNetwork::sendGameConnectPacket</a>(INT32 aClientId, UINT32 aGameToken)
00254 {
00255     XFcObjectDataFrame *frame = <a class="code" href="classXFuBluetoothMultiNetwork.html#a19">getPacketFrame</a>(aClientId, XFCNET_NONGUARANTEED);
00256     <span class="keywordflow">if</span> (frame)
00257     {
00258         frame-&gt;setReceiverId(0);
00259         <span class="keywordtype">void</span> *buffer = frame-&gt;lock();
00260         <span class="keywordflow">if</span> (buffer)
00261         {
00262             memcpy(buffer, &amp;aGameToken, 4);
00263             frame-&gt;setPacketSize(4);
00264         }
00265         frame-&gt;unlock();
00266     }
00267 }
00268 
00269 
00270 
<a name="l00271"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#b0">00271</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothMultiNetwork.html#b0">XFuBluetoothMultiNetwork::deleteAllClients</a>()
00272 {
00273     XFCLOGFUNC(<span class="stringliteral">"deleteAllClients()"</span>, 3);
00274     <span class="keywordflow">if</span> (!<a class="code" href="classXFuBluetoothMultiNetwork.html#o1">mCommunicationScheduler</a>)
00275         <span class="keywordflow">return</span>;
00276 
00277     XFcHashtableIterator&lt;UINT32, XFcBtClientWin *&gt; itClient;
00278 
00279     <span class="keywordflow">while</span> (<a class="code" href="classXFuBluetoothMultiNetwork.html#o8">mClients</a>.size() &gt; 0)
00280     {
00281         itClient = <a class="code" href="classXFuBluetoothMultiNetwork.html#o8">mClients</a>.begin();
00282         INT32 key = itClient.getKey();
00283         XFcClientCommWin *base_client = <a class="code" href="classXFuBluetoothMultiNetwork.html#a7">getClient</a>(key);
00284         <a class="code" href="classXFuBluetoothMultiNetwork.html#o1">mCommunicationScheduler</a>-&gt;removeClient(key);
00285         base_client-&gt;deinitializeClient();
00286         <a class="code" href="classXFuBluetoothMultiNetwork.html#o8">mClients</a>.remove(key);
00287         <span class="keyword">delete</span> base_client;
00288     }
00289     <a class="code" href="classXFuBluetoothMultiNetwork.html#o9">mSlaveClientId</a> = -1;
00290 }
00291 
00292 
<a name="l00293"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a9">00293</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothMultiNetwork.html#a9">XFuBluetoothMultiNetwork::removeAllClients</a>()
00294 {
00295     XFCLOGFUNC(<span class="stringliteral">"removeAllClients()"</span>, 3);
00296     <span class="keywordflow">if</span> (!<a class="code" href="classXFuBluetoothMultiNetwork.html#o2">mCommunicationHandler</a>)
00297         <span class="keywordflow">return</span>;
00298 
00299     XFcHashtableIterator&lt;UINT32, XFcBtClientWin *&gt; itClient;
00300 
00301     <span class="keywordflow">while</span> (<a class="code" href="classXFuBluetoothMultiNetwork.html#o8">mClients</a>.size() &gt; 0)
00302     {
00303         itClient = <a class="code" href="classXFuBluetoothMultiNetwork.html#o8">mClients</a>.begin();
00304         INT32 key = itClient.getKey();
00305         <a class="code" href="classXFuBluetoothMultiNetwork.html#a8">removeClient</a>(key);
00306     }
00307 
00308 }
00309 
00310 
<a name="l00311"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a13">00311</a> XFcDataReceiver * <a class="code" href="classXFuBluetoothMultiNetwork.html#a13">XFuBluetoothMultiNetwork::getDefaultDataReceiver</a>()
00312 {
00313     <span class="keywordflow">return</span> <a class="code" href="classXFuBluetoothMultiNetwork.html#o4">mDefaultDataReceiver</a>;
00314 }
00315 
00316 
<a name="l00317"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a16">00317</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothMultiNetwork.html#a16">XFuBluetoothMultiNetwork::setDefaultDataReceiver</a>(XFcDataReceiver *aReceiver)
00318 {
00319     <a class="code" href="classXFuBluetoothMultiNetwork.html#o4">mDefaultDataReceiver</a> = aReceiver;
00320     <a class="code" href="classXFuBluetoothMultiNetwork.html#o1">mCommunicationScheduler</a>-&gt;setDataReceiver(aReceiver);
00321 }
00322 
00323 
<a name="l00324"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a14">00324</a> XFcDataReceiver * <a class="code" href="classXFuBluetoothMultiNetwork.html#a14">XFuBluetoothMultiNetwork::getDataReceiver</a>(UINT32 aId)
00325 {
00326     <span class="keywordflow">return</span> <a class="code" href="classXFuBluetoothMultiNetwork.html#o1">mCommunicationScheduler</a>-&gt;getDataReceiver(aId);
00327 }
00328 
00329 
<a name="l00330"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a15">00330</a> INT <a class="code" href="classXFuBluetoothMultiNetwork.html#a15">XFuBluetoothMultiNetwork::addDataReceiver</a>(UINT32 aId, XFcDataReceiver *aReceiver)
00331 {
00332     <span class="keywordflow">return</span> <a class="code" href="classXFuBluetoothMultiNetwork.html#o1">mCommunicationScheduler</a>-&gt;addDataReceiver(aId, aReceiver);
00333 }
00334 
00335 
<a name="l00336"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a17">00336</a> XFcDataReceiver * <a class="code" href="classXFuBluetoothMultiNetwork.html#a17">XFuBluetoothMultiNetwork::removeDataReceiver</a>(UINT32 aId)
00337 {
00338     <span class="keywordflow">return</span> <a class="code" href="classXFuBluetoothMultiNetwork.html#o1">mCommunicationScheduler</a>-&gt;removeDataReceiver(aId);
00339 }
00340 
00341 
<a name="l00342"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a25">00342</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothMultiNetwork.html#a25">XFuBluetoothMultiNetwork::addEventHandler</a>(<a class="code" href="classXFuNetworkEventHandler.html">XFuNetworkEventHandler</a> *aHandler)
00343 {
00344     <a class="code" href="classXFuBluetoothMultiNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a7">put</a>(aHandler);
00345 }
00346 
00347 
<a name="l00348"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a26">00348</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothMultiNetwork.html#a26">XFuBluetoothMultiNetwork::removeEventHandler</a>(<a class="code" href="classXFuNetworkEventHandler.html">XFuNetworkEventHandler</a> *aHandler)
00349 {
00350     <a class="code" href="classXFuBluetoothMultiNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a10">remove</a>(aHandler);
00351 }
00352 
00353 
<a name="l00354"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a27">00354</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothMultiNetwork.html#a27">XFuBluetoothMultiNetwork::removeAllEventHandlers</a>()
00355 {
00356     <span class="keywordflow">while</span> (!<a class="code" href="classXFuBluetoothMultiNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a4">isEmpty</a>()) <a class="code" href="classXFuBluetoothMultiNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a10">remove</a>();
00357 }
00358 
00359 
<a name="l00360"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a7">00360</a> XFcClientCommWin * <a class="code" href="classXFuBluetoothMultiNetwork.html#a7">XFuBluetoothMultiNetwork::getClient</a>(INT32 aClientId)
00361 {
00362     XFCLOGFUNC(<span class="stringliteral">"getClient()"</span>, 3);
00363     XFcHashtable&lt;UINT32, XFcBtClientWin *&gt;::iterator it;
00364     XFcClientCommWin * value = NULL;
00365 
00366     it = <a class="code" href="classXFuBluetoothMultiNetwork.html#o8">mClients</a>.find(aClientId);
00367 
00368     <span class="keywordflow">if</span>(it.isValid())
00369     {
00370         value = it.getValue();
00371     }
00372 
00373     <span class="keywordflow">return</span> value;
00374 }
00375 
00376 
<a name="l00377"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a6">00377</a> INT32 <a class="code" href="classXFuBluetoothMultiNetwork.html#a6">XFuBluetoothMultiNetwork::addClient</a>(XFcAddress *aAddress, INT32 <span class="comment">/*aTimeoutTime*/</span>)
00378 {
00379     XFCLOGFUNC(<span class="stringliteral">"addClient()"</span>, 3);
00380     XFcBtClientWin *client = NULL;
00381     INT32 clientId = -1;
00382 
00383     <span class="keywordflow">if</span> (!aAddress)
00384         <span class="keywordflow">return</span> -1;
00385 
00386     <span class="keywordflow">if</span> ((client = XFcBtClientWin::create(aAddress)) == NULL)
00387         <span class="keywordflow">return</span> -1;
00388 
00389     <span class="keywordflow">switch</span> (aAddress-&gt;getType())
00390     {
00391         <span class="keywordflow">case</span> XFCNET_AFBT:
00392             <span class="keywordflow">if</span> (client-&gt;openClient() != -1)
00393             {
00394                 clientId = <a class="code" href="classXFuBluetoothMultiNetwork.html#o1">mCommunicationScheduler</a>-&gt;addClient(client);
00395                 <span class="keywordflow">if</span> (clientId != XFCNET_CLIENTADD_ERROR &amp;&amp; clientId != XFCNET_ERROR)
00396                 {
00397                     <span class="comment">// XXXX</span>
00398                     <a class="code" href="classXFuBluetoothMultiNetwork.html#o8">mClients</a>.put(clientId, client);
00399                 }
00400             }
00401 
00402             <span class="keywordflow">break</span>;
00403         <span class="keywordflow">default</span>:
00404             XFcCore::systemPanic(XFCSTR(<span class="stringliteral">"This address type is not supported"</span>));
00405             <span class="keywordflow">break</span>;
00406     }
00407 
00408     <span class="keywordflow">if</span> (clientId == -1)
00409         <span class="keyword">delete</span> client;
00410 
00411     <span class="keywordflow">return</span> clientId;
00412 }
00413 
00414 
<a name="l00415"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a8">00415</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothMultiNetwork.html#a8">XFuBluetoothMultiNetwork::removeClient</a>(INT32 aClientId)
00416 {
00417     XFCLOGFUNC(<span class="stringliteral">"removeClient()"</span>, 3);
00418     INT32 cId = 0;
00419 
00420     <span class="comment">// If communication handler is not created we do not have anything to do.</span>
00421     <span class="keywordflow">if</span> (!<a class="code" href="classXFuBluetoothMultiNetwork.html#o2">mCommunicationHandler</a>)
00422         <span class="keywordflow">return</span>;
00423 
00424     XFcBtClientWin * oldClient = (XFcBtClientWin *)<a class="code" href="classXFuBluetoothMultiNetwork.html#a7">getClient</a>(aClientId);
00425 
00426     <span class="keywordflow">if</span> (oldClient)
00427         oldClient-&gt;deinitializeClient();
00428     {
00429         <span class="comment">// Remove client and deinitialize it</span>
00430         <a class="code" href="classXFuBluetoothMultiNetwork.html#o1">mCommunicationScheduler</a>-&gt;removeClient(aClientId);
00431         <a class="code" href="classXFuBluetoothMultiNetwork.html#o8">mClients</a>.remove(aClientId);
00432 
00433         <span class="comment">// Listening client is created to backbuffer for incoming connections.</span>
00434         <span class="comment">// If client is removed we create new for new connection.</span>
00435         <span class="comment">// Service works as BT-Slave</span>
00436         <span class="keywordflow">if</span> (<a class="code" href="classXFuBluetoothMultiNetwork.html#o2">mCommunicationHandler</a>-&gt;isServer())
00437         {
00438             XFcBtClientWin *client = NULL;
00439             <span class="keywordflow">if</span> ((client = XFcBtClientWin::create(NULL)) != NULL)
00440             {
00441                 <a class="code" href="classXFuBluetoothMultiNetwork.html#o2">mCommunicationHandler</a>-&gt;listenConnection(*client);
00442                 cId = <a class="code" href="classXFuBluetoothMultiNetwork.html#o1">mCommunicationScheduler</a>-&gt;addClient(client);
00443 
00444                 <span class="keywordflow">if</span> (cId != XFCNET_CLIENTADD_ERROR &amp;&amp; cId != XFCNET_ERROR)
00445                 {
00446                     <span class="comment">// XXXX</span>
00447                     <a class="code" href="classXFuBluetoothMultiNetwork.html#o8">mClients</a>.put(cId, client);
00448                     <a class="code" href="classXFuBluetoothMultiNetwork.html#o9">mSlaveClientId</a> = cId;
00449                 }
00450                 <span class="keywordflow">else</span>
00451                     XFcCore::systemPanic(XFCSTR(<span class="stringliteral">"removeClient(), add client"</span>));
00452             }
00453             <span class="keywordflow">else</span>
00454                 XFcCore::systemPanic(XFCSTR(<span class="stringliteral">"removeClient(), new listener"</span>));
00455         }
00456     }
00457     <span class="keyword">delete</span> oldClient;
00458 }
00459 
00460 
<a name="l00461"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a22">00461</a> INT32 <a class="code" href="classXFuBluetoothMultiNetwork.html#a22">XFuBluetoothMultiNetwork::getRoundTripTime</a>(INT32 aClientId)
00462 {
00463     <span class="keywordflow">return</span> <a class="code" href="classXFuBluetoothMultiNetwork.html#o1">mCommunicationScheduler</a>-&gt;getRoundTripTime(aClientId);
00464 }
00465 
00466 
<a name="l00467"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a19">00467</a> XFcObjectDataFrame * <a class="code" href="classXFuBluetoothMultiNetwork.html#a19">XFuBluetoothMultiNetwork::getPacketFrame</a>(INT32 aClientId, XFCNET_MESSAGE_SLOT aSlot)
00468 {
00469     <span class="keywordflow">return</span> <a class="code" href="classXFuBluetoothMultiNetwork.html#o1">mCommunicationScheduler</a>-&gt;getPacketFrame(aClientId, aSlot);
00470 }
00471 
00472 
<a name="l00473"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a20">00473</a> XFcObjectDataFrame * <a class="code" href="classXFuBluetoothMultiNetwork.html#a20">XFuBluetoothMultiNetwork::getRecentStateFrame</a>(INT32 aClientId, INT32 aRecentId)
00474 {
00475     <span class="keywordflow">return</span> <a class="code" href="classXFuBluetoothMultiNetwork.html#o1">mCommunicationScheduler</a>-&gt;getRecentStateFrame(aClientId, aRecentId);
00476 }
00477 
00478 
<a name="l00479"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a21">00479</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothMultiNetwork.html#a21">XFuBluetoothMultiNetwork::removeRecentStateFrame</a>(INT32 aClientId, INT32 aRecentId)
00480 {
00481     <a class="code" href="classXFuBluetoothMultiNetwork.html#o1">mCommunicationScheduler</a>-&gt;removeRecentStateFrame(aClientId, aRecentId);
00482 }
00483 
00484 
<a name="l00485"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a23">00485</a> INT32 <a class="code" href="classXFuBluetoothMultiNetwork.html#a23">XFuBluetoothMultiNetwork::send</a>(INT32 aClientId,
00486                                                UINT32 aReceiverId,
00487                                                XFCNET_MESSAGE_SLOT aSlot,
00488                                                <a class="code" href="classXFuSerializable.html">XFuSerializable</a> *aSerializable)
00489 {
00490     XFcObjectDataFrame *frame = <a class="code" href="classXFuBluetoothMultiNetwork.html#a19">getPacketFrame</a>(aClientId, aSlot);
00491     INT32 size = -1;
00492     <span class="keywordflow">if</span> (frame)
00493     {
00494 
00495         <span class="keywordtype">void</span> *buffer = frame-&gt;lock();
00496         <span class="keywordflow">if</span> (buffer)
00497         {
00498             size = aSerializable-&gt;<a class="code" href="classXFuSerializable.html#a1">serialize</a>((CHAR8*)buffer, frame-&gt;sizeofBuffer());
00499             <span class="comment">// If size is set to -1 XForge does not send the frame and frame is released.</span>
00500             frame-&gt;setPacketSize(size);
00501             frame-&gt;setReceiverId(aReceiverId);
00502 
00503         }
00504         frame-&gt;unlock();
00505     }
00506     <span class="keywordflow">return</span> size;
00507 }
00508 
00509 
<a name="l00510"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a24">00510</a> INT32 <a class="code" href="classXFuBluetoothMultiNetwork.html#a24">XFuBluetoothMultiNetwork::sendRecentState</a>(INT32 aClientId,
00511                                                           UINT32 aReceiverId,
00512                                                           INT32 aRecentId,
00513                                                           <a class="code" href="classXFuSerializable.html">XFuSerializable</a> *aSerializable)
00514 {
00515     XFcObjectDataFrame *frame = <a class="code" href="classXFuBluetoothMultiNetwork.html#a20">getRecentStateFrame</a>(aClientId, aRecentId);
00516     INT32 size = -1;
00517 
00518     <span class="keywordflow">if</span> (frame)
00519     {
00520         <span class="keywordtype">void</span> *buffer = frame-&gt;lock();
00521         <span class="keywordflow">if</span> (buffer)
00522         {
00523             size = aSerializable-&gt;<a class="code" href="classXFuSerializable.html#a1">serialize</a>((CHAR8*)buffer, frame-&gt;sizeofBuffer());
00524             frame-&gt;setPacketSize(size);
00525             frame-&gt;setReceiverId(aReceiverId);
00526 
00527         }
00528         frame-&gt;unlock();
00529     }
00530     <span class="keywordflow">return</span> size;
00531 }
00532 
00533 
<a name="l00534"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a5">00534</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothMultiNetwork.html#a5">XFuBluetoothMultiNetwork::clientLost</a>(INT32 aClientId)
00535 {
00536     XFCLOGFUNC(<span class="stringliteral">"clientLost()"</span>, 3);
00537     <a class="code" href="classXFuBluetoothMultiNetwork.html#a8">removeClient</a>(aClientId);
00538 
00539     INT32 handlersNum = <a class="code" href="classXFuBluetoothMultiNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a2">size</a>();
00540     INT32 i;
00541 
00542     <span class="keywordflow">for</span> (i = 0; i &lt; handlersNum; i++)
00543     {
00544         <a class="code" href="classXFuBluetoothMultiNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a5">get</a>(i)-&gt;<a class="code" href="classXFuNetworkEventHandler.html#a2">handleClientLost</a>(aClientId);
00545     }
00546 }
00547 
00548 
<a name="l00549"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a18">00549</a> INT <a class="code" href="classXFuBluetoothMultiNetwork.html#a18">XFuBluetoothMultiNetwork::handleSender</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *aAddress, <span class="keyword">const</span> CHAR8 *aData, INT32 aLen)
00550 {
00551     XFCLOGFUNC(<span class="stringliteral">"handleSender()"</span>, 3);
00552 
00553     <span class="comment">// Used magic number mAcceptGameToken here.</span>
00554     <span class="comment">// Make sure that gameToken is not addjusted with same value than mAcceptGameToken is.</span>
00555     UINT32 gameToken = ~<a class="code" href="classXFuBluetoothMultiNetwork.html#o10">mAcceptGameToken</a>;
00556 
00557     <span class="keywordflow">if</span> (((XFcAddress *)aAddress)-&gt;getType() == (INT32)XFCNET_AFBT &amp;&amp; aLen == 4)
00558     {
00559         XFcBtClientWin * slaveClient = (XFcBtClientWin *)<a class="code" href="classXFuBluetoothMultiNetwork.html#a7">getClient</a>(mSlaveClientId);
00560         <span class="comment">// Get packet data</span>
00561         memcpy(&amp;gameToken, aData, 4);
00562 
00563         <span class="comment">// Test if packet data is game connect token packet</span>
00564         <span class="keywordflow">if</span> (gameToken == <a class="code" href="classXFuBluetoothMultiNetwork.html#o10">mAcceptGameToken</a>)
00565         {
00566             <span class="keywordflow">if</span> (slaveClient-&gt;isClientActive() == XFCNET_BT_LINESTATUS_ONHOLD)
00567             {
00568                 <span class="comment">// Accept client connection</span>
00569                 slaveClient-&gt;acceptConnection(1);
00570 
00571                 INT32 i;
00572                 <span class="keywordflow">for</span> (i = 0; i &lt; (INT32)<a class="code" href="classXFuBluetoothMultiNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a2">size</a>(); i++)
00573                 {
00574                     <span class="comment">// Notify event handler</span>
00575                     <a class="code" href="classXFuBluetoothMultiNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a5">get</a>(i)-&gt;<a class="code" href="classXFuNetworkEventHandler.html#a1">handleClientAccepted</a>(i);
00576 
00577                 }
00578             }
00579         }
00580     }
00581     <span class="keywordflow">if</span> (((XFcAddress *)aAddress)-&gt;getType() != (INT32)XFCNET_AFBT ||
00582         aLen != 4 ||
00583         gameToken != <a class="code" href="classXFuBluetoothMultiNetwork.html#o10">mAcceptGameToken</a>)
00584     {
00585 
00586         XFcBtClientWin * slaveClient = (XFcBtClientWin *)<a class="code" href="classXFuBluetoothMultiNetwork.html#a7">getClient</a>(mSlaveClientId);
00587 
00588         <span class="keywordflow">if</span> (slaveClient-&gt;isClientActive() == XFCNET_BT_LINESTATUS_ONHOLD)
00589         {
00590             <span class="comment">// Disconnect client</span>
00591             slaveClient-&gt;acceptConnection(0);
00592 
00593             <span class="comment">// Remove client, if we are bt-slave new listener is automatically created by remove client.</span>
00594             <a class="code" href="classXFuBluetoothMultiNetwork.html#a8">removeClient</a>(mSlaveClientId);
00595 
00596         }
00597     }
00598     <span class="keywordflow">return</span> 0;
00599 }
00600 
00601 
<a name="l00602"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a31">00602</a> INT <a class="code" href="classXFuBluetoothMultiNetwork.html#a31">XFuBluetoothMultiNetwork::startDeviceDiscovery</a>()
00603 {
00604     XFCLOGFUNC(<span class="stringliteral">"startDeviceDiscovery()"</span>, 3);
00605     <span class="comment">// Stop device discovery</span>
00606     <a class="code" href="classXFuBluetoothMultiNetwork.html#a28">stopDeviceDiscovery</a>();
00607 
00608     <span class="comment">// Delete host resolver</span>
00609     <span class="keywordflow">if</span> (!<a class="code" href="classXFuBluetoothMultiNetwork.html#o6">mHostResolver</a>)
00610         <a class="code" href="classXFuBluetoothMultiNetwork.html#o6">mHostResolver</a> = XFcBtHostResolver::create();
00611 
00612     <span class="comment">// Do the device discovery, async found devices are returned througth deviceDiscovery callback.</span>
00613     <span class="keywordflow">if</span> (mHostResolver)
00614         <span class="keywordflow">return</span> (<a class="code" href="classXFuBluetoothMultiNetwork.html#o6">mHostResolver</a>-&gt;inquiry(<span class="keyword">this</span>) == XFCNET_ERROR) ? 0 : 1;
00615 
00616     <span class="keywordflow">return</span> 0;
00617 }
00618 
00619 
<a name="l00620"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a28">00620</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothMultiNetwork.html#a28">XFuBluetoothMultiNetwork::stopDeviceDiscovery</a>()
00621 {
00622     XFCLOGFUNC(<span class="stringliteral">"stopDeviceDiscovery()"</span>, 3);
00623     <span class="keywordflow">if</span> (mHostResolver)
00624         <a class="code" href="classXFuBluetoothMultiNetwork.html#o6">mHostResolver</a>-&gt;cancelInquiry();
00625 }
00626 
00627 
<a name="l00628"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a32">00628</a> INT <a class="code" href="classXFuBluetoothMultiNetwork.html#a32">XFuBluetoothMultiNetwork::startClientDiscovery</a>(<span class="keyword">const</span> XFcBtUUID &amp;aUuid, <span class="keyword">const</span> XFcBtAddress *aAddress)
00629 {
00630     XFCLOGFUNC(<span class="stringliteral">"startClientDiscovery()"</span>, 3);
00631 
00632     INT retval = 0;
00633 
00634     <span class="keywordflow">if</span> (!<a class="code" href="classXFuBluetoothMultiNetwork.html#o12">mService</a>)
00635         <span class="keywordflow">return</span> 0;
00636 
00637     <a class="code" href="classXFuBluetoothMultiNetwork.html#o13">mUUID</a> = aUuid;
00638     
00639     <span class="keywordflow">if</span> (aAddress)
00640     {
00641         <span class="comment">// Have to fix this.</span>
00642         XFcAdvertiser *advr = NULL;
00643         <span class="keywordflow">if</span> ((advr = XFcBtAdvertiser::create(*aAddress, NULL, 0)) != NULL)
00644             retval = <a class="code" href="classXFuBluetoothMultiNetwork.html#o12">mService</a>-&gt;inquiry(*advr, <span class="keyword">this</span>, &amp;mUUID);
00645         <span class="keyword">delete</span> advr;
00646         <span class="keywordflow">return</span> retval;
00647     }
00648     <span class="keywordflow">else</span>
00649     {
00650         <span class="keyword">delete</span> <a class="code" href="classXFuBluetoothMultiNetwork.html#o5">mBtServerSearch</a>;
00651         <span class="keywordflow">if</span> ((<a class="code" href="classXFuBluetoothMultiNetwork.html#o5">mBtServerSearch</a> = XFcBtServerSearch::create()) != NULL)
00652             <span class="keywordflow">return</span> (<a class="code" href="classXFuBluetoothMultiNetwork.html#o5">mBtServerSearch</a>-&gt;inquiry(<span class="keyword">this</span>, mUUID) == XFCNET_ERROR) ? 0 : 1;
00653     }
00654     <span class="keywordflow">return</span> retval;
00655     <span class="comment">//return 0;</span>
00656 }
00657 
00658 
<a name="l00659"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a29">00659</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothMultiNetwork.html#a29">XFuBluetoothMultiNetwork::stopClientDiscovery</a>()
00660 {
00661     <span class="comment">// Not supported for 1.1 release</span>
00662     XFCLOGFUNC(<span class="stringliteral">"stopClientDiscovery()"</span>, 3);
00663 
00664     <span class="keywordflow">if</span> (mService)
00665         <a class="code" href="classXFuBluetoothMultiNetwork.html#o12">mService</a>-&gt;cancelInquiry();
00666 
00667     <span class="keywordflow">if</span> (mBtServerSearch)
00668         <a class="code" href="classXFuBluetoothMultiNetwork.html#o5">mBtServerSearch</a>-&gt;cancelInquiry();
00669 
00670     <span class="keyword">delete</span> <a class="code" href="classXFuBluetoothMultiNetwork.html#o5">mBtServerSearch</a>;
00671     <a class="code" href="classXFuBluetoothMultiNetwork.html#o5">mBtServerSearch</a> = NULL;
00672 }
00673 
00674 
<a name="l00675"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a34">00675</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothMultiNetwork.html#a34">XFuBluetoothMultiNetwork::deviceDiscovery</a>(<span class="keyword">const</span> XFcLinkedList&lt;XFcHostEntry *&gt; &amp;aHostEntry)
00676 {
00677     XFcLinkedList&lt;XFcHostEntry *&gt;::forwardIterator it;
00678     INT32 handlersNum = <a class="code" href="classXFuBluetoothMultiNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a2">size</a>();
00679     INT32 i;
00680 
00681     <span class="keywordflow">if</span> (aHostEntry.size() != 0)
00682     {
00683         <span class="keywordflow">for</span> (it = aHostEntry.forwardBegin(); it != aHostEntry.forwardEnd(); it++)
00684         {
00685             <span class="keywordflow">for</span> (i = 0; i &lt; handlersNum; ++i)
00686                 <a class="code" href="classXFuBluetoothMultiNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a5">get</a>(i)-&gt;<a class="code" href="classXFuNetworkEventHandler.html#a3">handleDeviceDiscovered</a>(it.getData());
00687         }
00688     }
00689 }
00690 
00691 
<a name="l00692"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a35">00692</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothMultiNetwork.html#a34">XFuBluetoothMultiNetwork::deviceDiscovery</a>(<span class="keyword">const</span> XFcLinkedList&lt;XFcAdvertiser *&gt; &amp;aAdvertiser)
00693 {
00694     XFcLinkedList&lt;XFcAdvertiser *&gt;::forwardIterator it;
00695     INT32 handlersNum = <a class="code" href="classXFuBluetoothMultiNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a2">size</a>();
00696     INT32 i;
00697 
00698     <span class="keywordflow">if</span> (aAdvertiser.size() != 0)
00699     {
00700         <span class="keywordflow">for</span> (it = aAdvertiser.forwardBegin(); it != aAdvertiser.forwardEnd(); it++)
00701         {
00702             <span class="keywordflow">for</span> (i = 0; i &lt; handlersNum; i++)
00703                 <a class="code" href="classXFuBluetoothMultiNetwork.html#o0">mNetworkEventHandlers</a>-&gt;<a class="code" href="classXFuDynamicArray.html#a5">get</a>(i)-&gt;<a class="code" href="classXFuNetworkEventHandler.html#a4">handleAdvertiseDiscovered</a>(it.getData());
00704         }
00705     }
00706 }
00707 
00708 
<a name="l00709"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a33">00709</a> INT <a class="code" href="classXFuBluetoothMultiNetwork.html#a33">XFuBluetoothMultiNetwork::startAdvertiser</a>(<span class="keyword">const</span> XFcBtUUID &amp;aUuid, <span class="keyword">const</span> CHAR8 *aMessage)
00710 {
00711     XFCLOGFUNC(<span class="stringliteral">"startAdveriser()"</span>, 3);
00712     
00713     XFcBtAdvertiser *advertise = NULL;
00714 
00715     <span class="keywordflow">if</span> (!<a class="code" href="classXFuBluetoothMultiNetwork.html#o12">mService</a>)
00716         <span class="keywordflow">return</span> 0;
00717 
00718     <span class="keywordflow">if</span> ((advertise = XFcBtAdvertiser::create()) == NULL)
00719         <span class="keywordflow">return</span> 0;
00720 
00721     <a class="code" href="classXFuBluetoothMultiNetwork.html#o13">mUUID</a> = aUuid;
00722     
00723     <span class="comment">// Create default message if not given any</span>
00724     <span class="keywordflow">if</span> (aMessage == NULL)
00725         advertise-&gt;setMessageHeader(<span class="stringliteral">"X-Forge server"</span>, 14);
00726     <span class="keywordflow">else</span>
00727         advertise-&gt;setMessageHeader(aMessage, strlen(aMessage));
00728 
00729     <span class="comment">// Set game port for advertiser</span>
00730     advertise-&gt;setGamePort(mGamePort);
00731 
00732     advertise-&gt;setAvailability(0xff); <span class="comment">// Fully available.</span>
00733 
00734     INT error = <a class="code" href="classXFuBluetoothMultiNetwork.html#o12">mService</a>-&gt;advertise(*advertise, &amp;mUUID);
00735 
00736     <span class="keyword">delete</span> advertise;
00737 
00738     <span class="keywordflow">return</span> (error == XFCNET_ERROR) ? 0 : 1;
00739 
00740 }
00741 
00742 
<a name="l00743"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a30">00743</a> <span class="keywordtype">void</span> <a class="code" href="classXFuBluetoothMultiNetwork.html#a30">XFuBluetoothMultiNetwork::stopAdvertiser</a>()
00744 {
00745     XFCLOGFUNC(<span class="stringliteral">"stopAdvertiser()"</span>, 3);
00746    
00747     <span class="keywordflow">if</span> (!<a class="code" href="classXFuBluetoothMultiNetwork.html#o12">mService</a>)
00748         <span class="keywordflow">return</span>;
00749 
00750     <a class="code" href="classXFuBluetoothMultiNetwork.html#o12">mService</a>-&gt;cancelAdvertise();
00751 }
00752 
00753 
<a name="l00754"></a><a class="code" href="classXFuBluetoothMultiNetwork.html#a36">00754</a> INT <a class="code" href="classXFuBluetoothMultiNetwork.html#a36">XFuBluetoothMultiNetwork::deviceLocalName</a>(XFcName &amp;aName)
00755 {
00756     <span class="comment">// Delete host resolver</span>
00757     <span class="keywordflow">if</span> (!<a class="code" href="classXFuBluetoothMultiNetwork.html#o6">mHostResolver</a>)
00758         <a class="code" href="classXFuBluetoothMultiNetwork.html#o6">mHostResolver</a> = XFcBtHostResolver::create();
00759 
00760     <span class="comment">// Do the device discovery, async found devices are returned througth deviceDiscovery callback.</span>
00761     <span class="keywordflow">if</span> (mHostResolver)
00762     {
00763         INT error = <a class="code" href="classXFuBluetoothMultiNetwork.html#o6">mHostResolver</a>-&gt;localName(aName);
00764 
00765         <span class="keywordflow">if</span> (error != XFCNET_ERROR)
00766         {
00767             <span class="keywordflow">if</span> (aName.mLen &lt; 0x40)
00768                 aName.mName[aName.mLen] = <span class="charliteral">'\0'</span>;
00769 
00770             <span class="keywordflow">return</span> 1;
00771         }
00772     }
00773     <span class="keywordflow">return</span> 0;
00774 }
</pre></div><br clear=all>
<center><table border=0 cellpadding=0 cellspacing=0>
<tr><td colspan=5><img src="paleblue.gif" width=600 height=1></td></tr>
<tr><td>&nbsp;&nbsp;&nbsp;</td><td><a href="http://www.fathammer.com/"><img src="logo.gif" border=0></a></td>
<td valign=bottom><center><font face="arial, helvetica" size="-2" color="#003366">X-Forge Documentation<br>Confidential<br>Copyright &copy; 2002-2003 Fathammer</font></center></td><td>&nbsp;&nbsp;&nbsp;</td>
<td valign=bottom><center><font face="arial, helvetica" size="-2" color="#003366">Documentation generated<br>with <a href="http://www.doxygen.org/index.html">doxygen</a><br>by <a href="mailto:dimitri@stack.nl">Dimitri van Heesch</a></font></center></td></tr></table>
</body></html>
